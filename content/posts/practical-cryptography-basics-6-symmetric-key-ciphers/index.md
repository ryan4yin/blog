---
title: "「译」写给开发人员的实用密码学（六）—— 对称密钥加密算法"
date: 2022-03-01T21:34:00+08:00
draft: true
resources:
- name: "featured-image"
  src: "symmetric-vs-asymmetric.jpg"

tags: ["Cryptography", "密码学", "对称加密", "安全"]
categories: ["技术"]

code:
  # whether to show the copy button of the code block
  copy: false
  # the maximum number of lines of displayed code by default
  maxShownLines: 100
---

>本文仍然在优化翻译质量、补充原文缺失的细节、代码示例。

>本文主要翻译自 [Practical-Cryptography-for-Developers-Book][cryptobook]，但是也补充了一些我的代码示例及思考。


《写给开发人员的实用密码学》系列文章目录：

- [「译」写给开发人员的实用密码学（一）—— 概览](/posts/practical-cryptography-basics-1/)
- [「译」写给开发人员的实用密码学（二）—— 哈希函数](/posts/practical-cryptography-basics-2-hash/)
- [「译」写给开发人员的实用密码学（三）—— MAC 与密钥派生函数 KDF](/posts/practical-cryptography-basics-3-key-derivation-function/)
- [「译」写给开发人员的实用密码学（四）—— 安全的随机数生成器](/posts/practical-cryptography-basics-4-secure-random-generators/)
- [「译」写给开发人员的实用密码学（五）—— 密钥交换与 DHKE](/posts/practical-cryptography-basics-5-key-exchange/)
- [「译」写给开发人员的实用密码学（六）—— 对称密钥加密算法](/posts/practical-cryptography-basics-6-symmetric-key-ciphers/)
- [「译」写给开发人员的实用密码学（七）—— 非对称密钥加密算法](/posts/practical-cryptography-basics-7-asymmetric-key-ciphers/)
- 待续



## 零、术语介绍

两个常用动词：

- 加密：cipher 或者 encrypt
- 解密：decipher 或者 decrypt

另外有几个名词有必要解释：

- cipher: 指用于加解密的「密码算法」
- cryptographic algorithm: 密码学算法，泛指密码学相关的各类算法
- ciphertext: 密文，即加密后的信息。对应的词是明文 plaintext
- password: 这个应该不需要解释，就是我们日常用的各种字符或者数字密码，也可称作口令。
- [passphrase](https://en.wikipedia.org/wiki/Passphrase): 翻译成「密码词组」或者「密碼片語」，通常指用于保护密钥或者其他敏感数据的一个 password.
  - 如果你用 ssh/gpg/openssl 等工具生成或使用过密钥，应该对它不陌生。

## 一、什么是对称加密

在密码学中，有两种加密方案被广泛使用：「对称加密」与「非对称加密」。

对称加密是指，加密与解密均是使用相同的密钥，因为这个特性，我们也称这个密钥为「共享密钥（Shared Secret Key）」，示意图如下：

{{< figure src="/images/practical-cryptography-basics-6-symmetric-key-ciphers/symmetric-cryptography.png" >}}

我们在第一章「概览」里介绍过，单纯使用对称加密算法并不能满足我们对消息真实性、完整性、不可否认性，因此通常我们会将对称加密算法跟其他算法组合成一个对称加密方案来使用。
加密方案可以包括：密钥派生函数（带有某些参数）+对称密码算法（带有某些参数）+密码分组模式算法+消息认证（MAC）算法。
如 AES-256-CTR-HMAC-SHA256 就表示一个使用 AES-256 与 Counter 分组模式进行加密，使用 HMAC-SHA256 进行消息认证的加密方案。
其他流行的对称加密方案还有 ChaCha20-Poly1305 和 AES-128-GCM 等。

现代密码学中广泛使用的对称加密算法（ciphers）有：AES（AES-128、AES-192、AES-256）、ChaCha20、Twofish、IDEA、Serpent、Camelia、RC6、CAST 等。其中绝大多数都是「**块密码算法**（Block Cipher）」或者叫「**分组密码算法**」，这种算法一次只能加密固定大小的块（例如 128 位）；少部分是「**流密码算法**（Stream Cipher）」，流密码算法将数据逐字节加密为密文流。
通过使用称为「分组密码工作模式（Block cipher mode of operation）」的技术，可以将分组密码算法转换为流密码算法。

另外，对称密钥密码算法是抗量子（quantum-resistant）的，这意味着强大的量子计算机无法破坏其安全性（当使用足够大的密钥长度时），即使计算机进入量子时代，仍然可以沿用当当前的对称密码算法（不过可能会需要更大的密钥长度）。

## 二、对称加密方案的结构

前面介绍了对称加密方案常由多种不同功能的算法组成，以确保消息的安全性、真实性、完整性、不可否认性。

一个对称加密方案通常会包含如下几种算法：

- 将密码转换为密钥的密钥派生算法 KDF（如 Scrypt 或 Argon2）：通过使用 KDF，加密方案可以允许用户使用字符密码作为「Shared Secret Key」，并使密码的破解变得困难和缓慢。
- 分组密码到流密码的转换算法（即分组密码模式，如 CBC 或 CTR）+ 消息填充算法（如 PKCS7）：分组密码算法（如 AES）需要借助这两种算法，才能加密任意大小的数据。
- 分组密码算法（如 AES）：使用密钥安全地加密固定长度的数据块。
  - 大多数流行的对称加密算法，都是分组密码算法。
- 消息认证算法（如HMAC）：用于验证消息的真实性、完整性、不可否认性。

## 三、分组密码工作模式

前面简单介绍了「**分组密码工作模式**（Block cipher mode of operation）」——也叫「**块密码工作模式**」——可以将分组密码算法转换为流密码算法，从而实现加密任意长度的数据。这里主要就具体介绍下这个分组密码工作模式。

加密方案的名称中就带有具体的「分组模式」名称，如：

- AES-256-GCM - 具有 256 位加密密钥和 GCM 分组模式的 AES 密码
- AES-128-CTR - 具有 128 位加密密钥和 CTR 分组模式的 AES 密码
- Serpent-128-CBC - 具有 128 位加密密钥和 CBC 分组模式的 Serpent 密码

「分组密码工作模式」背后的主要思想是把明文分成多个长度固定的组，再在这些分组上重复应用分组密码算法进行加密/解密，以实现安全地加密/解密任意长度的数据。

某些分组模式（如 CBC）要求将输入拆分为块，并使用填充算法（例如添加特殊填充字符）将最末尾的分组填充到块大小。其他分组模式（如 CTR、CFB、OFB、CCM、EAX 和 GCM）根本不需要填充，因为它们在每个步骤中在明文部分和内部密码状态之间执行 XOR。

基本上，加密大量输入数据的工作方式如下：初始化加密算法状态（使用加密密钥 + 随机盐），然后加密数据的第一部分（例如块或块的一部分），然后加密状态被转换（使用加密密钥和其他参数），然后加密下一部分，然后再次转换加密状态，然后加密下一部分，依此类推，直到处理完所有输入数据。解密的工作方式非常相似。

### 1. CTR (Counter) 块模式

下图说明了明文的分组（块）如何在 CTR 块操作模式下使用块密码一个接一个地加密：

{{< figure src="/images/practical-cryptography-basics-6-symmetric-key-ciphers/ctr-block-mode.png" >}}

TODO

对于 CTR 模式下的每个块，基于初始向量（IV，有时称为 `nonce`）+ 当前计数器（01、02、03，...）+「加密密钥」和「输入块」生成一个新的不可预测的密钥流块以产生输出块。
在 CTR 模式下，输入数据的最后一个块可以比密码块大小更短，因此不需要填充。输入数据（加密前）和输出数据（加密后）长度相同。

### 2. GCM (Galois/Counter) 块模式

下图直观地解释了 GCM 块模式（Galois/Counter 模式）的工作原理：

{{< figure src="/images/practical-cryptography-basics-6-symmetric-key-ciphers/gcm-galois_counter_mode.png" >}}

GCM 模式使用一个计数器，每处理一个块，计数器就加个一，并计算一个消息认证标签（MAC 码）。最终的身份验证标签是从最后一个块计算的。与所有计数器模式一样，GCM 用作流密码，因此必须在开始时为每个加密的流使用不同的 IV

### 3. 如何选用块模式

- 常用的安全块模式是 CBC（密码块链接）、CTR（计数器）和 GCM（伽罗瓦/计数器模式），它们需要一个随机（不可预测的）初始化向量 (IV)，在开始时也称为 nonce 或 salt
- 「**CTR**（Counter）」块模式在大多数情况下是一个不错的选择，因为它具有很强的安全性和并行处理能力，允许任意输入数据长度（无填充）。但它不提供身份验证和完整性，只提供加密
- **GCM**（Galois/Counter Mode）块模式继承了 CTR 模式的所有优点，并增加了消息认证（产生加密消息认证标签）。 GCM 是在对称密码中实现认证加密的快速有效的方法，**强烈推荐**
- CBC 模式在固定大小的块中工作。因此，在将输入数据分成块后，应使用填充算法使最后一个块的长度相同。大多数应用程序使用 **PKCS7** 填充方案或 ANSI X.923. 在某些情况下，CBC 阻塞模式可能容易受到「padding oracle」攻击，因此**最好避免使用 CBC 模式**
- 众所周知的不安全块模式是 ECB（电子密码本），它将相等的输入块加密为相等的输出块（不提供加密扩散）。**不要使用 ECB 块模式**！它可能会危及整个加密方案。
- CBC、CTR 和 GCM 模式等大多数块都支持「随机访问」解密。比如在视频播放器中的任意时间偏移处寻找，播放加密的视频流

总之，建议使用 CTR (Counter) 或 GCM (Galois/Counter) 块模式和对称密码，如 AES、RC6、Camellia、Serpent 等。其他的在某些情况下可能会有所帮助，但其中一些不太安全，所以只有在你很清楚自己在做什么的情况下才使用它们。

CTR 和 GCM 加密模式有很多优点：它们是安全的（目前没有已知的重大缺陷），可以加密任意长度的数据而无需填充，可以并行加密和解密块（在多核 CPU 中）并提供随机（ unordered) 访问加密块，因此它们适用于加密加密钱包、文档和流视频（用户可以按时间查找）。 GCM 还提供消息认证，是一般情况下密码块模式的推荐选择。

请注意，GCM、CTR 和其他阻塞模式会显示原始消息的长度。明文消息的长度与密文的长度相同。如果您想避免泄露原始明文长度，可以在加密前向明文添加一些随机字节，并在解密后将其删除（这将是某种填充）。


### 4. 初始向量 IV

应该对每条加密消息使用随机且不可预测的 IV（随机数）。
使用相同的对称密钥和相同的 IV 加密多条消息是一个常见的错误。这为大多数块模式的各种加密攻击打开了空间。 IV 的大小应与密码块大小相同，例如AES、Serpent 和 Camellia 的 128 位。

对于 GCM 模式，IV 可能不是秘密和不可预测的，但对于每条消息应该是不同的。

### 5. 认证加密

在密码学中，“认证加密”（AE）的概念是指一种加密数据并同时计算认证码（认证标签/MAC）的方案，用于提供消息的真实性和完整性。如果使用经过身份验证的加密方案，在解密时就知道解密是否成功（即解密密钥/密码是否正确，加密数据是否未被篡改）。

认证加密 (AE) 与类似概念的认证加密与关联数据 (AEAD) 相关，AEAD 是 AE 的一种更安全的变体。 AEAD 将关联数据 (AD) 绑定到密文和它应该出现的上下文，以便可以检测和拒绝将有效密文“剪切并粘贴”到不同上下文的尝试。 AEAD 用于加密和未加密数据一起使用的场景（例如，在加密的网络协议中），并确保整个数据流经过身份验证和完整性保护。换句话说，AEAD 增加了
检查某些内容的完整性和真实性的能力
相关数据 (AD)，也称为“附加验证数据”
(AAD)，即未加密。

一些加密方案（如 ChaCha20-Poly1305 和 AES-GCM）提供集成身份验证加密 (AEAD)，而其他加密方案（如 AES-CBC 和 AES-CTR）需要额外添加身份验证（如果需要）。

最流行的认证加密（AEAD）方案：

- ChaCha20-Poly1305
  - 具有集成 Poly1305 身份验证器的 ChaCha20 流密码（集成身份验证 AEAD 加密）
  - 需要 256 位密钥和随机 96 位随机数
  - 极高的性能
  - 由最现代的加密库实施
- AES-256-GCM
  - AES-GCM 是 GCM 块模式下的 AES (Rijndael) 块密码（集成认证的 AEAD 加密），其行为类似于流密码
  - 所需的 256 位密钥和随机 128 位随机数（初始向量）
  - 由最现代的加密库实现

今天的大多数应用程序应该更喜欢上面的一些加密方案来进行对称加密，而不是构建自己的加密方案。上述方案是高度安全的、经过验证的、经过良好测试的，并且从加密库中开箱即用。

通常更建议使用 ChaCha20-Poly1305，因为它的性能要强劲很多，在移动设备上比 AES-128-GCM 快 3 倍。

## 四、流行的对称加密算法

对称密钥加密算法（如 AES）是由数学家和密码学家设计的，它需要满足一个条件：在没有加密密钥的情况下解密密文应该是不可行的。
现代安全对称加密算法（如 AES 和 ChaCha20）都满足这个条件，而其他一些被认为是不安全的对称加密算法（如 DES 和 RC4）的算法可能不能满足这个条件，或者已经存在一些争议。

### 1. 安全的对称加密算法

#### AES (Rijndael)

AES（高级加密标准，也称为 Rijndael）是现代 IT 行业中最流行和广泛使用的对称加密算法。这是因为 AES 被证明是高度安全、快速且标准化的，并且几乎在所有平台上都得到了很好的支持。 AES 是 128 位分组密码，使用 128、192 或 256 位密钥。它通常用于像 AES-CTR 或 AES-GCM 这样的块模式来处理流数据。在大多数块模式中，AES 还需要一个随机的 128 位初始向量（IV，nonce）。

Rijndael 是 NIST (1997-2000) 组织的 AES 竞赛的获胜者，并以“AES”的名义正式宣布（DES 之后的下一个官方对称分组密码）。 2001 年，AES 被美国政府正式采纳为官方推荐，从那时起没有发现任何明显的弱点或攻击。

Rijndael (AES) 算法可免费用于任何用途：公共或私人、商业或非商业。

#### Salsa20 / ChaCha20

Salsa20 及其改进的变体 ChaCha（ChaCha8、ChaCha12、ChaCha20）和 XSalsa20 是由杰出的密码学家 Daniel Bernstein 设计的现代、快速、对称流密码家族。 Salsa20 密码是设计新对称流密码（2004-2008）的 eSTREAM 竞赛的决赛选手之一，随后与相关的 BLAKE 哈希函数一起被广泛采用。 Salsa20 及其变体是免版税的，没有专利。

Salsa20 密码将 128 位或 256 位对称密钥 + 随机生成的 64 位随机数（初始向量）和无限长度的数据流作为输入，并生成长度相同的加密数据流作为输出输入流。 Salsa20 密码通常用作经过身份验证的加密构造：ChaCha20-Poly1305。

#### 其他流行的对称加密算法

也存在一些其他的现代安全对称密码，它们的应用不如 AES 和 ChaCha20 这么广泛，但在软件开发人员和信息安全社区中仍然很流行：

- Serpent - 安全对称密钥分组密码（密钥大小：128、192 或 256 位），公共领域，未获得专利
- Twofish - 安全对称密钥分组密码（密钥大小：128、192 或 256 位），免版税，未获得专利
- Camellia - 安全对称密钥块密码（块大小：128 位；密钥大小：128、192 和 256 位），已获得专利，但可免费用于非商业用途
- RC5 - 安全对称密钥分组密码（密钥大小：128 到 2040 位；块大小：32、64 或 128 位；轮数：1 ... 255），短密钥不安全（56 位密钥成功暴力破解） , 在 2015 年之前获得专利，现在免版税
- RC6 - 安全对称密钥分组密码，类似于 RC5，但更复杂（密钥大小：128 到 2040 位；块大小：32、64 或 128 位；轮数：1 ... 255），直到 2017 年才获得专利免版税
- IDEA - 安全对称密钥分组密码（密钥大小：128 位），在 2012 年之前获得专利，现在免版税
- CAST (CAST-128 / CAST5, CAST-256 / CAST6) - 安全对称密钥分组密码系列（密钥大小：40 ... 256 位），用于商业和非商业用途的免版税基础
- ARIA - 安全对称密钥分组密码，类似于 AES（密钥大小：128、192 或 256 位），韩国官方标准，免费供公众使用
- SM4 - 安全对称密钥分组密码，类似于 AES（密钥大小：128 位），中国官方标准，免费供公众使用


### 不安全的对称加密算法

有一些对称加密算法过去曾经很流行，但现在被认为是不安全的或有争议的安全性，不建议再使用：

- DES - 56 位密钥大小，几乎被破坏，可以被暴力破解
- 3DES（三重 DES）- 64 位密码，被认为已损坏
- RC2 - 64 位密码，被认为已损坏
- RC4 - 流密码，破解，实际攻击演示
- Blowfish - 旧的 64 位密码，破烂，实际攻击演示
- GOST - 俄罗斯 64 位分组密码，有争议的安全性，被认为有风险


## 五、AES 加密算法

TODO

### 案例：以太坊钱包加密

TODO

## 七、ChaCha20-Poly1305

TODO

## 参考

- [Practical-Cryptography-for-Developers-Book][cryptobook]
- [A complete overview of SSL/TLS and its cryptographic system](https://dev.to/techschoolguru/a-complete-overview-of-ssl-tls-and-its-cryptographic-system-36pd)

[cryptobook]: https://github.com/nakov/Practical-Cryptography-for-Developers-Book

