---
title: "FinOps for Kubernetes - 如何拆分 Kubernetes 成本"
date: 2022-04-29T01:15:24+08:00
lastmod: 2022-04-29T01:15:24+08:00
draft: true

resources:
- name: "featured-image"
  src: "featured-image.jpg"

tags: ["云原生", "Kubernetes", "FinOps", "成本分析", "kubecost"]
categories: ["技术"]

lightgallery: false

comment:
  utterances:
    enable: true
  waline:
    enable: false
---

>FinOps Foundation: https://www.finops.org

>FinOps 是一种不断发展的云财务管理学科和文化实践，通过帮助工程、财务、技术和业务团队在数据驱动的预算分配上进行协作，使成本预算能够产生最大的业务价值。

传统的数据中心的成本是比较固定的，所有的成本变动通常都伴随着硬件更替，因此数据中心的成本分析是比较好做的。

而在云上环境就很不一样了，由于云服务的按量收费特性，以及其眼花缭乱的计费规则，云服务的成本很可能会随时出现意料之外的快速上涨，而且业务扩容对成本的影响也变得更难预测。

我在最近的大半年里，都在负责云计算成本方面的一些工作。
目前的主流云服务商（AWS/GCP/Alicloud/...）基本都提供基于资源标签的成本查询方法，也支持将成本导出并使用 SQL 进行细致分析。

因此其实要做到快速高效的**云成本分析与管控**，主要就涉及到如下几个点：

- **契合需求的标签规范**: 从公司业务侧需求出发，制定出合理的标签规范，这样才能按业务侧需要进行成本分析。
- **资源标签的准确率**: 随着公司业务的发展，标签规范的迭代，标签的准确率总是会上下波动。而标签准确率越高，我们对云计算成本的管控能力就越强。

但是也存在许多特殊的云上资源，云服务商目前并未提供良好的成本分析手段，Kubernetes 集群成本就是其中之一。

## Kubernetes 成本分析的难点

目前许多公司应该都面临着这样的场景：所有的服务都运行在一或多个 Kubernetes 集群上，其中包含多条业务线、多个产品、多个业务团队的服务实例，甚至除了业务服务，可能还包含 CICD、数据分析、机器学习等多种其他工作负载。而这些 Kubernetes 集群通常都由一个独立的 SRE 部门管理。
但是 Kubernetes 集群本身并不提供成本拆分的能力，我们只能看到整个集群的整体成本，或者集群每个节点或节点组的成本。
此外，Kubernetes 集群是一个非常动态的运行环境，其节点的数量、节点规格、Pod 所在的节点/Zone/Region，都可能会随着时间动态变动，这为成本分析带来了更大的困难。

这就导致我们很难回答这些问题：**每条业务线、每个产品、每个业务团队、或者每个服务分别花了多少钱？是否存在资源浪费？有何优化手段**？

而我在成本方面的一部分工作，就是通过人工分析、工程化分析等手段，来回答这些成本问题，分析与管控 Kubernetes 的成本。

接下来我会从概念讲起，介绍我做云上 Kubernetes 成本分析的思路与手段，最后再介绍一个目前业界最优秀的 Kubernetes 成本分析工具 - kubecost.

主要包含如下三个核心问题：

- 理解云服务商的 Kubernetes 服务是如何收费的，了解为什么在 Kubernetes 集群上进行准确的成本拆分很有挑战性。
- 寻找优化 Kubernetes 集群、业务服务的手段
- 确定 Kubernetes 集群的成本拆分手段，建立能快速高效地分析与管控集群成本的流程。

## Kubernetes 成本的构成

以 AWS EKS 为例，我们首先看下 Kubernetes 的成本是如何构成的：

- AWS EKS 本身不收费
- EKS 的所有节点会收对应的 EC2 实例运行费用、EBS 数据卷费用
- EKS 中使用的 PV 会带来 EBS  数据卷的费用
- 跨区流量传输费用
  - 所有节点之间的通讯（主要是服务之间的互相访问），如果跨了可用区，会收跨区流量传输费用
  - EKS 中的服务访问其他 AWS 服务如 RDS/ElastiCache，如果是跨可用区，会收取跨区流量费用
  - 如果使用了 Istio IngressGateway 或 traefik 等网关层代理 Pod，那这些 Pod 与服务实例之间，有可能会产生跨区流量
- NAT 网关费用
  - 如果 VPC 未配置 endpoints 使访问 AWS 服务（dynamodb/s3 等）时直接走 AWS 内部网络，这些流量会经过 VPC 的 NAT 网关，从而产生 NAT 网关费用
- 服务如果要对外提供访问，最佳实践是通过 aws-load-balancer-controller 绑定 AWS ALB, 这里会产生 ALB 费用
- 监控系统成本
  - Kubernetes 的监控系统是不可或缺的
  - 如果你使用的是 Datadog/NewRelic 等云服务，会造成云服务的成本；如果是自建 Prometheus，会造成 Prometheus 的运行成本，以及 Pull 指标造成的跨区流量成本

**总结下，其实就是三部分成本：计算、存储、网络**。其中计算与存储成本是相对固定的，而网络成本就比较动态，跟是否跨区、是否通过 NAT 等诸多因素有关。

## Kubernetes 资源分配的方式

Kubernetes 提供了三种资源分配的方式，被成所服务质量 QoS：

- Guaranteed resource allocation(保证资源分配): 即将 requests 与 limits 设置为相等，确保预留所有所需资源
  - 最保守的策略，服务性能最可靠，但是成本也最高
  - 这种方式分配的资源，拆分起来是最方便的，因为它的计算成本是静态的
- Burstable resource allocation(突发性能): 将 requests 设置得比 limits 低，这样相差的这一部分就是服务的可 Burst 资源量。
  - 最佳实践，选择合适的 requests 与 limits，可达成性能与可靠性之间的平衡
  - 这种资源，它 requests 的计算成本是静态的，Burstable 部分的计算成本是动态的
- Best effort resource allocation(尽力而为): 只设置 limits，不设置 requests，让 Pod 可以调度到任何可调度的节点上
  - 下策，这个选项会导致服务的性能无法保证，通常只在开发测试等资源受限的环境使用
  - 这种方式分配的资源，拆分起来是最麻烦的，因为它的成本是完全动态的。

## 最佳实践

- 按产品或者业务线来划分名字空间，不允许跨名字空间互相访问。
  - 如果存在多个产品或业务线共用的服务，可以在每个产品的名字空间分别部署一个副本，并把它们当成不同的服务来处理。
  - 这样名字空间就是成本划分的一个维度，我们还可以在名字空间上为每个产品设置资源上限与预警。
- 按产品或业务线来划分节点组，通过节点组的标签来进行成本划分
  - 这是第二个维度，但是节点组划分得太细，可能会导致资源利用不够充分。
  - 这个方案仅供参考，不一定好用
- 为 Kubernetes 服务设计与其他云资源一致的成本标签，添加到 Pod 的 label 中，通过 kubecost 等手段，基于 label 进行更细致的成本分析
- 定期（比如每周一） check 云成本变化，定位并解决成本异常
- 建立自动化的成本异常检测与告警机制（部分云服务有提供类似的服务，也可自建），收到告警即触发成本异常分析任务
- 始终将资源标签准确率维持在较高数值，准确率低于一定数值即自动告警，触发标签修正任务
- 将成本上升的压力与成本下降的效益覆盖到开发人员，授权他们跟踪服务的 Kubernetes 利用率与成本，以激励开发人员与 SRE 合作管控服务成本。

## 多云环境

上述讨论的绝大部分策略，都适用于多云环境。在这种涉及多个云服务提供商的场景，最重要的一点是：**搭建平台无关的成本分析与管控平台**。而其核心仍然是文章最前面提到的两点，只需要补充两个字 **一致**：

- **一致的资源标签规范**: 从公司业务侧需求出发，制定出**跨平台一致的**标签规范，这样才能按业务侧需要进行成本分析。
- **资源标签的准确率**: 随着公司业务的发展，标签规范的迭代，标签的准确率总是会上下波动。而标签准确率越高，我们对云计算成本的管控能力就越强。

这样就可以把不同云服务商的数据转换成统一的格式，然后在自有的成本平台上进行统一的分析了。

搭建一个这样的成本分析平台其实并不难，许多大公司都是这么干的，小公司也可以从一个最小的平台开始做起，再慢慢完善功能。

以我现有的经验看，其实主要就包含这么几个部分：

- 成本数据转换模块：将来自不同云的成本数据，转换成与云服务无关的格式，方便统一处理
- 折扣模块：处理不同资源的折扣
  - 比如 CDN 在用量高的时候通常会有很高的折扣比例
  - 还有 SavingPlans/CommitmentDiscounts 也需要特殊的处理
- 标签修整模块
  - 随着标签体系的发展，总会有些标签的变更，不方便直接在资源上执行，就需要在成本计算这里进行修正、增补或者删除
- 成本拆分模块
  - 有些资源的成本是共用的，就需要结合其他来源的数据进行成本拆分，比如 Kubernetes 集群的成本
- 成本报表：将最终的数据制作成符合各类人员需求的可视化图表，按需求还可以考虑添加交互式特征
  - 可使用 Grafana/Google DataStudio 等报表工具


## 使用 kubecost 进行 Kubernetes 成本分析

目前据我所知，主要有如下两个相关开源工具：

- [kubecost](https://github.com/kubecost/cost-model): kubecost 应该是目前最优秀的开源成本分析工具了，self-hosted 是免费的，也提供收费的云上版本，值得研究。
- [crane](https://github.com/gocrane/crane): 腾讯开源的一款 Kubernetes 成本优化工具，支持成本报表以及 EHPA 两个功能，才刚开源几个月，目前还比较简陋。
  - [腾讯推出国内首个云原生成本优化开源项目 Crane](https://cloud.tencent.com/developer/article/1960014)

其中 kubecost 是最成熟的一个，我们接下来以 kubecost 为例介绍下如何分析 Kubernetes 成本。

### 安装 kubecost

TBD

### 使用 kubecost

TBD

## Kubernetes 网络成本的分析

kubecost 只负责分析计算成本与存储成本，不能分析网络成本。

可现实是，对提供线上服务的云上 Kubernetes 集群而言，网络成本很可能等于甚至超过计算成本。这里面最贵的，是跨区/跨域传输的流量成本，以及 NAT 网关成本。

使用单个可用区风险比较高，资源池也可能不够用，因此我们通常会使用多个可用区，这就导致跨区流量成本激增。

比较好的估算方法是，按 kubelet 暴露出的 Pod network 监控指标计算出每个服务每天平均的 TX/RX 流量速率，然后使用这个指标对整个集群的流量成本进行拆分。


## 参考

- [kubecost](https://github.com/kubecost/cost-model): kubecost 应该是目前最优秀的开源成本分析工具了，self-hosted 是免费的，也提供收费的云上版本，值得研究。
- [crane](https://github.com/gocrane/crane): 腾讯开源的一款 Kubernetes 成本优化工具，支持成本报表以及 EHPA 两个功能，才刚开源几个月，目前还比较简陋。
- [Calculating Container Costs - FinOps](https://www.finops.org/projects/calculating-container-costs/)
