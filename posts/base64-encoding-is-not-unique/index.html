<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>Base64 编码并不唯一 - This Cute World</title><meta name=description content="This Cute World"><meta property="og:title" content="Base64 编码并不唯一">
<meta property="og:description" content="个人笔记，不保证正确 问题 我以前只知道 Base64 这个编码算法很常用，自己也经常在 JWT 等场景下使用，但是从来没了解过它的原理，一直先入为主地认为它的编码应">
<meta property="og:type" content="article">
<meta property="og:url" content="https://thiscute.world/posts/base64-encoding-is-not-unique/"><meta property="og:image" content="https://thiscute.world/posts/base64-encoding-is-not-unique/base64-encoding.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-05-31T00:13:00+08:00">
<meta property="article:modified_time" content="2020-05-31T00:13:00+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://thiscute.world/posts/base64-encoding-is-not-unique/base64-encoding.png">
<meta name=twitter:title content="Base64 编码并不唯一">
<meta name=twitter:description content="个人笔记，不保证正确 问题 我以前只知道 Base64 这个编码算法很常用，自己也经常在 JWT 等场景下使用，但是从来没了解过它的原理，一直先入为主地认为它的编码应">
<meta name=application-name content="This Cute World">
<meta name=apple-mobile-web-app-title content="This Cute World"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://thiscute.world/posts/base64-encoding-is-not-unique/><link rel=prev href=https://thiscute.world/posts/tcpdump-and-wireshark/><link rel=next href=https://thiscute.world/posts/jingdezhen-renaissance-band-2020-shenzhen/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Base64 编码并不唯一","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/thiscute.world\/posts\/base64-encoding-is-not-unique\/"},"image":[{"@type":"ImageObject","url":"https:\/\/thiscute.world\/posts\/base64-encoding-is-not-unique\/base64-encoding.png","width":837,"height":470}],"genre":"posts","keywords":"Base64, 编码","wordcount":1983,"url":"https:\/\/thiscute.world\/posts\/base64-encoding-is-not-unique\/","datePublished":"2020-05-31T00:13:00+08:00","dateModified":"2020-05-31T00:13:00+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https:\/\/thiscute.world\/avatar\/myself.png"},"author":{"@type":"Person","name":"ryan4yin"},"description":""}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>(''==='true'&&window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="This Cute World"><span id=id-1 class=typeit></span></a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/statistics/> 阅读排行 </a><a class=menu-item href=/categories/%E6%8A%80%E6%9C%AF/> 技术 </a><a class=menu-item href=/categories/%E9%9A%8F%E7%AC%94/> 随笔 </a><a class=menu-item href=/tags/> 标签 </a><a class=menu-item href=/friends/> 朋友们 </a><a class=menu-item href=/now/> 此刻 </a><a class=menu-item href=/about/> 关于 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/posts/base64-encoding-is-not-unique/ selected>Simplified Chinese</option></select>
</a><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="This Cute World"><span id=id-2 class=typeit></span></a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
取消
</a>
</div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/categories/%E6%8A%80%E6%9C%AF/ title>技术</a><a class=menu-item href=/categories/%E9%9A%8F%E7%AC%94/ title>随笔</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a><a href=javascript:void(0); class=menu-item title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value"><option value=/posts/base64-encoding-is-not-unique/ selected>Simplified Chinese</option></select>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>目录</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">Base64 编码并不唯一</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=https://thiscute.world/ title=Author target=_blank rel="noopener noreferrer author" class=author><i class="fas fa-user-circle fa-fw"></i>ryan4yin</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%8A%80%E6%9C%AF/><i class="far fa-folder fa-fw"></i>技术</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-05-31>2020-05-31</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1983 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div>
</div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/posts/base64-encoding-is-not-unique/base64-encoding.png data-srcset="/posts/base64-encoding-is-not-unique/base64-encoding.png, /posts/base64-encoding-is-not-unique/base64-encoding.png 1.5x, /posts/base64-encoding-is-not-unique/base64-encoding.png 2x" data-sizes=auto alt=/posts/base64-encoding-is-not-unique/base64-encoding.png title=/posts/base64-encoding-is-not-unique/base64-encoding.png></div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#原因分析>原因分析</a></li>
<li><a href=#问题一为什么只需要填充-2-或-4-个-bit-位>问题一：为什么只需要填充 2 或 4 个 bit 位？</a></li>
<li><a href=#问题二为什么用-python-测试时可能需要在-jwt-signature-的末尾添加多个-而-jwt-中不需要>问题二：为什么用 <code>python</code> 测试时可能需要在 JWT signature 的末尾添加多个 <code>=</code>，而 JWT 中不需要？</a></li>
<li><a href=#参考>参考</a></li>
</ul>
</nav></div>
</div><div class=content id=content><blockquote>
<p>个人笔记，不保证正确</p>
</blockquote>
<h1 id=问题>问题</h1>
<p>我以前只知道 Base64 这个编码算法很常用，自己也经常在 JWT 等场景下使用，但是从来没了解过它的原理，一直先入为主地认为它的编码应该是唯一的。</p>
<p>但是今天测试 JWT 时，发现修改 JWT 的最后一个字符（其实不是我发现的。。），居然有可能不影响 JWT 的正确性。比如下这个使用 HS256 算法的 JWT:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
</code></pre></td></tr></table>
</div>
</div><p>把它的最后一个字符改成 <code>d</code> <code>e</code>或者 <code>f</code>，都能成功通过 <code>http://jwt.io</code> 的验证。</p>
<p>这让我觉得很奇怪（难道我发现了一个 Bug？），在QQ群里一问，就有大佬找到根本原因：<strong>这是 Base64 编码的特性</strong>。并且通过 python 进行了实际演示：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>In</span> <span class=p>[</span><span class=mi>1</span><span class=p>]:</span> <span class=kn>import</span> <span class=nn>base64</span>

<span class=c1># 使用 jwt 的 signature 进行验证</span>
<span class=n>In</span> <span class=p>[</span><span class=mi>2</span><span class=p>]:</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=s2>&#34;SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c==&#34;</span><span class=p>)</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>2</span><span class=p>]:</span> <span class=sa>b</span><span class=s1>&#39;I</span><span class=se>\xf9</span><span class=s1>J</span><span class=se>\xc7\x04</span><span class=s1>IH</span><span class=se>\xc7\x8a</span><span class=s1>(]</span><span class=se>\x90</span><span class=s1>O</span><span class=se>\x87\xf0\xa4\xc7\x89\x7f</span><span class=s1>~</span><span class=se>\x8f</span><span class=s1>:N</span><span class=se>\xb2</span><span class=s1>%V</span><span class=se>\x9d</span><span class=s1>B</span><span class=se>\xcb</span><span class=s1>0</span><span class=se>\xe5</span><span class=s1>&#39;</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>3</span><span class=p>]:</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=s2>&#34;SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5d==&#34;</span><span class=p>)</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>3</span><span class=p>]:</span> <span class=sa>b</span><span class=s1>&#39;I</span><span class=se>\xf9</span><span class=s1>J</span><span class=se>\xc7\x04</span><span class=s1>IH</span><span class=se>\xc7\x8a</span><span class=s1>(]</span><span class=se>\x90</span><span class=s1>O</span><span class=se>\x87\xf0\xa4\xc7\x89\x7f</span><span class=s1>~</span><span class=se>\x8f</span><span class=s1>:N</span><span class=se>\xb2</span><span class=s1>%V</span><span class=se>\x9d</span><span class=s1>B</span><span class=se>\xcb</span><span class=s1>0</span><span class=se>\xe5</span><span class=s1>&#39;</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>4</span><span class=p>]:</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=s2>&#34;SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5e==&#34;</span><span class=p>)</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>4</span><span class=p>]:</span> <span class=sa>b</span><span class=s1>&#39;I</span><span class=se>\xf9</span><span class=s1>J</span><span class=se>\xc7\x04</span><span class=s1>IH</span><span class=se>\xc7\x8a</span><span class=s1>(]</span><span class=se>\x90</span><span class=s1>O</span><span class=se>\x87\xf0\xa4\xc7\x89\x7f</span><span class=s1>~</span><span class=se>\x8f</span><span class=s1>:N</span><span class=se>\xb2</span><span class=s1>%V</span><span class=se>\x9d</span><span class=s1>B</span><span class=se>\xcb</span><span class=s1>0</span><span class=se>\xe5</span><span class=s1>&#39;</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>5</span><span class=p>]:</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=s2>&#34;SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5f==&#34;</span><span class=p>)</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>5</span><span class=p>]:</span> <span class=sa>b</span><span class=s1>&#39;I</span><span class=se>\xf9</span><span class=s1>J</span><span class=se>\xc7\x04</span><span class=s1>IH</span><span class=se>\xc7\x8a</span><span class=s1>(]</span><span class=se>\x90</span><span class=s1>O</span><span class=se>\x87\xf0\xa4\xc7\x89\x7f</span><span class=s1>~</span><span class=se>\x8f</span><span class=s1>:N</span><span class=se>\xb2</span><span class=s1>%V</span><span class=se>\x9d</span><span class=s1>B</span><span class=se>\xcb</span><span class=s1>0</span><span class=se>\xe5</span><span class=s1>&#39;</span>

<span class=c1># 两个等于号之后的任何内容，都会被直接丢弃。这个是实现相关的，有的 base64 处理库对这种情况会报错。</span>
<span class=n>In</span> <span class=p>[</span><span class=mi>6</span><span class=p>]:</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=s2>&#34;SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5f==fdf=df==dfd=fderwe=r&#34;</span><span class=p>)</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>6</span><span class=p>]:</span> <span class=sa>b</span><span class=s1>&#39;I</span><span class=se>\xf9</span><span class=s1>J</span><span class=se>\xc7\x04</span><span class=s1>IH</span><span class=se>\xc7\x8a</span><span class=s1>(]</span><span class=se>\x90</span><span class=s1>O</span><span class=se>\x87\xf0\xa4\xc7\x89\x7f</span><span class=s1>~</span><span class=se>\x8f</span><span class=s1>:N</span><span class=se>\xb2</span><span class=s1>%V</span><span class=se>\x9d</span><span class=s1>B</span><span class=se>\xcb</span><span class=s1>0</span><span class=se>\xe5</span><span class=s1>&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到有两个现象：</p>
<ul>
<li>将同一个 base64 串的最后一个字母分别改成 <code>d</code> <code>e</code> <code>f</code>，解码出来的内容没有任何变化。</li>
<li>在 base64 串末尾 <code>==</code> 后面添加了一堆随机字符，对解码出的内容也没有任何影响。</li>
</ul>
<h2 id=原因分析>原因分析</h2>
<p>base64 编码将二进制内容(bytes)从左往右每 6 bits 分为一组，每一组编码为一个可打印字符。
bas64 从 ASCII 字符集中选出了 64 个字符（<code>=</code>号除外）进行编码。因为 $2^6=64$，使用 64 个字符才能保证上述编码的唯一性。</p>
<p>但是被编码的二进制内容(bytes)的 bits 数不一定是 6 的倍数，无法被编码为 6 bits 一组。
为了解决这个问题，就需要在这些二进制内容的末尾填充上 2 或 4 个 bit 位，这样才能使用 base64 进行编码。</p>
<p>关于这些被填充的 bits，在 RFC4648 中定义了规范行为：全部补 0.
但是这并不是一个强制的行为，因此实际上你可以随便补，在进行 base64 解析时，被填补的 bits 会被直接忽略掉。</p>
<p>这就导致了上面描述的行为：修改 <code>JWT</code> 的最后一个字符(6 bits，其中可能包含 2 或 4 个填充比特位)可能并不影响被编码的实际内容！</p>
<p>RFC4684 中对这个 bits 填充的描述如下：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>   3.5.  Canonical Encoding

   The padding step in base 64 and base 32 encoding can, if improperly
   implemented, lead to non-significant alterations of the encoded data.
   For example, if the input is only one octet for a base 64 encoding,
   then all six bits of the first symbol are used, but only the first
   two bits of the next symbol are used.  These pad bits MUST be set to
   zero by conforming encoders, which is described in the descriptions
   on padding below.  If this property do not hold, there is no
   canonical representation of base-encoded data, and multiple base-
   encoded strings can be decoded to the same binary data.  If this
   property (and others discussed in this document) holds, a canonical
   encoding is guaranteed.

   In some environments, the alteration is critical and therefore
   decoders MAY chose to reject an encoding if the pad bits have not
   been set to zero.  The specification referring to this may mandate a
   specific behaviour.
</code></pre></td></tr></table>
</div>
</div><p>它讲到在某些环境下，base64 解析器可能会严格检查被填充的这几个 bits，要求它们全部为 0.
但是我测试发现，Python 标准库和 <code>https://jwt.io</code> 都没有做这样的限制。因此我认为绝大部分环境下，被填充的 bits 都是会被忽略的。</p>
<h2 id=问题一为什么只需要填充-2-或-4-个-bit-位>问题一：为什么只需要填充 2 或 4 个 bit 位？</h2>
<p>这是看到「填充上 2 或 4 个 bit 位」时的第一想法——如果要补足到 6 的倍数，不应该是要填充 1-5 个 bit 位么？</p>
<p>要解答这个问题，我们得看 base64 的定义。在 RFC4648 的 base64 定义中，有如下这样一段话：</p>
<blockquote>
<p>The Base 64 encoding is designed to represent arbitrary sequences of
<strong>octets</strong> in a form that allows the use of both upper- and lowercase
letters but that need not be human readable.</p>
</blockquote>
<p>注意重点：<strong>octets</strong>—— 和 bytes 同义，表示 8 bits 一组的位序列。这表示 <strong>base64 只支持编码 bits 数为 8 的倍数的二进制内容，而 $8x \bmod 6$ 的结果只可能是 0/2/4 三种情况。</strong></p>
<p>因此只需要填充 2 或 4 个 bit 位。</p>
<p>这样的假设也并没有什么问题，因为现代计算机都是统一使用 8 bits(byte) 为最小的可读单位的。即使是 c 语言的「位域」也是如此。
因为 <strong>Byte(8 bits) 现代 CPU 数据读写操作的基本单位</strong>，学过汇编的对这个应该都有些印象。</p>
<p>你仔细想想，所有文件的最小计量单位，是不是都是 byte？</p>
<h2 id=问题二为什么用-python-测试时可能需要在-jwt-signature-的末尾添加多个-而-jwt-中不需要>问题二：为什么用 <code>python</code> 测试时可能需要在 JWT signature 的末尾添加多个 <code>=</code>，而 JWT 中不需要？</h2>
<p>前面已经讲过，base64 的编码步骤是是将字节(byte, 8 bits)序列，从左往右每 6 个 bits 转换成一个可打印字符。</p>
<p>查阅 RFC4648 第 4 小节中 baae64 的定义，能看到它实际上是每次处理 24 bits，因为这是 6 和 8 的最小公倍数，可以刚好用 4 个字符表示。
**在被处理的字节序列的比特(bits)数不是 24 的整数时，就需要在序列末尾填充 0 使末尾的 bits 数是 6 的倍数(6-bit groups)。**有可能会出现三种情况：</p>
<ol>
<li>被处理的字节序列 S 的比特数刚好是 24 的倍数：不需要补比特位，末尾也就不需要加 <code>=</code></li>
<li>S 的比特数是 $24x+8$: 末尾需要补 4 个 bits，这样末尾剩余的 bits 才是 6-bit groups，才能编码成 base64。然后添加两个 <code>==</code> 使编码后的字符数为 4 的倍数。</li>
<li>S 的比特数为 $24x+16$：末尾需要添加 2 个 bits 才能编码成 base64。然后添加一个 <code>=</code> 使编码后的字符数为 4 的倍数。</li>
</ol>
<p>其实可以看到，添加 <code>=</code> 的目的只是为了使编码后的字符数为 4 的倍数而已，<strong><code>=</code> 这个 padding 其实是冗余信息，完全可以去掉。</strong></p>
<p>在解码完成后，应用程序会自动去除掉末尾这不足 1 byte 的 2 或 4 个填充位。</p>
<p>因此 JWT 就去掉了它以减少传输的数据量。</p>
<p>可以用前面讲到的 JWT signature 进行验证：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>In</span> <span class=p>[</span><span class=mi>1</span><span class=p>]:</span> <span class=kn>import</span> <span class=nn>base64</span>

<span class=n>In</span> <span class=p>[</span><span class=mi>2</span><span class=p>]:</span> <span class=n>s</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=s2>&#34;SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c==&#34;</span><span class=p>)</span>

<span class=c1># len(s) * 8 得到 bits 数</span>
<span class=n>In</span> <span class=p>[</span><span class=mi>3</span><span class=p>]:</span> <span class=nb>len</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=o>*</span> <span class=mi>8</span> <span class=o>%</span> <span class=mi>24</span>
<span class=n>Out</span><span class=p>[</span><span class=mi>3</span><span class=p>]:</span> <span class=mi>8</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到这里的被编码内容比特数为 $24x+8$，所以末尾需要添加两个 <code>==</code> 号才符合 RFC4648 的定义。</p>
<h2 id=参考>参考</h2>
<ul>
<li><a href=https://stackoverflow.com/questions/4492426/remove-trailing-when-base64-encoding target=_blank rel="noopener noreferrer">Remove trailing “=” when base64 encoding</a></li>
<li><a href=https://tools.ietf.org/html/rfc4648 target=_blank rel="noopener noreferrer">RFC4648 - base64 定义</a></li>
<li><a href=https://stackoverflow.com/questions/37893325/difference-betweeen-rfc-3548-and-rfc-4648 target=_blank rel="noopener noreferrer">Difference betweeen RFC 3548 and RFC 4648</a></li>
<li><a href=https://www.jianshu.com/p/f1f4e10ad10e target=_blank rel="noopener noreferrer">Base64隐写原理和提取脚本</a></li>
</ul>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>更新于 2020-05-31</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/base64-encoding-is-not-unique/ data-title="Base64 编码并不唯一" data-via=ryan4yin data-hashtags=Base64,编码><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://thiscute.world/posts/base64-encoding-is-not-unique/ data-hashtag=Base64><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/base64-encoding-is-not-unique/><i class="fab fa-reddit fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/base64/>Base64</a>,&nbsp;<a href=/tags/%E7%BC%96%E7%A0%81/>编码</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span>
</section>
</div>
<div class=post-nav><a href=/posts/tcpdump-and-wireshark/ class=prev rel=prev title="使用 tcpdump 和 Wireshark 进行远程实时抓包分析"><i class="fas fa-angle-left fa-fw"></i>使用 tcpdump 和 Wireshark 进行远程实时抓包分析</a>
<a href=/posts/jingdezhen-renaissance-band-2020-shenzhen/ class=next rel=next title=「小歌行」-景德镇文艺复兴-2020巡演-深圳>「小歌行」-景德镇文艺复兴-2020巡演-深圳<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=utterances></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank> <img src=https://img.foreverblog.cn/logo_en_default.png alt style=width:auto;height:15px;margin-bottom:5px> </a> <a href=https://www.foreverblog.cn/go.html target=_blank> <img src=https://img.foreverblog.cn/wormhole_3_tp.gif alt style=width:auto;height:24px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.92.2">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/sunt-programator/CodeIT target=_blank rel="noopener noreferrer" title="CodeIT 0.2.10"><i class="fas fa-laptop-code fa-fw"></i> CodeIT</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://thiscute.world/ target=_blank rel="noopener noreferrer">ryan4yin</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{maxShownLines:100},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/ryan4yin.space"}},data:{"id-1":"This Cute World","id-2":"This Cute World"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},typeit:{cursorChar:null,cursorSpeed:null,data:{"id-1":["id-1"],"id-2":["id-2"]},duration:null,speed:null}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-4V93QVSNFW',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script></body>
</html>