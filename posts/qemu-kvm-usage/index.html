<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title class=pjax-title>QEMU/KVM 虚拟化环境的搭建与使用 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:title" content="QEMU/KVM 虚拟化环境的搭建与使用"><meta property="og:description" content="
    QEMU/KVM 虚拟化
QEMU/KVM 有一定的使用门槛，本文假设你已经拥有基础的虚拟化相关知识，最好是已经有 virtualbox 或 vmware workstation 的使用经验。


    前言虚拟机（Virtual Machine）是指通过软件模拟的具有完整硬件系统功能的、运行在一个完全隔离环境中的完整计算机系统。它的主要用途有：

测试、尝鲜新的操作系统。
快速创建完全隔离的沙箱环境，用于运行某些不安全的或者敏感的文件/程序。
云服务商或企业会通过服务器虚拟化，提升服务器的利用率。
虚拟机可以创建快照跟备份，系统环境可以随时还原到旧的快照，也能方便地拷贝给他人。

而 QEMU/KVM 则是目前最流行的企业级虚拟化技术，它基于 Linux 内核提供的 KVM 模块，结构精简，性能损失小，而且开源免费，因此成了大部分企业的首选虚拟化方案。
目前各大云厂商的虚拟化方案，新的服务器实例基本都是用的 KVM 技术。即使是起步最早，一直重度使用 Xen 的 AWS，从 EC2 C5 开始就改用了基于 KVM 定制的 Nitro 虚拟化技术。
但是 KVM 作为一个企业级的底层虚拟化技术，却没有对桌面使用做深入的优化，因此如果想把它当成桌面虚拟化软件来使用，替代掉 VirtualBox/VMware Workstation，有一定难度。"><meta property="og:type" content="article"><meta property="og:url" content="https://thiscute.world/posts/qemu-kvm-usage/"><meta property="og:image" content="https://thiscute.world/posts/qemu-kvm-usage/qemu-kvm-libvirt-go.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-17T21:34:04+08:00"><meta property="article:modified_time" content="2021-01-17T21:34:04+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/qemu-kvm-usage/qemu-kvm-libvirt-go.webp"><meta name=twitter:title content="QEMU/KVM 虚拟化环境的搭建与使用"><meta name=twitter:description content="
    QEMU/KVM 虚拟化
QEMU/KVM 有一定的使用门槛，本文假设你已经拥有基础的虚拟化相关知识，最好是已经有 virtualbox 或 vmware workstation 的使用经验。


    前言虚拟机（Virtual Machine）是指通过软件模拟的具有完整硬件系统功能的、运行在一个完全隔离环境中的完整计算机系统。它的主要用途有：

测试、尝鲜新的操作系统。
快速创建完全隔离的沙箱环境，用于运行某些不安全的或者敏感的文件/程序。
云服务商或企业会通过服务器虚拟化，提升服务器的利用率。
虚拟机可以创建快照跟备份，系统环境可以随时还原到旧的快照，也能方便地拷贝给他人。

而 QEMU/KVM 则是目前最流行的企业级虚拟化技术，它基于 Linux 内核提供的 KVM 模块，结构精简，性能损失小，而且开源免费，因此成了大部分企业的首选虚拟化方案。
目前各大云厂商的虚拟化方案，新的服务器实例基本都是用的 KVM 技术。即使是起步最早，一直重度使用 Xen 的 AWS，从 EC2 C5 开始就改用了基于 KVM 定制的 Nitro 虚拟化技术。
但是 KVM 作为一个企业级的底层虚拟化技术，却没有对桌面使用做深入的优化，因此如果想把它当成桌面虚拟化软件来使用，替代掉 VirtualBox/VMware Workstation，有一定难度。"><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/qemu-kvm-usage/><link rel=prev href=https://thiscute.world/posts/experience-of-pulumi/><link rel=next href=https://thiscute.world/posts/experience-of-vault/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"QEMU/KVM 虚拟化环境的搭建与使用","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/thiscute.world\/posts\/qemu-kvm-usage\/"},"image":[{"@type":"ImageObject","url":"https:\/\/thiscute.world\/posts\/qemu-kvm-usage\/qemu-kvm-libvirt-go.webp","width":1024,"height":308}],"genre":"posts","keywords":"虚拟化, Visualization, KVM, QEMU, libvirt","wordcount":5589,"url":"https:\/\/thiscute.world\/posts\/qemu-kvm-usage\/","datePublished":"2021-01-17T21:34:04+08:00","dateModified":"2021-01-17T21:34:04+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https:\/\/thiscute.world\/avatar\/myself.png"},"author":{"@type":"Person","name":"ryan4yin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark")}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行 </a><a class=menu-item href=/categories/tech/>技术 </a><a class=menu-item href=/categories/life/>生活 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/friends/>朋友们 </a><a class=menu-item href=/now/>此刻 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=# onclick=return!1 class="menu-item language" title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" id=language-select-desktop onchange="location=this.value"><option value=/posts/qemu-kvm-usage/ selected>Simplified Chinese</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=# onclick=return!1 class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a><a href=# onclick=return!1 class=menu-item title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" onchange="location=this.value"><option value=/posts/qemu-kvm-usage/ selected>Simplified Chinese</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#qemukvm-虚拟化>QEMU/KVM 虚拟化</a></li><li><a href=#前言>前言</a></li><li><a href=#一安装-queukvm>一、安装 QUEU/KVM</a><ul><li><a href=#1-libguestfs---虚拟机磁盘映像处理工具>1. libguestfs - 虚拟机磁盘映像处理工具</a></li><li><a href=#2-启动-qemukvm>2. 启动 QEMU/KVM</a></li><li><a href=#3-让非-root-用户能正常使用-kvm>3. 让非 root 用户能正常使用 kvm</a></li><li><a href=#3-启用嵌套虚拟化>3. 启用嵌套虚拟化</a></li></ul></li><li><a href=#二虚拟机磁盘映像管理>二、虚拟机磁盘映像管理</a><ul><li><a href=#1-导入-vmware-镜像>1. 导入 vmware 镜像</a></li><li><a href=#2-导入-img-镜像>2. 导入 img 镜像</a></li></ul></li><li><a href=#三虚拟机管理>三、虚拟机管理</a><ul><li><a href=#0-设置默认-uri>0. 设置默认 URI</a></li><li><a href=#1-虚拟机网络>1. 虚拟机网络</a></li><li><a href=#2-创建虚拟机---virt-intall>2. 创建虚拟机 - virt-intall</a></li><li><a href=#3-虚拟机管理---virsh>3. 虚拟机管理 - virsh</a></li></ul></li><li><a href=#四使用-cloudinit-自动配置虚拟机>四、使用 cloudinit 自动配置虚拟机</a><ul><li><a href=#下载-cloud-image>下载 cloud image</a></li><li><a href=#配置-cloudinit-并创建虚拟机>配置 cloudinit 并创建虚拟机</a></li><li><a href=#cloud-image-的坑>cloud image 的坑</a><ul><li><a href=#1-ubuntu-cloud-image-的坑>1. ubuntu cloud image 的坑</a></li><li><a href=#2-opensuse-cloud-image-的坑>2. opensuse cloud image 的坑</a></li><li><a href=#3-debian-cloud-image-的坑>3. debian cloud image 的坑</a></li></ul></li><li><a href=#画外cloudinit-主机名称>画外：cloudinit 主机名称</a></li><li><a href=#自动化>自动化</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">QEMU/KVM 虚拟化环境的搭建与使用</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=https://thiscute.world/ title=Author target=_blank rel="noopener noreferrer author" class=author>ryan4yin</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-01-17>2021-01-17</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2021-01-17>2021-01-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5589 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 12 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload data-src=/posts/qemu-kvm-usage/qemu-kvm-libvirt-go.webp data-srcset="/posts/qemu-kvm-usage/qemu-kvm-libvirt-go.webp, /posts/qemu-kvm-usage/qemu-kvm-libvirt-go.webp 1.5x, /posts/qemu-kvm-usage/qemu-kvm-libvirt-go.webp 2x" data-sizes=auto alt=/posts/qemu-kvm-usage/qemu-kvm-libvirt-go.webp title=/posts/qemu-kvm-usage/qemu-kvm-libvirt-go.webp height=308 width=1024></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#qemukvm-虚拟化>QEMU/KVM 虚拟化</a></li><li><a href=#前言>前言</a></li><li><a href=#一安装-queukvm>一、安装 QUEU/KVM</a><ul><li><a href=#1-libguestfs---虚拟机磁盘映像处理工具>1. libguestfs - 虚拟机磁盘映像处理工具</a></li><li><a href=#2-启动-qemukvm>2. 启动 QEMU/KVM</a></li><li><a href=#3-让非-root-用户能正常使用-kvm>3. 让非 root 用户能正常使用 kvm</a></li><li><a href=#3-启用嵌套虚拟化>3. 启用嵌套虚拟化</a></li></ul></li><li><a href=#二虚拟机磁盘映像管理>二、虚拟机磁盘映像管理</a><ul><li><a href=#1-导入-vmware-镜像>1. 导入 vmware 镜像</a></li><li><a href=#2-导入-img-镜像>2. 导入 img 镜像</a></li></ul></li><li><a href=#三虚拟机管理>三、虚拟机管理</a><ul><li><a href=#0-设置默认-uri>0. 设置默认 URI</a></li><li><a href=#1-虚拟机网络>1. 虚拟机网络</a></li><li><a href=#2-创建虚拟机---virt-intall>2. 创建虚拟机 - virt-intall</a></li><li><a href=#3-虚拟机管理---virsh>3. 虚拟机管理 - virsh</a></li></ul></li><li><a href=#四使用-cloudinit-自动配置虚拟机>四、使用 cloudinit 自动配置虚拟机</a><ul><li><a href=#下载-cloud-image>下载 cloud image</a></li><li><a href=#配置-cloudinit-并创建虚拟机>配置 cloudinit 并创建虚拟机</a></li><li><a href=#cloud-image-的坑>cloud image 的坑</a><ul><li><a href=#1-ubuntu-cloud-image-的坑>1. ubuntu cloud image 的坑</a></li><li><a href=#2-opensuse-cloud-image-的坑>2. opensuse cloud image 的坑</a></li><li><a href=#3-debian-cloud-image-的坑>3. debian cloud image 的坑</a></li></ul></li><li><a href=#画外cloudinit-主机名称>画外：cloudinit 主机名称</a></li><li><a href=#自动化>自动化</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><h2 id=qemukvm-虚拟化 class=headerLink><a href=#qemukvm-%e8%99%9a%e6%8b%9f%e5%8c%96 class=header-mark></a>QEMU/KVM 虚拟化</h2><blockquote><p>QEMU/KVM 有一定的使用门槛，本文假设你已经拥有基础的虚拟化相关知识，最好是已经有 virtualbox 或 vmware workstation 的使用经验。</p></blockquote><h2 id=前言 class=headerLink><a href=#%e5%89%8d%e8%a8%80 class=header-mark></a>前言</h2><p>虚拟机（Virtual Machine）是指通过软件模拟的具有完整硬件系统功能的、运行在一个完全隔离环境中的完整计算机系统。它的主要用途有：</p><ol><li>测试、尝鲜新的操作系统。</li><li>快速创建完全隔离的沙箱环境，用于运行某些不安全的或者敏感的文件/程序。</li><li>云服务商或企业会通过服务器虚拟化，提升服务器的利用率。</li><li>虚拟机可以创建快照跟备份，系统环境可以随时还原到旧的快照，也能方便地拷贝给他人。</li></ol><p>而 QEMU/KVM 则是目前最流行的企业级虚拟化技术，它基于 Linux 内核提供的 KVM 模块，结构精简，性能损失小，而且开源免费，因此成了大部分企业的首选虚拟化方案。</p><p>目前各大云厂商的虚拟化方案，新的服务器实例基本都是用的 KVM 技术。即使是起步最早，一直重度使用 Xen 的 AWS，从 EC2 C5 开始就改用了基于 KVM 定制的 Nitro 虚拟化技术。</p><p>但是 KVM 作为一个企业级的底层虚拟化技术，却没有对桌面使用做深入的优化，因此如果想把它当成桌面虚拟化软件来使用，替代掉 <a href=https://www.virtualbox.org/ target=_blank rel="noopener noreferrer">VirtualBox</a>/<a href=https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html target=_blank rel="noopener noreferrer">VMware Workstation</a>，有一定难度。</p><p>本文是我个人学习 KVM 的一个总结性文档，其目标是使用 KVM 作为桌面虚拟化软件。</p><h2 id=一安装-queukvm class=headerLink><a href=#%e4%b8%80%e5%ae%89%e8%a3%85-queukvm class=header-mark></a>一、安装 QUEU/KVM</h2><p>QEMU/KVM 环境需要安装很多的组件，它们各司其职：</p><ol><li>qemu: 模拟各类输入输出设备（网卡、磁盘、USB端口等）<ul><li>qemu 底层使用 kvm 模拟 CPU 和 RAM，比软件模拟的方式快很多。</li></ul></li><li>libvirt: 提供简单且统一的工具和 API，用于管理虚拟机，屏蔽了底层的复杂结构。（支持 qemu-kvm/virtualbox/vmware）</li><li>ovmf: 为虚拟机启用 UEFI 支持</li><li>virt-manager: 用于管理虚拟机的 GUI 界面（可以管理远程 kvm 主机）。</li><li>virt-viewer: 通过 GUI 界面直接与虚拟机交互（可以管理远程 kvm 主机）。</li><li>dnsmasq vde2 bridge-utils openbsd-netcat: 网络相关组件，提供了以太网虚拟化、网络桥接、NAT网络等虚拟网络功能。<ul><li>dnsmasq 提供了 NAT 虚拟网络的 DHCP 及 DNS 解析功能。</li><li>vde2: 以太网虚拟化</li><li>bridge-utils: 顾名思义，提供网络桥接相关的工具。</li><li>openbsd-netcat: TCP/IP 的瑞士军刀，详见 <a href=https://thiscute.world/posts/socat-netcat/ target=_blank rel="noopener noreferrer">socat & netcat</a>，这里不清楚是哪个网络组件会用到它。</li></ul></li></ol><p>安装命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># archlinux/manjaro</span>
</span></span><span class=line><span class=cl>sudo pacman -S qemu virt-manager virt-viewer dnsmasq vde2 bridge-utils openbsd-netcat
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ubuntu,参考了官方文档，但未测试</span>
</span></span><span class=line><span class=cl>sudo apt install qemu-kvm libvirt-daemon-system virt-manager virt-viewer virtinst bridge-utils
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># centos,参考了官方文档，但未测试</span>
</span></span><span class=line><span class=cl>sudo yum groupinstall <span class=s2>&#34;Virtualization Host&#34;</span>
</span></span><span class=line><span class=cl>sudo yum install virt-manager virt-viewer virt-install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># opensuse</span>
</span></span><span class=line><span class=cl><span class=c1># see: https://doc.opensuse.org/documentation/leap/virtualization/html/book-virt/cha-vt-installation.html</span>
</span></span><span class=line><span class=cl>sudo yast2 virtualization
</span></span><span class=line><span class=cl><span class=c1># enter to terminal ui, select kvm + kvm tools, and then install it.</span>
</span></span></code></pre></td></tr></table></div></div><p>安装完成后，还不能直接使用，需要做些额外的工作。请继续往下走。</p><h3 id=1-libguestfs---虚拟机磁盘映像处理工具 class=headerLink><a href=#1-libguestfs---%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%a3%81%e7%9b%98%e6%98%a0%e5%83%8f%e5%a4%84%e7%90%86%e5%b7%a5%e5%85%b7 class=header-mark></a>1. libguestfs - 虚拟机磁盘映像处理工具</h3><p><a href=https://libguestfs.org/ target=_blank rel="noopener noreferrer">libguestfs</a> 是一个虚拟机磁盘映像处理工具，可用于直接修改/查看/虚拟机映像、转换映像格式等。</p><p>它提供的命令列表如下：</p><ol><li><code>virt-df centos.img</code>: 查看硬盘使用情况</li><li><code>virt-ls centos.img /</code>: 列出目录文件</li><li><code>virt-copy-out -d domain /etc/passwd /tmp</code>：在虚拟映像中执行文件复制</li><li><code>virt-list-filesystems /file/xx.img</code>：查看文件系统信息</li><li><code>virt-list-partitions /file/xx.img</code>：查看分区信息</li><li><code>guestmount -a /file/xx.qcow2(raw/qcow2都支持) -m /dev/VolGroup/lv_root --rw /mnt</code>：直接将分区挂载到宿主机</li><li><code>guestfish</code>: 交互式 shell，可运行上述所有命令。</li><li><code>virt-v2v</code>: 将其他格式的虚拟机(比如 ova) 转换成 kvm 虚拟机。</li><li><code>virt-p2v</code>: 将一台物理机转换成虚拟机。</li></ol><p>学习过程中可能会使用到上述命令，提前安装好总不会有错，安装命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># opensuse</span>
</span></span><span class=line><span class=cl>sudo zypper install libguestfs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># archlinux/manjaro，目前缺少 virt-v2v/virt-p2v 组件</span>
</span></span><span class=line><span class=cl>sudo pacman -S libguestfs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ubuntu</span>
</span></span><span class=line><span class=cl>sudo apt install libguestfs-tools
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># centos</span>
</span></span><span class=line><span class=cl>sudo yum install libguestfs-tools
</span></span></code></pre></td></tr></table></div></div><h3 id=2-启动-qemukvm class=headerLink><a href=#2-%e5%90%af%e5%8a%a8-qemukvm class=header-mark></a>2. 启动 QEMU/KVM</h3><p>通过 systemd 启动 libvirtd 后台服务：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo systemctl <span class=nb>enable</span> libvirtd.service
</span></span><span class=line><span class=cl>sudo systemctl start libvirtd.service
</span></span></code></pre></td></tr></table></div></div><h3 id=3-让非-root-用户能正常使用-kvm class=headerLink><a href=#3-%e8%ae%a9%e9%9d%9e-root-%e7%94%a8%e6%88%b7%e8%83%bd%e6%ad%a3%e5%b8%b8%e4%bd%bf%e7%94%a8-kvm class=header-mark></a>3. 让非 root 用户能正常使用 kvm</h3><p>qumu/kvm 装好后，默认情况下需要 root 权限才能正常使用它。
为了方便使用，首先编辑文件 <code>/etc/libvirt/libvirtd.conf</code>:</p><ol><li><code>unix_sock_group = "libvirt"</code>，取消这一行的注释，使 <code>libvirt</code> 用户组能使用 unix 套接字。</li><li><code>unix_sock_rw_perms = "0770"</code>，取消这一行的注释，使用户能读写 unix 套接字。</li></ol><p>然后新建 libvirt 用户组，将当前用户加入该组：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>newgrp libvirt
</span></span><span class=line><span class=cl>sudo usermod -aG libvirt <span class=nv>$USER</span>
</span></span></code></pre></td></tr></table></div></div><p>最后重启 libvirtd 服务，应该就能正常使用了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo systemctl restart libvirtd.service
</span></span></code></pre></td></tr></table></div></div><h3 id=3-启用嵌套虚拟化 class=headerLink><a href=#3-%e5%90%af%e7%94%a8%e5%b5%8c%e5%a5%97%e8%99%9a%e6%8b%9f%e5%8c%96 class=header-mark></a>3. 启用嵌套虚拟化</h3><p>如果你需要<strong>在虚拟机中运行虚拟机</strong>（比如在虚拟机里测试 katacontainers 等安全容器技术），那就需要启用内核模块 kvm_intel 或 kvm_amd 实现嵌套虚拟化。</p><p>首先通过如下指令验证下是否已经启用了嵌套虚拟化（一般的发行版默认都不会启用）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># intel 用这个命令，输出 Y 则表示启用了嵌套虚拟化</span>
</span></span><span class=line><span class=cl>cat /sys/module/kvm_intel/parameters/nested
</span></span><span class=line><span class=cl><span class=c1># amd 用如下指令，输出 1 则表示启用了嵌套虚拟化</span>
</span></span><span class=line><span class=cl>cat /sys/module/kvm_amd/parameters/nested
</span></span></code></pre></td></tr></table></div></div><p>如果输出不是 <code>Y</code>/<code>1</code>，说明默认未启用嵌套虚拟化，需要手动启用，步骤如下。</p><p>如果是 intel cpu，需要使用如下命令启用嵌套虚拟化功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>## 1. 关闭所有虚拟机，并卸载 kvm_intel 内核模块</span>
</span></span><span class=line><span class=cl>sudo modprobe -r kvm_intel
</span></span><span class=line><span class=cl><span class=c1>## 2. 启用嵌套虚拟化功能</span>
</span></span><span class=line><span class=cl>sudo modprobe kvm_intel <span class=nv>nested</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1>## 3. 保存配置，使嵌套虚拟化功能在重启后自动启用</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modprobe.d/kvm.conf
</span></span></span><span class=line><span class=cl><span class=s>options kvm_intel nested=1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p>如果是 amd cpu，则应使用如下命令启用嵌套虚拟化功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>## 1. 关闭所有虚拟机，并卸载 kvm_intel 内核模块</span>
</span></span><span class=line><span class=cl>sudo modprobe -r kvm_amd
</span></span><span class=line><span class=cl><span class=c1>## 2. 启用嵌套虚拟化功能</span>
</span></span><span class=line><span class=cl>sudo modprobe kvm_amd <span class=nv>nested</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1>## 3. 保存配置，使嵌套虚拟化功能在重启后自动启用</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modprobe.d/kvm.conf
</span></span></span><span class=line><span class=cl><span class=s>options kvm_amd nested=1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p>改完后再利用前面提到的命令验证下是否启用成功。</p><p>至此，KVM 的安装就大功告成啦，现在应该可以在系统中找到 virt-manager 的图标，进去就可以使用了。
virt-manager 的使用方法和 virtualbox/vmware workstation 大同小异，这里就不详细介绍了，自己摸索摸索应该就会了。</p><hr><blockquote><p>如下内容是进阶篇，主要介绍如何通过命令行来管理虚拟机磁盘，以及 KVM。
如果你还是 kvm 新手，建议先通过图形界面 virt-manager 熟悉熟悉，再往下继续读。</p></blockquote><h2 id=二虚拟机磁盘映像管理 class=headerLink><a href=#%e4%ba%8c%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%a3%81%e7%9b%98%e6%98%a0%e5%83%8f%e7%ae%a1%e7%90%86 class=header-mark></a>二、虚拟机磁盘映像管理</h2><p>这需要用到两个工具：</p><ol><li>libguestfs: 虚拟机磁盘映像管理工具，前面介绍过了</li><li>qemu-img: qemu 的磁盘映像管理工具，用于创建磁盘、扩缩容磁盘、生成磁盘快照、查看磁盘信息、转换磁盘格式等等。</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建磁盘</span>
</span></span><span class=line><span class=cl>qemu-img create -f qcow2 -o <span class=nv>cluster_size</span><span class=o>=</span>128K virt_disk.qcow2 20G
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 扩容磁盘</span>
</span></span><span class=line><span class=cl>qemu-img resize ubuntu-server-cloudimg-amd64.img 30G
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看磁盘信息</span>
</span></span><span class=line><span class=cl>qemu-img info ubuntu-server-cloudimg-amd64.img
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转换磁盘格式</span>
</span></span><span class=line><span class=cl>qemu-img convert -f raw -O qcow2 vm01.img vm01.qcow2  <span class=c1># raw =&gt; qcow2</span>
</span></span><span class=line><span class=cl>qemu-img convert -f qcow2 -O raw vm01.qcow2 vm01.img  <span class=c1># qcow2 =&gt; raw</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=1-导入-vmware-镜像 class=headerLink><a href=#1-%e5%af%bc%e5%85%a5-vmware-%e9%95%9c%e5%83%8f class=header-mark></a>1. 导入 vmware 镜像</h3><p>直接从 vmware ova 文件导入 kvm，这种方式转换得到的镜像应该能直接用（网卡需要重新配置）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virt-v2v -i ova centos7-test01.ova -o <span class=nb>local</span> -os /vmhost/centos7-01  -of qcow2
</span></span></code></pre></td></tr></table></div></div><p>也可以先从 ova 中解压出 vmdk 磁盘映像，将 vmware 的 vmdk 文件转换成 qcow2 格式，然后再导入 kvm（网卡需要重新配置）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 转换映像格式</span>
</span></span><span class=line><span class=cl>qemu-img convert -p -f vmdk -O qcow2 centos7-test01-disk1.vmdk centos7-test01.qcow2
</span></span><span class=line><span class=cl><span class=c1># 查看转换后的映像信息</span>
</span></span><span class=line><span class=cl>qemu-img info centos7-test01.qcow2
</span></span></code></pre></td></tr></table></div></div><p>直接转换 vmdk 文件得到的 qcow2 镜像，启会报错，比如「磁盘无法挂载」。
根据 <a href=https://pve.proxmox.com/pve-docs/chapter-qm.html#_importing_virtual_machines_and_disk_images target=_blank rel="noopener noreferrer">Importing Virtual Machines and disk images - ProxmoxVE Docs</a> 文档所言，需要在网上下载安装 MergeIDE.zip 组件，
另外启动虚拟机前，需要将硬盘类型改为 IDE，才能解决这个问题。</p><h3 id=2-导入-img-镜像 class=headerLink><a href=#2-%e5%af%bc%e5%85%a5-img-%e9%95%9c%e5%83%8f class=header-mark></a>2. 导入 img 镜像</h3><p>img 镜像文件，就是所谓的 raw 格式镜像，也被称为裸镜像，IO 速度比 qcow2 快，但是体积大，而且不支持快照等高级特性。
如果不追求 IO 性能的话，建议将它转换成 qcow2 再使用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>qemu-img convert -f raw -O qcow2 vm01.img vm01.qcow2
</span></span></code></pre></td></tr></table></div></div><h2 id=三虚拟机管理 class=headerLink><a href=#%e4%b8%89%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%ae%a1%e7%90%86 class=header-mark></a>三、虚拟机管理</h2><p>虚拟机管理可以使用命令行工具 <code>virsh</code>/<code>virt-install</code>，也可以使用 GUI 工具 <code>virt-manager</code>.</p><p>GUI 很傻瓜式，就不介绍了，这里主要介绍命令行工具 <code>virsh</code>/<code>virt-install</code></p><p>先介绍下 libvirt 中的几个概念：</p><ol><li>Domain: 指代运行在虚拟机器上的操作系统的实例 - 一个虚拟机，或者用于启动虚拟机的配置。</li><li>Guest OS: 运行在 domain 中的虚拟操作系统。</li></ol><p>大部分情况下，你都可以把下面命令中涉及到的 <code>domain</code> 理解成虚拟机。</p><h3 id=0-设置默认-uri class=headerLink><a href=#0-%e8%ae%be%e7%bd%ae%e9%bb%98%e8%ae%a4-uri class=header-mark></a>0. 设置默认 URI</h3><p><code>virsh</code>/<code>virt-install</code>/<code>virt-viewer</code> 等一系列 libvirt 命令，sudo virsh net-list &ndash;all
默认情况下会使用 <code>qemu:///session</code> 作为 URI 去连接 QEMU/KVM，只有 root 账号才会默认使用 <code>qemu:///system</code>.</p><p>另一方面 <code>virt-manager</code> 这个 GUI 工具，默认也会使用 <code>qemu:///system</code> 去连接 QEMU/KVM（和 root 账号一致）</p><p><code>qemu:///system</code> 是系统全局的 qemu 环境，而 <code>qemu:///session</code> 的环境是按用户隔离的。
另外 <code>qemu:///session</code> 没有默认的 <code>network</code>，创建虚拟机时会出毛病。。。</p><p>因此，你需要将默认的 URI 改为 <code>qemu:///system</code>，否则绝对会被坑:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;export LIBVIRT_DEFAULT_URI=&#34;qemu:///system&#34;&#39;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></td></tr></table></div></div><h3 id=1-虚拟机网络 class=headerLink><a href=#1-%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%bd%91%e7%bb%9c class=header-mark></a>1. 虚拟机网络</h3><p>qemu-kvm 安装完成后，<code>qemu:///system</code> 环境中默认会创建一个 <code>default</code> 网络，而 <code>qemu:///session</code> 不提供默认的网络，需要手动创建。</p><p>我们通常使用 <code>qemu:///system</code> 环境就好，可以使用如下方法查看并启动 default 网络，这样后面创建虚拟机时才有网络可用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 列出所有虚拟机网络</span>
</span></span><span class=line><span class=cl>$ sudo virsh net-list --all
</span></span><span class=line><span class=cl> Name      State      Autostart   Persistent
</span></span><span class=line><span class=cl>----------------------------------------------
</span></span><span class=line><span class=cl> default   inactive   no          yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动默认网络</span>
</span></span><span class=line><span class=cl>$ virsh net-start default
</span></span><span class=line><span class=cl>Network default started
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将 default 网络设为自启动</span>
</span></span><span class=line><span class=cl>$ virsh net-autostart --network default
</span></span><span class=line><span class=cl>Network default marked as autostarted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 再次检查网络状况，已经是 active 了</span>
</span></span><span class=line><span class=cl>$ sudo virsh net-list --all
</span></span><span class=line><span class=cl> Name      State    Autostart   Persistent
</span></span><span class=line><span class=cl>--------------------------------------------
</span></span><span class=line><span class=cl> default   active   yes         yes
</span></span></code></pre></td></tr></table></div></div><p>也可以创建新的虚拟机网络，这需要手动编写网络的 xml 配置，然后通过 <code>virsh net-define --file my-network.xml</code> 创建，这里就不详细介绍了，因为暂时用不到&mldr;</p><h3 id=2-创建虚拟机---virt-intall class=headerLink><a href=#2-%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba---virt-intall class=header-mark></a>2. 创建虚拟机 - virt-intall</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 使用 iso 镜像创建全新的 proxmox 虚拟机，自动创建一个 60G 的磁盘。</span>
</span></span><span class=line><span class=cl>virt-install --virt-type kvm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--name pve-1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--vcpus <span class=m>4</span> --memory <span class=m>8096</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--disk <span class=nv>size</span><span class=o>=</span><span class=m>60</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--network <span class=nv>network</span><span class=o>=</span>default,model<span class=o>=</span>virtio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--os-type linux <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--os-variant generic <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--graphics vnc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--cdrom proxmox-ve_6.3-1.iso
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用已存在的 opensuse cloud 磁盘创建虚拟机</span>
</span></span><span class=line><span class=cl>virt-install --virt-type kvm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --name opensuse15-2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --vcpus <span class=m>2</span> --memory <span class=m>2048</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --disk opensuse15.2-openstack.qcow2,device<span class=o>=</span>disk,bus<span class=o>=</span>virtio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --disk seed.iso,device<span class=o>=</span>cdrom <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --os-type linux <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --os-variant opensuse15.2 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --network <span class=nv>network</span><span class=o>=</span>default,model<span class=o>=</span>virtio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --graphics vnc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --import
</span></span></code></pre></td></tr></table></div></div><p>其中的 <code>--os-variant</code> 用于设定 OS 相关的优化配置，官方文档<strong>强烈推荐</strong>设定，其可选参数可以通过 <code>osinfo-query os</code> 查看。</p><h3 id=3-虚拟机管理---virsh class=headerLink><a href=#3-%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%ae%a1%e7%90%86---virsh class=header-mark></a>3. 虚拟机管理 - virsh</h3><p>虚拟机创建好后，可使用 virsh 管理虚拟机。</p><p>首先介绍万能的帮助命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virsh <span class=nb>help</span>
</span></span></code></pre></td></tr></table></div></div><p>除了官方的 help 之外，我也总结了下 virsh 的常用命令，如下。</p><p>查看虚拟机列表：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># 查看正在运行的虚拟机
</span></span><span class=line><span class=cl>virsh list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># 查看所有虚拟机，包括 inactive 的虚拟机
</span></span><span class=line><span class=cl>virsh list --all
</span></span></code></pre></td></tr></table></div></div><p>使用 <code>virt-viewer</code> 以 vnc 协议登入虚拟机终端：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 使用虚拟机 ID 连接</span>
</span></span><span class=line><span class=cl>virt-viewer <span class=m>8</span>
</span></span><span class=line><span class=cl><span class=c1># 使用虚拟机名称连接，并且等待虚拟机启动</span>
</span></span><span class=line><span class=cl>virt-viewer --wait opensuse15
</span></span></code></pre></td></tr></table></div></div><p>启动、关闭、暂停(休眠)、重启虚拟机：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virsh start opensuse15
</span></span><span class=line><span class=cl>virsh <span class=nb>suspend</span> opensuse15
</span></span><span class=line><span class=cl>virsh resume opensuse15
</span></span><span class=line><span class=cl>virsh reboot opensuse15
</span></span><span class=line><span class=cl><span class=c1># 优雅关机</span>
</span></span><span class=line><span class=cl>virsh shutdown opensuse15
</span></span><span class=line><span class=cl><span class=c1># 强制关机</span>
</span></span><span class=line><span class=cl>virsh destroy opensuse15
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启用自动开机</span>
</span></span><span class=line><span class=cl>virsh autostart opensuse15
</span></span><span class=line><span class=cl><span class=c1># 禁用自动开机</span>
</span></span><span class=line><span class=cl>virsh autostart --disable opensuse15
</span></span></code></pre></td></tr></table></div></div><p>虚拟机快照管理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 列出一个虚拟机的所有快照</span>
</span></span><span class=line><span class=cl>virsh snapshot-list --domain opensuse15
</span></span><span class=line><span class=cl><span class=c1># 给某个虚拟机生成一个新快照</span>
</span></span><span class=line><span class=cl>virsh snapshot-create &lt;domain&gt;
</span></span><span class=line><span class=cl><span class=c1># 使用快照将虚拟机还原</span>
</span></span><span class=line><span class=cl>virsh snapshot-restore &lt;domain&gt; &lt;snapshotname&gt;
</span></span><span class=line><span class=cl><span class=c1># 删除快照</span>
</span></span><span class=line><span class=cl>virsh snapshot-delete &lt;domain&gt; &lt;snapshotname&gt;
</span></span></code></pre></td></tr></table></div></div><p>删除虚拟机：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virsh undefine opensuse15
</span></span></code></pre></td></tr></table></div></div><p>迁移虚拟机：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 使用默认参数进行离线迁移，将已关机的服务器迁移到另一个 qemu 实例</span>
</span></span><span class=line><span class=cl>virsh migrate <span class=m>37</span> qemu+ssh://tux@jupiter.example.com/system
</span></span><span class=line><span class=cl><span class=c1># 还支持在线实时迁移，待续</span>
</span></span></code></pre></td></tr></table></div></div><p>cpu/内存修改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 改成 4 核</span>
</span></span><span class=line><span class=cl>virsh setvcpus opensuse15 <span class=m>4</span>
</span></span><span class=line><span class=cl><span class=c1># 改成 4G</span>
</span></span><span class=line><span class=cl>virsh setmem opensuse15 <span class=m>4096</span>
</span></span></code></pre></td></tr></table></div></div><p>虚拟机监控：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 待续</span>
</span></span></code></pre></td></tr></table></div></div><p>修改磁盘、网络及其他设备：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 添加新设备</span>
</span></span><span class=line><span class=cl>virsh attach-device
</span></span><span class=line><span class=cl>virsh attach-disk
</span></span><span class=line><span class=cl>virsh attach-interface
</span></span><span class=line><span class=cl><span class=c1># 删除设备</span>
</span></span><span class=line><span class=cl>virsh detach-disk
</span></span><span class=line><span class=cl>virsh detach-device
</span></span><span class=line><span class=cl>virsh detach-interface
</span></span></code></pre></td></tr></table></div></div><h2 id=四使用-cloudinit-自动配置虚拟机 class=headerLink><a href=#%e5%9b%9b%e4%bd%bf%e7%94%a8-cloudinit-%e8%87%aa%e5%8a%a8%e9%85%8d%e7%bd%ae%e8%99%9a%e6%8b%9f%e6%9c%ba class=header-mark></a>四、使用 cloudinit 自动配置虚拟机</h2><p>在本机的 KVM 环境中，也可以使用 cloud-init 来初始化虚拟机。
好处是创建虚拟机的时候，就能设置好虚拟机的 hostname/network/user-pass/disk-size 等一系列参数，不需要每次启动后再手动登录到机器中配置。</p><h3 id=下载-cloud-image class=headerLink><a href=#%e4%b8%8b%e8%bd%bd-cloud-image class=header-mark></a>下载 cloud image</h3><blockquote><p>注意：下面的几种镜像都分别有自己的坑点，仅 Ubuntu/OpenSUSE 测试通过，其他发行版的 Cloud 镜像都有各种毛病&mldr;</p></blockquote><p>首先下载 Cloud 版本的系统镜像：</p><ol><li><a href=https://cloud-images.ubuntu.com/releases/ target=_blank rel="noopener noreferrer">Ubuntu Cloud Images (RELEASED)</a>: 提供 img 格式的裸镜像（PVE 也支持此格式）<ul><li>请下载带有 .img 结尾的镜像，其中 <code>kvm.img</code> 结尾的镜像会更精简一点。</li></ul></li><li><a href=https://download.opensuse.org/repositories/Cloud:/Images:/ target=_blank rel="noopener noreferrer">OpenSUSE Cloud Images</a><ul><li>请下载带有 NoCloud 或者 OpenStack 字样的镜像。</li></ul></li><li>对于其他镜像，可以考虑手动通过 iso 来制作一个 cloudinit 镜像，参考 <a href=https://docs.openstack.org/image-guide/ubuntu-image.html target=_blank rel="noopener noreferrer">openstack - create ubuntu cloud images from iso</a></li></ol><p>上述镜像和我们普通虚拟机使用的 ISO 镜像的区别，一是镜像格式不同，二是都自带了 <code>cloud-init</code>/<code>qemu-guest-agent</code>/<code>cloud-utils-growpart</code> 等 cloud 相关软件。</p><p>其中 NoCloud 表示支持 cloudinit NoCloud 数据源——即使用 <code>seed.iso</code> 提供 user-data/meta-data/network-config 配置，PVE 就是使用的这种模式。
而 Openstack 镜像通常也都支持 NoCloud 模式，所以一般也是可以使用的。</p><blockquote><p>cloud image 基本都没有默认密码，并且禁用了 SSH 密码登录，必须通过 cloud-init 设置私钥方式进行 ssh 登录。</p></blockquote><h3 id=配置-cloudinit-并创建虚拟机 class=headerLink><a href=#%e9%85%8d%e7%bd%ae-cloudinit-%e5%b9%b6%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e6%9c%ba class=header-mark></a>配置 cloudinit 并创建虚拟机</h3><p>这需要用到一个工具：<a href=https://github.com/canonical/cloud-utils target=_blank rel="noopener noreferrer">cloud-utils</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># manjaro</span>
</span></span><span class=line><span class=cl>sudo pacman -S cloud-utils
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ubuntu</span>
</span></span><span class=line><span class=cl>sudo apt install cloud-utils
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># opensuse，包仓库里找不到 cloud-utils，只能源码安装</span>
</span></span><span class=line><span class=cl>git clone https://github.com/canonical/cloud-utils
</span></span><span class=line><span class=cl>git checkout 0.32
</span></span><span class=line><span class=cl><span class=nb>cd</span> cloud-utils <span class=o>&amp;&amp;</span> sudo make install
</span></span><span class=line><span class=cl><span class=c1># 生成 iso 文件还需要 genisoimage，请使用一键安装：https://software.opensuse.org/package/genisoimage</span>
</span></span></code></pre></td></tr></table></div></div><p><code>cloud-utils</code> 提供 cloud-init 相关的各种实用工具，
其中有一个 <code>cloud-localds</code> 命令，可以通过 cloud 配置生成一个非 cloud 的 bootable 磁盘映像，供本地的虚拟机使用。</p><p>首先编写 <code>user-data</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c>#cloud-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>opensuse15-2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>fqdn</span><span class=p>:</span><span class=w> </span><span class=l>opensuse15-2.local  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 让 cloud-init 自动更新 /etc/hosts 中 localhost 相关的内容</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>manage_etc_hosts</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>package_upgrade</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>disable_root</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置 root 的 ssh 密钥</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 设置密码，仅用于控制台登录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>xxxxx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 使用密钥登录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssh_authorized_keys</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&lt;ssh-key content&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>chpasswd</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># expire 使密码用完即失效，用户每次登录都需要设置并使用密码！</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>expire</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># ssh 允许密码登录（不建议开启）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssh_pwauth</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><blockquote><p>注意 <code>user-data</code> 的第一行的 <code>#cloud-config</code> 绝对不能省略！它标识配置格式为 <code>text/cloud-config</code>！</p></blockquote><p>再编写 <code>network-config</code>(其格式和 ubuntu 的 netplan 基本完全一致，但是我只测通了 v1 版本，v2 版没测通):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>physical</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>eth0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>subnets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>static</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>address</span><span class=p>:</span><span class=w> </span><span class=m>192.168.122.160</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>netmask</span><span class=p>:</span><span class=w> </span><span class=m>255.255.255.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>gateway</span><span class=p>:</span><span class=w> </span><span class=m>192.168.122.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>nameserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>interface</span><span class=p>:</span><span class=w> </span><span class=l>eth0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>address</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>114.114.114.114</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>8.8.8.8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># search:  # search domain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   - xxx</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cloud-localds seed.iso user-data --network-config network-config
</span></span></code></pre></td></tr></table></div></div><blockquote><p>每次都手动生成 <code>seed.iso</code> 太麻烦了，实际使用，建议用后面介绍的自动化功能 proxmox-libvirt 或者 terraform-libvirt-provider~</p></blockquote><p>这样就生成出了一个 seed.iso，创建虚拟机时同时需要载入 seed.iso 和 cloud image，cloud-image 自身为启动盘，这样就大功告成了。
示例命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>virt-install --virt-type kvm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --name k8s-master-0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --vcpus <span class=m>2</span> --memory <span class=m>3072</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --disk k8s-master-0.qcow2,device<span class=o>=</span>disk,bus<span class=o>=</span>virtio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --disk ../vm-seeds/160-seed-k8s-master-0.iso,device<span class=o>=</span>cdrom <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --os-type linux <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --os-variant opensuse15.3 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --network <span class=nv>network</span><span class=o>=</span>default,model<span class=o>=</span>virtio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --graphics vnc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --import
</span></span></code></pre></td></tr></table></div></div><p>也可以使用 virt-viewer 的 GUI 界面进行操作。</p><p>这样设置完成后，cloud 虚拟机应该就可以启动了，可以检查下 hostname、网络、root 的密码和私钥、ssh 配置是否均正常。</p><p>一切正常后，还有个问题需要解决——初始磁盘应该很小。可以直接手动扩容 img 的大小，cloud-init 在虚拟机启动时就会自动扩容分区：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>qemu-img resize ubuntu-server-cloudimg-amd64.img 30G
</span></span></code></pre></td></tr></table></div></div><h3 id=cloud-image-的坑 class=headerLink><a href=#cloud-image-%e7%9a%84%e5%9d%91 class=header-mark></a>cloud image 的坑</h3><h4 id=1-ubuntu-cloud-image-的坑 class=headerLink><a href=#1-ubuntu-cloud-image-%e7%9a%84%e5%9d%91 class=header-mark></a>1. ubuntu cloud image 的坑</h4><ul><li>ubuntu 启动时会报错 <code>no such device: root</code>，但是过一会就会正常启动。<ul><li>这是 ubuntu cloud image 的 bug: <a href=https://bugs.launchpad.net/cloud-images/+bug/1726476 target=_blank rel="noopener noreferrer">https://bugs.launchpad.net/cloud-images/+bug/1726476</a></li></ul></li><li>ubuntu 启动后很快就会进入登录界面，但是 root 密码可能还没改好，登录会报密码错误，等待一会再尝试登录就 OK 了</li><li>ubuntu 的默认网卡名称是 ens3，不是 eth0，注意修改 network_config 的网卡名称，否则网络配置不会生效</li></ul><h4 id=2-opensuse-cloud-image-的坑 class=headerLink><a href=#2-opensuse-cloud-image-%e7%9a%84%e5%9d%91 class=header-mark></a>2. opensuse cloud image 的坑</h4><ul><li>opensuse leap 15 只支持 network_config v1，对 v2 的支持有 bug，<code>gateway4</code> 不会生效</li></ul><h4 id=3-debian-cloud-image-的坑 class=headerLink><a href=#3-debian-cloud-image-%e7%9a%84%e5%9d%91 class=header-mark></a>3. debian cloud image 的坑</h4><p>debian 的 cloud 镜像根本没法用，建议避免使用它。</p><ul><li>debian 启动时会彻底卡住，或者直接报错 kernel panic<ul><li>原因是添加了 spice 图形卡，换成 vnc 就正常了</li></ul></li><li><a href=https://cdimage.debian.org/cdimage/cloud/ target=_blank rel="noopener noreferrer">Debian Cloud Images</a> 中的 nocloud 镜像不会在启动时运行 cloudinit，cloudinit 完全不生效<ul><li>不知道是啥坑，没解决</li></ul></li></ul><h3 id=画外cloudinit-主机名称 class=headerLink><a href=#%e7%94%bb%e5%a4%96cloudinit-%e4%b8%bb%e6%9c%ba%e5%90%8d%e7%a7%b0 class=header-mark></a>画外：cloudinit 主机名称</h3><p>cloudinit 有三个参数与 hostname 相关。其中有两个，就是上面提到的 <code>user-data</code> 中的：</p><ol><li>hostname: 主机名称</li><li>fqdn: 主机的完全限定域名，优先级比 <code>hostname</code> 更高</li></ol><p>这两个参数的行为均受 <code>preserve_hostname: true/false</code> 这个参数的影响。</p><p>另一个是 <code>meta-data</code> 中，可以设置一个 <code>local-hostname</code>，此参数的地位好像和 <code>user-data</code> 中的 <code>hostname</code> 相同，不过可能优先级会高一些吧。
没有找到相关文档。</p><h3 id=自动化 class=headerLink><a href=#%e8%87%aa%e5%8a%a8%e5%8c%96 class=header-mark></a>自动化</h3><p>可以使用 pulumi/terraform 自动化创建与管理 QEMU/KVM 虚拟机，相当方便：</p><ul><li><a href=https://github.com/dmacvicar/terraform-provider-libvirt target=_blank rel="noopener noreferrer">terraform-provider-libvirt</a></li><li><a href=https://github.com/ryan4yin/pulumi-libvirt#examples target=_blank rel="noopener noreferrer">pulumi-libvirt#examples</a></li></ul><h2 id=参考 class=headerLink><a href=#%e5%8f%82%e8%80%83 class=header-mark></a>参考</h2><ul><li><a href=https://doc.opensuse.org/documentation/leap/virtualization/html/book-virt/index.html target=_blank rel="noopener noreferrer">Virtualization Guide - OpenSUSE</a></li><li><a href=https://computingforgeeks.com/complete-installation-of-kvmqemu-and-virt-manager-on-arch-linux-and-manjaro/ target=_blank rel="noopener noreferrer">Complete Installation of KVM, QEMU and Virt Manager on Arch Linux and Manjaro</a></li><li><a href=https://ubuntu.com/server/docs/virtualization-libvirt target=_blank rel="noopener noreferrer">virtualization-libvirt - ubuntu docs</a></li><li><a href=https://developers.redhat.com/products/rhel/hello-world#fndtn-kvm target=_blank rel="noopener noreferrer">RedHat Docs - KVM</a></li><li><a href=https://vrabe.tw/blog/use-ubuntu-cloud-images-with-qemu/ target=_blank rel="noopener noreferrer">在 QEMU 使用 Ubuntu Cloud Images</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-01-17</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=# onclick=return!1 title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/qemu-kvm-usage/ data-title="QEMU/KVM 虚拟化环境的搭建与使用" data-via=ryan4yin data-hashtags=虚拟化,Visualization,KVM,QEMU,libvirt><i class="fab fa-twitter fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Facebook" data-sharer=facebook data-url=https://thiscute.world/posts/qemu-kvm-usage/ data-hashtag=虚拟化><i class="fab fa-facebook-square fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/qemu-kvm-usage/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/>虚拟化</a>,&nbsp;<a href=/tags/visualization/>Visualization</a>,&nbsp;<a href=/tags/kvm/>KVM</a>,&nbsp;<a href=/tags/qemu/>QEMU</a>,&nbsp;<a href=/tags/libvirt/>libvirt</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/experience-of-pulumi/ class=prev rel=prev title="Pulumi 使用体验 - 基础设施代码化"><i class="fas fa-angle-left fa-fw"></i>Pulumi 使用体验 - 基础设施代码化</a>
<a href=/posts/experience-of-vault/ class=next rel=next title="secrets 管理工具 Vault 的介绍、安装及使用">secrets 管理工具 Vault 的介绍、安装及使用<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=width:auto;height:15px;margin-bottom:5px></a> <a href=https://www.foreverblog.cn/go.html target=_blank><img src=https://img.foreverblog.cn/wormhole_3.gif alt style=width:auto;height:24px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://thiscute.world/ target=_blank rel="noopener noreferrer">ryan4yin</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script></div><div class=pjax-assets><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript></div></body></html>