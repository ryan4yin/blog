<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title class=pjax-title>Proxmox Virtual Environment 使用指南 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:title" content="Proxmox Virtual Environment 使用指南"><meta property="og:description" content="本文介绍我使用 PVE 的一些心得（不保证正确 emmmm），可能需要一定使用经验才能顺畅阅读。 前言我在去年的文章 「QEMU/KVM 虚拟化环境的搭建与"><meta property="og:type" content="article"><meta property="og:url" content="https://thiscute.world/posts/proxmox-virtual-environment-instruction/"><meta property="og:image" content="https://thiscute.world/posts/proxmox-virtual-environment-instruction/proxmox-logo.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-27T22:38:03+08:00"><meta property="article:modified_time" content="2022-11-27T22:38:03+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/proxmox-virtual-environment-instruction/proxmox-logo.webp"><meta name=twitter:title content="Proxmox Virtual Environment 使用指南"><meta name=twitter:description content="本文介绍我使用 PVE 的一些心得（不保证正确 emmmm），可能需要一定使用经验才能顺畅阅读。 前言我在去年的文章 「QEMU/KVM 虚拟化环境的搭建与"><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/proxmox-virtual-environment-instruction/><link rel=prev href=https://thiscute.world/posts/deliberate-practice/><link rel=next href=https://thiscute.world/posts/2022-summary/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Proxmox Virtual Environment 使用指南","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/thiscute.world\/posts\/proxmox-virtual-environment-instruction\/"},"image":[{"@type":"ImageObject","url":"https:\/\/thiscute.world\/posts\/proxmox-virtual-environment-instruction\/proxmox-logo.webp","width":2019,"height":854}],"genre":"posts","keywords":"虚拟化, Visualization, KVM, QEMU, libvirt, Proxmox","wordcount":10104,"url":"https:\/\/thiscute.world\/posts\/proxmox-virtual-environment-instruction\/","datePublished":"2022-11-27T22:38:03+08:00","dateModified":"2022-11-27T22:38:03+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https:\/\/thiscute.world\/avatar\/myself.png"},"author":{"@type":"Person","name":"ryan4yin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark")}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行 </a><a class=menu-item href=/categories/tech/>技术 </a><a class=menu-item href=/categories/life/>生活 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/friends/>朋友们 </a><a class=menu-item href=/now/>此刻 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=# onclick=return!1 class="menu-item language" title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" id=language-select-desktop onchange="location=this.value"><option value=/posts/proxmox-virtual-environment-instruction/ selected>Simplified Chinese</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=# onclick=return!1 class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a><a href=# onclick=return!1 class=menu-item title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" onchange="location=this.value"><option value=/posts/proxmox-virtual-environment-instruction/ selected>Simplified Chinese</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#一安装-pve-系统>一、安装 PVE 系统</a><ul><li><a href=#组建-pve-集群>组建 PVE 集群</a></li></ul></li><li><a href=#二pve-控制台的使用>二、PVE 控制台的使用</a><ul><li><a href=#1-使用-cloudinit-自动配置网卡ssh密钥存储空间>1. 使用 cloudinit 自动配置网卡、SSH密钥、存储空间</a></li><li><a href=#2-虚拟机硬盘扩容>2. 虚拟机硬盘扩容</a></li></ul></li><li><a href=#三常见问题>三、常见问题</a><ul><li><a href=#1-导入已有的-qcow2-镜像>1. 导入已有的 qcow2 镜像</a></li><li><a href=#2-点击-shutdown-后-pve-系统卡住>2. 点击 shutdown 后 PVE 系统卡住</a></li><li><a href=#3-cant-lock-file-varlockqemu-serverlock-xxxconf--got-timeout>3. can’t lock file ‘/var/lock/qemu-server/lock-xxx.conf’ – got timeout</a></li><li><a href=#4-pve-集群有一个节点宕机如何解除关联>4. PVE 集群有一个节点宕机，如何解除关联？</a></li><li><a href=#5-cloud-image-的坑>5. cloud image 的坑</a><ul><li><a href=#ubuntu-cloud-image-的坑>ubuntu cloud image 的坑</a><ul><li><a href=#ubuntu-cloud-image-无法识别到-usb-设备的排查记录>「Ubuntu Cloud Image 无法识别到 USB 设备」的排查记录</a></li></ul></li><li><a href=#opensuse-cloud-image-的坑>opensuse cloud image 的坑</a></li><li><a href=#debian-cloud-image-的坑>debian cloud image 的坑</a></li></ul></li><li><a href=#6-克隆创建的虚拟机卡在-booting-from-hard-disk-状态>6. 克隆创建的虚拟机，卡在 <code>Booting from Hard Disk...</code> 状态</a></li><li><a href=#7-虚拟机启动时-cloudinit-报错-faild-to-start-openbsd-secure-shell-server>7. 虚拟机启动时 cloudinit 报错 faild to start OpenBSD Secure Shell server</a></li><li><a href=#8-修改-linux-虚拟机的-hostname>8. 修改 Linux 虚拟机的 Hostname</a></li><li><a href=#9-虚拟机迁移时报错-host-key-verification-failed>9. 虚拟机迁移时报错 <code>Host key verification failed</code></a></li><li><a href=#10-pve-的-vm-不支持-vmxsvm-虚拟化指令集>10. PVE 的 vm 不支持 vmx/svm 虚拟化指令集</a></li><li><a href=#11-如何在多台主机间同步-iso-镜像backup-文件>11. 如何在多台主机间同步 iso 镜像、backup 文件</a></li></ul></li><li><a href=#四pve-网络配置>四、PVE 网络配置</a><ul><li><a href=#1-桥接多张物理网卡>1. 桥接多张物理网卡</a></li><li><a href=#2-手动添加-usb-物理网卡>2. 手动添加 USB 物理网卡</a></li><li><a href=#3-配置-wifi-网卡>3. 配置 WiFi 网卡</a></li></ul></li><li><a href=#五提升-pve-的安全性>五、提升 PVE 的安全性</a><ul><li><a href=#1-配置-acme-证书并使其自动更新>1. 配置 ACME 证书并使其自动更新</a></li><li><a href=#2-ssh-禁用密码登录>2. SSH 禁用密码登录</a></li><li><a href=#3-用户管理>3. 用户管理</a></li></ul></li><li><a href=#六pcie-直通显卡硬盘usb-设备等>六、PCI(e) 直通（显卡、硬盘、USB 设备等）</a></li><li><a href=#拓展---cloudinit-高级配置>拓展 - cloudinit 高级配置</a></li><li><a href=#拓展---自动化配置与监控告警>拓展 - 自动化配置与监控告警</a></li><li><a href=#拓展---pve-运行在-arm-开发版上>拓展 - PVE 运行在 ARM 开发版上</a></li><li><a href=#拓展---其他-qemukvm-相关的虚拟化平台>拓展 - 其他 QEMU/KVM 相关的虚拟化平台</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Proxmox Virtual Environment 使用指南</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=https://thiscute.world/ title=Author target=_blank rel="noopener noreferrer author" class=author>ryan4yin</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-11-27>2022-11-27</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2022-11-27>2022-11-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 10104 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 21 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload data-src=/posts/proxmox-virtual-environment-instruction/proxmox-logo.webp data-srcset="/posts/proxmox-virtual-environment-instruction/proxmox-logo.webp, /posts/proxmox-virtual-environment-instruction/proxmox-logo.webp 1.5x, /posts/proxmox-virtual-environment-instruction/proxmox-logo.webp 2x" data-sizes=auto alt=/posts/proxmox-virtual-environment-instruction/proxmox-logo.webp title=/posts/proxmox-virtual-environment-instruction/proxmox-logo.webp height=854 width=2019></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#一安装-pve-系统>一、安装 PVE 系统</a><ul><li><a href=#组建-pve-集群>组建 PVE 集群</a></li></ul></li><li><a href=#二pve-控制台的使用>二、PVE 控制台的使用</a><ul><li><a href=#1-使用-cloudinit-自动配置网卡ssh密钥存储空间>1. 使用 cloudinit 自动配置网卡、SSH密钥、存储空间</a></li><li><a href=#2-虚拟机硬盘扩容>2. 虚拟机硬盘扩容</a></li></ul></li><li><a href=#三常见问题>三、常见问题</a><ul><li><a href=#1-导入已有的-qcow2-镜像>1. 导入已有的 qcow2 镜像</a></li><li><a href=#2-点击-shutdown-后-pve-系统卡住>2. 点击 shutdown 后 PVE 系统卡住</a></li><li><a href=#3-cant-lock-file-varlockqemu-serverlock-xxxconf--got-timeout>3. can’t lock file ‘/var/lock/qemu-server/lock-xxx.conf’ – got timeout</a></li><li><a href=#4-pve-集群有一个节点宕机如何解除关联>4. PVE 集群有一个节点宕机，如何解除关联？</a></li><li><a href=#5-cloud-image-的坑>5. cloud image 的坑</a><ul><li><a href=#ubuntu-cloud-image-的坑>ubuntu cloud image 的坑</a><ul><li><a href=#ubuntu-cloud-image-无法识别到-usb-设备的排查记录>「Ubuntu Cloud Image 无法识别到 USB 设备」的排查记录</a></li></ul></li><li><a href=#opensuse-cloud-image-的坑>opensuse cloud image 的坑</a></li><li><a href=#debian-cloud-image-的坑>debian cloud image 的坑</a></li></ul></li><li><a href=#6-克隆创建的虚拟机卡在-booting-from-hard-disk-状态>6. 克隆创建的虚拟机，卡在 <code>Booting from Hard Disk...</code> 状态</a></li><li><a href=#7-虚拟机启动时-cloudinit-报错-faild-to-start-openbsd-secure-shell-server>7. 虚拟机启动时 cloudinit 报错 faild to start OpenBSD Secure Shell server</a></li><li><a href=#8-修改-linux-虚拟机的-hostname>8. 修改 Linux 虚拟机的 Hostname</a></li><li><a href=#9-虚拟机迁移时报错-host-key-verification-failed>9. 虚拟机迁移时报错 <code>Host key verification failed</code></a></li><li><a href=#10-pve-的-vm-不支持-vmxsvm-虚拟化指令集>10. PVE 的 vm 不支持 vmx/svm 虚拟化指令集</a></li><li><a href=#11-如何在多台主机间同步-iso-镜像backup-文件>11. 如何在多台主机间同步 iso 镜像、backup 文件</a></li></ul></li><li><a href=#四pve-网络配置>四、PVE 网络配置</a><ul><li><a href=#1-桥接多张物理网卡>1. 桥接多张物理网卡</a></li><li><a href=#2-手动添加-usb-物理网卡>2. 手动添加 USB 物理网卡</a></li><li><a href=#3-配置-wifi-网卡>3. 配置 WiFi 网卡</a></li></ul></li><li><a href=#五提升-pve-的安全性>五、提升 PVE 的安全性</a><ul><li><a href=#1-配置-acme-证书并使其自动更新>1. 配置 ACME 证书并使其自动更新</a></li><li><a href=#2-ssh-禁用密码登录>2. SSH 禁用密码登录</a></li><li><a href=#3-用户管理>3. 用户管理</a></li></ul></li><li><a href=#六pcie-直通显卡硬盘usb-设备等>六、PCI(e) 直通（显卡、硬盘、USB 设备等）</a></li><li><a href=#拓展---cloudinit-高级配置>拓展 - cloudinit 高级配置</a></li><li><a href=#拓展---自动化配置与监控告警>拓展 - 自动化配置与监控告警</a></li><li><a href=#拓展---pve-运行在-arm-开发版上>拓展 - PVE 运行在 ARM 开发版上</a></li><li><a href=#拓展---其他-qemukvm-相关的虚拟化平台>拓展 - 其他 QEMU/KVM 相关的虚拟化平台</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>本文介绍我使用 PVE 的一些心得（不保证正确 emmmm），可能需要一定使用经验才能顺畅阅读。</p></blockquote><h2 id=前言 class=headerLink><a href=#%e5%89%8d%e8%a8%80 class=header-mark></a>前言</h2><p>我在去年的文章 <a href=https://thiscute.world/posts/QEMU/KVM-usage/ target=_blank rel="noopener noreferrer">「QEMU/KVM 虚拟化环境的搭建与使用」</a> 中介绍了如何使用 QEMU/KVM 作为桌面虚拟化软件，其功能对标开源免费的 <a href=https://www.virtualbox.org/ target=_blank rel="noopener noreferrer">Oracle VM VirtualBox</a> 以及收费但是用户众多的 <a href=https://www.vmware.com/products/workstation-pro.html target=_blank rel="noopener noreferrer">VMware Workstation Pro</a>.</p><p>虽然我们也可以远程使用 QEMU/KVM，但是使用门槛比较高。而且如果要管理多台服务器，各种命令也比较繁琐。
我们显然需要更易用的软件来管理服务器场景下的虚拟化。</p><p>而这篇文章介绍的 <a href=https://pve.proxmox.com/wiki/Main_Page target=_blank rel="noopener noreferrer">Proxmox Virtual Environment</a>（后续简称 PVE），就是一个基于 QEMU/KVM 的虚拟机集群管理平台。</p><p>PVE 以 Debian + QEMU/KVM + LXC 为基础进行了深度定制，提供了一套比较完善的 Web UI，基本上 95% 的操作都可以直接通过它的 Web UI 完成，但是仍然有些功能只需要使用它的 CLI 完成，或者说需要手动修改一些配置文件。</p><p>PVE 完全基于 Linux 世界的各种开源技术，存储技术使用了 LVM（也支持 Ceph/iSCSI/NFS），也支持通过 cloudinit 预配置网络、磁盘扩容、设置 hostname（这其实是 libvirtd 的功能）。
它的文档也比较齐全，而且写得清晰易懂，还包含许多它底层的 QEMU/KVM/CEPH/Cloudinit 等开源技术的内容，对学习 Linux 虚拟化技术也有些帮助。（这里必须喷下 VMware 的文档，真的是写得烂得一批，不知所云）</p><p>总的来说，PVE 没有 <a href=https://www.vmware.com/cn/products/vsphere-hypervisor.html target=_blank rel="noopener noreferrer">vShpere Hypervisor</a> 跟 <a href=https://learn.microsoft.com/en-us/windows-server/virtualization/hyper-v/hyper-v-technology-overview target=_blank rel="noopener noreferrer">Windows Hyper-V</a> 那么成熟、完善、稳定，但是基于 QEMU/KVM 且能够免费使用，很适合 Linux/开源/虚拟化 爱好者折腾。</p><blockquote><p>你可能还听说过 OpenStack，不过这个玩意儿我没接触过，所以这里略过了它。</p></blockquote><p>因为这些原因，我选择了 PVE 作为我的 Homelab 系统。</p><p>先贴一张我当前 Homelab 的 PVE 控制台截图，然后就进入正文。</p><p><figure><a class=lightgallery href=/images/proxmox-ve-instruction/ryan-pve-console.webp title=/images/proxmox-ve-instruction/ryan-pve-console.webp data-thumbnail=/images/proxmox-ve-instruction/ryan-pve-console.webp data-sub-html="<h2>我的 PVE 集群</h2>"><img class=lazyload data-src=/images/proxmox-ve-instruction/ryan-pve-console.webp data-srcset="/images/proxmox-ve-instruction/ryan-pve-console.webp, /images/proxmox-ve-instruction/ryan-pve-console.webp 1.5x, /images/proxmox-ve-instruction/ryan-pve-console.webp 2x" data-sizes=auto alt=/images/proxmox-ve-instruction/ryan-pve-console.webp></a><figcaption class=image-caption>我的 PVE 集群</figcaption></figure></p><blockquote><p>如果你想了解我的 PVE 集群都跑了些啥，可以瞅一瞅 <a href=https://github.com/ryan4yin/knowledge/tree/master/homelab target=_blank rel="noopener noreferrer">homelab - ryan4yin/knowledge</a>.</p></blockquote><h2 id=一安装-pve-系统 class=headerLink><a href=#%e4%b8%80%e5%ae%89%e8%a3%85-pve-%e7%b3%bb%e7%bb%9f class=header-mark></a>一、安装 PVE 系统</h2><p>建议直接使用 <a href=https://github.com/ventoy/Ventoy target=_blank rel="noopener noreferrer">ventoy</a> 制作一个 U 盘启动盘，把官网下载的 PVE ISO 镜像拷贝进去，即可使用它进行系统安装。
安装过程中需要注意的点有：</p><ul><li>如果你有多台机器，每台机器需要使用不同的主机名称（hostname），否则后面组建 PVE 集群时会有麻烦。<ul><li>建议使用机器型号 + 数字编号作为机器的 hostname</li></ul></li><li>为每台 PVE 节点配置静态 IP，避免 IP 变更。</li></ul><p>系统安装好后即可按照提示直接访问其 Web UI，会提示 HTTPS 证书无效，忽略即可。另外还会有一个烦人的 PVE 订阅提示，也可直接忽略（7.2 及以上版本，暂时没找到怎么禁用掉这个提示）。</p><p>此外对于国内环境，建议按下面这篇文章配置国内镜像源（提升软件安装速度）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 设置 debian 的阿里镜像源</span>
</span></span><span class=line><span class=cl>cp /etc/apt/sources.list /etc/apt/sources.list.bak
</span></span><span class=line><span class=cl>sed -i <span class=s2>&#34;s@\(deb\|security\).debian.org@mirrors.aliyun.com@g&#34;</span> /etc/apt/sources.list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置 pve 国内镜像源</span>
</span></span><span class=line><span class=cl><span class=c1># https://mirrors.bfsu.edu.cn/help/proxmox/</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;deb https://mirrors.bfsu.edu.cn/proxmox/debian buster pve-no-subscription&#39;</span> &gt; /etc/apt/sources.list.d/pve-no-subscription.list
</span></span></code></pre></td></tr></table></div></div><h3 id=组建-pve-集群 class=headerLink><a href=#%e7%bb%84%e5%bb%ba-pve-%e9%9b%86%e7%be%a4 class=header-mark></a>组建 PVE 集群</h3><blockquote><p>如果你仅使用单机 PVE，可忽略这一节内容。</p></blockquote><p>将多台 PVE 节点组成一个集群，可以获得很多新玩法，比如虚拟机在多节点间的热迁移。</p><p>这个也还挺简单的，首先随便登入一台机器的 Web Console，点击「Datacenter」=>「Cluster」=>「Create Cluster」即可创建一个 PVE 集群。</p><p>接着复制「Join Information」中的内容，在其他每台 PVE 节点的 Web Console 页面中，点击「Datacenter」=>「Cluster」=>「Join Cluster」，然后粘贴前面复制的「Join Information」，再输入前面节点的密码，等待大约一分钟，然后刷新页面，PVE 集群即组建完成。</p><p><figure><a class=lightgallery href=/images/proxmox-ve-instruction/pve-cluster-configuration.webp title=/images/proxmox-ve-instruction/pve-cluster-configuration.webp data-thumbnail=/images/proxmox-ve-instruction/pve-cluster-configuration.webp data-sub-html="<h2>PVE 集群配置</h2>"><img class=lazyload data-src=/images/proxmox-ve-instruction/pve-cluster-configuration.webp data-srcset="/images/proxmox-ve-instruction/pve-cluster-configuration.webp, /images/proxmox-ve-instruction/pve-cluster-configuration.webp 1.5x, /images/proxmox-ve-instruction/pve-cluster-configuration.webp 2x" data-sizes=auto alt=/images/proxmox-ve-instruction/pve-cluster-configuration.webp></a><figcaption class=image-caption>PVE 集群配置</figcaption></figure></p><p>PVE 集群的所有节点是完全平等的，集群组建完成后，登录其中任意一个节点的 Web Console 都可以管理集群中所有节点的资源。</p><h2 id=二pve-控制台的使用 class=headerLink><a href=#%e4%ba%8cpve-%e6%8e%a7%e5%88%b6%e5%8f%b0%e7%9a%84%e4%bd%bf%e7%94%a8 class=header-mark></a>二、PVE 控制台的使用</h2><p>PVE 控制台的使用还挺简单的，多试试基本就会用了。这里不做详细介绍，主要说明下创建虚拟机时一些重要的参数：</p><ul><li>CPU<ul><li>将 CPU 类型设置为 <code>host</code> 可以提高性能，适合比较吃性能或者对实时性要求高的虚拟机如 windows/openwrt</li><li>对于虚拟机核数，建议将 <code>sockets</code> 设为 1（即 CPU 插槽数，一般物理服务器才会有 2 及以上的 CPU 插槽），cores 设为你想分配给该虚拟机的 CPU 核数</li><li>仅针对多物理 CPU 场景（多 <code>sockets</code>）才需要启用 NUMA（个人猜测，可能有错）</li></ul></li><li>磁盘、网卡<ul><li>磁盘驱动建议用 <code>virtio SCSI</code>、网卡驱动建议用 <code>VirtIO(paravirtualized)</code>，它的性能更高。<ul><li>Linux 虚拟机原生支持 virtio 半虚拟化，而 windows 想要完全开启半虚拟化，需要手动安装驱动，详见 <a href=https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers target=_blank rel="noopener noreferrer">Windows_VirtIO_Drivers - Proxmox WIKI</a>，简单的说就是要下个 iso 挂载到 windows 主机中，并安装其中的驱动。</li></ul></li><li>如果硬盘是 SSD，虚拟机磁盘可以启用 <code>SSD Emulation</code>，对于 IO 性能要求高的场景还可以为磁盘勾选 <code>IO Thread</code> 功能</li></ul></li><li>显示器<ul><li>默认使用 std 类型，兼容性最好，但是是纯 CPU 模拟的，比较耗 CPU。</li><li>如果你有 windows 等需要显卡加速的桌面虚拟机，但是又不想搞复杂的显卡直通，可以选择 <code>VirGL GPU(virtio-gl)</code> 类型，这是一项正在进行中的工作：以较小的性能损耗将虚拟机中的 3D/2D 运算 offload 到 host GPU，而且避免复杂的驱动配置。仅需要提前手动在 PVE 中先装下这几个包 <code>apt install libgl1 libegl1</code>，并且在主机内安装好 virtio 驱动（前面提过了，Linux 自带，Windows 需要手动安装 virtio drivers）</li><li>详见 <a href=https://wiki.archlinux.org/title/QEMU#Graphic_card target=_blank rel="noopener noreferrer">QEMU Graphic card - Arch WIKI</a></li></ul></li><li>其他选项<ul><li>调整启动项顺序，对于 cloud image 建议只启用 scsi0 这个选项</li></ul></li><li>虚拟机模板（Template）与克隆（Clone）<ul><li>建议首先使用 ubuntu/opensuse cloud image 配置好基础环境（比如安装好 vim/curl/qemu-guest-agent），然后转换为 template，其他所有 Linux 虚拟机都可以直接 clone 一个，改个新名字，再改改 cloudinit 配置跟磁盘大小，就能直接启动使用了。相当方便。</li><li>仅 Full Clone 的虚拟机才可以在 PVE 集群节点间随意迁移，因此如果你需要虚拟机迁移功能，请不要使用 Link Clone.</li></ul></li><li>BIOS 通常都建议使用默认的 SeaBIOS，仅 Windows 等场景才建议换成 OMVF(UEFI)<ul><li>OMVF 的分辨率、Secure Boot 等参数，都可以在启动时按 ESC 进入 UEFI 配置界面来调整。</li></ul></li></ul><p>上面这些内容，官方有详细文档，能读英文的话可以直接看 <a href=https://pve.proxmox.com/wiki/Qemu/KVM_Virtual_Machines target=_blank rel="noopener noreferrer">Qemu/KVM Virtual Machines - Proxmox WIKI</a>.</p><h3 id=1-使用-cloudinit-自动配置网卡ssh密钥存储空间 class=headerLink><a href=#1-%e4%bd%bf%e7%94%a8-cloudinit-%e8%87%aa%e5%8a%a8%e9%85%8d%e7%bd%ae%e7%bd%91%e5%8d%a1ssh%e5%af%86%e9%92%a5%e5%ad%98%e5%82%a8%e7%a9%ba%e9%97%b4 class=header-mark></a>1. 使用 cloudinit 自动配置网卡、SSH密钥、存储空间</h3><blockquote><p>完全参照官方文档 <a href=https://pve.proxmox.com/wiki/Cloud-Init_Support target=_blank rel="noopener noreferrer">Cloud-Init_Support - PVE Docs</a></p></blockquote><blockquote><p>注意：下面的几种镜像都分别有自己的坑点，仅 Ubuntu/OpenSUSE 测试通过，其他发行版的 Cloud 镜像都有各种毛病&mldr;</p></blockquote><p>一般配 Linux 虚拟机，我们当然希望能在虚拟机启动时，就自动配置好 IP 地址、SSH 密钥、文件系统自动扩容，这样能免去很多手工操作。cloudinit 就是一个能帮你自动完成这些功能的工具，AWS、阿里云等各大云服务厂商都支持这种配置方式，好消息是 PVE 也支持。</p><p>下面简单介绍下如何使用 cloudinit 来自动化配置 Linux 虚拟机。</p><p>首先 cloudinit 必须使用特殊的系统镜像，下面是几个知名发行版的 Cloud 系统镜像：</p><ol><li><a href=https://cloud-images.ubuntu.com/releases/ target=_blank rel="noopener noreferrer">Ubuntu Cloud Images (RELEASED)</a>: 提供 img 格式的裸镜像（PVE 也支持此格式）<ul><li>请下载带有 .img 结尾的镜像，其中 <code>kvm.img</code> 结尾的镜像会更精简一点，而不带 kvm 的会稍微大一点，但是带了所有常用的内核模块。</li></ul></li><li><a href=https://download.opensuse.org/repositories/Cloud:/Images:/ target=_blank rel="noopener noreferrer">OpenSUSE Cloud Images</a><ul><li>请下载带有 NoCloud 或者 OpenStack 字样的镜像。</li></ul></li><li>对于其他镜像，可以考虑手动通过 iso 来制作一个 cloudinit 镜像，参考 <a href=https://docs.openstack.org/image-guide/ubuntu-image.html target=_blank rel="noopener noreferrer">openstack - create ubuntu cloud images from iso</a></li></ol><blockquote><p>注：<a href=https://cdimage.debian.org/cdimage/cloud/ target=_blank rel="noopener noreferrer">Debian Cloud Images</a> 的镜像无法使用，其他 ubuntu/opensuse 的 cloud 镜像也各有问题&mldr;在后面的常见问题中有简单描述这些问题。</p></blockquote><blockquote><p>这里评论区有些新内容，指出 cloud image 的各种毛病可能的解决方案，想深入了解请移步评论区。</p></blockquote><p>上述镜像和我们普通虚拟机使用的 ISO 镜像的区别，一是镜像格式不同，二是都自带了 <code>cloud-init</code>/<code>cloud-utils-growpart</code> 等用于自动化配置虚拟机的相关工具。</p><p>其名字中的 NoCloud 表示支持 cloudinit NoCloud 数据源——即使用 <code>seed.iso</code> 提供 user-data/meta-data/network-config 配置，PVE 就是使用的这种模式。
而 Openstack 镜像通常也都支持 NoCloud 模式，所以一般也是可以使用的。</p><p>以 ubuntu 的 cloudimg 镜像为例，下载好镜像后，首先创建虚拟机，并以导入的磁盘为该虚拟机的硬盘，命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建新虚拟机</span>
</span></span><span class=line><span class=cl>qm create <span class=m>9000</span> --name ubuntu-bionic-template --memory <span class=m>2048</span> --net0 virtio,bridge<span class=o>=</span>vmbr0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将下载好的 img/qcow2 镜像导入为新虚拟机的硬盘</span>
</span></span><span class=line><span class=cl>qm importdisk <span class=m>9000</span> ubuntu-20.10-server-cloudimg-amd64.img local-lvm
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过 scsi 方式，将导入的硬盘挂载到虚拟机上</span>
</span></span><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>9000</span> --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-9000-disk-0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># qcow2 镜像默认仅 2G 大小，需要手动扩容到 32G，否则虚拟机启动会报错</span>
</span></span><span class=line><span class=cl>qm resize <span class=m>9000</span> scsi0 32G
</span></span></code></pre></td></tr></table></div></div><p>然后创建挂载 cloud-init 的 seed.iso，修改启动项以及其他：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 创建一个 cloud-init 需要使用的 CDROM 盘(sr0)</span>
</span></span><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>9000</span> --ide2 local-lvm:cloudinit
</span></span><span class=line><span class=cl><span class=c1># 设置系统引导盘</span>
</span></span><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>9000</span> --boot c --bootdisk scsi0
</span></span><span class=line><span class=cl><span class=c1># 设置 serial0 为显示终端，很多云镜像都需要这个。</span>
</span></span><span class=line><span class=cl>qm <span class=nb>set</span> <span class=m>9000</span> --serial0 socket --vga serial0
</span></span></code></pre></td></tr></table></div></div><p>上面的工作都完成后，还需要做一些后续配置</p><ol><li>手动设置 cloud-init 参数，<strong>重新生成 cloudinit image</strong>，启动虚拟机，并通过 ssh 登入远程终端<ol><li>cloud image 基本都没有默认密码，并且禁用了 SSH 密码登录。必须通过 cloud-init 参数添加私钥、设置账号、密码、私钥。</li></ol></li><li>检查 qemu-guest-agent，如果未自带，一定要手动安装它！<ol><li>ubuntu 需要通过 <code>sudo apt install qemu-guest-agent</code> 手动安装它</li></ol></li><li>安装所需的基础环境，如 docker/docker-compose/vim/git/python3</li><li>关闭虚拟机，然后将虚拟机设为模板</li></ol><p>接下来就可以从这个模板虚拟机，克隆各类新虚拟机了~</p><p><figure><a class=lightgallery href=/images/proxmox-ve-instruction/pve-cloudinit-configuration.webp title=/images/proxmox-ve-instruction/pve-cloudinit-configuration.webp data-thumbnail=/images/proxmox-ve-instruction/pve-cloudinit-configuration.webp data-sub-html="<h2>保险起见，改完配置后记得点下 Regenerate Image</h2>"><img class=lazyload data-src=/images/proxmox-ve-instruction/pve-cloudinit-configuration.webp data-srcset="/images/proxmox-ve-instruction/pve-cloudinit-configuration.webp, /images/proxmox-ve-instruction/pve-cloudinit-configuration.webp 1.5x, /images/proxmox-ve-instruction/pve-cloudinit-configuration.webp 2x" data-sizes=auto alt=/images/proxmox-ve-instruction/pve-cloudinit-configuration.webp></a><figcaption class=image-caption>保险起见，改完配置后记得点下 Regenerate Image</figcaption></figure></p><p>其他 cloudinit 相关文档：</p><ul><li><a href=https://support.huaweicloud.com/usermanual-ims/ims_01_0407.html target=_blank rel="noopener noreferrer">配置 Cloud-Init 工具 - 华为云</a></li><li><a href=https://github.com/canonical/cloud-init target=_blank rel="noopener noreferrer">canonical/cloud-init - github</a></li><li><a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/amazon-linux-2-virtual-machine.html target=_blank rel="noopener noreferrer">Run Amazon Linux 2 as a virtual machine on premises</a></li></ul><h3 id=2-虚拟机硬盘扩容 class=headerLink><a href=#2-%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%a1%ac%e7%9b%98%e6%89%a9%e5%ae%b9 class=header-mark></a>2. 虚拟机硬盘扩容</h3><p>CentOS/Ubuntu/Debian 提供的 Cloud 镜像，都自带了 <code>cloud-utils-growpart</code> 这个组件，可以实现在扩容物理硬盘时，自动调整 Linux 的分区大小。</p><p>因此需要扩容虚拟机时，直接通过 UI 面板/命令行扩容虚拟机的硬盘即可， Linux 的分区会被 <code>cloud-utils-growpart</code> 自动扩容。</p><p>PVE 可通过如下命令进行磁盘扩容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 将 id 为 9000 的虚拟机的 scsi0 磁盘，扩容到 32G</span>
</span></span><span class=line><span class=cl><span class=c1># 请自行修改虚拟机 ID 与磁盘大小，注意仅支持扩容！不能缩容。</span>
</span></span><span class=line><span class=cl>qm resize <span class=m>9000</span> scsi0 32G
</span></span></code></pre></td></tr></table></div></div><p>而其他非 Cloud 镜像，则需要在扩容磁盘后再进入虚拟机手动扩容分区跟磁盘，具体命令就不介绍了，请自行查阅相关文档吧。</p><blockquote><p>因为这个方便的特性，也为了减少虚拟化的开销，Cloud 镜像默认是不使用 LVM 逻辑分区的。
LVM 逻辑分区虽然方便，但是它对物理机的作用更大些。虚拟机因为本身就能动态扩容“物理硬盘”的大小，基本不用不到 LVM。</p></blockquote><blockquote><p>还有一点，就是虚拟机通常只需要一个根分区就行，尤其是归 openstack/kubernetes 管的虚拟机。
只有在使用分布式存储之类的场景下，数据需要独立存储，才需要用到额外的分区(<code>/data</code> 之类的)。
一般只有物理机，才需要像网上很多文章提的那样，为 <code>/boot</code> <code>/</code> <code>/home</code> 去单独分区。
而且现在大家都用 SSD 了，物理机这样做分区的都少了，比如我个人电脑，就是一个 <code>/</code> 分区打天下。。。</p></blockquote><h2 id=三常见问题 class=headerLink><a href=#%e4%b8%89%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 class=header-mark></a>三、常见问题</h2><h3 id=1-导入已有的-qcow2-镜像 class=headerLink><a href=#1-%e5%af%bc%e5%85%a5%e5%b7%b2%e6%9c%89%e7%9a%84-qcow2-%e9%95%9c%e5%83%8f class=header-mark></a>1. 导入已有的 qcow2 镜像</h3><blockquote><p>必须要命令行操作</p></blockquote><p>先通过 scp 将 qcow2 传输到 PVE 上，然后命令行使用如下命令导入镜像：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 命令格式</span>
</span></span><span class=line><span class=cl>qm importdisk &lt;vmid&gt; &lt;source&gt; &lt;storage&gt;
</span></span><span class=line><span class=cl><span class=c1># 示例</span>
</span></span><span class=line><span class=cl>qm importdisk <span class=m>201</span> vm-201-disk-1.qcow2 local-lvm
</span></span></code></pre></td></tr></table></div></div><p>导入完成后，在 WebUI 界面的左侧会看到多了一个「未使用的磁盘 0」，
现在新建一台新虚拟机，然后删除掉默认的磁盘（分离+删除，要两步），然后挂载这个「未使用的磁盘 0」就大功告成了。</p><h3 id=2-点击-shutdown-后-pve-系统卡住 class=headerLink><a href=#2-%e7%82%b9%e5%87%bb-shutdown-%e5%90%8e-pve-%e7%b3%bb%e7%bb%9f%e5%8d%a1%e4%bd%8f class=header-mark></a>2. 点击 shutdown 后 PVE 系统卡住</h3><p>PVE 的 <code>shutdown</code> 功能依赖 <code>qemu-guest-agent</code>，对于还没有安装 <code>qemu-guest-agent</code> 的任何主机，或者已经卡死无响应的虚拟机，千万不要点 <code>shutdown</code> 按钮，因为一定会卡住很久，最后失败！</p><p><code>shutdown</code> 卡住的解决办法：手动在下方的「Tasks」面板中双击卡住的「Shutdown」操作，然后点击「stop」停止该操作。</p><p>该如何关闭这类没有 <code>qemu-guest-agent</code> 或者已经卡死无响应的主机？答案是使用 <code>stop</code>！</p><h3 id=3-cant-lock-file-varlockqemu-serverlock-xxxconf--got-timeout class=headerLink><a href=#3-cant-lock-file-varlockqemu-serverlock-xxxconf--got-timeout class=header-mark></a>3. can’t lock file ‘/var/lock/qemu-server/lock-xxx.conf’ – got timeout</h3><p>PVE 虚拟机卡在 BIOS 系统引导这一步，无法启动，也无法 <code>stop</code>！</p><p>解决方法：手动删除掉 lockfile: <code>/var/lock/qemu-server/lock-xxx.conf</code></p><p>因为虚拟机还卡在 BIOS 引导这一步，删除掉 lockfile 再关闭虚拟机并不会导致数据丢失。</p><h3 id=4-pve-集群有一个节点宕机如何解除关联 class=headerLink><a href=#4-pve-%e9%9b%86%e7%be%a4%e6%9c%89%e4%b8%80%e4%b8%aa%e8%8a%82%e7%82%b9%e5%ae%95%e6%9c%ba%e5%a6%82%e4%bd%95%e8%a7%a3%e9%99%a4%e5%85%b3%e8%81%94 class=header-mark></a>4. PVE 集群有一个节点宕机，如何解除关联？</h3><p>将多个节点组成一个 PVE Cluster 是很自然的一个选择，它能提供虚拟机热迁移（同 CPU 供应商）、统一管理面板等非常方便的功能。
但是这会带来集群级别的高可用问题。</p><p>根据官方文档 <a href=https://pve.proxmox.com/wiki/Cluster_Manager target=_blank rel="noopener noreferrer">Cluster_Manager - Proxmox</a>，如果你需要容忍一定数量的节点宕机，PVE Cluster 至少需要三台主机（这跟 Etcd 一样，大概是 Raft 共识算法的要求），并且所有节点的 PVE 版本要完全一致。</p><p>那么如果个别节点出了问题，无法修复，该如何将它踢出集群呢？</p><p>如果需要踢出的节点仍然处于可用状态，而且在线节点占比超过 50%，则修改流程如下：</p><ul><li>首先通过访问节点的 shell 界面，通过命令 <code>pvecm nodes</code> 确认集群的所有节点</li><li>将需要移除的节点彻底关机，并且确保它不会以当前配置再次启动（也就是说关机后需要清空硬盘，避免数据混乱）</li><li>通过命令 <code>pvecm delnode xxx</code> 将问题节点移除集群</li><li>重置旧节点硬盘，并重新装机，用做其他用途。</li></ul><p>如果你的集群只有 2 个节点，或者有超过 3 个节点但是宕机节点数不低于 50%，那出于数据一致性要求 Raft 算法会禁止更新集群数据，上面的流程就走不通了。如果你直接走上面的流程，它会报错 <code>cluster not ready - no quorum?</code> 这时需要首先修改配置，使剩下的节点重新达成一致。其实就是修改选主节点时的投票数。</p><p>对于 2 个节点但挂掉 1 个的情况，首先执行如下指令允许当前节点自己选主：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 设置只需要 1 票就能当前主节点</span>
</span></span><span class=line><span class=cl><span class=c1># 潜在问题是可能有些集群元数据只在损坏节点上有，这么改会导致这些数据丢失，从而造成一些问题。</span>
</span></span><span class=line><span class=cl><span class=c1># 安全起见，建议在修复集群后，再重启一遍节点...</span>
</span></span><span class=line><span class=cl>pvecm expected <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>现在 quorum 就已经恢复了，可以走前面给出的节点移除流程。</p><p>如果节点已经删除，但是 Web GUI 上仍然显示有被删除的节点，可以在集群的所有剩余节点上，手动删除掉 <code>/etc/pve/nodes/node-name/</code> 文件夹，即可从集群中彻底删除该节点的数据，注意千万别删错了，不然就尴尬了&mldr;</p><p>如果 corosync 完全无法启动，上面给出的命令也会修改选主投票参数也会失败，这时可以直接手动修改 <code>/etc/corosync/corosync.conf</code> 删除掉有问题的节点对应的配置，调低 expceted 投票数，使 corosync 能正常启动，再执行前述操作。</p><h3 id=5-cloud-image-的坑 class=headerLink><a href=#5-cloud-image-%e7%9a%84%e5%9d%91 class=header-mark></a>5. cloud image 的坑</h3><h4 id=ubuntu-cloud-image-的坑 class=headerLink><a href=#ubuntu-cloud-image-%e7%9a%84%e5%9d%91 class=header-mark></a>ubuntu cloud image 的坑</h4><ul><li>ubuntu 启动时会报错 <code>no such device: root</code>，但是过一会就会正常启动。<ul><li>这是 ubuntu cloud image 的 bug: <a href=https://bugs.launchpad.net/cloud-images/+bug/1726476 target=_blank rel="noopener noreferrer">https://bugs.launchpad.net/cloud-images/+bug/1726476</a></li></ul></li><li>ubuntu 启动后很快就会进入登录界面，但是 root 密码可能还没改好，登录会报密码错误，等待一会再尝试登录就 OK 了</li><li>ubuntu 的默认网卡名称是 ens3，不是 eth0，注意修改 network_config 的网卡名称，否则网络配置不会生效</li><li>以 kvm 结尾的 Ubuntu Cloud Image 无法识别到 USB 设备，将 USB 端口映射到该虚拟机中没有任何作用。<ul><li>kvm 使用了精简版的 linux 内核，去掉了 USB 等在云上用不到的驱动，建议改用无 kvm 结尾的镜像。</li></ul></li></ul><h5 id=ubuntu-cloud-image-无法识别到-usb-设备的排查记录 class=headerLink><a href=#ubuntu-cloud-image-%e6%97%a0%e6%b3%95%e8%af%86%e5%88%ab%e5%88%b0-usb-%e8%ae%be%e5%a4%87%e7%9a%84%e6%8e%92%e6%9f%a5%e8%ae%b0%e5%bd%95 class=header-mark></a>「Ubuntu Cloud Image 无法识别到 USB 设备」的排查记录</h5><p>现象：</p><ul><li>在尝试使用 PVE 将 USB 接口直通到 Ubuntu Cloud Image 启动的虚拟机作为 NAS 系统时，发现 <code>lsblk</code> 根本无法找到我的 USB 硬盘</li><li>换成我笔记本接硬盘盒，能够正常识别并挂载硬盘</li><li>使用 <code>lsusb</code> 不会报错，但是也看不到任何内容</li><li>使用 <code>lspci</code> 能找到 USB 对应的 PCI 设备</li><li>进一步使用 <code>cat /proc/modules | grep usb</code> 与 <code>lsmod | grep usb</code> 均查不到任何 usb 相关的内核模块<ul><li>而在我笔记本上 <code>lsmod | grep usb</code> 能够输出 <code>usb_storage</code> <code>usb_core</code> 等多项内核模块。</li></ul></li><li>再用 <code>modprobe usb</code> 会提示 <code>modprobe: FATAL: Module usb not found in directory /lib/modules/5.15.0-1021-kvm</code></li></ul><p>问题原因很明显了，Ubuntu 根本没有为 cloud image 预置 usb 内核模块，所以才有这个问题&mldr;</p><p>进一步搜索发现这个帖子：<a href=https://askubuntu.com/questions/1315370/whats-the-difference-between-ubuntus-amd64-disk-kvm-img-and-the-regular-amd64 target=_blank rel="noopener noreferrer">What&rsquo;s the difference between ubuntu&rsquo;s amd64-disk-kvm.img and the regular amd64.img cloud images?</a>，解答了我的疑惑。</p><p>原因是，我使用了 ubuntu 为 cloud 环境做了精简的 kvm 内核，非常轻量，但是缺少 usb 等常用内核模块。</p><p>对于 NAS 外接存储这个场景，我应该使用不以 kvm 结尾的 ubuntu cloud image，换了个基础镜像后问题就解决了~</p><h4 id=opensuse-cloud-image-的坑 class=headerLink><a href=#opensuse-cloud-image-%e7%9a%84%e5%9d%91 class=header-mark></a>opensuse cloud image 的坑</h4><ul><li>opensuse leap 15 只支持 network_config v1，对 v2 的支持有 bug，<code>gateway4</code> 不会生效</li></ul><h4 id=debian-cloud-image-的坑 class=headerLink><a href=#debian-cloud-image-%e7%9a%84%e5%9d%91 class=header-mark></a>debian cloud image 的坑</h4><p>debian 的 cloud 镜像根本没法用，建议避免使用它。</p><ul><li>debian 启动时会彻底卡住，或者直接报错 kernel panic<ul><li>原因是添加了 spice 图形卡，换成 vnc 就正常了</li></ul></li><li><a href=https://cdimage.debian.org/cdimage/cloud/ target=_blank rel="noopener noreferrer">Debian Cloud Images</a> 中的 nocloud 镜像不会在启动时运行 cloudinit，cloudinit 完全不生效<ul><li>不知道是啥坑，没解决</li></ul></li></ul><h3 id=6-克隆创建的虚拟机卡在-booting-from-hard-disk-状态 class=headerLink><a href=#6-%e5%85%8b%e9%9a%86%e5%88%9b%e5%bb%ba%e7%9a%84%e8%99%9a%e6%8b%9f%e6%9c%ba%e5%8d%a1%e5%9c%a8-booting-from-hard-disk-%e7%8a%b6%e6%80%81 class=header-mark></a>6. 克隆创建的虚拟机，卡在 <code>Booting from Hard Disk...</code> 状态</h3><p>被用做模板的虚拟机可以正常启动，但是克隆的虚拟机就卡住了。</p><p>可能的原因：</p><ol><li>磁盘有问题，出这个问题的 cloud image 是 <code>ubuntu-20.10-server-cloudimg-amd64.img</code>，我更换成 <code>ubuntu-20.10-server-cloudimg-amd64-disk-kvm.img</code> 就没问题了。<ol><li>磁盘镜像均下载自 <a href=https://cloud-images.ubuntu.com/releases/groovy/release-20201210/ target=_blank rel="noopener noreferrer">https://cloud-images.ubuntu.com/releases/groovy/release-20201210/</a></li></ol></li><li>BIOS 不匹配：将 BIOS 从 SeaBIOS 切换到 OVMF(UEFI)<ol><li>如果仍然无法启动，请进入 OVMF 的 BIOS 界面关闭「Secure Boot」后再重启看看</li></ol></li></ol><h3 id=7-虚拟机启动时-cloudinit-报错-faild-to-start-openbsd-secure-shell-server class=headerLink><a href=#7-%e8%99%9a%e6%8b%9f%e6%9c%ba%e5%90%af%e5%8a%a8%e6%97%b6-cloudinit-%e6%8a%a5%e9%94%99-faild-to-start-openbsd-secure-shell-server class=header-mark></a>7. 虚拟机启动时 cloudinit 报错 faild to start OpenBSD Secure Shell server</h3><p>有如下几种可能：</p><ul><li><strong>可能性一：虚拟机名称包含非法字符</strong><ul><li>pve 的 cloudinit 配置会在启动时尝试将虚拟机 hostname 修改为与虚拟机一致，但是又没有对虚拟机名称做合法性校验&mldr;</li><li>当你使用的虚拟机名称包含了非法字符时就会出这个问题，比如 <code>ubuntu-22.10-cloudimage-template</code>，其中的 <code>.</code> 就是非法的， <code>.</code> 在 DNS 中用于划分不同的域！</li><li><strong>解决方法</strong>：克隆个新虚拟机并改用合法名称，再删除旧虚拟机，问题就解决了。</li></ul></li><li><strong>可能性二：磁盘空间不足</strong><ul><li>qcow 镜像转换成的虚拟机磁盘很小，只有 2G，如果不扩容，启动时就会出各种奇怪的问题。</li><li><strong>解决方法</strong>：通过 Web UI 扩容磁盘大小，建议至少给 32G。</li></ul></li></ul><h3 id=8-修改-linux-虚拟机的-hostname class=headerLink><a href=#8-%e4%bf%ae%e6%94%b9-linux-%e8%99%9a%e6%8b%9f%e6%9c%ba%e7%9a%84-hostname class=header-mark></a>8. 修改 Linux 虚拟机的 Hostname</h3><p>如前所述，pve 的 cloudinit 配置会在启动时尝试将虚拟机 hostname 修改为与虚拟机一致，这导致手动修改无法生效无效。</p><p>解决方法：从旧的虚拟机克隆一个新虚拟机，将新虚拟机名称设为你期望的 hostname，然后删除旧虚拟机，启动新克隆的虚拟机，即完成了 hostname 重命名。</p><h3 id=9-虚拟机迁移时报错-host-key-verification-failed class=headerLink><a href=#9-%e8%99%9a%e6%8b%9f%e6%9c%ba%e8%bf%81%e7%a7%bb%e6%97%b6%e6%8a%a5%e9%94%99-host-key-verification-failed class=header-mark></a>9. 虚拟机迁移时报错 <code>Host key verification failed</code></h3><blockquote><p>社区相关帖子：https://forum.proxmox.com/threads/host-key-verification-failed-when-migrate.41666/</p></blockquote><p>这通常是因为节点增删，或者不小心动到了 <code>~/.ssh/known_hosts</code> 文件，导致的问题。</p><p>可以通过手动在每台节点上执行如下命令解决：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>ssh -o <span class=s1>&#39;HostKeyAlias=&lt;Target node Name&gt;&#39;</span> root@&lt;Target node IP&gt;
</span></span></code></pre></td></tr></table></div></div><p>注意将上述命令中的 <code>Target node Name></code> 改为节点名称，将 <code>&lt;Target node IP></code> 改为节点 IP 地址。</p><h3 id=10-pve-的-vm-不支持-vmxsvm-虚拟化指令集 class=headerLink><a href=#10-pve-%e7%9a%84-vm-%e4%b8%8d%e6%94%af%e6%8c%81-vmxsvm-%e8%99%9a%e6%8b%9f%e5%8c%96%e6%8c%87%e4%bb%a4%e9%9b%86 class=header-mark></a>10. PVE 的 vm 不支持 vmx/svm 虚拟化指令集</h3><p>在 Linux 虚拟机中运行如下命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>egrep <span class=s1>&#39;(vmx|svm)&#39;</span> --color<span class=o>=</span>always /proc/cpuinfo
</span></span></code></pre></td></tr></table></div></div><p>有输出则说明此虚拟机本身也支持 vmx/svm 虚拟化指令集（vmx 是 intel 指令集，svm 是 amd 的指令集）。</p><p>如果没有任何输出，说明此虚拟机不支持嵌套虚拟机，无法在其内部运行 Hyper-V 或者 kvm 虚拟化程序。</p><p>一般来说 PVE 宿主机默认就会启用嵌套虚拟化功能，可通过如下指令验证：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># intel 用这个命令，输出 Y 则表示启用了嵌套虚拟化</span>
</span></span><span class=line><span class=cl>cat /sys/module/kvm_intel/parameters/nested
</span></span><span class=line><span class=cl><span class=c1># amd 用如下指令，输出 1 则表示启用了嵌套虚拟化</span>
</span></span><span class=line><span class=cl>cat /sys/module/kvm_amd/parameters/nested
</span></span></code></pre></td></tr></table></div></div><p>如果输出不是 <code>Y</code>/<code>1</code>，则需要手动启用嵌套虚拟化功能。</p><p>如果是 intel cpu，需要使用如下命令启用嵌套虚拟化功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>## 1. 关闭所有虚拟机，并卸载 kvm_intel 内核模块</span>
</span></span><span class=line><span class=cl>sudo modprobe -r kvm_intel
</span></span><span class=line><span class=cl><span class=c1>## 2. 启用嵌套虚拟化功能</span>
</span></span><span class=line><span class=cl>sudo modprobe kvm_intel <span class=nv>nested</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1>## 3. 保存配置，使嵌套虚拟化功能在重启后自动启用</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modprobe.d/kvm.conf
</span></span></span><span class=line><span class=cl><span class=s>options kvm_intel nested=1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p>如果是 amd cpu，则应使用如下命令启用嵌套虚拟化功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1>## 1. 关闭所有虚拟机，并卸载 kvm_intel 内核模块</span>
</span></span><span class=line><span class=cl>sudo modprobe -r kvm_amd
</span></span><span class=line><span class=cl><span class=c1>## 2. 启用嵌套虚拟化功能</span>
</span></span><span class=line><span class=cl>sudo modprobe kvm_amd <span class=nv>nested</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1>## 3. 保存配置，使嵌套虚拟化功能在重启后自动启用</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | sudo tee /etc/modprobe.d/kvm.conf
</span></span></span><span class=line><span class=cl><span class=s>options kvm_amd nested=1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p>上面这么一堆操作后，宿主机就已经启用了嵌套虚拟化，但是虚拟机内部却仍然不一定能有虚拟化指令集。</p><p><strong>根本原因是 PVE 默认使用 kvm64 这种虚拟化的 CPU 类型，它不支持 vmx/svm 指令集！将虚拟机的 CPU 类型改为 <code>host</code>，然后重启虚拟机，问题就解决了</strong>。</p><h3 id=11-如何在多台主机间同步-iso-镜像backup-文件 class=headerLink><a href=#11-%e5%a6%82%e4%bd%95%e5%9c%a8%e5%a4%9a%e5%8f%b0%e4%b8%bb%e6%9c%ba%e9%97%b4%e5%90%8c%e6%ad%a5-iso-%e9%95%9c%e5%83%8fbackup-%e6%96%87%e4%bb%b6 class=header-mark></a>11. 如何在多台主机间同步 iso 镜像、backup 文件</h3><p>PVE 自动创建的 iso 镜像、backup 文件，默认都只会保存到本机的 <code>local</code> 分区中，那万一机器出了问题，很可能备份就一起丢了。</p><p>极简解决方案，每台机器放一个 crontab 脚本，定期使用 rsync 将本机的 <code>/var/lib/vz/template/</code> 与其他几台主机同步，同时还可以将数据备份一份到外部 HDD 存储确保安全。</p><p>示例脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 将本机的 /var/lib/vz/template/ 文件夹与另外两台主机同步</span>
</span></span><span class=line><span class=cl>rsync -avz --progress /var/lib/vz/template/ root@192.168.5.162:/var/lib/vz/template/
</span></span><span class=line><span class=cl>rsync -avz --progress /var/lib/vz/template/ root@192.168.5.163:/var/lib/vz/template/
</span></span></code></pre></td></tr></table></div></div><p>不过好像 PVE 官方也提供一个 <a href=https://www.proxmox.com/en/proxmox-backup-server target=_blank rel="noopener noreferrer">proxmox-backup-server</a>，感觉可以搞个容器跑这玩意儿，把数据备份到 USB 硬盘盒或者 SMB 挂载的硬盘里，待研究。</p><ul><li><a href=https://github.com/proxmox/proxmox-backup target=_blank rel="noopener noreferrer">proxmox/proxmox-backup</a>: 官方用纯 rust 实现的一个备份服务器</li><li><a href=https://github.com/ayufan/pve-backup-server-dockerfiles target=_blank rel="noopener noreferrer">ayufan/pve-backup-server-dockerfiles</a></li></ul><p>另外开源社区也有 restic/rclone 等工具也可用于备份，备份方案还在研究中，未确定。</p><h2 id=四pve-网络配置 class=headerLink><a href=#%e5%9b%9bpve-%e7%bd%91%e7%bb%9c%e9%85%8d%e7%bd%ae class=header-mark></a>四、PVE 网络配置</h2><h3 id=1-桥接多张物理网卡 class=headerLink><a href=#1-%e6%a1%a5%e6%8e%a5%e5%a4%9a%e5%bc%a0%e7%89%a9%e7%90%86%e7%bd%91%e5%8d%a1 class=header-mark></a>1. 桥接多张物理网卡</h3><p>示例如下，主要就是在 vmbr0 网桥的 <code>Bridge Ports</code> 里面：</p><p><figure><a class=lightgallery href=/images/proxmox-ve-instruction/pve-multiple-nic.webp title=/images/proxmox-ve-instruction/pve-multiple-nic.webp data-thumbnail=/images/proxmox-ve-instruction/pve-multiple-nic.webp data-sub-html="<h2>桥接多张物理网卡</h2>"><img class=lazyload data-src=/images/proxmox-ve-instruction/pve-multiple-nic.webp data-srcset="/images/proxmox-ve-instruction/pve-multiple-nic.webp, /images/proxmox-ve-instruction/pve-multiple-nic.webp 1.5x, /images/proxmox-ve-instruction/pve-multiple-nic.webp 2x" data-sizes=auto alt=/images/proxmox-ve-instruction/pve-multiple-nic.webp></a><figcaption class=image-caption>桥接多张物理网卡</figcaption></figure></p><h3 id=2-手动添加-usb-物理网卡 class=headerLink><a href=#2-%e6%89%8b%e5%8a%a8%e6%b7%bb%e5%8a%a0-usb-%e7%89%a9%e7%90%86%e7%bd%91%e5%8d%a1 class=header-mark></a>2. 手动添加 USB 物理网卡</h3><blockquote><p>参考官方文档: <a href=https://pve.proxmox.com/pve-docs/chapter-sysadmin.html#sysadmin_network_configuration target=_blank rel="noopener noreferrer">SysAdmin - Network Configuration</a></p></blockquote><p>我遇到这个问题的场景是：我的 mini 主机（GTR5）只有两个 2.5G 网卡，不太够用。而家里的路由器剩下的都是千兆网口，路由器也难以拓展网卡。
网上搜了下 2.5G 交换机又发现价格 429 起步，所以决定买两张 USB 2.5GbE 网卡插在这台小主机上作为便宜的网口拓展方案。</p><p>现在网卡有了，有两种方式可以让 PVE 识别到这张网卡：</p><blockquote><p>好像 PVE 偶尔也能自动识别到网卡，就是比较慢&mldr;</p></blockquote><ol><li>方法一：直接重启机器，然后就能在 Web UI 的 <code>Network</code> 配置中见到这张 USB 网卡了。之后直接把该网卡加入到 vmbr 网桥的 <code>Bridge Ports</code> 中并应用配置，就大功告成了。</li><li>方法二：不重启机器实现添加 USB 网卡。如果机器不能重启，就可以走这个流程：<ol><li>首先，使用 <code>ip link</code> 命令打印出当前的所有网络接口</li><li>将 2.5GbE 网卡插到 USB3.0 端口上，Linux 将自动识别到它</li><li>现在再使用 <code>ip link</code> 命令查看所有网络接口，找到新增的接口名称（通常在输出内容最末尾）。<ol><li>在我的环境中新的 USB 网卡名称为 <code>enx00e04c680178</code></li></ol></li><li>在配置文件 <code>/etc/network/interfaces</code> 的末尾新增一行：<code>iface enx00e04c680178 inet manual</code>（注意替换网卡名称）</li><li>现在直接刷新 Web UI 页面， USB 网卡就会出现了。之后直接把该网卡加入到 vmbr 网桥的 <code>Bridge Ports</code> 中并应用配置，就大功告成了。</li></ol></li></ol><h3 id=3-配置-wifi-网卡 class=headerLink><a href=#3-%e9%85%8d%e7%bd%ae-wifi-%e7%bd%91%e5%8d%a1 class=header-mark></a>3. 配置 WiFi 网卡</h3><p>如果主机自带了 WiFi 网卡，启动后 Proxmox VE 能识别到该网卡，但是无法通过 Web UI 修改它的任何配置。</p><p>那么本着物尽其用的精神，该如何利用上这张 WiFi 网卡呢？</p><p>根据 PVE 官方文档 <a href=https://pve.proxmox.com/wiki/WLAN target=_blank rel="noopener noreferrer">WLAN - Proxmox VE Docs</a>，并不建议在 PVE 上使用 WLAN，它存在如下问题：</p><ul><li>WiFi 自身必须是一个 Linux Bridge 设备，无法被桥接到 vmbr0 等网桥上。因为大多数 Access Point 都会直接拒绝掉未授权的源地址发过来的数据包&mldr;</li><li>与有线连接相比，WiFi 的延迟要高得多，而且延迟波动较大。</li></ul><p>因此仅建议在不得已的情况下，才使用 WiFi 网卡.</p><p>如果要配置 WLAN 网卡的话，官方建议直接参考 Debian 的官方文档进行配置：<a href=https://wiki.debian.org/WiFi/HowToUse target=_blank rel="noopener noreferrer">How to use a WiFi interface - Debian</a>，不过这里也找到一篇中文博客：</p><ul><li><a href=https://foxi.buduanwang.vip/virtualization/pve/1939.html/ target=_blank rel="noopener noreferrer">proxmox中使用ax210连接无线网络 - 佛西博客</a></li></ul><h2 id=五提升-pve-的安全性 class=headerLink><a href=#%e4%ba%94%e6%8f%90%e5%8d%87-pve-%e7%9a%84%e5%ae%89%e5%85%a8%e6%80%a7 class=header-mark></a>五、提升 PVE 的安全性</h2><h3 id=1-配置-acme-证书并使其自动更新 class=headerLink><a href=#1-%e9%85%8d%e7%bd%ae-acme-%e8%af%81%e4%b9%a6%e5%b9%b6%e4%bd%bf%e5%85%b6%e8%87%aa%e5%8a%a8%e6%9b%b4%e6%96%b0 class=header-mark></a>1. 配置 ACME 证书并使其自动更新</h3><p>对于个人使用而言，不配置证书好像也 ok，虽然访问 Web UI 时浏览器会提示不安全，但也不影响使用。</p><p>如果你拥有自己的域名，同时也期望更高的安全性，根据<a href=https://pve.proxmox.com/wiki/Certificate_Management#sysadmin_certs_acme_dns_challenge target=_blank rel="noopener noreferrer">Certificate Management - 官方文档</a>，pve 可借助 acme.sh 进行证书的申请与自动更新。</p><p>TODO</p><h3 id=2-ssh-禁用密码登录 class=headerLink><a href=#2-ssh-%e7%a6%81%e7%94%a8%e5%af%86%e7%a0%81%e7%99%bb%e5%bd%95 class=header-mark></a>2. SSH 禁用密码登录</h3><p>pve 的 ssh 默认是启用了密码登录的，为了安全性，建议上传 ssh 密钥改用密钥登录，并禁用密码登录功能。</p><p>详见 <a href=https://github.com/ryan4yin/knowledge/blob/master/linux/Linux%20%E4%B8%BB%E6%9C%BA%E5%AE%89%E5%85%A8%E8%AE%BE%E7%BD%AE.md target=_blank rel="noopener noreferrer">Linux 主机安全设置.md - ryan4yin</a></p><h3 id=3-用户管理 class=headerLink><a href=#3-%e7%94%a8%e6%88%b7%e7%ae%a1%e7%90%86 class=header-mark></a>3. 用户管理</h3><p>PVE 支持对接多种授权协议，对于个人使用而言，直接使用 Linux PAM 是最简单的。</p><p>即使是在内网，为了安全性，也建议设置复杂密码，同时所有虚拟机也建议仅启用密钥登录，所有 Web 页面都建议设置复杂密码。（特别是家里没有访客网络的时候&mldr;）</p><h2 id=六pcie-直通显卡硬盘usb-设备等 class=headerLink><a href=#%e5%85%adpcie-%e7%9b%b4%e9%80%9a%e6%98%be%e5%8d%a1%e7%a1%ac%e7%9b%98usb-%e8%ae%be%e5%a4%87%e7%ad%89 class=header-mark></a>六、PCI(e) 直通（显卡、硬盘、USB 设备等）</h2><p>QEMU/KVM 的 PCI(e) 直通功能可以让虚拟机<strong>独占</strong>指定的 PCI(e) 设备，越过宿主机控制器直接与该 PCI(e) 设备通信。</p><p>相比使用 QEMU/KVM 提供的 virtio 半虚拟化硬件，PCI(e) 直通有如下优势：</p><ul><li>大大提升虚拟机与 PCI(e) 设备的 IO 性能（更低的延迟，更高的速度，更低的资源占用）。</li><li>可以利用上 QEMU/KVM 本身不支持的硬件特性，比如 PCI 直通最常见的使用场景——显卡直通。</li></ul><p>那么最常见的 PCI(e) 直通需求有：</p><ul><li><strong>显卡直通</strong>，实现在内部 windows 主机中用宿主机显卡看影视、玩游戏、剪视频</li><li><strong>硬盘或 USB 直通</strong>，以提升硬盘或 USB 的 IO 性能。</li></ul><p>首先列举下相关的文档：</p><ul><li><a href=https://pve.proxmox.com/wiki/PCI%28e%29_Passthrough target=_blank rel="noopener noreferrer">PCI(e) Passthrough - Proxmox WIKI</a>.</li><li><a href=https://pve.proxmox.com/wiki/Pci_passthrough#GPU_OVMF_PCI_Passthrough_.28recommended.29 target=_blank rel="noopener noreferrer">GPU OVMF PCI Passthrough (recommended) - Proxmox WIKI</a></li><li><a href=https://wiki.archlinux.org/title/QEMU/Guest_graphics_acceleration target=_blank rel="noopener noreferrer">QEMU/Guest graphics acceleration - Arch WIKI</a></li></ul><p>TODO 实操内容待补充&mldr;</p><h2 id=拓展---cloudinit-高级配置 class=headerLink><a href=#%e6%8b%93%e5%b1%95---cloudinit-%e9%ab%98%e7%ba%a7%e9%85%8d%e7%bd%ae class=header-mark></a>拓展 - cloudinit 高级配置</h2><p>PVE 使用 CDROM 只读盘(<code>/dev/sr0</code>)来进行 cloud-init 的配置。
在虚拟机启动后，<code>/dev/sr0</code> 将被卸载。</p><p>可挂载上该只读盘，查看其中的初始化配置内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir cloud-config
</span></span><span class=line><span class=cl>$ mount /dev/sr0 cloud-config
</span></span><span class=line><span class=cl>mount: /dev/sr0 is write-protected, mounting read-only
</span></span><span class=line><span class=cl>$ ls cloud-config
</span></span><span class=line><span class=cl>meta-data  network-config  user-data
</span></span></code></pre></td></tr></table></div></div><p>查看其中内容，会发现 <code>user-data</code> 有很多参数都被硬编码了，没有通过 PVE Web Console 暴露出来，导致我们无法自定义这些配置。</p><p>比如它硬编码了 <code>manage_etc_hosts: true</code>，强制每次都使用虚拟机的名称作为 hostname.</p><p>如果确认有修改这些配置的需求，完全可以修改掉 PVE 代码里的硬编码参数。
通过全文搜索即可找到硬编码参数的位置，以 <code>manage_etc_hosts</code> 为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 在 /usr/share 中全文搜索 manage_etc_hosts 这个关键字</span>
</span></span><span class=line><span class=cl>grep -r manage_etc_hosts /usr/share
</span></span></code></pre></td></tr></table></div></div><p>直接就搜索到了硬编码位置是 <code>/usr/share/perl5/PVE/QemuServer/Cloudinit.pm</code>，修改对应的 cloudinit 配置模板，然后重启节点（重启才能重新加载对应的 ruby 程序），即可实现对该硬编码参数的修改。</p><h2 id=拓展---自动化配置与监控告警 class=headerLink><a href=#%e6%8b%93%e5%b1%95---%e8%87%aa%e5%8a%a8%e5%8c%96%e9%85%8d%e7%bd%ae%e4%b8%8e%e7%9b%91%e6%8e%a7%e5%91%8a%e8%ad%a6 class=header-mark></a>拓展 - 自动化配置与监控告警</h2><p>自动化配置相关工具：</p><ol><li><a href=https://github.com/Telmate/terraform-provider-proxmox/ target=_blank rel="noopener noreferrer">Telmate/terraform-provider-proxmox</a>: 用户最多，但是只支持管理虚拟机资源</li><li><a href=https://github.com/danitso/terraform-provider-proxmox target=_blank rel="noopener noreferrer">danitso/terraform-provider-proxmox</a>: stars 少，但是可以管理 PVE 的大部分资源，包括节点、用户、资源池、TLS证书等等<ul><li>代码更顺眼，但是作者忙，没时间合并 pr，导致 Bug 更多一些，而且很久没更新了&mldr;</li></ul></li><li><a href=https://github.com/ryan4yin/pulumi-proxmox target=_blank rel="noopener noreferrer">ryan4yin/pulumi-proxmox</a>: 我维护的一个 proxmox 自动配置工具</li><li><a href=https://github.com/proxmoxer/proxmoxer target=_blank rel="noopener noreferrer">Python SDK</a></li></ol><p>监控告警：</p><ul><li><a href=https://github.com/prometheus-pve/prometheus-pve-exporter target=_blank rel="noopener noreferrer">prometheus pve expoter</a>: 通过 prometheus+grafana 监控 PVE 集群</li></ul><h2 id=拓展---pve-运行在-arm-开发版上 class=headerLink><a href=#%e6%8b%93%e5%b1%95---pve-%e8%bf%90%e8%a1%8c%e5%9c%a8-arm-%e5%bc%80%e5%8f%91%e7%89%88%e4%b8%8a class=header-mark></a>拓展 - PVE 运行在 ARM 开发版上</h2><p>PVE 官方目前还未推出 ARM 支持，但是社区已有方案：</p><ul><li><a href=https://github.com/pimox/pimox7 target=_blank rel="noopener noreferrer">pimox7</a></li><li><a href=https://foxi.buduanwang.vip/virtualization/pve/1902.html/ target=_blank rel="noopener noreferrer">安装Arm版本的Proxmox VE - 佛西博客</a></li><li><a href=https://github.com/jiangcuo/Proxmox-Arm64 target=_blank rel="noopener noreferrer">Proxmox-Arm64</a></li></ul><p>proxmox 社区比较活跃，建议多在社区内看看相关进展。</p><h2 id=拓展---其他-qemukvm-相关的虚拟化平台 class=headerLink><a href=#%e6%8b%93%e5%b1%95---%e5%85%b6%e4%bb%96-qemukvm-%e7%9b%b8%e5%85%b3%e7%9a%84%e8%99%9a%e6%8b%9f%e5%8c%96%e5%b9%b3%e5%8f%b0 class=header-mark></a>拓展 - 其他 QEMU/KVM 相关的虚拟化平台</h2><p>PVE 毕竟是一个商业系统，虽然目前可以免费用，但是以后就不一定了。</p><p>如果你担心 PVE 以后会不提供免费使用的功能，或者单纯想折腾折腾的技术，还可以试试下面这些虚拟化平台：</p><ul><li><a href=https://github.com/retspen/webvirtcloud target=_blank rel="noopener noreferrer">webvirtcloud</a>: 其前身是 webvirtmgr，一个完全开源的 QEMU/KVM Web UI，额外提供了用户管理功能。</li><li><a href=https://github.com/kubevirt/kubevirt target=_blank rel="noopener noreferrer">kubevirt</a>: 基于 Kubernetes 进行虚拟化管理</li><li><a href=https://github.com/rancher/harvester target=_blank rel="noopener noreferrer">rancher/harvester</a>: Rancher 开源的基于 Kubernetes 的超融合平台(HCI)<ul><li>其底层使用 kubevirt 提供虚拟化能力，通过 longhorn 提供分布式存储能力。</li><li>HCI 超融合 = 计算虚拟化 + 网络虚拟化 + 分布式存储，它和传统的虚拟化软件最大的不同是：分布式存储。</li><li>企业级场景下一般至少得 10GbE 网络 + SSD 才能 hold 住 HCI 超融合架构。</li><li>超融合对存储的一些要求：<ul><li>软件定义 – 解除硬件绑定，可通过升级拓展更丰富的功能，自动化能力高</li><li>全分布式架构 - 扩展性好，消除单点故障风险</li><li>高可靠性 - 智能的故障恢复功能，丰富的数据保护手段</li><li>高性能 – 支持多种存储介质，充分挖掘和利用新式硬件的性能</li><li>高度融合 – 架构简单并易于管理</li></ul></li><li>超融合架构可以降低私有云的构建与维护难度，让私有云的使用维护和公有云一样简单。</li><li>超融合架构下，虚拟机的计算和存储是完全高可用的：计算资源能智能动态更换，存储也是分布式存储，底层计算和存储也可以很简单的扩缩容。</li></ul></li></ul><p>我打算有时间在 PVE 集群里跑个 rancher/harvester 玩玩 emmmm</p><h2 id=参考 class=headerLink><a href=#%e5%8f%82%e8%80%83 class=header-mark></a>参考</h2><ul><li><a href=https://zhuanlan.zhihu.com/p/49118355 target=_blank rel="noopener noreferrer">KVM 虚拟化环境搭建 - ProxmoxVE</a></li><li><a href=https://zhuanlan.zhihu.com/p/49120559 target=_blank rel="noopener noreferrer">KVM 虚拟化环境搭建 - WebVirtMgr</a></li><li><a href=https://pve.proxmox.com/wiki/Main_Page target=_blank rel="noopener noreferrer">Proxmox Virtual Environment - Proxmox WIKI</a></li><li><a href=https://wiki.archlinux.org/title/QEMU#top-page target=_blank rel="noopener noreferrer">QEMU - Arch Linux WIKI</a></li><li><a href=https://foxi.buduanwang.vip/category/virtualization/pve/ target=_blank rel="noopener noreferrer">佛西博客 - PVE 相关</a>: 这位博主写了很多 pve 相关的内容，而且比较有深度</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-11-27</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=# onclick=return!1 title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/proxmox-virtual-environment-instruction/ data-title="Proxmox Virtual Environment 使用指南" data-via=ryan4yin data-hashtags=虚拟化,Visualization,KVM,QEMU,libvirt,Proxmox><i class="fab fa-twitter fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Facebook" data-sharer=facebook data-url=https://thiscute.world/posts/proxmox-virtual-environment-instruction/ data-hashtag=虚拟化><i class="fab fa-facebook-square fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/proxmox-virtual-environment-instruction/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/>虚拟化</a>,&nbsp;<a href=/tags/visualization/>Visualization</a>,&nbsp;<a href=/tags/kvm/>KVM</a>,&nbsp;<a href=/tags/qemu/>QEMU</a>,&nbsp;<a href=/tags/libvirt/>libvirt</a>,&nbsp;<a href=/tags/proxmox/>Proxmox</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/deliberate-practice/ class=prev rel=prev title=刻意练习><i class="fas fa-angle-left fa-fw"></i>刻意练习</a>
<a href=/posts/2022-summary/ class=next rel=next title="2022 年年终总结">2022 年年终总结<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=width:auto;height:15px;margin-bottom:5px></a> <a href=https://www.foreverblog.cn/go.html target=_blank><img src=https://img.foreverblog.cn/wormhole_3.gif alt style=width:auto;height:24px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://thiscute.world/ target=_blank rel="noopener noreferrer">ryan4yin</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script></div><div class=pjax-assets><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript></div></body></html>