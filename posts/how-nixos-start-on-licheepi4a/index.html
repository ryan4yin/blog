<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>NixOS 在 Lichee Pi 4A 上是如何启动的 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:title" content="NixOS 在 Lichee Pi 4A 上是如何启动的"><meta property="og:description" content="文章是 2023-08-07 写的，后面就完全忘掉这回事了，今天偶然翻到它才想起要整理发布下&mldr;所以 注意文章中的时间线是 2023 年 8 月。 零、前言我从今年 5 月"><meta property="og:type" content="article"><meta property="og:url" content="https://thiscute.world/posts/how-nixos-start-on-licheepi4a/"><meta property="og:image" content="https://thiscute.world/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-29T00:58:57+08:00"><meta property="article:modified_time" content="2024-01-29T00:58:57+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp"><meta name=twitter:title content="NixOS 在 Lichee Pi 4A 上是如何启动的"><meta name=twitter:description content="文章是 2023-08-07 写的，后面就完全忘掉这回事了，今天偶然翻到它才想起要整理发布下&mldr;所以 注意文章中的时间线是 2023 年 8 月。 零、前言我从今年 5 月"><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><meta name=twitter:creator content="@ryan4yin"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/how-nixos-start-on-licheepi4a/><link rel=prev href=https://thiscute.world/posts/2023-summary/><link rel=next href=https://thiscute.world/posts/an-incomplete-guide-to-data-security/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"NixOS 在 Lichee Pi 4A 上是如何启动的","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://thiscute.world/posts/how-nixos-start-on-licheepi4a/"},"image":[{"@type":"ImageObject","url":"https://thiscute.world/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp","width":4096,"height":3072}],"genre":"posts","keywords":"Linux, NixOS, LicheePi4A, Embedded, U-Boot, RISC-V","wordcount":12960,"url":"https://thiscute.world/posts/how-nixos-start-on-licheepi4a/","datePublished":"2024-01-29T00:58:57+08:00","dateModified":"2024-01-29T00:58:57+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https://thiscute.world/avatar/myself.png"},"author":{"@type":"Person","name":"ryan4yin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行
</a><a class=menu-item href=/series/>系列
</a><a class=menu-item href=/categories/tech/>技术
</a><a class=menu-item href=/categories/life/>生活
</a><a class=menu-item href=/tags/>标签
</a><a class=menu-item href=/friends/>朋友们
</a><a class=menu-item href=/now/>此刻
</a><a class=menu-item href=/about/>关于
</a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title=选择语言 id=language-select-desktop onchange="location=this.value"><option value=/posts/how-nixos-start-on-licheepi4a/ selected>Simplified Chinese</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a><a href=javascript:void(0); class=menu-item title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title=选择语言 onchange="location=this.value"><option value=/posts/how-nixos-start-on-licheepi4a/ selected>Simplified Chinese</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#零前言>零、前言</a></li><li><a href=#一基础知识介绍>一、基础知识介绍</a><ul><li><a href=#1-lichee-pi-4a-介绍>1. Lichee Pi 4A 介绍</a></li><li><a href=#2-nixos-介绍>2. NixOS 介绍</a></li></ul></li><li><a href=#二移植思路>二、移植思路</a></li><li><a href=#三nixos-启动流程分析>三、NixOS 启动流程分析</a><ul><li><a href=#1-bootloader-配置与系统文件树分析>1. Bootloader 配置与系统文件树分析</a></li><li><a href=#2-实际启动日志分析>2. 实际启动日志分析</a></li><li><a href=#3-init-程序分析>3. init 程序分析</a></li><li><a href=#4-activate-程序分析>4. activate 程序分析</a></li></ul></li><li><a href=#四硬件驱动部分>四、硬件驱动部分</a><ul><li><a href=#1-u-bootu-boot-splu-boot-tpl-的关系>1. u-boot，u-boot-spl，u-boot-tpl 的关系</a></li><li><a href=#2-risc-v-的启动流程>2. RISC-V 的启动流程</a></li><li><a href=#3-opensbi>3. OpenSBI</a></li><li><a href=#4-fw_dynamicbin-跟-u-boot-splbin-两个文件>4. fw_dynamic.bin 跟 u-boot-spl.bin 两个文件</a></li><li><a href=#5-t-head-官方的编译工具链>5. T-Head 官方的编译工具链</a></li></ul></li><li><a href=#五我是如何构建出一个可以在-licheepi-4a-上运行的-nixos-镜像的>五、我是如何构建出一个可以在 LicheePi 4A 上运行的 NixOS 镜像的</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">NixOS 在 Lichee Pi 4A 上是如何启动的</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://thiscute.world/ title=Author target=_blank rel="noopener noreferrerauthor" class=author>ryan4yin</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span>&nbsp;<span class=post-category>和</span>&nbsp;<span class=post-series>系列 <a href=/series/nixos-%E4%B8%8E-nix-flakes/><i class="far fa-list-alt fa-fw"></i>NixOS 与 Nix Flakes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-01-29>2024-01-29</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2024-01-29>2024-01-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 12960 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 26 分钟&nbsp;</div></div><div class="details series-nav open"><div class="details-summary series-title"><span>系列 - NixOS 与 Nix Flakes</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content series-content"><nav><ul><li><a href=/posts/nixos-and-flake-basics/>NixOS 与 Nix Flakes 新手入门</a></li><li><span class=active>NixOS 在 Lichee Pi 4A 上是如何启动的</span></li><li><a href=/posts/my-experience-of-nixos/>OS as Code - 我的 NixOS 使用体会</a></li></ul></nav></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#零前言>零、前言</a></li><li><a href=#一基础知识介绍>一、基础知识介绍</a><ul><li><a href=#1-lichee-pi-4a-介绍>1. Lichee Pi 4A 介绍</a></li><li><a href=#2-nixos-介绍>2. NixOS 介绍</a></li></ul></li><li><a href=#二移植思路>二、移植思路</a></li><li><a href=#三nixos-启动流程分析>三、NixOS 启动流程分析</a><ul><li><a href=#1-bootloader-配置与系统文件树分析>1. Bootloader 配置与系统文件树分析</a></li><li><a href=#2-实际启动日志分析>2. 实际启动日志分析</a></li><li><a href=#3-init-程序分析>3. init 程序分析</a></li><li><a href=#4-activate-程序分析>4. activate 程序分析</a></li></ul></li><li><a href=#四硬件驱动部分>四、硬件驱动部分</a><ul><li><a href=#1-u-bootu-boot-splu-boot-tpl-的关系>1. u-boot，u-boot-spl，u-boot-tpl 的关系</a></li><li><a href=#2-risc-v-的启动流程>2. RISC-V 的启动流程</a></li><li><a href=#3-opensbi>3. OpenSBI</a></li><li><a href=#4-fw_dynamicbin-跟-u-boot-splbin-两个文件>4. fw_dynamic.bin 跟 u-boot-spl.bin 两个文件</a></li><li><a href=#5-t-head-官方的编译工具链>5. T-Head 官方的编译工具链</a></li></ul></li><li><a href=#五我是如何构建出一个可以在-licheepi-4a-上运行的-nixos-镜像的>五、我是如何构建出一个可以在 LicheePi 4A 上运行的 NixOS 镜像的</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>文章是 2023-08-07 写的，后面就完全忘掉这回事了，今天偶然翻到它才想起要整理发布下&mldr;所以
注意文章中的时间线是 2023 年 8 月。</p></blockquote><h2 id=零前言 class=headerLink><a href=#%e9%9b%b6%e5%89%8d%e8%a8%80 class=header-mark></a>零、前言</h2><p>我从今年 5 月份初收到了内测板的 Lichee Pi 4A，这是当下性能最高的 RISC-V 开发板之一，不过当
时没怎么折腾。</p><p>6 月初的时候我开始尝试在 Orange Pi 5 上运行 NixOS，在
<a href=https://matrix.to/#/#nixos-on-arm:nixos.org target=_blank rel="noopener noreferrer">NixOS on ARM 的 Matrix 群组</a>
中得到了俄罗斯
老哥 @K900 的帮助，没费多大劲就成功了，一共就折腾了三天。</p><p>于是我接着尝试在 Lichee Pi 4A 上运行 NixOS，因为已经拥有了 Orange Pi 5 上的折腾经验，我以
为这次会很顺利。但是实际难度远远超出了我的预期，我从 6 月 13 号开始断断续续折腾到 7 月 3
号，接触了大量的新东西，包括 U-Boot、OpenSBI、SPL Flash、RISCV Boot Flows 等等，还参考了
@chainsx 的 Fedora for Lichee Pi 4A 方案，请教了 @NickCao 许多 NixOS 相关的问题，@revy 帮
我修了好几个 revyos/thead-kernel 在标准工具链上编译的 bug，期间也请教过 @HougeLangley 他折
腾 Lichee Pi 4A 的经验。我在付出了这么多的努力后，才最终成功编译出了 NixOS 的系统镜像（包
含 boot 跟 rootfs 两个分区）。</p><p>但是！现在要说「但是」了。</p><p>镜像是有了，系统却无法启动&mldr;找了各种资料也没解决，也没好意思麻烦各位大佬，搞得有点心灰意
冷，就先把这部分工作放下了。</p><p>接着就隔了一个多月没碰 Lichee Pi 4A，直到 8 月 5 号，外国友人 @JayDeLux 在
<a href=https://t.me/linux4rv target=_blank rel="noopener noreferrer">Mainline Linux for RISC-V</a>
TG 群组中询问我 NixOS 移植工作的进展如
何（之前有在群里提过我在尝试移植），我才决定再次尝试一下。</p><p>在之前工作的基础上一番骚操作后，我在 8 月 6 号晚上终于成功启动了 NixOS，这次意外的顺利，后
续也成功通过一份 Nix Flake 配置编译出了可用的 NixOS 镜像。</p><p>最终成果：<a href=https://github.com/ryan4yin/nixos-licheepi4a target=_blank rel="noopener noreferrer">https://github.com/ryan4yin/nixos-licheepi4a</a></p><p>整个折腾过程相当曲折，虽然最终达成了目标，但是期间遭受的折磨也真的不少。总的来说仍然是一次
很有趣的经历，既学到了许多新技术知识、认识了些有趣的外国友人（@JayDeLux 甚至还给我打了 $50
美刀表示感谢），也跟 @HougeLangley 、@chainsx 、@Rabenda(revy) 等各位大佬混了个脸熟。</p><p>这篇文章就是记录下我在这个折腾过程中学到的所有知识，以飨读者，同时也梳理一下自己的收获。</p><p>本文的写作思路是自顶向下的，先从 NixOS 镜像的 boot 分区配置、启动脚本开始分析，过渡到实际
的启动日志，再接续分析下后续的启动流程。NixOS 分析完了后，再看看与 RISC-V 相关的硬件固件与
bootloader 部分要如何与 NixOS 协同工作，使得 NixOS 能够在 Lichee Pi 4A 上正常启动。</p><h2 id=一基础知识介绍 class=headerLink><a href=#%e4%b8%80%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86%e4%bb%8b%e7%bb%8d class=header-mark></a>一、基础知识介绍</h2><h3 id=1-lichee-pi-4a-介绍 class=headerLink><a href=#1-lichee-pi-4a-%e4%bb%8b%e7%bb%8d class=header-mark></a>1. Lichee Pi 4A 介绍</h3><p>LicheePi 4A 是当前市面上性能最高的 RISC-V Linux 开发板之一，它以 TH1520 为主控核心
（4xC910@1.85G， RV64GCV，4TOPS@int8 NPU， 50GFLOP GPU），板载最大 16GB 64bit
LPDDR4X，128GB eMMC，支持 HDMI+MIPI 双4K 显示输出，支持 4K 摄像头接入，双千兆网口（其中一
个支持POE供电）和 4 个 USB3.0 接口，多种音频输入输出（由专用 C906 核心处理）。</p><p>以上来自 Lichee Pi 4A 官方文档
<a href=https://wiki.sipeed.com/hardware/zh/lichee/th1520/lpi4a/1_intro.html target=_blank rel="noopener noreferrer">Lichee Pi 4A - Sipeed Wiki</a>
.</p><p>总之它是我手上性能最高的 RISC-V 开发板。</p><p>LicheePi 4A 官方主要支持 <a href=https://github.com/revyos/revyos/ target=_blank rel="noopener noreferrer">RevyOS</a>
—— 一款针对 T-Head 芯
片生态的 Debian 优化定制发行版。根据猴哥（@HougeLangley）文章介绍，它也是目前唯一且确实能
够启用 Lichee Pi 4A 板载 GPU 的发行版，</p><h3 id=2-nixos-介绍 class=headerLink><a href=#2-nixos-%e4%bb%8b%e7%bb%8d class=header-mark></a>2. NixOS 介绍</h3><p>这个感觉就不用多说了，我在这几个月已经给 NixOS 写了非常多的文字了，感兴趣请直接移步
<a href=https://github.com/ryan4yin/nixos-and-flakes-book target=_blank rel="noopener noreferrer">ryan4yin/nixos-and-flakes-book</a>
.</p><p>在 4 月份接触了 NixOS 后，我成了 NixOS 铁粉。作为一名铁粉，我当然想把我手上的所有性能好点
的板子都装上 NixOS，Lichee Pi 4A 自然也不例外。</p><p>我目前主要完成了两块板子的 NixOS 移植工作，一块是 Orange Pi 5，另一块就是 Lichee Pi 4A。
Orange Pi 5 是 ARM64 架构的，刚好也遇到了拥有该板子的 NixOS 用户 @K900，在他的帮助下我很顺
利地就完成了移植工作。</p><p>而 Lichee Pi 4A 就比较曲折，也比较有话题性。所以才有了这篇文章。</p><h2 id=二移植思路 class=headerLink><a href=#%e4%ba%8c%e7%a7%bb%e6%a4%8d%e6%80%9d%e8%b7%af class=header-mark></a>二、移植思路</h2><p>一个完整的嵌入式 Linux 系统，通常包含了 U-Boot、kernel、设备树以及根文件系统（rootfs）四个
部分。</p><p>其中 U-Boot，kernel 跟设备树，都是与硬件相关的，需要针对不同的硬件进行定制。而 rootfs 的大
部分内容（比如说 NixOS 系统的 rootfs 本身），都是与硬件无关的，可以通用。</p><p>我的移植思路是，从 LicheePi4A 官方使用的 RevyOS 中拿出跟硬件相关的部分（也就是 U-Boot,
kernel 跟设备树这三个），再结合上跟硬件无关的 NixOS rootfs，组合成一个完整的、可在
LicheePi4A 上正常启动运行的 NixOS 系统。</p><p>RevyOS 针对 LicheePi4A 定制的几个项目源码如下：</p><ul><li><a href=https://github.com/revyos/thead-kernel.git target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-kernel.git</a></li><li><a href=https://github.com/revyos/thead-u-boot.git target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-u-boot.git</a></li><li><a href=https://github.com/revyos/thead-opensbi.git target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-opensbi.git</a></li></ul><p>思路很清晰，但因为 NixOS 本身的特殊性，实际操作起来，现有的 Gentoo, Arch Linux, Fedora 的
移植仓库代码全都无法直接使用，需要做的工作还是不少的。</p><h2 id=三nixos-启动流程分析 class=headerLink><a href=#%e4%b8%89nixos-%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90 class=header-mark></a>三、NixOS 启动流程分析</h2><p>要做移植，首先就要了解 NixOS 系统本身的文件树结构以及系统启动流程，搞明白它跟 Arch Linux,
Fedora 等其他发行版的区别，这样才好参考其他发行版的移植工作，搞明白该如何入手。</p><h3 id=1-bootloader-配置与系统文件树分析 class=headerLink><a href=#1-bootloader-%e9%85%8d%e7%bd%ae%e4%b8%8e%e7%b3%bb%e7%bb%9f%e6%96%87%e4%bb%b6%e6%a0%91%e5%88%86%e6%9e%90 class=header-mark></a>1. Bootloader 配置与系统文件树分析</h3><p>这里方便起见，我直接使用我自己为 LicheePi4A 构建好的 NixOS 镜像进行分析。首先参照
<a href=https://github.com/ryan4yin/nixos-licheepi4a target=_blank rel="noopener noreferrer">ryan4yin/nixos-licheepi4a</a>
的 README 下载解
压镜像，再使用 losetup 跟 mount 直接挂载镜像中的各分区进行初步分析：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 解压镜像</span>
</span></span><span class=line><span class=cl>› mv nixos-licheepi4a-sd-image-*-riscv64-linux.img.zst nixos-lp4a.img.zst
</span></span><span class=line><span class=cl>› zstd -d nixos-lp4a.img.zst
</span></span><span class=line><span class=cl><span class=c1># 将 img 文件作为虚拟 loop 设备连接到系统中</span>
</span></span><span class=line><span class=cl>› sudo losetup --find --partscan nixos-lp4a.img
</span></span><span class=line><span class=cl><span class=c1># 查看挂载的 loop 设备</span>
</span></span><span class=line><span class=cl>› lsblk <span class=p>|</span> grep loop
</span></span><span class=line><span class=cl>loop0               7:0    <span class=m>0</span>  1.9G  <span class=m>0</span> loop
</span></span><span class=line><span class=cl>├─loop0p1         259:8    <span class=m>0</span>  200M  <span class=m>0</span> part
</span></span><span class=line><span class=cl>└─loop0p2         259:9    <span class=m>0</span>  1.7G  <span class=m>0</span> part
</span></span><span class=line><span class=cl><span class=c1># 分别挂载镜像中的 boot 跟 rootfs 分区</span>
</span></span><span class=line><span class=cl>› mkdir boot root
</span></span><span class=line><span class=cl>› sudo mount /dev/loop0p1 boot
</span></span><span class=line><span class=cl>› sudo mount /dev/loop0p2 root
</span></span><span class=line><span class=cl><span class=c1># 查看 boot 分区内容</span>
</span></span><span class=line><span class=cl>› ls boot/
</span></span><span class=line><span class=cl>╭───┬───────────────────────────┬──────┬─────────┬──────────────╮
</span></span><span class=line><span class=cl>│ <span class=c1># │           name            │ type │  size   │   modified   │</span>
</span></span><span class=line><span class=cl>├───┼───────────────────────────┼──────┼─────────┼──────────────┤
</span></span><span class=line><span class=cl>│ <span class=m>0</span> │ boot/extlinux             │ dir  │  4.1 KB │ <span class=m>44</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>1</span> │ boot/fw_dynamic.bin       │ file │ 85.9 KB │ <span class=m>24</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>2</span> │ boot/light_aon_fpga.bin   │ file │ 50.3 KB │ <span class=m>24</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>3</span> │ boot/light_c906_audio.bin │ file │ 16.4 KB │ <span class=m>24</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>4</span> │ boot/nixos                │ dir  │  4.1 KB │ <span class=m>44</span> years ago │
</span></span><span class=line><span class=cl>╰───┴───────────────────────────┴──────┴─────────┴──────────────╯
</span></span><span class=line><span class=cl><span class=c1># 查看 root 分区内容</span>
</span></span><span class=line><span class=cl>› ls root/
</span></span><span class=line><span class=cl>╭───┬────────────────────────────┬──────┬──────────┬──────────────╮
</span></span><span class=line><span class=cl>│ <span class=c1># │            name            │ type │   size   │   modified   │</span>
</span></span><span class=line><span class=cl>├───┼────────────────────────────┼──────┼──────────┼──────────────┤
</span></span><span class=line><span class=cl>│ <span class=m>0</span> │ root/boot                  │ dir  │   4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>1</span> │ root/lost+found            │ dir  │  16.4 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>2</span> │ root/nix                   │ dir  │   4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>3</span> │ root/nix-path-registration │ file │ 242.0 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>╰───┴────────────────────────────┴──────┴──────────┴──────────────╯
</span></span></code></pre></td></tr></table></div></div><p>可以看到 NixOS 整个根目录（<code>/root</code>）下一共就四个文件夹，其中真正保存有系统数据的文件夹只有
<code>/boot</code> 跟 <code>/nix</code> 这两个，这与传统的 Linux 发行版大相径庭。有一点 Linux 使用经验的朋友都应
该清楚，传统的 Linux 发行版遵循 UNIX 系统的
<a href=https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard target=_blank rel="noopener noreferrer">FHS</a>
标准，根目录下会有很多
文件夹，比如
<code>/bin</code>、<code>/etc</code>、<code>/home</code>、<code>/lib</code>、<code>/opt</code>、<code>/root</code>、<code>/sbin</code>、<code>/srv</code>、<code>/tmp</code>、<code>/usr</code>、<code>/var</code>
等等。</p><p>那 NixOS 它这么玩，真的能正常启动么？这就是我在构建出镜像后却发现无法在 LicheePi 4A 上启动
时，最先产生的疑问。在询问 @chainsx 跟 @revy 系统无法启动的解决思路的时候，他们也一脸懵
逼，觉得这个文件树有点奇葩，很怀疑是我构建流程有问题导致文件树不完整。</p><p>但实际上 NixOS 就是这么玩的，它 rootfs 中所有的数据全都存放在 <code>/nix/store</code> 这个目录下并且
被挂载为只读，其他的文件夹以及其中的文件都是在运行时动态创建的。这是它实现声明式系统配置、
可回滚更新、可并行安装多个版本的软件包等等特性的基础。</p><p>下面继续分析，先仔细看下 <code>/boot</code> 的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>› tree boot
</span></span><span class=line><span class=cl>boot
</span></span><span class=line><span class=cl>├── extlinux
</span></span><span class=line><span class=cl>│   └── extlinux.conf
</span></span><span class=line><span class=cl>├── fw_dynamic.bin
</span></span><span class=line><span class=cl>├── light_aon_fpga.bin
</span></span><span class=line><span class=cl>├── light_c906_audio.bin
</span></span><span class=line><span class=cl>└── nixos
</span></span><span class=line><span class=cl>    ├── 2n6fjh4lhzaswbyacaf72zmz6mdsmm8l-initrd-k-riscv64-unknown-linux-gnu-initrd
</span></span><span class=line><span class=cl>    ├── l18cz7jd37n35dwyf8wc8divm46k7sdf-k-riscv64-unknown-linux-gnu-dtbs
</span></span><span class=line><span class=cl>    │   ├── sifive
</span></span><span class=line><span class=cl>    │   │   └── hifive-unleashed-a00.dtb
</span></span><span class=line><span class=cl>    │   └── thead
</span></span><span class=line><span class=cl>    │       ├── fire-emu-crash.dtb
</span></span><span class=line><span class=cl>    │       ├── fire-emu.dtb
</span></span><span class=line><span class=cl>    │       ├── ...... <span class=o>(</span>省略<span class=o>)</span>
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-audio.dtb
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-dsi0-hdmi.dtb
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-dsp.dtb
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-gpu.dtb
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-hdmi.dtb
</span></span><span class=line><span class=cl>    │       ├── light-lpi4a-ddr2G.dtb
</span></span><span class=line><span class=cl>    │       └── light_mpw.dtb
</span></span><span class=line><span class=cl>    └── l18cz7jd37n35dwyf8wc8divm46k7sdf-k-riscv64-unknown-linux-gnu-Image
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>6</span> directories, <span class=m>64</span> files
</span></span></code></pre></td></tr></table></div></div><p>可以看到：</p><ol><li>它使用 <code>/boot/extlinux/extlinux.conf</code> 作为 U-Boot 的启动项配置，据
<a href=https://github.com/ARM-software/u-boot/blob/master/doc/README.distro target=_blank rel="noopener noreferrer">U-Boot 官方的 Distro 文档</a>
所言，这是 U-Boot 的标准配置文件。</li><li>另外还有一些 <code>xxx.bin</code> 文件，这些是一些硬件固件，其中的 <code>light_c906_audio.bin</code> 显然
是<a href="https://www.t-head.cn/product/C906?lang=zh" target=_blank rel="noopener noreferrer">玄铁 906</a>
这个 IP 核的音频固件，其他的后
面再研究。</li><li>NixOS 的 <code>initrd</code>, <code>dtbs</code> 以及 <code>Image</code> 文件都是在 <code>/boot/nixos</code> 下，这三个文件也都是跟
Linux 的启动相关的，现在不用管它们，下一步会分析。</li></ol><p>再看下 <code>/boot/extlinux/extlinux.conf</code> 的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>› cat boot/extlinux/extlinux.conf
</span></span><span class=line><span class=cl><span class=c1># Generated file, all changes will be lost on nixos-rebuild!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Change this to e.g. nixos-42 to temporarily boot to an older configuration.</span>
</span></span><span class=line><span class=cl>DEFAULT nixos-default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MENU TITLE ------------------------------------------------------------
</span></span><span class=line><span class=cl>TIMEOUT <span class=m>50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>LABEL nixos-default
</span></span><span class=line><span class=cl>  MENU LABEL NixOS - Default
</span></span><span class=line><span class=cl>  LINUX ../nixos/l18cz7jd37n35dwyf8wc8divm46k7sdf-k-riscv64-unknown-linux-gnu-Image
</span></span><span class=line><span class=cl>  INITRD ../nixos/2n6fjh4lhzaswbyacaf72zmz6mdsmm8l-initrd-k-riscv64-unknown-linux-gnu-initrd
</span></span><span class=line><span class=cl>  APPEND <span class=nv>init</span><span class=o>=</span>/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b/init <span class=nv>console</span><span class=o>=</span>ttyS0,115200 <span class=nv>root</span><span class=o>=</span><span class=nv>UUID</span><span class=o>=</span>14e19a7b-0ae0-484d-9d54-43bd6fdc20c7 <span class=nv>rootfstype</span><span class=o>=</span>ext4 rootwait rw earlycon clk_ignore_unused <span class=nv>eth</span><span class=o>=</span><span class=nv>$ethaddr</span> <span class=nv>rootrwoptions</span><span class=o>=</span>rw,noatime <span class=nv>rootrwreset</span><span class=o>=</span>yes <span class=nv>loglevel</span><span class=o>=</span><span class=m>4</span>
</span></span><span class=line><span class=cl>  FDT ../nixos/l18cz7jd37n35dwyf8wc8divm46k7sdf-k-riscv64-unknown-linux-gnu-dtbs/thead/light-lpi4a.dtb
</span></span></code></pre></td></tr></table></div></div><p>从上述配置中能获得这些信息：</p><ol><li>它创建了一个名为 <code>nixos-default</code> 的启动项并将它设为了默认启动项，extlinux 在启动阶段会
根据该配置启动 NixOS 系统</li><li>启动项中的 <code>LINUX</code> <code>INITRD</code> <code>FDT</code> 三个参数分别指定了 kernel(Image 文件)、initrd 以及设
备树（dtb）的位置，这三个文件我们在前面已经看到了，都在 <code>/boot/nixos</code> 下。<ol><li>根据 Linux 官方文档
<a href=https://docs.kernel.org/admin-guide/initrd.html target=_blank rel="noopener noreferrer">Using the initial RAM disk (initrd)</a>
所言，在使用了 initrd 这个内存盘的情况下，Linux 的启动流程如下：<ol><li>bootloader(这里是 u-boot) 根据配置加载 kernel 文件（<code>Image</code>）、dtb 设备树文件以及
<code>initrd</code> 文件系统，然后以设备树跟 initrd 的地址为参数启动 Kernel.</li><li>Kernel 将传入的 initrd 转换成一个内存盘并挂载为根文件系统，然后释放 initrd 的内
存。</li><li>Kernel 接着运行 <code>init</code> 参数指定的可执行程序，这里是
<code>/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b/init</code>，
这个 init 程序会挂载真正的根文件系统，并在其上执行后续的启动流程。</li><li>initrd 文件系统被移除，系统启动完毕。</li></ol></li><li><code>initrd</code> 这样一个临时的内存盘，通常用于在系统启动阶段加载一些内核中未内置但启动却必
需的驱动或数据文件供 <code>init</code> 程序使用，以便后续能够挂载真正的根文件系统。<ol><li>比如说挂载一个 LUKS 加密的根文件系统，这通常会涉及到提示用户输入 passphrase、从某
个地方读取解密用的 keyfile 或者与插入的 USB 硬件密钥交互，这会需要读取内核之外的
keyfile 文件、用到内核之外的加密模块、USB 驱动、HID 用户输入输出模块或者其他因为
许可协议、模块大小等问题无法被静态链接到内核中的各种内核模块或程序。initrd 就是用
来解决这些问题的。</li></ol></li></ol></li><li><code>APPEND</code> 参数包含有许多关键信息：<ol><li>系统的 init 程序，也就是传说中的 1 号进程（PID 1），被设置为
<code>/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b/init</code>，
这实际是一个 shell 脚本，我们下一步会重点分析它。<ol><li>在传统的 Linux 发行版中，init 通常使用默认值 <code>/sbin/init</code>，它会被链接到
<code>/lib/systemd/systemd</code>，也就是直接使用 systemd 作为 1 号进程。你可以在
Fedora/Ubuntu 等传统发行版中运行 <code>ls -al /sbin/init</code> 确认这一点，以及检查它们的
<code>/boot/grub/grub.cfs</code> 启动项配置，看看它们有无自定义内核的 <code>init</code> 参数。</li></ol></li><li>系统的 rootfs 分区为 <code>/dev/disk/by-uuid/14e19a7b-0ae0-484d-9d54-43bd6fdc20c7</code>，使用
的文件系统为 ext4.</li><li><code>earlycon</code>(early console) 表示在系统启动早期就启用控制台输出，这样可以在系统启动阶段
通过 UAER/HDMI 等接口看到相关的启动日志，方便调试。</li><li>其他参数先不管。</li></ol></li></ol><p>这样一分析就能得出结论：在执行 <code>init</code> 程序之前的启动流程都未涉及到真正的根文件系统，NixOS
与其他发行版在该流程中并无明显差异。</p><h3 id=2-实际启动日志分析 class=headerLink><a href=#2-%e5%ae%9e%e9%99%85%e5%90%af%e5%8a%a8%e6%97%a5%e5%bf%97%e5%88%86%e6%9e%90 class=header-mark></a>2. 实际启动日志分析</h3><p>为了方便后续内容的理解，先看下 NixOS 系统在 LicheePi 4A 上的实际启动日志是个很不错的选择。</p><p>按我项目中的 README 正常烧录好系统后，使用 USB 转串口工具连接到 LicheePi 4A 的 UART0 串
口，然后启动系统，就能看到 NixOS 的启动日志。</p><p>接线示例：</p><p><figure><img src=./lp4a-pinout-debuglog-1.webp width=80%><figcaption><h4>LicheePi4A UART 调试接线 - 正面</h4></figcaption></figure><figure><img src=./lp4a-pinout-debuglog-2.webp width=80%><figcaption><h4>LicheePi4A UART 调试接线 - 反面</h4></figcaption></figure></p><p>接好线后使用 minicom 查看日志：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>› ls /dev/ttyUSB0
</span></span><span class=line><span class=cl>╭───┬──────────────┬─────────────┬──────┬───────────────╮
</span></span><span class=line><span class=cl>│ <span class=c1># │     name     │    type     │ size │   modified    │</span>
</span></span><span class=line><span class=cl>├───┼──────────────┼─────────────┼──────┼───────────────┤
</span></span><span class=line><span class=cl>│ <span class=m>0</span> │ /dev/ttyUSB0 │ char device │  <span class=m>0</span> B │ <span class=m>6</span> minutes ago │
</span></span><span class=line><span class=cl>╰───┴──────────────┴─────────────┴──────┴───────────────╯
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>› minicom -d /dev/ttyusb0 -b <span class=m>115200</span>
</span></span></code></pre></td></tr></table></div></div><p>一个正常的启动日志示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Welcome to minicom 2.8
</span></span><span class=line><span class=cl>brom_ver 8
</span></span><span class=line><span class=cl>[APP][E] protocol_connect failed, exit.
</span></span><span class=line><span class=cl>OpenSBI v0.9
</span></span><span class=line><span class=cl>   ____                    _____ ____ _____
</span></span><span class=line><span class=cl>  / __ \                  / ____|  _ \_   _|
</span></span><span class=line><span class=cl> | |  | |_ __   ___ _ __ | (___ | |_) || |
</span></span><span class=line><span class=cl> | |  | | &#39;_ \ / _ \ &#39;_ \ \___ \|  _ &lt; | |
</span></span><span class=line><span class=cl> | |__| | |_) |  __/ | | |____) | |_) || |_
</span></span><span class=line><span class=cl>  \____/| .__/ \___|_| |_|_____/|____/_____|
</span></span><span class=line><span class=cl>        | |
</span></span><span class=line><span class=cl>        |_|
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Platform Name             : T-HEAD Light Lichee Pi 4A configuration for 8GB DDR board
</span></span><span class=line><span class=cl>Platform Features         : mfdeleg
</span></span><span class=line><span class=cl>Platform HART Count       : 4
</span></span><span class=line><span class=cl>Platform IPI Device       : clint
</span></span><span class=line><span class=cl>Platform Timer Device     : clint
</span></span><span class=line><span class=cl>Platform Console Device   : uart8250
</span></span><span class=line><span class=cl>Platform HSM Device       : ---
</span></span><span class=line><span class=cl>Platform SysReset Device  : thead_reset
</span></span><span class=line><span class=cl>Firmware Base             : 0x0
</span></span><span class=line><span class=cl>Firmware Size             : 132 KB
</span></span><span class=line><span class=cl>Runtime SBI Version       : 0.3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Domain0 Name              : root
</span></span><span class=line><span class=cl>Domain0 Boot HART         : 0
</span></span><span class=line><span class=cl>Domain0 HARTs             : 0*,1*,2*,3*
</span></span><span class=line><span class=cl>Domain0 Region00          : 0x000000ffdc000000-0x000000ffdc00ffff (I)
</span></span><span class=line><span class=cl>Domain0 Region01          : 0x0000000000000000-0x000000000003ffff ()
</span></span><span class=line><span class=cl>Domain0 Region02          : 0x0000000000000000-0xffffffffffffffff (R,W,X)
</span></span><span class=line><span class=cl>Domain0 Next Address      : 0x0000000000200000
</span></span><span class=line><span class=cl>Domain0 Next Arg1         : 0x0000000001f00000
</span></span><span class=line><span class=cl>Domain0 Next Mode         : S-mode
</span></span><span class=line><span class=cl>Domain0 SysReset          : yes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Boot HART ID              : 0
</span></span><span class=line><span class=cl>Boot HART Domain          : root
</span></span><span class=line><span class=cl>Boot HART ISA             : rv64imafdcvsux
</span></span><span class=line><span class=cl>Boot HART Features        : scounteren,mcounteren,time
</span></span><span class=line><span class=cl>Boot HART PMP Count       : 0
</span></span><span class=line><span class=cl>Boot HART PMP Granularity : 0
</span></span><span class=line><span class=cl>Boot HART PMP Address Bits: 0
</span></span><span class=line><span class=cl>Boot HART MHPM Count      : 16
</span></span><span class=line><span class=cl>Boot HART MHPM Count      : 16
</span></span><span class=line><span class=cl>Boot HART MIDELEG         : 0x0000000000000222
</span></span><span class=line><span class=cl>Boot HART MEDELEG         : 0x000000000000b109
</span></span><span class=line><span class=cl>[    0.000000] Linux version 5.10.113 (nixbld@localhost) (riscv64-unknown-linux-gnu-gcc (GCC) 13.1.0, GN0
</span></span><span class=line><span class=cl>[    0.000000] OF: fdt: Ignoring memory range 0x0 - 0x200000
</span></span><span class=line><span class=cl>[    0.000000] earlycon: uart0 at MMIO32 0x000000ffe7014000 (options &#39;115200n8&#39;)
</span></span><span class=line><span class=cl>[    0.000000] printk: bootconsole [uart0] enabled
</span></span><span class=line><span class=cl>[    2.292495] (NULL device *): failed to find vdmabuf_reserved_memory node
</span></span><span class=line><span class=cl>[    2.453953] spi-nor spi0.0: unrecognized JEDEC id bytes: ff ff ff ff ff ff
</span></span><span class=line><span class=cl>[    2.460971] dw_spi_mmio ffe700c000.spi: cs1 &gt;= max 1
</span></span><span class=line><span class=cl>[    2.466001] spi_master spi0: spi_device register error /soc/spi@ffe700c000/spidev@1
</span></span><span class=line><span class=cl>[    2.497453] sdhci-dwcmshc ffe70a0000.sd: can&#39;t request region for resource [mem 0xffef014064-0xffef01]
</span></span><span class=line><span class=cl>[    2.509014] misc vhost-vdmabuf: failed to find vdmabuf_reserved_memory node
</span></span><span class=line><span class=cl>[    3.386036] debugfs: File &#39;SDOUT&#39; in directory &#39;dapm&#39; already present!
</span></span><span class=line><span class=cl>[    3.392692] debugfs: File &#39;Playback&#39; in directory &#39;dapm&#39; already present!
</span></span><span class=line><span class=cl>[    3.399524] debugfs: File &#39;Capture&#39; in directory &#39;dapm&#39; already present!
</span></span><span class=line><span class=cl>[    3.406262] debugfs: File &#39;Playback&#39; in directory &#39;dapm&#39; already present!
</span></span><span class=line><span class=cl>[    3.413067] debugfs: File &#39;Capture&#39; in directory &#39;dapm&#39; already present!
</span></span><span class=line><span class=cl>[    3.425466] aw87519_pa 5-0058: aw87519_parse_dt: no reset gpio provided failed
</span></span><span class=line><span class=cl>[    3.432752] aw87519_pa 5-0058: aw87519_i2c_probe: failed to parse device tree node
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;&lt;&lt; NixOS Stage 1 &gt;&gt;&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>running udev...
</span></span><span class=line><span class=cl>Starting systemd-udevd version 253.6
</span></span><span class=line><span class=cl>kbd_mode: KDSKBMODE: Inappropriate ioctl for device
</span></span><span class=line><span class=cl>Gstarting device mapper and LVM...
</span></span><span class=line><span class=cl>checking /dev/disk/by-label/NIXOS_SD...
</span></span><span class=line><span class=cl>fsck (busybox 1.36.1)
</span></span><span class=line><span class=cl>[fsck.ext4 (1) -- /mnt-root/] fsck.ext4 -a /dev/disk/by-label/NIXOS_SD
</span></span><span class=line><span class=cl>NIXOS_SD: recovering journal
</span></span><span class=line><span class=cl>NIXOS_SD: clean, 148061/248000 files, 818082/984159 blocks
</span></span><span class=line><span class=cl>mounting /dev/disk/by-label/NIXOS_SD on /...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;&lt;&lt; NixOS Stage 2 &gt;&gt;&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>running activation script...
</span></span><span class=line><span class=cl>setting up /etc...
</span></span><span class=line><span class=cl>++ /nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin/bin/findm/
</span></span><span class=line><span class=cl>+ rootPart=/dev/disk/by-label/NIXOS_SD
</span></span><span class=line><span class=cl>++ lsblk -npo PKNAME /dev/disk/by-label/NIXOS_SD
</span></span><span class=line><span class=cl>+ bootDevice=/dev/mmcblk1
</span></span><span class=line><span class=cl>++ lsblk -npo MAJ:MIN /dev/disk/by-label/NIXOS_SD
</span></span><span class=line><span class=cl>++ /nix/store/zag1z2yvsh2ccpsbgsda7xhv4sfha7mj-gawk-riscv64-unknown-linux-gnu-5.2.1/bin/awk -F: &#39;{print &#39;
</span></span><span class=line><span class=cl>+ partNum=&#39;26 &#39;
</span></span><span class=line><span class=cl>+ echo ,+,
</span></span><span class=line><span class=cl>+ sfdisk -N26 --no-reread /dev/mmcblk1
</span></span><span class=line><span class=cl>GPT PMBR size mismatch (8332023 != 122894335) will be corrected by write.
</span></span><span class=line><span class=cl>The backup GPT table is not on the end of the device. This problem will be corrected by write.
</span></span><span class=line><span class=cl>warning: /dev/mmcblk1: partition 26 is not defined yet
</span></span><span class=line><span class=cl>Disk /dev/mmcblk1: 58.6 GiB, 62921900032 bytes, 122894336 sectors
</span></span><span class=line><span class=cl>Units: sectors of 1 * 512 = 512 bytes
</span></span><span class=line><span class=cl>Sector size (logical/physical): 512 bytes / 512 bytes
</span></span><span class=line><span class=cl>I/O size (minimum/optimal): 512 bytes / 512 bytes
</span></span><span class=line><span class=cl>Disklabel type: gpt
</span></span><span class=line><span class=cl>Disk identifier: 58B10C85-BB4D-F94A-9194-82020FC9DC23
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Old situation:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Device          Start     End Sectors  Size Type
</span></span><span class=line><span class=cl>/dev/mmcblk1p1  16384  425983  409600  200M Microsoft basic data
</span></span><span class=line><span class=cl>/dev/mmcblk1p2 425984 8331990 7906007  3.8G Linux filesystem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/dev/mmcblk1p26: Created a new partition 3 of type &#39;Linux filesystem&#39; and of size 54.6 GiB.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>New situation:
</span></span><span class=line><span class=cl>Disklabel type: gpt
</span></span><span class=line><span class=cl>Disk identifier: 58B10C85-BB4D-F94A-9194-82020FC9DC23
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Device           Start       End   Sectors  Size Type
</span></span><span class=line><span class=cl>/dev/mmcblk1p1   16384    425983    409600  200M Microsoft basic data
</span></span><span class=line><span class=cl>/dev/mmcblk1p2  425984   8331990   7906007  3.8G Linux filesystem
</span></span><span class=line><span class=cl>/dev/mmcblk1p3 8333312 122892287 114558976 54.6G Linux filesystem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>The partition table has been altered.
</span></span><span class=line><span class=cl>Calling ioctl() to re-read partition table.
</span></span><span class=line><span class=cl>Re-reading the partition table failed.: Device or resource busy
</span></span><span class=line><span class=cl>The kernel still uses the old table. The new table will be used at the next reboot or after you run part.
</span></span><span class=line><span class=cl>Syncing disks.
</span></span><span class=line><span class=cl>+ /nix/store/wm9ynqbkqi7gagggb4y6f4l454kkga32-parted-riscv64-unknown-linux-gnu-3.6/bin/partprobe
</span></span><span class=line><span class=cl>+ /nix/store/yln7ma9dldr3f2dva4l0iq275s4brxml-e2fsprogs-riscv64-unknown-linux-gnu-1.46.6-bin/bin/resize2D
</span></span><span class=line><span class=cl>resize2fs 1.46.6 (1-Feb-2023)
</span></span><span class=line><span class=cl>Filesystem at /dev/disk/by-label/NIXOS_SD is mounted on /; on-line resizing required
</span></span><span class=line><span class=cl>old_desc_blocks = 1, new_desc_blocks = 1
</span></span><span class=line><span class=cl>The filesystem on /dev/disk/by-label/NIXOS_SD is now 988250 (4k) blocks long.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>+ /nix/store/f5w7dd1f195bxkashhr5x0a788nxrxvc-nix-riscv64-unknown-linux-gnu-2.13.3/bin/nix-store --load-b
</span></span><span class=line><span class=cl>+ touch /etc/NIXOS
</span></span><span class=line><span class=cl>+ /nix/store/f5w7dd1f195bxkashhr5x0a788nxrxvc-nix-riscv64-unknown-linux-gnu-2.13.3/bin/nix-env -p /nix/vm
</span></span><span class=line><span class=cl>+ rm -f /nix-path-registration
</span></span><span class=line><span class=cl>starting systemd...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Welcome to NixOS 23.05 (Stoat)!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[  OK  ] Created slice Slice /system/getty.
</span></span><span class=line><span class=cl>[  OK  ] Created slice Slice /system/modprobe.
</span></span><span class=line><span class=cl>[  OK  ] Created slice Slice /system/serial-getty.......
</span></span><span class=line><span class=cl>......
</span></span></code></pre></td></tr></table></div></div><p>简单总结下日志中的信息：</p><ol><li>整个启动流程被分成了三个阶段，分别是：<ol><li>OpenSBI: 这个阶段貌似进行了一些硬件相关的初始化，比如说串口、SPI、SD 卡等，貌似还有
些报错，先不管。</li><li>NixOS Stage 1: 这应该就是 <code>initrd</code> 阶段干的活，内核加载了 systemd udev 内核模块，然
后使用 busybox 的 fsck 检查了根文件系统，接着挂载了根文件系统。</li><li>NixOS Stage 2:<ol><li>运行了一个什么<code>activation script</code>，它首先设置好了 <code>/etc</code> 文件夹，然后检查了根分区
文件系统的情况，并自动执行了分区与文件系统的扩容操作。</li><li>接着通过 <code>nix-env -p /nix/vm...</code> 大概是切换了个运行环境。</li><li>最后启动了 systemd，这之后的流程就跟其他发行版没啥区别了（都是 systemd）。</li></ol></li></ol></li></ol><h3 id=3-init-程序分析 class=headerLink><a href=#3-init-%e7%a8%8b%e5%ba%8f%e5%88%86%e6%9e%90 class=header-mark></a>3. init 程序分析</h3><p>有了上面这些信息，我们就可以比较容易地理解 init 这个程序了，它主要对应前面日志中的 NixOS
Stage 2，即在真正挂载根文件系统之后，执行的第一个用户态程序。</p><p>在 NixOS 中这个 init 程序实际上是一个 shell 脚本，可以直接通过 <code>cat</code> 或者 <code>vim</code> 来查看它的
内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>› cat /nix/store/a5gnycsy3cq4ix2k8624649zj8xqzkxc-nixos-system-nixos-23.05.20230624.3ef8b37/init
</span></span><span class=line><span class=cl><span class=c1>#! /nix/store/91hllz70n1b0qkb0r9iw1bg9xzx66a3b-bash-5.2-p15-riscv64-unknown-linux-gnu/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>systemConfig</span><span class=o>=</span>/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>HOME</span><span class=o>=</span>/root <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;/nix/store/fifbf1h3i83jvan2vkk7xm4fraq7drm7-coreutils-riscv64-unknown-linux-gnu-9.1/bin:/nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin/bin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Process the kernel command line.</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> o in <span class=k>$(</span>&lt;/proc/cmdline<span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nv>$o</span> in
</span></span><span class=line><span class=cl>            boot.debugtrace<span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># Show each command.</span>
</span></span><span class=line><span class=cl>                <span class=nb>set</span> -x
</span></span><span class=line><span class=cl>                <span class=p>;;</span>
</span></span><span class=line><span class=cl>        <span class=k>esac</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Print a greeting.</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\e[1;32m&lt;&lt;&lt; NixOS Stage 2 &gt;&gt;&gt;\e[0m&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Normally, stage 1 mounts the root filesystem read/writable.</span>
</span></span><span class=line><span class=cl>    <span class=c1># However, in some environments, stage 2 is executed directly, and the</span>
</span></span><span class=line><span class=cl>    <span class=c1># root is read-only.  So make it writable here.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$container</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        mount -n -o remount,rw none /
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Likewise, stage 1 mounts /proc, /dev and /sys, so if we don&#39;t have a</span>
</span></span><span class=line><span class=cl><span class=c1># stage 1, we need to do that here.</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -e /proc/1 <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    specialMount<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>device</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>mountPoint</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>options</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$3</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>fsType</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$4</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># We must not overwrite this mount because it&#39;s bind-mounted</span>
</span></span><span class=line><span class=cl>        <span class=c1># from stage 1&#39;s /run</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>mountPoint</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span> /run <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        install -m <span class=m>0755</span> -d <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        mount -n -t <span class=s2>&#34;</span><span class=nv>$fsType</span><span class=s2>&#34;</span> -o <span class=s2>&#34;</span><span class=nv>$options</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>source</span> /nix/store/vn0sga6rn69vkdbs0d2njh0aig7zmzi6-mounts.sh
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;booting system configuration </span><span class=si>${</span><span class=nv>systemConfig</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;booting system configuration </span><span class=nv>$systemConfig</span><span class=s2>&#34;</span> &gt; /dev/kmsg
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make /nix/store a read-only bind mount to enforce immutability of</span>
</span></span><span class=line><span class=cl><span class=c1># the Nix store.  Note that we can&#39;t use &#34;chown root:nixbld&#34; here</span>
</span></span><span class=line><span class=cl><span class=c1># because users/groups might not exist yet.</span>
</span></span><span class=line><span class=cl><span class=c1># Silence chown/chmod to fail gracefully on a readonly filesystem</span>
</span></span><span class=line><span class=cl><span class=c1># like squashfs.</span>
</span></span><span class=line><span class=cl>chown -f 0:30000 /nix/store
</span></span><span class=line><span class=cl>chmod -f <span class=m>1775</span> /nix/store
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;1&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> ! <span class=o>[[</span> <span class=s2>&#34;</span><span class=k>$(</span>findmnt --noheadings --output OPTIONS /nix/store<span class=k>)</span><span class=s2>&#34;</span> <span class=o>=</span>~ ro<span class=o>(</span>,<span class=p>|</span>$<span class=o>)</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$container</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            mount --bind /nix/store /nix/store
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            mount --rbind /nix/store /nix/store
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        mount -o remount,ro,bind /nix/store
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Use /etc/resolv.conf supplied by systemd-nspawn, if applicable.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> -e /etc/resolv.conf <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        resolvconf -m <span class=m>1000</span> -a host &lt;/etc/resolv.conf
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Log the script output to /dev/kmsg or /run/log/stage-2-init.log.</span>
</span></span><span class=line><span class=cl>    <span class=c1># Only at this point are all the necessary prerequisites ready for these commands.</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> <span class=o>{</span>logOutFd<span class=o>}</span>&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=o>{</span>logErrFd<span class=o>}</span>&gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>test</span> -w /dev/kmsg<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>exec</span> &gt; &gt;<span class=o>(</span>tee -i /proc/self/fd/<span class=s2>&#34;</span><span class=nv>$logOutFd</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=k>while</span> <span class=nb>read</span> -r line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>test</span> -n <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                <span class=nb>echo</span> <span class=s2>&#34;&lt;7&gt;stage-2-init: </span><span class=nv>$line</span><span class=s2>&#34;</span> &gt; /dev/kmsg
</span></span><span class=line><span class=cl>            <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>done</span><span class=o>)</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        mkdir -p /run/log
</span></span><span class=line><span class=cl>        <span class=nb>exec</span> &gt; &gt;<span class=o>(</span>tee -i /run/log/stage-2-init.log<span class=o>)</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Required by the activation script</span>
</span></span><span class=line><span class=cl>install -m <span class=m>0755</span> -d /etc /etc/nixos
</span></span><span class=line><span class=cl>install -m <span class=m>01777</span> -d /tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run the script that performs all configuration activation that does</span>
</span></span><span class=line><span class=cl><span class=c1># not have to be done at boot time.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;running activation script...&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$systemConfig</span>/activate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Record the boot configuration.</span>
</span></span><span class=line><span class=cl>ln -sfn <span class=s2>&#34;</span><span class=nv>$systemConfig</span><span class=s2>&#34;</span> /run/booted-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run any user-specified commands.</span>
</span></span><span class=line><span class=cl>/nix/store/91hllz70n1b0qkb0r9iw1bg9xzx66a3b-bash-5.2-p15-riscv64-unknown-linux-gnu/bin/bash /nix/store/cmvnjz39iq4bx4cq3lvri2jj0sjq5h24-local-cmds
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure systemd doesn&#39;t try to populate /etc, by forcing its first-boot</span>
</span></span><span class=line><span class=cl><span class=c1># heuristic off. It doesn&#39;t matter what&#39;s in /etc/machine-id for this purpose,</span>
</span></span><span class=line><span class=cl><span class=c1># and systemd will immediately fill in the file when it starts, so just</span>
</span></span><span class=line><span class=cl><span class=c1># creating it is enough. This `: &gt;&gt;` pattern avoids forking and avoids changing</span>
</span></span><span class=line><span class=cl><span class=c1># the mtime if the file already exists.</span>
</span></span><span class=line><span class=cl>: &gt;&gt; /etc/machine-id
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># No need to restore the stdout/stderr streams we never redirected and</span>
</span></span><span class=line><span class=cl><span class=c1># especially no need to start systemd</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Reset the logging file descriptors.</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> 1&gt;<span class=p>&amp;</span><span class=nv>$logOutFd</span> 2&gt;<span class=p>&amp;</span><span class=nv>$logErrFd</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> <span class=o>{</span>logOutFd<span class=o>}</span>&gt;<span class=p>&amp;</span>- <span class=o>{</span>logErrFd<span class=o>}</span>&gt;<span class=p>&amp;</span>-
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Start systemd in a clean environment.</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;starting systemd...&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> /run/current-system/systemd/lib/systemd/systemd <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><p>简单总结下这个脚本的功能：</p><ol><li>通过 <code>mount -o remount,ro,bind /nix/store</code> 将 <code>/nix/store</code> 目录重新挂载为只读，确保 Nix
Store 的不可变性，从而使系统状态可复现。</li><li>直接开始执行 <code>$systemConfig/activate</code> 这个程序。</li><li>activate 完毕后，启动真正的 1 号进程 systemd，进入后续启动流程。</li></ol><h3 id=4-activate-程序分析 class=headerLink><a href=#4-activate-%e7%a8%8b%e5%ba%8f%e5%88%86%e6%9e%90 class=header-mark></a>4. activate 程序分析</h3><p>前面的 init 程序其实没干啥，根据我们看过的启动日志，大部分的功能应该都是在
<code>$systemConfig/activate</code> 这个程序中完成的。</p><p>再看看其中的 $systemConfig/activate 的内容，它同样是一个 shell 脚本，直接 <code>cat</code>/<code>vim</code> 查看
下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span><span class=lnt>312
</span><span class=lnt>313
</span><span class=lnt>314
</span><span class=lnt>315
</span><span class=lnt>316
</span><span class=lnt>317
</span><span class=lnt>318
</span><span class=lnt>319
</span><span class=lnt>320
</span><span class=lnt>321
</span><span class=lnt>322
</span><span class=lnt>323
</span><span class=lnt>324
</span><span class=lnt>325
</span><span class=lnt>326
</span><span class=lnt>327
</span><span class=lnt>328
</span><span class=lnt>329
</span><span class=lnt>330
</span><span class=lnt>331
</span><span class=lnt>332
</span><span class=lnt>333
</span><span class=lnt>334
</span><span class=lnt>335
</span><span class=lnt>336
</span><span class=lnt>337
</span><span class=lnt>338
</span><span class=lnt>339
</span><span class=lnt>340
</span><span class=lnt>341
</span><span class=lnt>342
</span><span class=lnt>343
</span><span class=lnt>344
</span><span class=lnt>345
</span><span class=lnt>346
</span><span class=lnt>347
</span><span class=lnt>348
</span><span class=lnt>349
</span><span class=lnt>350
</span><span class=lnt>351
</span><span class=lnt>352
</span><span class=lnt>353
</span><span class=lnt>354
</span><span class=lnt>355
</span><span class=lnt>356
</span><span class=lnt>357
</span><span class=lnt>358
</span><span class=lnt>359
</span><span class=lnt>360
</span><span class=lnt>361
</span><span class=lnt>362
</span><span class=lnt>363
</span><span class=lnt>364
</span><span class=lnt>365
</span><span class=lnt>366
</span><span class=lnt>367
</span><span class=lnt>368
</span><span class=lnt>369
</span><span class=lnt>370
</span><span class=lnt>371
</span><span class=lnt>372
</span><span class=lnt>373
</span><span class=lnt>374
</span><span class=lnt>375
</span><span class=lnt>376
</span><span class=lnt>377
</span><span class=lnt>378
</span><span class=lnt>379
</span><span class=lnt>380
</span><span class=lnt>381
</span><span class=lnt>382
</span><span class=lnt>383
</span><span class=lnt>384
</span><span class=lnt>385
</span><span class=lnt>386
</span><span class=lnt>387
</span><span class=lnt>388
</span><span class=lnt>389
</span><span class=lnt>390
</span><span class=lnt>391
</span><span class=lnt>392
</span><span class=lnt>393
</span><span class=lnt>394
</span><span class=lnt>395
</span><span class=lnt>396
</span><span class=lnt>397
</span><span class=lnt>398
</span><span class=lnt>399
</span><span class=lnt>400
</span><span class=lnt>401
</span><span class=lnt>402
</span><span class=lnt>403
</span><span class=lnt>404
</span><span class=lnt>405
</span><span class=lnt>406
</span><span class=lnt>407
</span><span class=lnt>408
</span><span class=lnt>409
</span><span class=lnt>410
</span><span class=lnt>411
</span><span class=lnt>412
</span><span class=lnt>413
</span><span class=lnt>414
</span><span class=lnt>415
</span><span class=lnt>416
</span><span class=lnt>417
</span><span class=lnt>418
</span><span class=lnt>419
</span><span class=lnt>420
</span><span class=lnt>421
</span><span class=lnt>422
</span><span class=lnt>423
</span><span class=lnt>424
</span><span class=lnt>425
</span><span class=lnt>426
</span><span class=lnt>427
</span><span class=lnt>428
</span><span class=lnt>429
</span><span class=lnt>430
</span><span class=lnt>431
</span><span class=lnt>432
</span><span class=lnt>433
</span><span class=lnt>434
</span><span class=lnt>435
</span><span class=lnt>436
</span><span class=lnt>437
</span><span class=lnt>438
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>› cat root/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b/activate
</span></span><span class=line><span class=cl><span class=c1>#!/nix/store/91hllz70n1b0qkb0r9iw1bg9xzx66a3b-bash-5.2-p15-riscv64-unknown-linux-gnu/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>systemConfig</span><span class=o>=</span><span class=s1>&#39;/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span>/empty
</span></span><span class=line><span class=cl><span class=k>for</span> i in /nix/store/fifbf1h3i83jvan2vkk7xm4fraq7drm7-coreutils-riscv64-unknown-linux-gnu-9.1 /nix/store/x3hfwbwcqgl9zpqrk8kvm3p2kjns9asm-gnugrep-riscv64-unknown-linux-gnu-3.7 /nix/store/qn0yhj5d7r432rdh1885cn40gz184ww9-findutils-riscv64-unknown-linux-gnu-4.9.0 /nix/store/slwk77dzar2l1c4h9fikdw93ig4wdfy1-getent-glibc-riscv64-unknown-linux-gnu-2.37-8 /nix/store/yrf57f5h1rwmf3q70msx35a2p9f0rsjr-glibc-riscv64-unknown-linux-gnu-2.37-8-bin /nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13 /nix/store/2imxx6v9xhy8mbbx9q1r2d991m81inar-net-tools-riscv64-unknown-linux-gnu-2.10 /nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:<span class=nv>$i</span>/bin:<span class=nv>$i</span>/sbin
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>_status</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>trap</span> <span class=s2>&#34;_status=1 _localstatus=\$?&#34;</span> ERR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure a consistent umask.</span>
</span></span><span class=line><span class=cl><span class=nb>umask</span> <span class=m>0022</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet specialfs:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>specialMount<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>device</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>mountPoint</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>options</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$3</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>fsType</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$4</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> mountpoint -q <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>options</span><span class=o>=</span><span class=s2>&#34;remount,</span><span class=nv>$options</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    mkdir -m <span class=m>0755</span> -p <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  mount -t <span class=s2>&#34;</span><span class=nv>$fsType</span><span class=s2>&#34;</span> -o <span class=s2>&#34;</span><span class=nv>$options</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> /nix/store/vn0sga6rn69vkdbs0d2njh0aig7zmzi6-mounts.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;specialfs&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet binfmt:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>mkdir -p -m <span class=m>0755</span> /run/binfmt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;binfmt&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet stdio:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;stdio&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet binsh:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Create the required /bin/sh symlink; otherwise lots of things</span>
</span></span><span class=line><span class=cl><span class=c1># (notably the system() function) won&#39;t work.</span>
</span></span><span class=line><span class=cl>mkdir -m <span class=m>0755</span> -p /bin
</span></span><span class=line><span class=cl>ln -sfn <span class=s2>&#34;/nix/store/4y83vxk3mfk216d1jjfjgckkxwrbassi-bash-interactive-5.2-p15-riscv64-unknown-linux-gnu/bin/sh&#34;</span> /bin/.sh.tmp
</span></span><span class=line><span class=cl>mv /bin/.sh.tmp /bin/sh <span class=c1># atomically replace /bin/sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;binsh&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet check-manual-docbook:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=k>$(</span>cat /nix/store/xzgmgymf510dicgppghq27lrh9fjpxfi-options-used-docbook<span class=k>)</span> <span class=o>=</span> <span class=m>1</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> -e <span class=s2>&#34;\e[31;1mwarning\e[0m: This configuration contains option documentation in docbook.&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>          <span class=s2>&#34;Support for docbook is deprecated and will be removed after NixOS 23.05.&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>          <span class=s2>&#34;See nix-store --read-log /nix/store/n232fhpqqqnlfjl0rj59xxms419glja2-options.json.drv&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;check-manual-docbook&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet domain:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;domain&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet users:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>install -m <span class=m>0700</span> -d /root
</span></span><span class=line><span class=cl>install -m <span class=m>0755</span> -d /home
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/nix/store/6fap9xv6snx5fr2m7m804v4gc23pb1jh-perl-riscv64-unknown-linux-gnu-5.36.0-env/bin/perl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-w /nix/store/gx91fdp4a099jpfwdkbdw2imvl3lalsk-update-users-groups.pl /nix/store/1zj6fk93qkqd3z8n34s4r40xnby2ci21-users-groups.json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;users&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet groups:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;groups&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet etc:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Set up the statically computed bits of /etc.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;setting up /etc...&#34;</span>
</span></span><span class=line><span class=cl>/nix/store/habrmd12my31s9r9fdby78l2dg5p7qyx-perl-riscv64-unknown-linux-gnu-5.36.0-env/bin/perl /nix/store/rg5rf512szdxmnj9qal3wfdnpfsx38qi-setup-etc.pl /nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;etc&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet hashes:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>users</span><span class=o>=()</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span>: <span class=nb>read</span> -r user <span class=nb>hash</span> tail<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$hash</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;</span>$<span class=s2>&#34;</span>* <span class=o>&amp;&amp;</span> ! <span class=s2>&#34;</span><span class=nv>$hash</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^<span class=se>\$</span><span class=o>(</span>y<span class=p>|</span>gy<span class=p>|</span>7<span class=p>|</span>2b<span class=p>|</span>2y<span class=p>|</span>2a<span class=p>|</span>6<span class=o>)</span><span class=se>\$</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>users</span><span class=o>+=(</span><span class=s2>&#34;</span><span class=nv>$user</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span> &lt;/etc/shadow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> <span class=s2>&#34;</span><span class=si>${#</span><span class=nv>users</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>WARNING: The following user accounts rely on password hashing algorithms
</span></span></span><span class=line><span class=cl><span class=s2>that have been removed. They need to be renewed as soon as possible, as
</span></span></span><span class=line><span class=cl><span class=s2>they do prevent their users from logging in.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s1>&#39; - %s\n&#39;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>users</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;hashes&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet hostname:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>hostname <span class=s2>&#34;lp4a&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;hostname&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet modprobe:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Allow the kernel to find our wrapped modprobe (which searches</span>
</span></span><span class=line><span class=cl><span class=c1># in the right location in the Nix store for kernel modules).</span>
</span></span><span class=line><span class=cl><span class=c1># We need this when the kernel (or some module) auto-loads a</span>
</span></span><span class=line><span class=cl><span class=c1># module.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> /nix/store/wv00igsmj6mkk1ybssdch52hx0hx0x67-kmod-riscv64-unknown-linux-gnu-30/bin/modprobe &gt; /proc/sys/kernel/modprobe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;modprobe&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet nix:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>install -m <span class=m>0755</span> -d /nix/var/nix/<span class=o>{</span>gcroots,profiles<span class=o>}</span>/per-user
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;nix&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet nix-channel:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Subscribe the root user to the NixOS channel by default.</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -e <span class=s2>&#34;/root/.nix-channels&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;https://nixos.org/channels/nixos-23.05 nixos&#34;</span> &gt; <span class=s2>&#34;/root/.nix-channels&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;nix-channel&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet systemd-timesyncd-init-clock:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! <span class=o>[</span> -f /var/lib/systemd/timesync/clock <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>test</span> -d /var/lib/systemd/timesync <span class=o>||</span> mkdir -p /var/lib/systemd/timesync
</span></span><span class=line><span class=cl>  touch /var/lib/systemd/timesync/clock
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;systemd-timesyncd-init-clock&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet udevd:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># The deprecated hotplug uevent helper is not used anymore</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -e /proc/sys/kernel/hotplug <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;&#34;</span> &gt; /proc/sys/kernel/hotplug
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow the kernel to find our firmware.</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -e /sys/module/firmware_class/parameters/path <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/ann0ayjx9qf296pssrk2b26fry235idz-firmware/lib/firmware&#34;</span> &gt; /sys/module/firmware_class/parameters/path
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;udevd&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet usrbinenv:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>mkdir -m <span class=m>0755</span> -p /usr/bin
</span></span><span class=line><span class=cl>ln -sfn /nix/store/fifbf1h3i83jvan2vkk7xm4fraq7drm7-coreutils-riscv64-unknown-linux-gnu-9.1/bin/env /usr/bin/.env.tmp
</span></span><span class=line><span class=cl>mv /usr/bin/.env.tmp /usr/bin/env <span class=c1># atomically replace /usr/bin/env</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;usrbinenv&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet var:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Various log/runtime directories.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir -m <span class=m>1777</span> -p /var/tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Empty, immutable home directory of many system accounts.</span>
</span></span><span class=line><span class=cl>mkdir -p /var/empty
</span></span><span class=line><span class=cl><span class=c1># Make sure it&#39;s really empty</span>
</span></span><span class=line><span class=cl>/nix/store/yln7ma9dldr3f2dva4l0iq275s4brxml-e2fsprogs-riscv64-unknown-linux-gnu-1.46.6-bin/bin/chattr -f -i /var/empty <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>find /var/empty -mindepth <span class=m>1</span> -delete
</span></span><span class=line><span class=cl>chmod <span class=m>0555</span> /var/empty
</span></span><span class=line><span class=cl>chown root:root /var/empty
</span></span><span class=line><span class=cl>/nix/store/yln7ma9dldr3f2dva4l0iq275s4brxml-e2fsprogs-riscv64-unknown-linux-gnu-1.46.6-bin/bin/chattr -f +i /var/empty <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;var&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet wrappers:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> <span class=s2>&#34;/run/wrappers&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># We want to place the tmpdirs for the wrappers to the parent dir.</span>
</span></span><span class=line><span class=cl><span class=nv>wrapperDir</span><span class=o>=</span><span class=k>$(</span>mktemp --directory --tmpdir<span class=o>=</span><span class=s2>&#34;/run/wrappers&#34;</span> wrappers.XXXXXXXXXX<span class=k>)</span>
</span></span><span class=line><span class=cl>chmod a+rx <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/chsh&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/jqk530wxiq3832zyiqn8qi6i2pr3snnl-dbus-riscv64-unknown-linux-gnu-1.14.8/libexec/dbus-daemon-launch-helper&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper&#34;</span>
</span></span><span class=line><span class=cl>chown root:messagebus <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+rx,o-rx&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/2d68cpnlqls47ijrwss83swjk2q1v953-fuse-riscv64-unknown-linux-gnu-2.9.9/bin/fusermount&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/06w8lm5k9i2n1xhkszsf4pa9hw9l0r5s-fuse-riscv64-unknown-linux-gnu-3.11.0/bin/fusermount3&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin/bin/mount&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/newgidmap&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/newgrp&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/newuidmap&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/passwd&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/mckzq3q58m31d8ax04gnjqx43niamis0-iputils-riscv64-unknown-linux-gnu-20221126/bin/ping&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set desired capabilities on the file plus cap_setpcap so</span>
</span></span><span class=line><span class=cl><span class=c1># the wrapper program can elevate the capabilities set on</span>
</span></span><span class=line><span class=cl><span class=c1># its file into the Ambient set.</span>
</span></span><span class=line><span class=cl>/nix/store/z2gpziznsj8rnv55vyq5n287g5cvx7lg-libcap-riscv64-unknown-linux-gnu-2.68/bin/setcap <span class=s2>&#34;cap_setpcap,cap_net_raw+p&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the executable bit</span>
</span></span><span class=line><span class=cl>chmod u+rx,g+x,o+x <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/sg&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/gbp100zp8a8gja22dyjz4nwv0qsxb7qy-shadow-riscv64-unknown-linux-gnu-4.13-su/bin/su&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/scywdc7rd6cjfvji166a6d0bsjj90vys-sudo-riscv64-unknown-linux-gnu-1.9.13p3/bin/sudo&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/scywdc7rd6cjfvji166a6d0bsjj90vys-sudo-riscv64-unknown-linux-gnu-1.9.13p3/bin/sudoedit&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin/bin/umount&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/cn72qv0n576vg61mgaran7g2vj6gdjwn-linux-pam-riscv64-unknown-linux-gnu-1.5.2/bin/unix_chkpwd&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -L /run/wrappers/bin <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=c1># Atomically replace the symlink</span>
</span></span><span class=line><span class=cl>  <span class=c1># See https://axialcorps.com/2013/07/03/atomically-replacing-files-and-directories/</span>
</span></span><span class=line><span class=cl>  <span class=nv>old</span><span class=o>=</span><span class=k>$(</span>readlink -f /run/wrappers/bin<span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -e <span class=s2>&#34;/run/wrappers/bin-tmp&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    rm --force --recursive <span class=s2>&#34;/run/wrappers/bin-tmp&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  ln --symbolic --force --no-dereference <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>&#34;</span> <span class=s2>&#34;/run/wrappers/bin-tmp&#34;</span>
</span></span><span class=line><span class=cl>  mv --no-target-directory <span class=s2>&#34;/run/wrappers/bin-tmp&#34;</span> <span class=s2>&#34;/run/wrappers/bin&#34;</span>
</span></span><span class=line><span class=cl>  rm --force --recursive <span class=s2>&#34;</span><span class=nv>$old</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=c1># For initial setup</span>
</span></span><span class=line><span class=cl>  ln --symbolic <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>&#34;</span> <span class=s2>&#34;/run/wrappers/bin&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;wrappers&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make this configuration the current configuration.</span>
</span></span><span class=line><span class=cl><span class=c1># The readlink is there to ensure that when $systemConfig = /system</span>
</span></span><span class=line><span class=cl><span class=c1># (which is a symlink to the store), /run/current-system is still</span>
</span></span><span class=line><span class=cl><span class=c1># used as a garbage collection root.</span>
</span></span><span class=line><span class=cl>ln -sfn <span class=s2>&#34;</span><span class=k>$(</span>readlink -f <span class=s2>&#34;</span><span class=nv>$systemConfig</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span> /run/current-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent the current configuration from being garbage-collected.</span>
</span></span><span class=line><span class=cl>mkdir -p /nix/var/nix/gcroots
</span></span><span class=line><span class=cl>ln -sfn /run/current-system /nix/var/nix/gcroots/current-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=nv>$_status</span>
</span></span></code></pre></td></tr></table></div></div><p>这个脚本有点长，简单总结下它干了啥：</p><ol><li>通过 <code>source /nix/store/vn0sga6rn69vkdbs0d2njh0aig7zmzi6-mounts.sh</code> 挂载一些目录，看下
这个文件内容就知道，挂的是 <code>/proc</code> <code>/sys</code> <code>/dev</code> <code>/rum</code> 等几个临时目录。</li><li>通过 <code>mkdir</code>/<code>install</code> 等指令自动创建 <code>/home</code> <code>/root</code> <code>/bin</code> <code>/usr</code> <code>/usr/bin</code> 等目录</li><li>通过
<code>perl /nix/store/rg5rf512szdxmnj9qal3wfdnpfsx38qi-setup-etc.pl /nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc</code>
配置生成 <code>/etc</code> 目录中的各种文件。</li><li>通过 <code>ln</code> 命令添加其他各种软链接，以及一些别的设置。</li></ol><p>其中第三步 etc 目录的设置，实际数据基本都来自该脚本的第二个参数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>› ls root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc
</span></span><span class=line><span class=cl>╭────┬──────────────────────────────────────────────────────────────────────────┬─────────┬────────┬──────────────╮
</span></span><span class=line><span class=cl>│  <span class=c1># │                                   name                                   │  type   │  size  │   modified   │</span>
</span></span><span class=line><span class=cl>├────┼──────────────────────────────────────────────────────────────────────────┼─────────┼────────┼──────────────┤
</span></span><span class=line><span class=cl>│  <span class=m>0</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/bashrc           │ symlink │   <span class=m>54</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>1</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/binfmt.d         │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>2</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/dbus-1           │ symlink │   <span class=m>50</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>3</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/default          │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>4</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/dhcpcd.exit-hook │ symlink │   <span class=m>60</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>5</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/fonts            │ symlink │   <span class=m>69</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>6</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/fstab            │ symlink │   <span class=m>53</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>7</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/fuse.conf        │ symlink │   <span class=m>57</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>8</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/host.conf        │ symlink │   <span class=m>57</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>9</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/hostname         │ symlink │   <span class=m>56</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>10</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/hosts            │ symlink │   <span class=m>49</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>11</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/inputrc          │ symlink │   <span class=m>51</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>12</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/issue            │ symlink │   <span class=m>49</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>13</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/kbd              │ symlink │   <span class=m>61</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>14</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/locale.conf      │ symlink │   <span class=m>55</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>15</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/login.defs       │ symlink │   <span class=m>54</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>16</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/lsb-release      │ symlink │   <span class=m>59</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>17</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/lvm              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>18</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/man_db.conf      │ symlink │   <span class=m>59</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>19</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/modprobe.d       │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>20</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/modules-load.d   │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>21</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/nanorc           │ symlink │   <span class=m>54</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>22</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/netgroup         │ symlink │   <span class=m>56</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>23</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/nix              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>24</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/nscd.conf        │ symlink │   <span class=m>57</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>25</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/nsswitch.conf    │ symlink │   <span class=m>61</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>26</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/os-release       │ symlink │   <span class=m>58</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>27</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/pam              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>28</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/pam.d            │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>29</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/pki              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>30</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/profile          │ symlink │   <span class=m>55</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>31</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/protocols        │ symlink │   <span class=m>75</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>32</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/pulse            │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>33</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/resolvconf.conf  │ symlink │   <span class=m>63</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>34</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/rpc              │ symlink │   <span class=m>90</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>35</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/samba            │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>36</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/services         │ symlink │   <span class=m>74</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>37</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/set-environment  │ symlink │   <span class=m>59</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>38</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/shells           │ symlink │   <span class=m>54</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>39</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/ssh              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>40</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/ssl              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>41</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sudoers          │ symlink │   <span class=m>51</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>42</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sudoers.gid      │ file    │    <span class=m>3</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>43</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sudoers.mode     │ file    │    <span class=m>5</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>44</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sudoers.uid      │ file    │    <span class=m>3</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>45</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sysctl.d         │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>46</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/systemd          │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>47</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/terminfo         │ symlink │   <span class=m>70</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>48</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/tmpfiles.d       │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>49</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/udev             │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>50</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/vconsole.conf    │ symlink │   <span class=m>57</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>51</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/zoneinfo         │ symlink │   <span class=m>97</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>├────┼──────────────────────────────────────────────────────────────────────────┼─────────┼────────┼──────────────┤
</span></span><span class=line><span class=cl>│  <span class=c1># │                                   name                                   │  type   │  size  │   modified   │</span>
</span></span><span class=line><span class=cl>╰────┴──────────────────────────────────────────────────────────────────────────┴─────────┴────────┴──────────────╯
</span></span></code></pre></td></tr></table></div></div><p>这个 perl 脚本基本就是根据这个 nix store 中的 etc 文件夹，生成 <code>/etc</code> 目录中的各种文件或软
链接。</p><h2 id=四硬件驱动部分 class=headerLink><a href=#%e5%9b%9b%e7%a1%ac%e4%bb%b6%e9%a9%b1%e5%8a%a8%e9%83%a8%e5%88%86 class=header-mark></a>四、硬件驱动部分</h2><p>NixOS 要能在 LicheePi 4A 上正常启动，还需要有硬件固件的支持，因此光了解 NixOS 的启动流程还
不够，还需要了解硬件固件的启动流程。这里简要介绍下 Linux 在 RISC-V 上的启动流程。</p><h3 id=1-u-bootu-boot-splu-boot-tpl-的关系 class=headerLink><a href=#1-u-bootu-boot-splu-boot-tpl-%e7%9a%84%e5%85%b3%e7%b3%bb class=header-mark></a>1. u-boot，u-boot-spl，u-boot-tpl 的关系</h3><p>U-Boot 是嵌入式领域最常用的 bootloader，</p><p>对于一般嵌入式系统而言只需要一个 u-boot 作为 bootloader 即可，但入今的嵌入式 IC 已经转向
SOC 片上系统，其内部不仅仅是一颗 CPU 核，还可能包含各种各样的其他 IP，因而相关的上层软件也
需要针对性的划分不同的功能域，操作域，安全域等上层应用。为了支持这些复杂而碎片化的应用需
求，又或者因为 SRAM 太小以致无法放下整个 bootloader，SOC 的 Boot 阶段衍生出了多级
BootLoader，u-boot 为此定义了二三级加载器:</p><ul><li>spl：Secondary Program Loader，二级加载器</li><li>tpl：Tertiary Program Loader，三级加载器</li></ul><p>spl 和 tpl 走 u-boot 完全相同的 boot 流程，不过在 spl 和 tpl 中大多数驱动和功能被去除了，
根据需要只保留一部分 spl 和 tpl 需要的功能，通过 CONFIG_SPL_BUILD 和 CONFIG_TPL_BUILD 控
制；一般只用 spl 就足够了，spl 完成 ddr 初始化，并完成一些外设驱动初始化，比如 usb，emmc，
以此从其他外围设备加载 u-boot，但是如果对于小系统 spl 还是太大了，则可以继续加入 tpl，tpl
只做 ddr 等的特定初始化保证代码体积极小，以此再次从指定位置加载 spl，spl 再去加载 u-boot。</p><p>LicheePi4A 就使用了二级加载器，它甚至写死了 eMMC 的分区表，要求我们使用 fastboot 往对应的
分区写入 u-boot-spl.bin，官方给出的命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># flash u-boot into spl partition</span>
</span></span><span class=line><span class=cl>sudo fastboot flash ram u-boot-with-spl.bin
</span></span><span class=line><span class=cl>sudo fastboot reboot
</span></span><span class=line><span class=cl><span class=c1># flash uboot partition</span>
</span></span><span class=line><span class=cl>sudo fastboot flash uboot u-boot-with-spl.bin
</span></span></code></pre></td></tr></table></div></div><h3 id=2-risc-v-的启动流程 class=headerLink><a href=#2-risc-v-%e7%9a%84%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b class=header-mark></a>2. RISC-V 的启动流程</h3><p>网上找到的一个图，涉及到一些 RISC-V 指令集相关的知识点：</p><figure><img src=./current-riscv-boot-flow.webp width=80%><figcaption><h4>RISCV 开发版当前的引导流程</h4></figcaption></figure><p>根据我们前面的 NixOS 启动日志，跟这个图还是比较匹配的，但我们没观察到任何 U-Boot 日志，有
可能是因为 U-Boot 没开日志，暂时不打算细究。</p><h3 id=3-opensbi class=headerLink><a href=#3-opensbi class=header-mark></a>3. OpenSBI</h3><p>前面的 NixOS 启动日志跟启动流程图中都出现了 OpenSBI，那么 OpenSBI 是什么呢？为什么 ARM 开
发版的启动流程中没有这么个玩意儿？</p><p>查了下资料，大概是说因为 RISC-V 是一个开放指令集，任何人都可以基于 RISC-V 开发自己的定制指
令集，或者定制 IC 布局。这显然存在很明显的碎片化问题。OpenSBI 就是为了避免此问题而设计的，
它提供了一个标准的接口，即 Supervisor Binary Interface, SBI. 上层系统只需要适配 SBI 就可以
了，不需要关心底层硬件的细节。IC 开发商也只需要实现 SBI 的接口，就可以让任何适配了 SBI 的
上层系统能在其硬件平台上正常运行。</p><p>而 OpenSBI 则是 SBI 标准的一个开源实现，IC 开发商只需要将 OpenSBI 移植到自己的硬件平台上即
可支持 SBI 标准。</p><p>而 ARM 跟 X86 等指令集则是封闭的，不允许其他公司修改与拓展其指令集，因此不存在碎片化的问
题，也就不需要 OpenSBI 这样的东西。</p><h3 id=4-fw_dynamicbin-跟-u-boot-splbin-两个文件 class=headerLink><a href=#4-fw_dynamicbin-%e8%b7%9f-u-boot-splbin-%e4%b8%a4%e4%b8%aa%e6%96%87%e4%bb%b6 class=header-mark></a>4. fw_dynamic.bin 跟 u-boot-spl.bin 两个文件</h3><ol><li><code>fw_dynamic.bin</code>: 我们 NixOS 镜像的 <code>/boot</code> 中就有这个固件，它是 OpenSBI 的编译产物。<ol><li>RevyOS 的定制 OpenSBI 构建方
法：<a href=https://github.com/revyos/thead-opensbi/blob/lpi4a/.github/workflows/build.yml target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-opensbi/blob/lpi4a/.github/workflows/build.yml</a></li></ol></li><li><code>u-boot-spl.bin</code>: 这个文件是 u-boot 的编译产物，它是二级加载器。<ol><li>RevyOS 的定制 u-boot 构建方
法：<a href=https://github.com/revyos/thead-u-boot/blob/lpi4a/.github/workflows/build.yml target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-u-boot/blob/lpi4a/.github/workflows/build.yml</a></li></ol></li></ol><h3 id=5-t-head-官方的编译工具链 class=headerLink><a href=#5-t-head-%e5%ae%98%e6%96%b9%e7%9a%84%e7%bc%96%e8%af%91%e5%b7%a5%e5%85%b7%e9%93%be class=header-mark></a>5. T-Head 官方的编译工具链</h3><p>因为历史原因，TH1520 设计时貌似 RVV 还没出正式的规范，因此它使用了一些非标准的指令集，GCC
官方貌似宣称了永远不会支持这些指令集&mldr;（个人理解，可能有误哈）</p><p>因此为了获得最佳性能，LicheePi4A 官方文档建议使用 T-Head 提供的工具链编译整个系统。</p><p>但我在研究了 NixOS 的工具链实现，以及咨询了 @NickCao 后，确认了在 NixOS 上这几乎是不可行
的。NixOS 因为不遵循 FHS 标准，它对 GCC 等工具链做了非常多的魔改，要在 NixOS 上使用 T-Head
的工具链，就要使这一堆魔改的东西在 T-Head 的工具链上也能 Work，这个工作量很大，也很有技术
难度。</p><p>所以最终选择了用 NixOS 的标准工具链编译系统，@revy 老师也为此帮我做了些适配工作，解决了一
些标准工具链上的编译问题。</p><p>Issue 区也有人提到了这个问题，Revy 老师也帮助补充了些相关信
息：<a href=https://github.com/ryan4yin/nixos-licheepi4a/issues/14 target=_blank rel="noopener noreferrer">https://github.com/ryan4yin/nixos-licheepi4a/issues/14</a></p><h2 id=五我是如何构建出一个可以在-licheepi-4a-上运行的-nixos-镜像的 class=headerLink><a href=#%e4%ba%94%e6%88%91%e6%98%af%e5%a6%82%e4%bd%95%e6%9e%84%e5%bb%ba%e5%87%ba%e4%b8%80%e4%b8%aa%e5%8f%af%e4%bb%a5%e5%9c%a8-licheepi-4a-%e4%b8%8a%e8%bf%90%e8%a1%8c%e7%9a%84-nixos-%e9%95%9c%e5%83%8f%e7%9a%84 class=header-mark></a>五、我是如何构建出一个可以在 LicheePi 4A 上运行的 NixOS 镜像的</h2><p>到这里，NixOS 在 LicheePI4A 上启动的整个流程就基本讲清楚了， <strong>NixOS 跟其他传统发行版在启
动流程中最大的区别是它自定义了一个 init 脚本，在启动 systemd 之前，它会先执行这个脚本进行
文件系统的初始化操作，准备好最基础的 FHS 目录结构，使得后续的 systemd 以及其他服务能正常启
动</strong>。正是因为这个 init 脚本，NixOS 才能在仅有 <code>/boot</code> 与 <code>/nix</code> 这两个目录的情况下正常启
动整个系统。</p><blockquote><p>NixOS 数据的集中化只读存储使更多的骚操作成为可能，比如直接使用 tmpfs 作为根文件系统，将
需要持久化的目录挂载到外部存储设备上，这样每次重启系统时，所有预期之外的临时数据都会被清
空，进一步保证了系统的可复现性与安全性。如果你有系统洁癖，而且有兴趣折腾，那就快来看看
@LanTian 写的
<a href=https://lantian.pub/article/modify-computer/nixos-impermanence.lantian/ target=_blank rel="noopener noreferrer">NixOS 系列（四）：「无状态」操作系统</a>
吧~</p></blockquote><p>最终在 LicheePi4A 成功启动后的登录的截图：</p><figure><img src=./nixos-licheepi-neofetch.webp width=80%><figcaption><h4>NixOS 成功启动</h4></figcaption></figure><p>那么基于我们到目前为止学到的知识，要如何构建出一个可以在 LicheePi 4A 上运行的 NixOS 镜像
呢？</p><p>这个讲起来就很费时间了，涉及到了 NixOS
的<a href=https://nixos-and-flakes.thiscute.world/zh/development/cross-platform-compilation target=_blank rel="noopener noreferrer">交叉编译系统</a>
，<a href=https://nixos-and-flakes.thiscute.world/zh/development/kernel-development target=_blank rel="noopener noreferrer">内核 override</a>
,
<a href=https://nixos-and-flakes.thiscute.world/zh/nixos-with-flakes/introduction-to-flakes target=_blank rel="noopener noreferrer">flakes</a>
,
<a href=https://github.com/ryan4yin/nixos-licheepi4a/blob/main/modules/sd-image/sd-image.nix target=_blank rel="noopener noreferrer">镜像构建</a>
等
等，要展开讲的话也是下一篇文章了，有兴趣的可以直接看我的 NixOS on LicheePi4A 仓
库：<a href=https://github.com/ryan4yin/nixos-licheepi4a target=_blank rel="noopener noreferrer">https://github.com/ryan4yin/nixos-licheepi4a</a>
.</p><p>简单的说，NixOS 跟传统 Linux 发行版的系统镜像构建思路是一致的，但因为其声明式与可复现性的
特点，实际实现时出现了非常大的区别。以我的项目仓库为例，整个项目完全使用 Nix 语言声明式编
写（内嵌了部分 Shell 脚本&mldr;），而且这份配置也可用于系统后续的持续声明式更新部署（我还给出
了一个 demo）。</p><p>最后，再推荐一波我的 NixOS 入门指
南：<a href=https://github.com/ryan4yin/nixos-and-flakes-book target=_blank rel="noopener noreferrer">ryan4yin/nixos-and-flakes-book</a>
，
对 NixOS 感兴趣的读者们，快进我碗里来（</p><h2 id=参考 class=headerLink><a href=#%e5%8f%82%e8%80%83 class=header-mark></a>参考</h2><ul><li><a href=https://litterhougelangley.club/blog/2023/05/27/licheepi-4a-%e8%bf%99%e4%b8%aa%e5%b0%8f%e6%9d%bf%e6%9c%89%e7%82%b9%e6%84%8f%e6%80%9d%ef%bc%88%e7%ac%ac%e4%b8%80%e9%83%a8%e5%88%86%ef%bc%89/ target=_blank rel="noopener noreferrer">LicheePi 4A —— 这个小板有点意思（第一部分） - HougeLangley</a></li><li><a href=https://opensource.com/article/18/1/analyzing-linux-boot-process target=_blank rel="noopener noreferrer">Analyzing the Linux boot process - By Alison Chaiken</a></li><li><a href=https://github.com/riscv-software-src/opensbi/blob/master/docs/firmware/fw.md target=_blank rel="noopener noreferrer">OpenSBI Platform Firmwares</a></li><li><a href=https://crvf2019.github.io/pdf/43.pdf target=_blank rel="noopener noreferrer">An Introduction to RISC-V Boot flow: Overview, Blob vs Blobfree standards</a></li><li><a href=https://quard-star-tutorial.readthedocs.io/zh_CN/latest/ch5-1.html target=_blank rel="noopener noreferrer">基于 qemu-riscv 从 0 开始构建嵌入式 linux 系统 ch5-1. 什么是多级 BootLoader 与 opensbi(上)¶</a></li><li><a href=https://docs.kernel.org/admin-guide/initrd.html target=_blank rel="noopener noreferrer">Using the initial RAM disk (initrd) - kernel.org</a></li><li><a href=https://www.baeldung.com/linux/kernel-images target=_blank rel="noopener noreferrer">Differences Between vmlinux, vmlinuz, vmlinux.bin, zimage, and bzimage</a></li><li><a href=https://github.com/ARM-software/u-boot/blob/master/doc/README.distro target=_blank rel="noopener noreferrer">U-Boot 官方的 Distro 文档</a></li></ul></div><h2>相关内容</h2><div class=related-container><div class=related-item-container><div class=related-image><a href=/posts/my-experience-of-nixos/><img loading=lazy src=/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp srcset="/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp,
/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp 1.5x,
/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp 2x" title=/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/my-experience-of-nixos/>OS as Code - 我的 NixOS 使用体会</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/an-incomplete-guide-to-data-security/><img loading=lazy src=/posts/an-incomplete-guide-to-data-security/datasecurity.webp srcset="/posts/an-incomplete-guide-to-data-security/datasecurity.webp,
/posts/an-incomplete-guide-to-data-security/datasecurity.webp 1.5x,
/posts/an-incomplete-guide-to-data-security/datasecurity.webp 2x" title=/posts/an-incomplete-guide-to-data-security/datasecurity.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/an-incomplete-guide-to-data-security/>个人数据安全不完全指南</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/why-i-choose-niche-products/><img loading=lazy src=/posts/why-i-choose-niche-products/anime-girls-seagulls.webp srcset="/posts/why-i-choose-niche-products/anime-girls-seagulls.webp,
/posts/why-i-choose-niche-products/anime-girls-seagulls.webp 1.5x,
/posts/why-i-choose-niche-products/anime-girls-seagulls.webp 2x" title=/posts/why-i-choose-niche-products/anime-girls-seagulls.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/why-i-choose-niche-products/>为什么我折腾这些小众技术？</a></h2></div></div><div class=sponsor><div class=sponsor-avatar><img loading=lazy src=https://thiscute.world/avatar/myself.webp srcset="https://thiscute.world/avatar/myself.webp,
https://thiscute.world/avatar/myself.webp 1.5x,
https://thiscute.world/avatar/myself.webp 2x" title=https://thiscute.world/avatar/myself.webp></div><p class=sponsor-bio><em>如果你觉得这篇文章对你有所帮助，欢迎评论、分享、打赏~</em></p><a href=https://afdian.net/a/ryan4yin title=Sponsor target=_blank class=sponsor-button rel="noopener noreferrer"><i class="far fa-heart fa-fw icon" style=color:#ec6cb9></i>
<span>赞赏</span></a></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-01-29</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/how-nixos-start-on-licheepi4a/ data-title="NixOS 在 Lichee Pi 4A 上是如何启动的" data-via=ryan4yin data-hashtags=Linux,NixOS,LicheePi4A,Embedded,U-Boot,RISC-V><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Hacker News" data-sharer=hackernews data-url=https://thiscute.world/posts/how-nixos-start-on-licheepi4a/ data-title="NixOS 在 Lichee Pi 4A 上是如何启动的"><span class="fab fa-hacker-news fa-fw"></span></button><button title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/how-nixos-start-on-licheepi4a/><span class="fab fa-reddit fa-fw"></span></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="分享到 Mastodon" onclick='shareOnMastodon("NixOS 在 Lichee Pi 4A 上是如何启动的","https://thiscute.world/posts/how-nixos-start-on-licheepi4a/")'><span class="fab fa-mastodon fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/nixos/>NixOS</a>,&nbsp;<a href=/tags/licheepi4a/>LicheePi4A</a>,&nbsp;<a href=/tags/embedded/>Embedded</a>,&nbsp;<a href=/tags/u-boot/>U-Boot</a>,&nbsp;<a href=/tags/risc-v/>RISC-V</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/2023-summary/ class=prev rel=prev title="我的 2023 - 认识更多有趣的人，见识更宽广的世界"><i class="fas fa-angle-left fa-fw"></i>我的 2023 - 认识更多有趣的人，见识更宽广的世界</a>
<a href=/posts/an-incomplete-guide-to-data-security/ class=next rel=next title=个人数据安全不完全指南>个人数据安全不完全指南<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=display:inline-block;width:auto;height:20px></a>
<a href=https://www.foreverblog.cn/go.html target=_blank><img src=https://img.foreverblog.cn/wormhole_3.gif alt style=display:inline-block;width:auto;height:20px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动&nbsp;|&nbsp;托管在 <a title=Vercel href=https://vercel.com/ target=_blank rel="noopener noreffer">Vercel</a> 上&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 -2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://thiscute.world/ target=_blank rel="noopener noreferrer">ryan4yin</a></span>&nbsp;|&nbsp;<span class=license> <a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:300},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script></div></body></html>