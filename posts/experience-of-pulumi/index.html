<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Pulumi 使用体验 - 基础设施代码化 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:title" content="Pulumi 使用体验 - 基础设施代码化"><meta property="og:description" content="Pulumi 是一个基础设施的自动管理工具，使用
Python/TypeScript/Go/Dotnet 编写好声明式的资源配置，就能实现一键创建/修改/销毁各类资源，这
里的资源可以是："><meta property="og:type" content="article"><meta property="og:url" content="https://thiscute.world/posts/experience-of-pulumi/"><meta property="og:image" content="https://thiscute.world/posts/experience-of-pulumi/pulumi.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-08T18:51:30+08:00"><meta property="article:modified_time" content="2021-01-08T18:51:30+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/experience-of-pulumi/pulumi.webp"><meta name=twitter:title content="Pulumi 使用体验 - 基础设施代码化"><meta name=twitter:description content="Pulumi 是一个基础设施的自动管理工具，使用
Python/TypeScript/Go/Dotnet 编写好声明式的资源配置，就能实现一键创建/修改/销毁各类资源，这
里的资源可以是："><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><meta name=twitter:creator content="@ryan4yin"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/experience-of-pulumi/><link rel=prev href=https://thiscute.world/posts/opensuse-instruction/><link rel=next href=https://thiscute.world/posts/qemu-kvm-usage/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Pulumi 使用体验 - 基础设施代码化","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://thiscute.world/posts/experience-of-pulumi/"},"image":[{"@type":"ImageObject","url":"https://thiscute.world/posts/experience-of-pulumi/pulumi.webp","width":1200,"height":480}],"genre":"posts","keywords":"基础设施即代码, 云原生, Pulumi, Terraform","wordcount":6686,"url":"https://thiscute.world/posts/experience-of-pulumi/","datePublished":"2021-01-08T18:51:30+08:00","dateModified":"2021-01-08T18:51:30+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https://thiscute.world/avatar/myself.png"},"author":{"@type":"Person","name":"ryan4yin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行 </a><a class=menu-item href=/series/>系列 </a><a class=menu-item href=/categories/tech/>技术 </a><a class=menu-item href=/categories/life/>生活 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/friends/>朋友们 </a><a class=menu-item href=/now/>此刻 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title=选择语言 id=language-select-desktop onchange="location=this.value"><option value=/posts/experience-of-pulumi/ selected>Simplified Chinese</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a><a href=javascript:void(0); class=menu-item title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title=选择语言 onchange="location=this.value"><option value=/posts/experience-of-pulumi/ selected>Simplified Chinese</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#pulumi-vs-terraform-vs-cloudformation>Pulumi vs Terraform vs CloudFormation</a></li><li><a href=#pulumi-特点介绍>Pulumi 特点介绍</a></li><li><a href=#使用建议>使用建议</a></li><li><a href=#常见问题>常见问题</a><ul><li><a href=#1-output-的用法>1. <code>Output</code> 的用法</a></li><li><a href=#2-如何使用多个云账号多个-k8s-集群>2. 如何使用多个云账号/多个 k8s 集群？</a></li><li><a href=#3-inter-stack-属性传递>3. inter-stack 属性传递</a></li><li><a href=#4-pulumi-up-被中断或者对资源做了手动修改会发生什么>4. <code>pulumi up</code> 被中断，或者对资源做了手动修改，会发生什么？</a></li><li><a href=#5-如何手动声明资源间的依赖关系>5. 如何手动声明资源间的依赖关系？</a></li><li><a href=#6-如何导入已经存在的资源>6. 如何导入已经存在的资源？</a><ul><li><a href=#61-通过-pulumi-import-命令导入资源>6.1 通过 pulumi import 命令导入资源</a></li><li><a href=#62-通过代码导入资源>6.2 通过代码导入资源</a></li></ul></li><li><a href=#63-如何从-pulumi-中移除被导入的资源>6.3 如何从 pulumi 中移除被导入的资源</a></li><li><a href=#5-pulumi-kubernetes>5. pulumi-kubernetes？</a></li><li><a href=#6-阿里云资源-replace-报错>6. 阿里云资源 replace 报错？</a></li><li><a href=#7-有些资源属性无法使用-pulumi-配置>7. 有些资源属性无法使用 pulumi 配置？</a></li><li><a href=#8-cicd-中如何使-pulumi-将状态保存到文件>8. CI/CD 中如何使 pulumi 将状态保存到文件？</a></li><li><a href=#9-如何估算资源变更导致的成本变化>9. 如何估算资源变更导致的成本变化？</a></li></ul></li><li><a href=#缺点>缺点</a><ul><li><a href=#1-报错信息不直观>1. 报错信息不直观</a></li><li><a href=#2-资源状态被破坏时修复起来非常麻烦>2. 资源状态被破坏时，修复起来非常麻烦</a></li></ul></li><li><a href=#常用-provider>常用 Provider</a></li><li><a href=#我创建维护的-provider>我创建维护的 Provider</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Pulumi 使用体验 - 基础设施代码化</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://thiscute.world/ title=Author target=_blank rel="noopener noreferrer author" class=author>ryan4yin</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span>&nbsp;<span class=post-category>和</span>&nbsp;<span class=post-series>系列 <a href=/series/%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%B8%E5%85%B3/><i class="far fa-list-alt fa-fw"></i>云原生相关</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-01-08>2021-01-08</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2021-01-08>2021-01-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6686 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 14 分钟&nbsp;</div></div><div class=featured-image><img loading=eager src=/posts/experience-of-pulumi/pulumi.webp srcset="/posts/experience-of-pulumi/pulumi.webp, /posts/experience-of-pulumi/pulumi.webp 1.5x, /posts/experience-of-pulumi/pulumi.webp 2x" sizes=auto alt=/posts/experience-of-pulumi/pulumi.webp title=/posts/experience-of-pulumi/pulumi.webp height=480 width=1200></div><div class="details series-nav open"><div class="details-summary series-title"><span>系列 - 云原生相关</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content series-content"><nav><ul><li><a href=/posts/finops-for-kubernetes/>FinOps for Kubernetes - 如何拆分 Kubernetes 成本</a></li><li><a href=/posts/kubernetes-deployment-using-kubeadm/>部署一个 Kubernetes 集群</a></li><li><a href=/posts/kubernetes-best-practices/>Kubernetes 微服务最佳实践</a></li><li><a href=/posts/experience-of-argo-workflows/>云原生流水线 Argo Workflows 的安装、使用以及个人体验</a></li><li><span class=active>Pulumi 使用体验 - 基础设施代码化</span></li><li><a href=/posts/use-istio-for-jwt-auth/>使用 Istio 进行 JWT 身份验证（充当 API 网关）</a></li><li><a href=/posts/kubernetes-common-errors-and-solutions/>Kubernetes 常见错误、原因及处理方法</a></li><li><a href=/posts/experience-of-vault/>secrets 管理工具 Vault 的介绍、安装及使用</a></li><li><a href=/posts/kubernetes-cert-management/>Kubernetes 中的证书管理工具 - cert-manager</a></li></ul></nav></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#pulumi-vs-terraform-vs-cloudformation>Pulumi vs Terraform vs CloudFormation</a></li><li><a href=#pulumi-特点介绍>Pulumi 特点介绍</a></li><li><a href=#使用建议>使用建议</a></li><li><a href=#常见问题>常见问题</a><ul><li><a href=#1-output-的用法>1. <code>Output</code> 的用法</a></li><li><a href=#2-如何使用多个云账号多个-k8s-集群>2. 如何使用多个云账号/多个 k8s 集群？</a></li><li><a href=#3-inter-stack-属性传递>3. inter-stack 属性传递</a></li><li><a href=#4-pulumi-up-被中断或者对资源做了手动修改会发生什么>4. <code>pulumi up</code> 被中断，或者对资源做了手动修改，会发生什么？</a></li><li><a href=#5-如何手动声明资源间的依赖关系>5. 如何手动声明资源间的依赖关系？</a></li><li><a href=#6-如何导入已经存在的资源>6. 如何导入已经存在的资源？</a><ul><li><a href=#61-通过-pulumi-import-命令导入资源>6.1 通过 pulumi import 命令导入资源</a></li><li><a href=#62-通过代码导入资源>6.2 通过代码导入资源</a></li></ul></li><li><a href=#63-如何从-pulumi-中移除被导入的资源>6.3 如何从 pulumi 中移除被导入的资源</a></li><li><a href=#5-pulumi-kubernetes>5. pulumi-kubernetes？</a></li><li><a href=#6-阿里云资源-replace-报错>6. 阿里云资源 replace 报错？</a></li><li><a href=#7-有些资源属性无法使用-pulumi-配置>7. 有些资源属性无法使用 pulumi 配置？</a></li><li><a href=#8-cicd-中如何使-pulumi-将状态保存到文件>8. CI/CD 中如何使 pulumi 将状态保存到文件？</a></li><li><a href=#9-如何估算资源变更导致的成本变化>9. 如何估算资源变更导致的成本变化？</a></li></ul></li><li><a href=#缺点>缺点</a><ul><li><a href=#1-报错信息不直观>1. 报错信息不直观</a></li><li><a href=#2-资源状态被破坏时修复起来非常麻烦>2. 资源状态被破坏时，修复起来非常麻烦</a></li></ul></li><li><a href=#常用-provider>常用 Provider</a></li><li><a href=#我创建维护的-provider>我创建维护的 Provider</a></li></ul></nav></div></div><div class=content id=content><p><a href=https://github.com/pulumi/pulumi target=_blank rel="noopener noreferrer">Pulumi</a> 是一个基础设施的自动管理工具，使用
Python/TypeScript/Go/Dotnet 编写好声明式的资源配置，就能实现一键创建/修改/销毁各类资源，这
里的资源可以是：</p><ul><li>AWS/阿里云等云上的负载均衡、云服务器、TLS 证书、DNS、CDN、OSS、数据库&mldr;几乎所有的云上资
源</li><li>本地自建的 vSphere/Kubernetes/ProxmoxVE/libvirt 环境中的虚拟机、容器等资源</li></ul><p>相比直接调用 AWS/阿里云/Kubernetes 的 API，使用 pulumi 的好处有：</p><ul><li>声明式配置：你只需要声明你的资源属性就 OK，所有的状态管理、异常处理都由 pulumi 完成。</li><li>统一的配置方式：提供统一的配置方法，来声明式的配置所有 AWS/阿里云/Kubernetes 资源。</li><li>声明式配置的可读性更好，更便于维护</li></ul><p>试想一下，通过传统的手段去从零搭建一个云上测试环境、或者本地开发环境，需要手工做多少繁琐的
工作。</p><p>而依靠 Pulumi 这类「基础设施即代码（Infrastructure as Code, IaC）」的工具，只需要一行命令
就能搭建好一个可复现的云上测试环境或本地开发环境。</p><p>比如我们的阿里云测试环境，包括两个 kubernetes 集群、负载均衡、VPC 网络、数据库、云监控告警
/日志告警、RAM账号权限体系等等，是一个比较复杂的体系。</p><p>人工去配置这么多东西，想要复现是很困难的，非常繁琐而且容易出错。</p><p>但是使用 pulumi，只需要一行命令，就能创建并配置好这五花八门一大堆的玩意儿。销毁整个测试环
境也只需要一行命令。</p><p><strong>实际使用体验</strong>：我们使用 Pulumi 自动化了阿里云测试环境搭建 95%+ 的操作，这个比例随着阿里
云的 pulumi provider 的完善，还可以进一步提高！</p><h2 id=pulumi-vs-terraform-vs-cloudformation class=headerLink><a href=#pulumi-vs-terraform-vs-cloudformation class=header-mark></a>Pulumi vs Terraform vs CloudFormation</h2><p>先介绍下 CloudFormation，它是 AWS 提供的一个 IaC 工具， 它使用 json/yaml 编写声明式配置文
件，然后完全在 AWS 云上进行资源的创建、管理、销毁。其所创建的资源跟 CloudFormation Task 同
生命周期，因此删除该 CloudFormation Task 就会自动销毁所有相关资源。因此它的好处应该是可以
完全在云上运行，本地客户端只是一个提交配置的工具。而缺点则是只能在 AWS 上使用。</p><p>而在通用的「基础设施即代码」领域，有一个工具比 Pulumi 更流行，它就是
<a href=https://www.terraform.io/ target=_blank rel="noopener noreferrer">Terraform</a>.</p><p>实际上我们一开始使用的也是 Terraform，但是后来使用 Pulumi 完全重写了一遍。</p><p>主要原因是，Pulumi 解决了 Terraform 配置的一个痛点：配置语法太过简单，导致配置繁琐。而且还
要额外学习一门 DSL - HCL</p><p>Terraform 虽然应用广泛，但是它默认使用的 HCL 语言太简单，表现力不够强。这就导致在一些场景
下使用 Terraform，会出现大量的重复配置。</p><p>一个典型的场景是「批量创建资源，动态生成资源参数」。比如批量创建一批名称类似的 ECS 服务器
/VPC交换机。如果使用 terraform，就会出现大量的重复配置。</p><p>改用 terraform 提供的 module 能在一定程度上实现配置的复用，但是它还是解决不了问题。要使用
module，你需要付出时间去学习 module 的概念，为了拼接参数，你还需要学习 HCL 的一些高级用
法。</p><p>但是付出了这么多，最后写出的 module 还是不够灵活——它被 HCL 局限住了。</p><p>为了实现如此的参数化动态化，我们不得不引入 Python 等其他编程语言。于是构建流程就变成了：</p><ol><li>借助 Python 等其他语言先生成出 HCL 配置</li><li>通过 <code>terraform</code> 命令行进行 plan 与 apply</li><li>通过 Python 代码解析 <code>terraform.tfstat</code>，获取 apply 结果，再进行进一步操作。</li></ol><p>这显然非常繁琐，主要困难就在于 Python 和 Terraform 之间的交互。</p><p>进一步思考，<strong>既然其他编程语言如 Python/Go 的引入不可避免，那是不是能使用它们彻底替代掉
HCL 呢？能不能直接使用 Python/Go 编写配置</strong>？如果 Terraform 原生就支持 Python/Go 来编写配
置，那就不存在交互问题了。</p><p>相比于使用领域特定语言 HCL，使用通用编程语言编写配置，好处有：</p><ol><li>Python/Go/TypeScript 等通用的编程语言，也支持 Yaml 这样方便自动化生成的配置语言，能满足
你的一切需求。</li><li>作为一个开发人员/DevOps，你应该对 Python/Go 等语言相当熟悉，可以直接利用上已有的经验。</li><li>更方便测试：可以使用各编程语言中流行的测试框架来测试 pulumi 配置！</li></ol><p>于是 Pulumi 横空出世。</p><blockquote><p>另一个和 Pulumi 功能类似的工具，是刚出炉没多久的
<a href=https://github.com/hashicorp/terraform-cdk target=_blank rel="noopener noreferrer">terraform-cdk</a>，但是目前它还很不成熟。</p></blockquote><h2 id=pulumi-特点介绍 class=headerLink><a href=#pulumi-%e7%89%b9%e7%82%b9%e4%bb%8b%e7%bb%8d class=header-mark></a>Pulumi 特点介绍</h2><ol start=4><li>原生支持通过 Python/Go/TypeScript/Dotnet 等语言编写配置，也就完全解决了上述的 terraform
和 python 的交互问题。</li><li>pulumi 是目前最流行的 真-IaaS 工具，对各语言的支持都很成熟。</li><li>兼容 terraform 的所有 provider，只是需要自行使用
<a href=https://github.com/pulumi/pulumi-tf-provider-boilerplate target=_blank rel="noopener noreferrer">pulumi-tf-provider-boilerplate</a>
重新打包，有些麻烦。<ol><li>pulumi 官方的 provider 几乎全都是封装的 terraform provider，包括
aws/azure/alicloud，目前只发现 kubernetes 是原生的（独苗啊）。</li></ol></li><li>状态管理和 secrets 管理有如下几种选择：<ol><li>使用 app.pulumi.com（默认）:免费版提供 stack 历史管理，可以看到所有的历史记录。另外
还提供一个资源关系的可视化面板。总之很方便，但是多人合作就需要收费。</li><li>本地文件存储：<code>pulumi login file:///app/data</code></li><li><a href=https://www.pulumi.com/docs/intro/concepts/state/#logging-into-the-aws-s3-backend target=_blank rel="noopener noreferrer">云端对象存储</a>，
支持 s3 等对象存储协议，因此可以使用 AWS 或者本地的 MinIO 来做 Backend.<ul><li><code>pulumi login 's3://&lt;bucket-path>?endpoint=my.minio.local:8080&disableSSL=true&s3ForcePathStyle=true'</code></li><li>minio/aws 的 credential 可以通过 <code>AWS_ACCESS_KEY_ID</code> 和 <code>AWS_SECRET_ACCESS_KEY</code> 两
个环境变量设置。另外即使是使用 MinIO，<code>AWS_REGION</code> 这个没啥用的环境变量也必须设
置！否则会报错。</li></ul></li><li><a href=https://github.com/pulumi/pulumi/issues/4727 target=_blank rel="noopener noreferrer">gitlab 13 支持 Terraform HTTP State 协议</a>，
等这个 pr 合并，pulumi 也能以 gitlab 为 backend 了。</li><li>使用 pulumi 企业版（自建服务）：比 app.pulumi.com 提供更多的特性，但是显然是收费
的。。</li></ol></li></ol><p>总之，非常香，强烈推荐各位 DevOps 试用。</p><hr><blockquote><p>以下内容是我对 pulumi 的一些思考，以及使用 pulumi 遇到的各种问题+解决方法，适合对 pulumi
有一定了解的同学阅读。</p></blockquote><blockquote><p>如果你刚接触 Pulumi 而且有兴趣学习，建议先移步
<a href=https://www.pulumi.com/docs/get-started/install/ target=_blank rel="noopener noreferrer">pulumi get started</a> 入个门，再接着看
下面的内容。</p></blockquote><h2 id=使用建议 class=headerLink><a href=#%e4%bd%bf%e7%94%a8%e5%bb%ba%e8%ae%ae class=header-mark></a>使用建议</h2><ol><li><strong>建议查看对应的 terraform provider 文档：pulumi 的 provider 基本都是封装的 terraform
版本，而且文档是自动生成的，比（简）较（直）难（一）看（坨）懂（shi），examples 也
少</strong>。</li><li>stack: pulumi 官方提供了两种 stack 用
法：<a href=https://www.pulumi.com/docs/intro/concepts/organizing-stacks-projects/ target=_blank rel="noopener noreferrer">「单体」和「微-stack」</a><ol><li>单体: one stack rule them all，通过 stack 参数来控制步骤。stack 用来区分环境 dev/pro
等。</li><li>微-stack: 每一个 stack 是一个步骤，所有 stack 组成一个完整的项目。</li><li>实际使用中，我发现「微-stack」模式需要使用到 pulumi 的 inter-stack dependencies，报
一堆的错，而且不够灵活。因此目前更推荐「单体」模式。</li></ol></li></ol><p>我们最近使用 pulumi 完全重写了以前用 terraform 编写的云上配置，简化了很多繁琐的配置，也降
低了我们 Python 运维代码和 terraform 之间的交互难度。另外我们还充分利用上了 Python 的类型
检查和语法检查，很多错误 IDE 都能直接给出提示，强化了配置的一致性和可维护性。</p><p>不过由于阿里云 provider 暂时还：</p><ol><li>不支持管理 ASM 服务网格、DTS 数据传输等资源</li><li>OSS 等产品的部分参数也暂时不支持配置（比如 OSS 不支持配置图片样式、ElasticSearch 暂时不
支持自动创建 7.x 版本）</li><li>不支持创建 ElasticSearch 7.x</li></ol><p>这些问题，导致我们仍然有部分配置需要手动处理，另外一些耗时长的资源，需要单独去创建。因此还
不能实现完全的「一键」。</p><h2 id=常见问题 class=headerLink><a href=#%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 class=header-mark></a>常见问题</h2><h3 id=1-output-的用法 class=headerLink><a href=#1-output-%e7%9a%84%e7%94%a8%e6%b3%95 class=header-mark></a>1. <code>Output</code> 的用法</h3><ol><li>pulumi 通过资源之间的属性引用（<code>Output[str]</code>）来确定依赖关系，如果你通过自定义的属性
(<code>str</code>)解耦了资源依赖，会导致资源创建顺序错误而创建失败。</li><li><code>Output[str]</code> 是一个异步属性，类似 Future，不能被用在 pulumi 参数之外的地方！</li><li><code>Output[str]</code> 提供两种方法能直接对 <code>Output[str]</code> 进行一些操作：<ol><li><code>Output.concat("http://", domain, "/", path)</code>: 此方法将 str 与 <code>Output[str]</code> 拼接起
来，返回一个新的 <code>Output[str]</code> 对象，可用做 pulumi 属性。</li><li><code>domain.apply(lambda it: print(it))</code>: <code>Output[str]</code> 的 <code>apply</code> 方法接收一个函数。在
异步获取到数据后，pulumi 会调用这个函数，把具体的数据作为参数传入。<ul><li>另外 <code>apply</code> 也会将传入函数的返回值包装成 <code>Output</code> 类型返回出来。</li><li>可用于：在获取到数据后，将数据打印出来/发送到邮箱/调用某个 API 上传数据等等。</li></ul></li><li><code>Output.all(output1, output2, ...).apply(lambda it: print(it))</code> 可用于将多个
<code>output</code> 值，拼接成一个 <code>Output</code> 类型，其内部的 raw 值为一个 tuple 对象
<code>(str1, str2, ...)</code>.<ol><li>官方举
例：<code>connection_string = Output.all(sql_server.name, database.name).apply(lambda args: f"Server=tcp:{args[0]}.database.windows.net;initial catalog={args[1]}...")</code></li></ol></li></ol></li></ol><h3 id=2-如何使用多个云账号多个-k8s-集群 class=headerLink><a href=#2-%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e5%a4%9a%e4%b8%aa%e4%ba%91%e8%b4%a6%e5%8f%b7%e5%a4%9a%e4%b8%aa-k8s-%e9%9b%86%e7%be%a4 class=header-mark></a>2. 如何使用多个云账号/多个 k8s 集群？</h3><p>默认情况下 pulumi 使用默认的 provider，但是 pulumi 所有的资源都有一个额外的 <code>opts</code> 参数，
可用于设定其他 provider。</p><p>通过这个 <code>opts</code>，我们可以实现在一个 pulumi 项目中，使用多个云账号，或者管理多个 k8s 集群。</p><p>示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pulumi</span> <span class=kn>import</span> <span class=n>get_stack</span><span class=p>,</span> <span class=n>ResourceOptions</span><span class=p>,</span> <span class=n>StackReference</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pulumi_alicloud</span> <span class=kn>import</span> <span class=n>Provider</span><span class=p>,</span> <span class=n>oss</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自定义 provider，key/secret 通过参数设定，而不是从默认的环境变量读取。</span>
</span></span><span class=line><span class=cl><span class=c1># 可以自定义很多个 providers</span>
</span></span><span class=line><span class=cl><span class=n>provider</span> <span class=o>=</span> <span class=n>pulumi_alicloud</span><span class=o>.</span><span class=n>Provider</span><span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=s2>&#34;custom-alicloud-provider&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=n>region</span><span class=o>=</span><span class=s2>&#34;cn-hangzhou&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=n>access_key</span><span class=o>=</span><span class=s2>&#34;xxx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=n>secret_key</span><span class=o>=</span><span class=s2>&#34;jjj&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过 opts，让 pulumi 使用自定义的 provider（替换掉默认的）</span>
</span></span><span class=line><span class=cl><span class=n>bucket</span> <span class=o>=</span> <span class=n>oss</span><span class=o>.</span><span class=n>Bucket</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>opts</span><span class=o>=</span><span class=n>ResourceOptions</span><span class=p>(</span><span class=n>provider</span><span class=o>=</span><span class=n>provider</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=3-inter-stack-属性传递 class=headerLink><a href=#3-inter-stack-%e5%b1%9e%e6%80%a7%e4%bc%a0%e9%80%92 class=header-mark></a>3. inter-stack 属性传递</h3><blockquote><p>这东西还没搞透，待研究。</p></blockquote><p>多个 stack 之间要互相传递参数，需要通过 <code>pulumi.export</code> 导出属性，通过 <code>stack.require_xxx</code>
获取属性。</p><p>从另一个 stack 读取属性的示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pulumi</span> <span class=kn>import</span> <span class=n>StackReference</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cfg</span> <span class=o>=</span> <span class=n>pulumi</span><span class=o>.</span><span class=n>Config</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>stack_name</span> <span class=o>=</span> <span class=n>pulumi</span><span class=o>.</span><span class=n>get_stack</span><span class=p>()</span>  <span class=c1># stack 名称</span>
</span></span><span class=line><span class=cl><span class=n>project</span> <span class=o>=</span> <span class=n>pulumi</span><span class=o>.</span><span class=n>get_project</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>infra</span> <span class=o>=</span> <span class=n>StackReference</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ryan4yin/</span><span class=si>{</span><span class=n>project</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>stack_name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 这个属性在上一个 stack 中被 export 出来</span>
</span></span><span class=line><span class=cl><span class=n>vpc_id</span> <span class=o>=</span> <span class=n>infra</span><span class=o>.</span><span class=n>require</span><span class=p>(</span><span class=s2>&#34;resources.vpc.id&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=4-pulumi-up-被中断或者对资源做了手动修改会发生什么 class=headerLink><a href=#4-pulumi-up-%e8%a2%ab%e4%b8%ad%e6%96%ad%e6%88%96%e8%80%85%e5%af%b9%e8%b5%84%e6%ba%90%e5%81%9a%e4%ba%86%e6%89%8b%e5%8a%a8%e4%bf%ae%e6%94%b9%e4%bc%9a%e5%8f%91%e7%94%9f%e4%bb%80%e4%b9%88 class=header-mark></a>4. <code>pulumi up</code> 被中断，或者对资源做了手动修改，会发生什么？</h3><ol><li>强行中断 <code>pulumi up</code>，会导致资源进入 <code>pending</code> 状态，必须手动修复。<ol><li>修复方法：<code>pulumi stack export</code>，删除 pending 资源，再 <code>pulumi stack import</code></li></ol></li><li>手动删除了云上资源，或者修改了一些对资源管理无影响的参数，对 <code>pulumi</code> 没有影响，它能正
确检测到这种情况。<ol><li>可以通过 <code>pulumi refresh</code> 手动从云上拉取最新的资源状态。</li></ol></li><li>手动更改了资源之间的依赖关系（比如绑定 EIP 之类的），很可能导致 pulumi 无法正确管理资源
之间的依赖。<ul><li>这种情况必须先手动还原依赖关系（或者把相关资源全部手动删除掉），然后才能继续使用
pulumi。</li></ul></li></ol><h3 id=5-如何手动声明资源间的依赖关系 class=headerLink><a href=#5-%e5%a6%82%e4%bd%95%e6%89%8b%e5%8a%a8%e5%a3%b0%e6%98%8e%e8%b5%84%e6%ba%90%e9%97%b4%e7%9a%84%e4%be%9d%e8%b5%96%e5%85%b3%e7%b3%bb class=header-mark></a>5. 如何手动声明资源间的依赖关系？</h3><p>有时候因为一些问题（比如 pulumi provider 功能缺失，使用了 restful api 实现部分功
能），pulumi 可能无法识别到某些资源之间的依赖关系。</p><p>这时可以为资源添加 <code>dependsOn</code> 属性，这个属性能显式地声明依赖关系。</p><h3 id=6-如何导入已经存在的资源 class=headerLink><a href=#6-%e5%a6%82%e4%bd%95%e5%af%bc%e5%85%a5%e5%b7%b2%e7%bb%8f%e5%ad%98%e5%9c%a8%e7%9a%84%e8%b5%84%e6%ba%90 class=header-mark></a>6. 如何导入已经存在的资源？</h3><p>如果你司不是一开始就使用了 pulumi 这类工具，那通常绝大部分云上资源都是手动管理、或者由其他
工具自动化管理的，该如何将它们纳入 pulumi 管辖呢？</p><p>官方有提供一篇相关文档
<a href=https://www.pulumi.com/docs/guides/adopting/import/ target=_blank rel="noopener noreferrer">Importing Infrastructure</a>.</p><p>文档有提到两种资源导入的方法，导入成功后都会自动生成资源的状态，以及对应的 pulumi 代码。第
一种是使用 <code>pulumi import</code> 命令，第二种是在代码中使用 <code>import</code> 参数。</p><p>除此之外，社区还有几个其他资源导入工具（reverse IaC）值得研究：</p><ul><li><a href=https://github.com/iann0036/former2 target=_blank rel="noopener noreferrer">former2</a>: 为已有的 AWS 资源生成
terraform/pulumi/cloudformation 等配置，但是不支持生成 tfstate 状态</li><li><a href=https://github.com/GoogleCloudPlatform/terraformer target=_blank rel="noopener noreferrer">terraformer</a>: 为已有的
AWS/GCP/Azure/Alicloud/DigitalOcean 等多种云资源生成 terraform 配置以及 tfstate 状态</li><li><a href=https://github.com/cycloidio/terracognita target=_blank rel="noopener noreferrer">terracognita</a>: 功能跟 terraformer 一样，都支
持生成 terraform 配置以及 tfstate 状态，但是它支持 AWS/GCP/Azure 三朵云</li><li><a href=https://github.com/pulumi/pulumi-terraform target=_blank rel="noopener noreferrer">pulumi-terraform</a>: 这个 provider 使你可以在
pulumi 项目里使用 tfstate 状态文件</li><li><a href=https://github.com/pulumi/tf2pulumi target=_blank rel="noopener noreferrer">tf2pulumi</a>: 将 terraform 配置转换为 pulumi
typescript 配置</li></ul><h4 id=61-通过-pulumi-import-命令导入资源 class=headerLink><a href=#61-%e9%80%9a%e8%bf%87-pulumi-import-%e5%91%bd%e4%bb%a4%e5%af%bc%e5%85%a5%e8%b5%84%e6%ba%90 class=header-mark></a>6.1 通过 pulumi import 命令导入资源</h4><p>使用 <code>pulumi import</code> 命令导入资源的好处是，不需要为每个资源手写代码，此命令会<strong>自动生成资
源的 stack state 与配置代码</strong>。</p><p>使用此命令导入的资源，默认会启用删除保护，你可通过参数 <code>--protect=false</code> 来关闭删除保护。</p><p>资源名称可通过命令行参数，或者 Json 文件来指定。</p><p>下面我们演示一个导入一个 s3 bucket 的流程：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 导入一个名为 test-sre 的 s3 bucket，资源 ID 为 p-test-sre</span>
</span></span><span class=line><span class=cl>$ pulumi import aws:s3/bucket:Bucket p-test-sre test-sre
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>Do you want to perform this import? yes
</span></span><span class=line><span class=cl>Importing <span class=o>(</span>dev<span class=o>)</span>:
</span></span><span class=line><span class=cl>     Type                 Name             Status
</span></span><span class=line><span class=cl> +   pulumi:pulumi:Stack  pulumi-test-dev  <span class=nv>created</span>
</span></span><span class=line><span class=cl> <span class=o>=</span>   └─ aws:s3:Bucket     p-test-sre       imported
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Resources:
</span></span><span class=line><span class=cl>    + <span class=m>1</span> <span class=nv>created</span>
</span></span><span class=line><span class=cl>    <span class=o>=</span> <span class=m>1</span> imported
</span></span><span class=line><span class=cl>    <span class=m>2</span> changes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Duration: 8s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please copy the following code into your Pulumi application. Not doing so
</span></span><span class=line><span class=cl>will cause Pulumi to report that an update will happen on the next update command.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please note that the imported resources are marked as protected. To destroy them
</span></span><span class=line><span class=cl>you will need to remove the <span class=sb>`</span>protect<span class=sb>`</span> option and run <span class=sb>`</span>pulumi update<span class=sb>`</span> *before*
</span></span><span class=line><span class=cl>the destroy will take effect.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>import pulumi
</span></span><span class=line><span class=cl>import pulumi_aws as aws
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>p_test_sre</span> <span class=o>=</span> aws.s3.Bucket<span class=o>(</span><span class=s2>&#34;p-test-sre&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>arn</span><span class=o>=</span><span class=s2>&#34;arn:aws:s3:::test-sre&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>bucket</span><span class=o>=</span><span class=s2>&#34;test-sre&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>hosted_zone_id</span><span class=o>=</span><span class=s2>&#34;ZZBBCC332211KK&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>request_payer</span><span class=o>=</span><span class=s2>&#34;BucketOwner&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>tags</span><span class=o>={</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Name&#34;</span>: <span class=s2>&#34;test-sre&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Team&#34;</span>: <span class=s2>&#34;Platform&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=nv>opts</span><span class=o>=</span>pulumi.ResourceOptions<span class=o>(</span><span class=nv>protect</span><span class=o>=</span>True<span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><p>能看到它会自动导入对应资源的 state，并同时打印出对应的 python 代码，要求我们手动将代码复制
粘贴到项目中。而且代码会自带 arn/hosted_zone_id/protect 等属性，说明这个资源实际上是无法像
普通 pulumi 资源一样，通过 <code>pulumi up</code>/<code>pulumi destroy</code> 自动创建销毁的。要通过 pulumi 删除
该资源，需要首先解除删除保护，然后将对应的代码片段删除掉，最后执行 <code>pulumi up</code>。</p><p>也可通过 json 来批量导入资源，首先编写一个 json 资源清单：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>	&#34;resources&#34;: [{
</span></span><span class=line><span class=cl>			&#34;type&#34;: &#34;aws:s3/bucket:Bucket&#34;,
</span></span><span class=line><span class=cl>			&#34;name&#34;: &#34;s3-bucket_xxx-debug&#34;,
</span></span><span class=line><span class=cl>			&#34;id&#34;: &#34;xxx-debug&#34;
</span></span><span class=line><span class=cl>		},
</span></span><span class=line><span class=cl>		{
</span></span><span class=line><span class=cl>			&#34;type&#34;: &#34;aws:s3/accessPoint:AccessPoint&#34;,
</span></span><span class=line><span class=cl>			&#34;name&#34;: &#34;s3-accesspoint_xxx-debug&#34;,
</span></span><span class=line><span class=cl>			&#34;id&#34;: &#34;112233445566:xxx-debug&#34;
</span></span><span class=line><span class=cl>		}
</span></span><span class=line><span class=cl>	]
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>然后执行如下命令批量导入资源：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ pulumi import -f test-resources.json
</span></span><span class=line><span class=cl>......
</span></span><span class=line><span class=cl>Do you want to perform this import? yes
</span></span><span class=line><span class=cl>Importing <span class=o>(</span>dev<span class=o>)</span>:
</span></span><span class=line><span class=cl>     Type                   Name                             Status
</span></span><span class=line><span class=cl>     pulumi:pulumi:Stack    pulumi-test-dev
</span></span><span class=line><span class=cl> <span class=o>=</span>   ├─ aws:s3:AccessPoint  s3-accesspoint_xxx-debug  <span class=nv>imported</span>
</span></span><span class=line><span class=cl> <span class=o>=</span>   └─ aws:s3:Bucket       s3-bucket_xxx-debug       imported
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Resources:
</span></span><span class=line><span class=cl>    <span class=o>=</span> <span class=m>2</span> imported
</span></span><span class=line><span class=cl>    <span class=m>2</span> unchanged
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Duration: 8s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please copy the following code into your Pulumi application. Not doing so
</span></span><span class=line><span class=cl>will cause Pulumi to report that an update will happen on the next update command.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Please note that the imported resources are marked as protected. To destroy them
</span></span><span class=line><span class=cl>you will need to remove the <span class=sb>`</span>protect<span class=sb>`</span> option and run <span class=sb>`</span>pulumi update<span class=sb>`</span> *before*
</span></span><span class=line><span class=cl>the destroy will take effect.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>import pulumi
</span></span><span class=line><span class=cl>import pulumi_aws as aws
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>s3_bucket_snappea_dl_debug</span> <span class=o>=</span> aws.s3.Bucket<span class=o>(</span><span class=s2>&#34;s3-bucket_xxx-debug&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>arn</span><span class=o>=</span><span class=s2>&#34;arn:aws:s3:::xxx-debug&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>bucket</span><span class=o>=</span><span class=s2>&#34;xxx-debug&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>hosted_zone_id</span><span class=o>=</span><span class=s2>&#34;ZZBBCC332211KK&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>request_payer</span><span class=o>=</span><span class=s2>&#34;BucketOwner&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>tags</span><span class=o>={</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Name&#34;</span>: <span class=s2>&#34;xxx-debug&#34;</span>,
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Team&#34;</span>: <span class=s2>&#34;Xxx&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=nv>opts</span><span class=o>=</span>pulumi.ResourceOptions<span class=o>(</span><span class=nv>protect</span><span class=o>=</span>True<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=nv>s3_accesspoint_snappea_dl_debug</span> <span class=o>=</span> aws.s3.AccessPoint<span class=o>(</span><span class=s2>&#34;s3-accesspoint_xxx-debug&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>account_id</span><span class=o>=</span><span class=s2>&#34;112233445566&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>bucket</span><span class=o>=</span><span class=s2>&#34;xxx-debug&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>name</span><span class=o>=</span><span class=s2>&#34;xxx-debug&#34;</span>,
</span></span><span class=line><span class=cl>    <span class=nv>public_access_block_configuration</span><span class=o>=</span>aws.s3.AccessPointPublicAccessBlockConfigurationArgs<span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=nv>block_public_acls</span><span class=o>=</span>False,
</span></span><span class=line><span class=cl>        <span class=nv>block_public_policy</span><span class=o>=</span>False,
</span></span><span class=line><span class=cl>        <span class=nv>ignore_public_acls</span><span class=o>=</span>False,
</span></span><span class=line><span class=cl>        <span class=nv>restrict_public_buckets</span><span class=o>=</span>False,
</span></span><span class=line><span class=cl>    <span class=o>)</span>,
</span></span><span class=line><span class=cl>    <span class=nv>opts</span><span class=o>=</span>pulumi.ResourceOptions<span class=o>(</span><span class=nv>protect</span><span class=o>=</span>True<span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><p>能看到同样的生成出了两个资源的 stack 状态，以及对应的代码。</p><h4 id=62-通过代码导入资源 class=headerLink><a href=#62-%e9%80%9a%e8%bf%87%e4%bb%a3%e7%a0%81%e5%af%bc%e5%85%a5%e8%b5%84%e6%ba%90 class=header-mark></a>6.2 通过代码导入资源</h4><p>通过代码导入资源，需要你手工为每个资源编写代码，并且确保代码的所有参数与资源本身的状态完全
一致。</p><p>因此可以看到这种导入方式很不灵活，通常不推荐使用，<code>pulumi import</code> 自动生成代码它不香么
emmmm</p><p>大概的流程如下，首先编写一个资源的配置代码，并将其标注为 <code>import</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>p_test_sre</span> <span class=o>=</span> <span class=n>aws</span><span class=o>.</span><span class=n>s3</span><span class=o>.</span><span class=n>Bucket</span><span class=p>(</span><span class=s2>&#34;p-test-sre&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bucket</span><span class=o>=</span><span class=s2>&#34;test-sre&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Name&#34;</span><span class=p>:</span> <span class=s2>&#34;test-sre&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Team&#34;</span><span class=p>:</span> <span class=s2>&#34;xxx&#34;</span><span class=p>,</span>  <span class=c1># 这里我故意写错了，pulumi 会检测到这里有问题，提示导入将失败</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>opts</span><span class=o>=</span><span class=n>pulumi</span><span class=o>.</span><span class=n>ResourceOptions</span><span class=p>(</span>
</span></span><span class=line><span class=cl>       <span class=n>protect</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>       <span class=n>import_</span><span class=o>=</span><span class=s2>&#34;test-sre&#34;</span><span class=p>,</span>  <span class=c1># 标记需要导入此资源，导入成功后需要手工删除此标记。</span>
</span></span><span class=line><span class=cl><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>然后执行 <code>pulumi up</code> 就会开始导入此资源，如果设定的参数与资源状态不匹配，会有对应的错误提
示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>❯ pulumi up
</span></span><span class=line><span class=cl>Previewing update (dev):
</span></span><span class=line><span class=cl>     Type                 Name             Plan       Info
</span></span><span class=line><span class=cl>     pulumi:pulumi:Stack  pulumi-test-dev
</span></span><span class=line><span class=cl> =   └─ aws:s3:Bucket     p-test-sre       import     [diff: -tags]; 1 warning
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Diagnostics:
</span></span><span class=line><span class=cl>  aws:s3:Bucket (p-test-sre):
</span></span><span class=line><span class=cl>    warning: inputs to import do not match the existing resource; importing this resource will fail
</span></span></code></pre></td></tr></table></div></div><p>在确保参数完全一致后，导入就会成功，导入成功后，需要手动删除代码中的 <code>import</code> 这个标记。</p><h3 id=63-如何从-pulumi-中移除被导入的资源 class=headerLink><a href=#63-%e5%a6%82%e4%bd%95%e4%bb%8e-pulumi-%e4%b8%ad%e7%a7%bb%e9%99%a4%e8%a2%ab%e5%af%bc%e5%85%a5%e7%9a%84%e8%b5%84%e6%ba%90 class=header-mark></a>6.3 如何从 pulumi 中移除被导入的资源</h3><p>格式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>pulumi state delete &lt;resource URN&gt; <span class=o>[</span>flags<span class=o>]</span>
</span></span></code></pre></td></tr></table></div></div><p>比如要删除先前导入的 <code>arn:aws:s3:::test-sre</code>，首先删除对应的代码，然后执行
<code>pulumi preview</code>，就会报错并打印出对应的资源 urn:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-mysql data-lang=mysql><span class=line><span class=cl><span class=err>$</span><span class=w> </span><span class=n>pulumi</span><span class=w> </span><span class=n>preview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Diagnostics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>aws</span><span class=p>:</span><span class=n>s3</span><span class=p>:</span><span class=nf>Bucket</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=o>-</span><span class=n>test</span><span class=o>-</span><span class=n>sre</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>error</span><span class=p>:</span><span class=w> </span><span class=n>Preview</span><span class=w> </span><span class=n>failed</span><span class=p>:</span><span class=w> </span><span class=n>unable</span><span class=w> </span><span class=k>to</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=n>resource</span><span class=w> </span><span class=s2>&#34;urn:pulumi:dev::pulumi-test::aws:s3/bucket:Bucket::p-test-sre&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>as</span><span class=w> </span><span class=n>it</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=n>currently</span><span class=w> </span><span class=n>marked</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>protection</span><span class=p>.</span><span class=w> </span><span class=k>To</span><span class=w> </span><span class=n>unprotect</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>either</span><span class=w> </span><span class=n>remove</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=o>`</span><span class=n>protect</span><span class=o>`</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>resource</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>your</span><span class=w> </span><span class=n>Pulumi</span><span class=w> </span><span class=n>program</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>run</span><span class=w> </span><span class=o>`</span><span class=n>pulumi</span><span class=w> </span><span class=n>up</span><span class=o>`</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>`</span><span class=n>pulumi</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=n>unprotect</span><span class=w> </span><span class=s1>&#39;urn:pulumi:dev::pulumi-test::aws:s3/bucket:Bucket::p-test-sre&#39;</span><span class=o>`</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>接下来使用如下命令强制从 state 文件中移除此资源（仅修改配置，对实际资源无任何影响）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>pulumi state delete urn:pulumi:dev::pulumi-test::aws:s3/bucket:Bucket::p-test-sre --force
</span></span></code></pre></td></tr></table></div></div><h3 id=5-pulumi-kubernetes class=headerLink><a href=#5-pulumi-kubernetes class=header-mark></a>5. pulumi-kubernetes？</h3><p>pulumi-kubernetes 是一条龙服务：</p><ol><li>在 yaml 配置生成这一步，它能结合/替代掉 helm/kustomize，或者你高度自定义的 Python 脚
本。</li><li>在 yaml 部署这一步，它能替代掉 argo-cd 这类 gitops 工具。</li><li>强大的状态管理，argo-cd 也有状态管理，可以对比看看。</li></ol><p>也可以仅通过 kubernetes_pulumi 生成 yaml，再通过 argo-cd 部署，这样 pulumi_kubernetes 就仅
用来简化 yaml 的编写，仍然通过 gitops 工具/kubectl 来部署。</p><p>使用 pulumi-kubernetes 写配置，要警惕逻辑和数据的混合程度。因为 kubernetes 的配置复杂度比
较高，如果动态配置比较多，很容易就会写出难以维护的 python 代码来。</p><p>渲染 yaml 的示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pulumi</span> <span class=kn>import</span> <span class=n>get_stack</span><span class=p>,</span> <span class=n>ResourceOptions</span><span class=p>,</span> <span class=n>StackReference</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pulumi_kubernetes</span> <span class=kn>import</span> <span class=n>Provider</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pulumi_kubernetes.apps.v1</span> <span class=kn>import</span> <span class=n>Deployment</span><span class=p>,</span> <span class=n>DeploymentSpecArgs</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pulumi_kubernetes.core.v1</span> <span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=n>ContainerArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>ContainerPortArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>EnvVarArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>PodSpecArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>PodTemplateSpecArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>ResourceRequirementsArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>Service</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>ServicePortArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>ServiceSpecArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pulumi_kubernetes.meta.v1</span> <span class=kn>import</span> <span class=n>LabelSelectorArgs</span><span class=p>,</span> <span class=n>ObjectMetaArgs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>provider</span> <span class=o>=</span> <span class=n>Provider</span><span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=s2>&#34;render-yaml&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>   <span class=n>render_yaml_to_directory</span><span class=o>=</span><span class=s2>&#34;rendered&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>deployment</span> <span class=o>=</span> <span class=n>Deployment</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s2>&#34;redis&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=n>spec</span><span class=o>=</span><span class=n>DeploymentSpecArgs</span><span class=p>(</span><span class=o>...</span><span class=p>),</span>
</span></span><span class=line><span class=cl>   <span class=n>opts</span><span class=o>=</span><span class=n>ResourceOptions</span><span class=p>(</span><span class=n>provider</span><span class=o>=</span><span class=n>provider</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>如示例所示，pulumi-kubernetes 的配置是完全结构化的，比 yaml/helm/kustomize 要灵活非常多。</p><p>总之它非常灵活，既可以和 helm/kustomize 结合使用，替代掉 argocd/kubectl。也可以和
argocd/kubectl 使用，替代掉 helm/kustomize。</p><p>具体怎么使用好？我也还在研究。</p><h3 id=6-阿里云资源-replace-报错 class=headerLink><a href=#6-%e9%98%bf%e9%87%8c%e4%ba%91%e8%b5%84%e6%ba%90-replace-%e6%8a%a5%e9%94%99 class=header-mark></a>6. 阿里云资源 replace 报错？</h3><p>阿里云有部分资源，只能创建删除，不允许修改，比如「资源组」。对这类资源做变更时，pulumi 会
直接报错：「Resources aleardy exists」，这类资源，通常都有一个「force」参数，指示是否强制
修改——即先删除再重建。</p><h3 id=7-有些资源属性无法使用-pulumi-配置 class=headerLink><a href=#7-%e6%9c%89%e4%ba%9b%e8%b5%84%e6%ba%90%e5%b1%9e%e6%80%a7%e6%97%a0%e6%b3%95%e4%bd%bf%e7%94%a8-pulumi-%e9%85%8d%e7%bd%ae class=header-mark></a>7. 有些资源属性无法使用 pulumi 配置？</h3><p>这得看各云服务提供商的支持情况。</p><p>比如阿里云很多资源的属性，pulumi 都无法完全配置，因为 alicloud provider 的功能还不够全面。</p><p>目前我们生产环境，大概 95%+ 的东西，都可以使用 pulumi 实现自动化配置。而其他 OSS 的高级参
数、新出的 ASM 服务网格、kubernetes 的授权管理、ElasticSearch7 等资源，还是需要手动配置。</p><p>这个没办法，只能等阿里云提供支持。</p><h3 id=8-cicd-中如何使-pulumi-将状态保存到文件 class=headerLink><a href=#8-cicd-%e4%b8%ad%e5%a6%82%e4%bd%95%e4%bd%bf-pulumi-%e5%b0%86%e7%8a%b6%e6%80%81%e4%bf%9d%e5%ad%98%e5%88%b0%e6%96%87%e4%bb%b6 class=header-mark></a>8. CI/CD 中如何使 pulumi 将状态保存到文件？</h3><p>CI/CD 中我们可能会希望 pulumi 将状态保存到本地，避免连接 pulumi 中心服务器。这一方面能加快
速度，另一方面一些临时状态我们可能根本不想存储，可以直接丢弃。</p><p>方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 指定状态文件路径</span>
</span></span><span class=line><span class=cl>pulumi login file://&lt;file-path&gt;
</span></span><span class=line><span class=cl><span class=c1># 保存到默认位置: ~/.pulumi/credentials.json</span>
</span></span><span class=line><span class=cl>pulumi login --local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 保存到远程 S3 存储（minio/ceph 或者各类云对象存储服务，都兼容 aws 的 s3 协议）</span>
</span></span><span class=line><span class=cl>pulumi login s3://&lt;bucket-path&gt;
</span></span></code></pre></td></tr></table></div></div><p>登录完成后，再进行 <code>pulumi up</code> 操作，数据就会直接保存到你设定的路径下。</p><h3 id=9-如何估算资源变更导致的成本变化 class=headerLink><a href=#9-%e5%a6%82%e4%bd%95%e4%bc%b0%e7%ae%97%e8%b5%84%e6%ba%90%e5%8f%98%e6%9b%b4%e5%af%bc%e8%87%b4%e7%9a%84%e6%88%90%e6%9c%ac%e5%8f%98%e5%8c%96 class=header-mark></a>9. 如何估算资源变更导致的成本变化？</h3><p>目前 pulumi 貌似没有类似的工具，但是 terraform 有一个
<a href=https://github.com/infracost/infracost target=_blank rel="noopener noreferrer">infracost</a> 可以干这个活，值得关注。</p><h2 id=缺点 class=headerLink><a href=#%e7%bc%ba%e7%82%b9 class=header-mark></a>缺点</h2><h3 id=1-报错信息不直观 class=headerLink><a href=#1-%e6%8a%a5%e9%94%99%e4%bf%a1%e6%81%af%e4%b8%8d%e7%9b%b4%e8%a7%82 class=header-mark></a>1. 报错信息不直观</h3><p>pulumi 和 terraform 都有一个缺点，就是封装层次太高了。</p><p>封装的层次很高，优点是方便了我们使用，可以使用很统一很简洁的声明式语法编写配置。而缺点，则
是出了 bug，报错信息往往不够直观，导致问题不好排查。</p><h3 id=2-资源状态被破坏时修复起来非常麻烦 class=headerLink><a href=#2-%e8%b5%84%e6%ba%90%e7%8a%b6%e6%80%81%e8%a2%ab%e7%a0%b4%e5%9d%8f%e6%97%b6%e4%bf%ae%e5%a4%8d%e8%b5%b7%e6%9d%a5%e9%9d%9e%e5%b8%b8%e9%ba%bb%e7%83%a6 class=header-mark></a>2. 资源状态被破坏时，修复起来非常麻烦</h3><p>在很多情况下，都可能发生资源状态被破坏的问题：</p><ol><li>在创建资源 A，因为参数是已知的，你直接使用了常量而不是 <code>Output</code>。这会导致 pulumi 无法识
别到依赖关系！从而创建失败，或者删除时资源状态被破坏！</li><li>有一个 pulumi stack 一次在三台物理机上创建资源。你白天创建资源晚上删除资源，但是某一台
物理机晚上会关机。这将导致 pulumi 无法查询到这台物理机上的资源状态，这个 pulumi stack
在晚上就无法使用，它会一直报错！</li></ol><h2 id=常用-provider class=headerLink><a href=#%e5%b8%b8%e7%94%a8-provider class=header-mark></a>常用 Provider</h2><ul><li><a href=https://github.com/pulumi/pulumi-alicloud target=_blank rel="noopener noreferrer">pulumi-alicloud</a>: 管理阿里云资源</li><li><a href=https://github.com/pulumi/pulumi-vault target=_blank rel="noopener noreferrer">pulumi-vault</a>: 我这边用它来快速初始化 vault，创
建与管理 vault 的所有配置。</li></ul><h2 id=我创建维护的-provider class=headerLink><a href=#%e6%88%91%e5%88%9b%e5%bb%ba%e7%bb%b4%e6%8a%a4%e7%9a%84-provider class=header-mark></a>我创建维护的 Provider</h2><p>由于 Pulumi 生态还比较小，有些 provider 只有 terraform 才有。</p><p>我为了造(方)福(便)大(自)众(己)，创建并维护了两个本地虚拟机相关的 Providers:</p><ul><li><a href=https://github.com/ryan4yin/pulumi-proxmox target=_blank rel="noopener noreferrer">ryan4yin/pulumi-proxmox</a>: 目前只用来自动创
建 PVE 虚拟机<ul><li>可以考虑结合 kubespray/kubeadm 快速创建 k8s 集群</li></ul></li><li><a href=https://github.com/ryan4yin/pulumi-libvirt target=_blank rel="noopener noreferrer">ryan4yin/pulumi-libvirt</a>: 快速创建 kvm 虚拟
机<ul><li>可以考虑结合 kubespray/kubeadm 快速创建 k8s 集群</li></ul></li></ul></div><h2>相关内容</h2><div class=related-container><div class=related-item-container><div class=related-image><a href=/posts/finops-for-kubernetes/><img loading=lazy src=/posts/finops-for-kubernetes/finops-for-kubernetes.webp srcset="/posts/finops-for-kubernetes/finops-for-kubernetes.webp, /posts/finops-for-kubernetes/finops-for-kubernetes.webp 1.5x, /posts/finops-for-kubernetes/finops-for-kubernetes.webp 2x" sizes=auto alt=/posts/finops-for-kubernetes/finops-for-kubernetes.webp title=/posts/finops-for-kubernetes/finops-for-kubernetes.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/finops-for-kubernetes/>FinOps for Kubernetes - 如何拆分 Kubernetes 成本</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/kubernetes-deployment-using-kubeadm/><img loading=lazy src=/posts/kubernetes-deployment-using-kubeadm/adopt-kubernetes.webp srcset="/posts/kubernetes-deployment-using-kubeadm/adopt-kubernetes.webp, /posts/kubernetes-deployment-using-kubeadm/adopt-kubernetes.webp 1.5x, /posts/kubernetes-deployment-using-kubeadm/adopt-kubernetes.webp 2x" sizes=auto alt=/posts/kubernetes-deployment-using-kubeadm/adopt-kubernetes.webp title=/posts/kubernetes-deployment-using-kubeadm/adopt-kubernetes.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/kubernetes-deployment-using-kubeadm/>部署一个 Kubernetes 集群</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/kubernetes-best-practices/><img loading=lazy src=/posts/kubernetes-best-practices/kubernetes-best-practices.webp srcset="/posts/kubernetes-best-practices/kubernetes-best-practices.webp, /posts/kubernetes-best-practices/kubernetes-best-practices.webp 1.5x, /posts/kubernetes-best-practices/kubernetes-best-practices.webp 2x" sizes=auto alt=/posts/kubernetes-best-practices/kubernetes-best-practices.webp title=/posts/kubernetes-best-practices/kubernetes-best-practices.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/kubernetes-best-practices/>Kubernetes 微服务最佳实践</a></h2></div></div><div class=sponsor><div class=sponsor-avatar><img loading=lazy src=https://thiscute.world/avatar/myself.webp srcset="https://thiscute.world/avatar/myself.webp, https://thiscute.world/avatar/myself.webp 1.5x, https://thiscute.world/avatar/myself.webp 2x" sizes=auto alt=https://thiscute.world/avatar/myself.webp title=https://thiscute.world/avatar/myself.webp></div><p class=sponsor-bio><em>如果你觉得这篇文章对你有所帮助，欢迎评论、分享、打赏~</em></p><a href=https://afdian.net/a/ryan4yin title=Sponsor target=_blank class=sponsor-button rel="noopener noreferrer"><i class="far fa-heart fa-fw icon" style=color:#ec6cb9></i>
<span>赞赏</span></a></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-01-08</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/experience-of-pulumi/ data-title="Pulumi 使用体验 - 基础设施代码化" data-via=ryan4yin data-hashtags=基础设施即代码,云原生,Pulumi,Terraform><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Hacker News" data-sharer=hackernews data-url=https://thiscute.world/posts/experience-of-pulumi/ data-title="Pulumi 使用体验 - 基础设施代码化"><span class="fab fa-hacker-news fa-fw"></span></button><button title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/experience-of-pulumi/><span class="fab fa-reddit fa-fw"></span></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="分享到 Mastodon" onclick='shareOnMastodon("Pulumi 使用体验 - 基础设施代码化","https://thiscute.world/posts/experience-of-pulumi/")'><span class="fab fa-mastodon fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E5%8D%B3%E4%BB%A3%E7%A0%81/>基础设施即代码</a>,&nbsp;<a href=/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/>云原生</a>,&nbsp;<a href=/tags/pulumi/>Pulumi</a>,&nbsp;<a href=/tags/terraform/>Terraform</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/opensuse-instruction/ class=prev rel=prev title="openSUSE 使用指南"><i class="fas fa-angle-left fa-fw"></i>openSUSE 使用指南</a>
<a href=/posts/qemu-kvm-usage/ class=next rel=next title="QEMU/KVM 虚拟化环境的搭建与使用">QEMU/KVM 虚拟化环境的搭建与使用<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=display:inline-block;width:auto;height:20px></a>
<a href=https://www.foreverblog.cn/go.html target=_blank><img src=https://img.foreverblog.cn/wormhole_3.gif alt style=display:inline-block;width:auto;height:20px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动&nbsp;|&nbsp;托管在 <a title=Vercel href=https://vercel.com/ target=_blank rel="noopener noreffer">Vercel</a> 上&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://thiscute.world/ target=_blank rel="noopener noreferrer">ryan4yin</a></span>&nbsp;|&nbsp;<span class=license> <a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script></div></body></html>