<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>OS as Code - 我的 NixOS 使用体会 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:title" content="OS as Code - 我的 NixOS 使用体会"><meta property="og:description" content="本文最初发表于 如何评价NixOS?，觉得比较有价值所以再搬运到我的博客。 我 23 年 4 月开始用 NixOS 之前也看过（如何评价NixOS?） 这个帖子，几个高"><meta property="og:type" content="article"><meta property="og:url" content="https://thiscute.world/posts/my-experience-of-nixos/"><meta property="og:image" content="https://thiscute.world/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-21T16:26:21+08:00"><meta property="article:modified_time" content="2024-02-21T16:26:21+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp"><meta name=twitter:title content="OS as Code - 我的 NixOS 使用体会"><meta name=twitter:description content="本文最初发表于 如何评价NixOS?，觉得比较有价值所以再搬运到我的博客。 我 23 年 4 月开始用 NixOS 之前也看过（如何评价NixOS?） 这个帖子，几个高"><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><meta name=twitter:creator content="@ryan4yin"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/my-experience-of-nixos/><link rel=prev href=https://thiscute.world/posts/an-incomplete-guide-to-data-security/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"OS as Code - 我的 NixOS 使用体会","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://thiscute.world/posts/my-experience-of-nixos/"},"image":[{"@type":"ImageObject","url":"https://thiscute.world/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp","width":2614,"height":1216}],"genre":"posts","keywords":"NixOS, Nix, Flakes, Linux, DevOps","wordcount":5488,"url":"https://thiscute.world/posts/my-experience-of-nixos/","datePublished":"2024-02-21T16:26:21+08:00","dateModified":"2024-02-21T16:26:21+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https://thiscute.world/avatar/myself.png"},"author":{"@type":"Person","name":"ryan4yin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行 </a><a class=menu-item href=/series/>系列 </a><a class=menu-item href=/categories/tech/>技术 </a><a class=menu-item href=/categories/life/>生活 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/friends/>朋友们 </a><a class=menu-item href=/now/>此刻 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title=选择语言 id=language-select-desktop onchange="location=this.value"><option value=/posts/my-experience-of-nixos/ selected>Simplified Chinese</option><option value=/en/posts/my-experience-of-nixos/>English</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a><a href=javascript:void(0); class=menu-item title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title=选择语言 onchange="location=this.value"><option value=/posts/my-experience-of-nixos/ selected>Simplified Chinese</option><option value=/en/posts/my-experience-of-nixos/>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#nixpkgs-中的包太少>Nixpkgs 中的包太少？</a></li><li><a href=#nixos-值不值得学>NixOS 值不值得学？</a></li><li><a href=#nixos-的声明式配置---os-as-code>NixOS 的声明式配置 - OS as Code</a></li><li><a href=#nixos-的学习成本>NixOS 的学习成本</a></li><li><a href=#nixos-的卖点>NixOS 的卖点？</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">OS as Code - 我的 NixOS 使用体会</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://thiscute.world/ title=Author target=_blank rel="noopener noreferrer author" class=author>ryan4yin</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span>&nbsp;<span class=post-category>和</span>&nbsp;<span class=post-series>系列 <a href=/series/nixos-%E4%B8%8E-nix-flakes/><i class="far fa-list-alt fa-fw"></i>NixOS 与 Nix Flakes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2024-02-21>2024-02-21</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2024-02-21>2024-02-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 5488 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 11 分钟&nbsp;</div></div><div class=featured-image><img loading=eager src=/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp srcset="/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp, /posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp 1.5x, /posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp 2x" sizes=auto alt=/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp title=/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp height=1216 width=2614></div><div class="details series-nav open"><div class="details-summary series-title"><span>系列 - NixOS 与 Nix Flakes</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content series-content"><nav><ul><li><a href=/posts/nixos-and-flake-basics/>NixOS 与 Nix Flakes 新手入门</a></li><li><a href=/posts/how-nixos-start-on-licheepi4a/>NixOS 在 Lichee Pi 4A 上是如何启动的</a></li><li><span class=active>OS as Code - 我的 NixOS 使用体会</span></li></ul></nav></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#nixpkgs-中的包太少>Nixpkgs 中的包太少？</a></li><li><a href=#nixos-值不值得学>NixOS 值不值得学？</a></li><li><a href=#nixos-的声明式配置---os-as-code>NixOS 的声明式配置 - OS as Code</a></li><li><a href=#nixos-的学习成本>NixOS 的学习成本</a></li><li><a href=#nixos-的卖点>NixOS 的卖点？</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>本文最初发表于 <a href=https://www.zhihu.com/question/56543855/answer/3403111768 target=_blank rel="noopener noreferrer">如何评价NixOS?</a>，觉得比较有价值所以再搬运到我的博客。</p></blockquote><p>我 23 年 4 月开始用 NixOS 之前也看过（<a href=https://www.zhihu.com/question/56543855/answer/3403111768 target=_blank rel="noopener noreferrer">如何评价NixOS?</a>） 这个帖子，几个高赞回答都从不同方面给出了很有意义的评价，也是吸引我入坑的原因之一。</p><p>现在是 2024 年 2 月，距离我入坑 NixOS 刚好 10 个月，我当初写的新手笔记已经获得了大量好评与不少的赞助，并成为了整个社区最受欢迎的入门教程之一。自 2023 年 6 月我为它专门创建一个 GitHub 仓库与单独的文档站点以来，它已经获得了 1189 个 stars，除我之外还有 37 位读者给它提了 PR：</p><ul><li><a href=https://nixos-and-flakes.thiscute.world/zh/ target=_blank rel="noopener noreferrer">NixOS 与 FLakes - 一份非官方的新手指南</a></li></ul><figure><img src=./nixos-and-flakes-book-202402.webp width=80%><figcaption><h4>NixOS & Flakes Book</h4></figcaption></figure><p>那么作为一个已经深度使用 NixOS 作为主力桌面系统接近 10 个月的熟手，我在这里也从另一个角度来分享下我的入坑体会。</p><p>注意，这篇文章不是 NixOS 入门教程，想看教程请移步上面给的链接。</p><h2 id=nixpkgs-中的包太少 class=headerLink><a href=#nixpkgs-%e4%b8%ad%e7%9a%84%e5%8c%85%e5%a4%aa%e5%b0%91 class=header-mark></a>Nixpkgs 中的包太少？</h2><p>先澄清下一点，NixOS 的包非常的多，Nixpkgs 中的包在体量上跟 Arch AUR 是一个级别的。<a href="https://link.zhihu.com/?target=https%3A//repology.org/repositories/statistics/total" target=_blank rel="noopener noreferrer">Repository statistics</a> 的包仓库统计数据如下：</p><p><figure><img loading=lazy src=./repository-statistics.webp srcset="./repository-statistics.webp, ./repository-statistics.webp 1.5x, ./repository-statistics.webp 2x" sizes=auto alt="Repository statistics" title="Repository statistics"></figure></p><p>虽然 Nixpkgs 因为还打了许多 npm 之类的包，包的总数有水分，但即使排除掉这部分包，它跟 AUR 的包数量应该也是差不多的。</p><p>而且因为 Nixpkgs 是官方包仓库，使用了 Monorepo 与 PR Review 机制，整体的包质量肯定是比 AUR 要好的。上面截图也能看到 Nixpkgs 的包整体上比 AUR 更新、漏洞更少。</p><p>包仓库这里也是 NixOS 跟 Arch 不太同的地方，Arch 的官方包仓库收录很严格，相对的 AUR 生态相当繁荣。但任何人都能往 AUR 上传内容，虽然有一个投票机制起到一定审核作用，但这个限制太松散了。</p><p>而 NixOS 就很不一样了，它的官方包仓库 Nixpkgs 很乐于接受新包，想为 Nixpkgs 提个 PR 加包或功能相对其他发行版而言要简单许多，这是导致 Nixpkgs 的体量接近 AUR 的直接原因（GitHub 显示 Nixpkgs 有 5000+ 历史贡献者，这很夸张了）。NixOS 其实也有个与 AUR(Arch User Repository) 类似的 NUR（Nix User Repository），但因为 Nixpkgs 的宽松，NUR 反而没啥内容。</p><p>举例来说，QQ 能直接从 Nixpkgs 官方包仓库下载使用，而在 Arch 上你得用 AUR 或者 archlinux-cn.</p><p>这算是各有优势吧。NixOS 被人喷包少，主要是因为它不遵循 FHS 标准，导致大部分网上下载的 Linux 程序都不能直接在 NixOS 上运行。这当然有解决方案，我建议是首先看看 Nixpkgs 中是否已经有这个包了，有的话直接用就行。如果没有，再尝试一些社区的解决方案，或者自己给打个包。</p><p>用 NixOS 的话自己打包程序是不可避免的，因为即使 Nixpkgs 中已经有了这么多包，但它仍然不可能永远 100% 匹配你的需求，总有你想用但 Nixpkgs 跟 NUR 里边都没有的包，在 NixOS 上你常常必须要给你的包写个打包脚本，才能使它在 NixOS 上正常运行。</p><p>另外即使有些程序本身确实能在 NixOS 上无痛运行，但为了做到可复现，NixOS 用户通常也会选择自己手动给它打个包。</p><p>OK，闲话说完，下面进入正题。</p><p>首先，NixOS 比传统发行版复杂很多，也存在非常多的历史遗留问题。</p><p>举例来说，它的官方文档烂到逼得我一个刚学 NixOS 的新手自己边学边写入门文档。在我用自己的渣渣英语把笔记翻译了一遍发到 reddit （<a href=https://www.reddit.com/r/NixOS/comments/13dxw9d/nixos_nix_flakes_a_guide_for_beginners/ target=_blank rel="noopener noreferrer">NixOS & Nix Flakes - A Guide for Beginners</a>）后，居然还获得了许多老外的大量好评（经过这么长时间的持续迭代，现在甚至已经变成了社区最受欢迎的新手教程之一），这侧面也说明官方文档到底有多烂。</p><h2 id=nixos-值不值得学 class=headerLink><a href=#nixos-%e5%80%bc%e4%b8%8d%e5%80%bc%e5%be%97%e5%ad%a6 class=header-mark></a>NixOS 值不值得学？</h2><p><strong>NixOS 值不值得学或者说投入产出比是否够高？在我看来，这归根结底是个规模问题</strong>。</p><p><strong>这里的规模，一是指你对 Linux 系统所做的自定义内容的规模，二是指你系统更新的频繁程度，三是指你 Linux 机器的数量</strong>。</p><p>下面我从个人经历的角度来讲下我以前用 Arch Ubuntu 等传统发行版的体验，以及我为什么选择了 NixOS，NixOS 又为我带来了什么样的改变。</p><p>举个例子，以前我用 Deepin Ubuntu 时我基本没对系统做过什么深入定制，一是担心把系统弄出问题修复起来头疼，二是如果不额外写一份文档或脚本记录下步骤的话，我做的所有定制都是黑盒且不可迁移的，一个月后我就全忘了，只能战战兢兢地持续维护这个随着我的使用而越来越黑盒、状态越来越混沌的系统。</p><p>如果用的是 Arch 这种滚动发行版还好，系统一点点增量更新，遇到的一般都是小问题。而对 Ubuntu Deepin 这种，原地升级只出小问题是很少见的，这基本就意味着我必须在某个时间点，在新版本的 Ubuntu 上把我以前做过的定制再全部重做一遍，更关键的是，我非常有可能已经忘了我以前做了什么，这就意味着我得花更多的时间去研究我的系统环境里到底都有些啥东西，是怎么安装配置的，这种重复劳动非常痛苦。</p><p>总之很显然的一点是，我对系统做的定制越多越复杂，迁移到新版本的难度就越大。</p><p>我想也正是因为这一点，Arch Gentoo Fedora 这种滚动发行版才在 Linux 爱好者圈子中如此受欢迎，喜欢定制自己系统的 Linux 用户也大都使用这类滚动发行版。</p><p>那么 Arch Fedora 就能彻底解决问题了么？显然并不是。
首先它们的更新频率比较高，这代表着你会更容易把你的系统搞出点毛病来。当然这其实是个小问题，现在 Linux 社区谁还没整上个 btrfs / zfs 文件系统快照啊，出问题回滚快照就行。
它们最根本的问题是：</p><ol><li>你的 Arch 系统环境、文件系统快照、或者虚拟机快照，它们仍然是个黑盒，仍然会随着你的持续使用而越来越混沌，也并不包含如何从零构建这个环境的「知识」，是<strong>不可解释</strong>的。<ul><li>我在工作中就见到过一些「<strong>祖传虚拟机快照</strong>」或「<strong>祖传云服务器快照</strong>」，没人知道这个环境是怎么搭建的，每一任接手的人都只能继续往上叠 Buff，然后再把这个定时炸弹传给下一任。这就像那个轮流往一个水杯里加水的游戏，最后在谁加水的时候溢出来了，那就算他倒霉。</li></ul></li><li>Arch 实质要求你持续跟着它的更新走，这意味着你必须要持续更新维护它。<ul><li>如果你把机器放了一年半载跑得很稳定，然后你想要更新一下，那出问题的风险会相当高。如果你因此而决定弄台最新版本的 Arch 机器再把旧环境还原出来，那就又回到了之前的问题——你得想办法从旧环境中还原出你的定制流程，这也不是个好差事。</li></ul></li><li>快照与当前硬件环境强相关，直接在不同硬件的机器上使用很容易遇到各种奇怪的问题，也就是说这东西<strong>不可迁移</strong>。</li><li>快照是一堆庞大的二进制文件，它的体积非常大，这使得备份与分享它的成本高昂。</li></ol><p>Docker 能解决上述问题中的一部分。
首先它的容器镜像可由 Dockerfile 完全描述，也就是说它是<strong>可解释</strong>的，此外容器镜像能在不同环境中复现出完全一致的环境，这表明它是<strong>可迁移</strong>的。
对于服务器环境，将应用程序全都跑在容器中，宿主机只负责跑容器，这种架构使得你只需要维护最基础的系统环境，以及一些 Dockerfile 跟 yaml 文件，这极大地降低了系统的维护成本，从而成为了 DevOps 的首选。</p><p>但 Docker 容器技术是专为应用程序的提供一致的运行环境而设计的，在虚拟机、桌面环境等场景下它并不适用（当然你非要这么弄也不是不行，很麻烦就是了）。
此外 Dockerfile 仍旧依赖你所编写的各种脚本、命令来构建镜像，这些脚本、命令都需要你自己维护，其运行结果的可复现能力也完全看你自己的水平。</p><p>如果你因为这些维护难题而选择极简策略——尽可能少地定制任何桌面系统与虚拟机环境，能用默认的就用默认——这就是换到 NixOS 之前的我。
为了降低系统维护难度，我以前使用 Deepin Manjaro EndeavourOS 的过程中，基本没对系统配置做任何大变动。
作为一名 SRE/DevOps，我在工作中就已经踩了够多的环境问题的坑，写腻写烦各种安装脚本、Ansible 配置了，业余完全不想搞这些幺蛾子。</p><p>但如果你是个喜欢定制与深入研究系统细节的极客，随着你对系统所做的定制越来越多，越来越复杂，或者你 Homelab 与云上的 Linux 机器越来越多，你一定会在某个时间点开始编写各种部署流程的文档、部署脚本或使用一些自动化工具帮自己完成一些繁琐的工作。</p><p>文档就不用说了，这个显然很容易过时，没啥大用。
如果你选择自己写自动化脚本或选用自动化工具，它的配置会越来越复杂，而且系统更新经常会破坏掉其中一些功能，需要你手动修复。
此外它还高度依赖你当前的系统环境，当你某天装了台新机器然后信心满满地用它部署环境时，大概率会遇到各种环境不一致导致的错误需要手动解决。还有一点是，你写的脚本大概率并没有仔细考量抽象、模块化、错误处理等内容，这也会导致随着规模的扩大，维护它变得越来越痛苦。</p><p>然后你发现了 NixOS，它有什么声明式的配置，你仔细看了下它的实现，哦这声明式的配置，不就是把一堆 bash 脚本封装了下，对用户只提供了一套简洁干净的 api 么，它实际干的活不跟我自己这几年写的一堆脚本一模一样？好像没啥新鲜的。</p><p>嗯接着你试用了一下，发现 NixOS 的这套系统定制脚本都存在一个叫 Nixpkgs 的仓库中，有数千人在持续维护它，几十年积累下来已经拥有了一套非常丰富、也比较稳定的声明式抽象、模块系统、类型系统、专为这套超大型的软件包仓库与 NixOS 系统配置而开发的大规模 CI 系统 Hydra、以及逐渐形成的能满足数千人协作更新这套复杂配置的社区运营模式。</p><p>你立马学习 nix 语言，然后动手把这套维护了 N 年的脚本改写成 NixOS 配置。</p><p>越写就对它越满意，改造后的配置缩水了相当多，维护难度直线下降。</p><p>很大部分以前自己用各种脚本跟工具实现的功能，都被 Nixpkgs 封装好了，只需要 enable 一下再传几个关键参数，就能无痛运行。nixpkgs 中的脚本都有专门的 maintainer 维护更新，任何发现了问题的用户也可以提个 PR 修下问题，在没经过 CI 与 staging unstable 等好几个阶段的广泛验证前，更新也不会进入 stable.</p><p>上面所说的你，嗯就是我自己。</p><p>现在回想下我当初就为了用 systemd 跑个简单的小工具而跟 systemd 疯狂搏斗的场景，泪目&mldr; 要是我当初就懂 NixOS&mldr;</p><h2 id=nixos-的声明式配置---os-as-code class=headerLink><a href=#nixos-%e7%9a%84%e5%a3%b0%e6%98%8e%e5%bc%8f%e9%85%8d%e7%bd%ae---os-as-code class=header-mark></a>NixOS 的声明式配置 - OS as Code</h2><p>有过一定编程经验的人都应该知道抽象与模块化的重要性，复杂程度越高的场景，抽象与模块化带来的收益就越高。Terraform/Kubernetes 甚至 Spring Boot 的流行都体现了这一点。NixOS 的声明式配置也是如此，它将底层的实现细节都封装起来了，并且这些底层封装大都有社区负责更新维护，还有 PR Review、CICD 与多阶段的测试验证确保其可靠性，这极大地降低了我的心智负担，从而解放了我的生产力。它的可复现能力则免除了我的后顾之忧，让我不再担心搞坏系统。</p><p>从另一方面看，NixOS 的声明式配置也是一份从零构建出一个一模一样的 OS 的知识，或者说是一份可构建出你 NixOS 系统环境的<strong>源代码</strong>。
只要这个源代码没丢，对它进行修改、审查，将源代码分享给别人，或者从别人的源代码中借鉴一些自己想要的功能，都是非常容易的。</p><p>NixOS 的配置声明了整个系统完整的状态，你简单的抄点其他 NixOS 用户的系统配置就能很确定自己将得到同样的环境。相比之下，你抄其他 Arch/Ubuntu 等传统发行版用户的配置就要麻烦的多，要考虑各种版本区别、环境区别，不确定性很高。</p><h2 id=nixos-的学习成本 class=headerLink><a href=#nixos-%e7%9a%84%e5%ad%a6%e4%b9%a0%e6%88%90%e6%9c%ac class=header-mark></a>NixOS 的学习成本</h2><p>NixOS 的入门门槛相对较高，也不适合从来没接触过 Linux 与编程的小白，这是因为它的设计理念与传统 Linux 发行版有很大不同。
但这也是它的优势所在，跨过那道门槛，你会发现一片新天地。</p><p>举例来说，<strong>NixOS 用户翻 Nixpkgs 中的实现源码实际是每个用户的基本技能，给 Nixpkgs 提 PR 加功能加包修 Bug 的 NixOS 用户也相当常见</strong>。
<strong>这既是使新用户望而却步的拦路之虎，同时也是给选择了 NixOS 的 Linux 用户提供的进阶之梯</strong>。</p><p>想象下大部分 Arch 用户（比如以前的我）可能用了好几年 Arch，但根本不了解 Arch 底层的实现细节，没打过自己的包。而 NixOS 能让翻源码成为常态，实际也说明理解它的实现细节并不难。我从两个方面来说明这一点。</p><p>第一，Nix 是一门相当简单的语言，语法规则相当少，<strong>比 Java Python 这种通用语言简单了太多</strong>。因此有一定编程经验的工程师能花两三个小时就完整过一遍它的语法。再多花一点时间，读些常见 Nix 代码就没啥难度了。</p><p>第二，<strong>NixOS 良好的声明式抽象与模块化系统，将 OS 分成了许多层来实现，使用户在使用过程中，既可以只关注当前这一层抽象接口，也可以选择再深入到下一层抽象来更自由地实现自己想要的功能</strong>（<strong>这种选择的权利，实际也给了用户机会去渐进式地理解 NixOS 本身</strong>）。举例来说，新手用户只要懂最上层的抽象就正常使用 NixOS。当你有了一点使用经验，想实现些自定义需求，挖下深挖一层抽象（比如说直接通过 systemd 的声明式参数自定义一些操作）通常就足够了。如果你已经是个 NixOS 熟手，想更极客一点，就可以再继续往下挖。</p><p>总之因为上面这两点，理解 Nixpkgs 中的源码或者使用 Nix 语言自己打几个包并不难，可以说每个有一定经验的 NixOS 用户同时也会是 NixOS 打包人。</p><h2 id=nixos-的卖点 class=headerLink><a href=#nixos-%e7%9a%84%e5%8d%96%e7%82%b9 class=header-mark></a>NixOS 的卖点？</h2><p>我们看了许多人提到 NixOS 的优点，上面我也提到了不少。
圈外人听得比较多的可能主要是它不存在依赖冲突，能随时回滚，强大的可复现能力。
如果你有实际使用过 NixOS，那你也应该知道 NixOS 的这些优势：</p><ol><li>系统更新具有类似数据库事务的原子化特性，这意味着你的系统更新要么成功要么失败，（一般）不会出现中间状态。</li><li>NixOS 的声明式配置实际实现了 OS as Code，这使得这些配置非常便于分享。直接在 GitHub 上从其他 NixOS 用户那里 Copy 需要的代码到你的系统配置中，你就能得到一个一模一样的功能。新手用户也能很容易地从别人的配置中学到很多东西。</li><li>声明式配置为用户提供了高度便捷的系统自定义能力，通过改几行配置，就可以快速更换系统的各种组件。</li><li>等等</li></ol><p>这些都是 NixOS 的卖点，其中一些特性现在在传统发行版上也能实现，Fedora Silverblue 等新兴的不可变发行版也在这些方面有些不错的创新。
但能解决所有这些问题的系统，目前只有 NixOS（以及更小众的 Guix——它同样基于 Nix 包管理器）。</p><h2 id=总结 class=headerLink><a href=#%e6%80%bb%e7%bb%93 class=header-mark></a>总结</h2><p>从决定入坑 NixOS 到现在，短短 10 个月，我在 Linux 上取得的收获远超过去三年。我已经在 PC 上尝试了非常多的新技术新工具，我的 Homelab 内容也丰富了非常多（我目前已经有了十多台 NixOS 主机），我对 Linux 系统结构的了解也越来越深刻。光是这几点收获，就完全值回票价了。</p><p>总的来说，NixOS 很特殊，很强大。
但另一方面它也有着相当多的历史债务，比如说文档混乱不说人话、Flakes 特性从 2019 年搞到现在 2024 年还处在实验状态、Nix 语言太过简单导致 Nixpkgs 中大量使用 Bash 脚本、模块系统的实现缺陷导致报错信息相当隐晦，等等。
但社区正在蓬勃发展，文档、Flakes 等技术债社区都在积极解决中，而且 NixOS 的热度也在持续提升（我写的新手教程也为此出了一份力），因此我对它的未来持比较乐观的态度。</p></div><h2>相关内容</h2><div class=related-container><div class=related-item-container><div class=related-image><a href=/posts/an-incomplete-guide-to-data-security/><img loading=lazy src=/posts/an-incomplete-guide-to-data-security/datasecurity.webp srcset="/posts/an-incomplete-guide-to-data-security/datasecurity.webp, /posts/an-incomplete-guide-to-data-security/datasecurity.webp 1.5x, /posts/an-incomplete-guide-to-data-security/datasecurity.webp 2x" sizes=auto alt=/posts/an-incomplete-guide-to-data-security/datasecurity.webp title=/posts/an-incomplete-guide-to-data-security/datasecurity.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/an-incomplete-guide-to-data-security/>个人数据安全不完全指南</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/how-nixos-start-on-licheepi4a/><img loading=lazy src=/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp srcset="/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp, /posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp 1.5x, /posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp 2x" sizes=auto alt=/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp title=/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/how-nixos-start-on-licheepi4a/>NixOS 在 Lichee Pi 4A 上是如何启动的</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/why-i-choose-niche-products/><img loading=lazy src=/posts/why-i-choose-niche-products/anime-girls-seagulls.webp srcset="/posts/why-i-choose-niche-products/anime-girls-seagulls.webp, /posts/why-i-choose-niche-products/anime-girls-seagulls.webp 1.5x, /posts/why-i-choose-niche-products/anime-girls-seagulls.webp 2x" sizes=auto alt=/posts/why-i-choose-niche-products/anime-girls-seagulls.webp title=/posts/why-i-choose-niche-products/anime-girls-seagulls.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/why-i-choose-niche-products/>为什么我折腾这些小众技术？</a></h2></div></div><div class=sponsor><div class=sponsor-avatar><img loading=lazy src=https://thiscute.world/avatar/myself.webp srcset="https://thiscute.world/avatar/myself.webp, https://thiscute.world/avatar/myself.webp 1.5x, https://thiscute.world/avatar/myself.webp 2x" sizes=auto alt=https://thiscute.world/avatar/myself.webp title=https://thiscute.world/avatar/myself.webp></div><p class=sponsor-bio><em>如果你觉得这篇文章对你有所帮助，欢迎评论、分享、打赏~</em></p><a href=https://afdian.net/a/ryan4yin title=Sponsor target=_blank class=sponsor-button rel="noopener noreferrer"><i class="far fa-heart fa-fw icon" style=color:#ec6cb9></i>
<span>赞赏</span></a></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-02-21</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/my-experience-of-nixos/ data-title="OS as Code - 我的 NixOS 使用体会" data-via=ryan4yin data-hashtags=NixOS,Nix,Flakes,Linux,DevOps><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Hacker News" data-sharer=hackernews data-url=https://thiscute.world/posts/my-experience-of-nixos/ data-title="OS as Code - 我的 NixOS 使用体会"><span class="fab fa-hacker-news fa-fw"></span></button><button title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/my-experience-of-nixos/><span class="fab fa-reddit fa-fw"></span></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="分享到 Mastodon" onclick='shareOnMastodon("OS as Code - 我的 NixOS 使用体会","https://thiscute.world/posts/my-experience-of-nixos/")'><span class="fab fa-mastodon fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/nixos/>NixOS</a>,&nbsp;<a href=/tags/nix/>Nix</a>,&nbsp;<a href=/tags/flakes/>Flakes</a>,&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/devops/>DevOps</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/an-incomplete-guide-to-data-security/ class=prev rel=prev title=个人数据安全不完全指南><i class="fas fa-angle-left fa-fw"></i>个人数据安全不完全指南</a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=display:inline-block;width:auto;height:20px></a>
<a href=https://www.foreverblog.cn/go.html target=_blank><img src=https://img.foreverblog.cn/wormhole_3.gif alt style=display:inline-block;width:auto;height:20px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动&nbsp;|&nbsp;托管在 <a title=Vercel href=https://vercel.com/ target=_blank rel="noopener noreffer">Vercel</a> 上&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://thiscute.world/ target=_blank rel="noopener noreferrer">ryan4yin</a></span>&nbsp;|&nbsp;<span class=license> <a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script></div></body></html>