<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>SQLAlchemy 学习笔记（三）：ORM 中的关系构建 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:title" content="SQLAlchemy 学习笔记（三）：ORM 中的关系构建"><meta property="og:description" content="个人笔记，不保证正确。 一、关系构建：ForeignKey 与 relationship关系构建的重点，在于搞清楚这两个函数的用法。Foreign"><meta property="og:type" content="article"><meta property="og:url" content="https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/"><meta property="og:image" content="https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/sqlalchemy-relationships.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-21T22:19:00+08:00"><meta property="article:modified_time" content="2019-05-21T22:19:00+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/sqlalchemy-relationships.webp"><meta name=twitter:title content="SQLAlchemy 学习笔记（三）：ORM 中的关系构建"><meta name=twitter:description content="个人笔记，不保证正确。 一、关系构建：ForeignKey 与 relationship关系构建的重点，在于搞清楚这两个函数的用法。Foreign"><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><meta name=twitter:creator content="@ryan4yin"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/><link rel=prev href=https://thiscute.world/posts/webnovel-addiction-recovery/><link rel=next href=https://thiscute.world/posts/escape-my-university/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"SQLAlchemy 学习笔记（三）：ORM 中的关系构建","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/"},"image":[{"@type":"ImageObject","url":"https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/sqlalchemy-relationships.webp","width":1500,"height":864}],"genre":"posts","keywords":"SQLAlchemy, Python, ORM, 后端, 数据库, Database","wordcount":3074,"url":"https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/","datePublished":"2019-05-21T22:19:00+08:00","dateModified":"2019-05-21T22:19:00+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https://thiscute.world/avatar/myself.png"},"author":{"@type":"Person","name":"ryan4yin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行
</a><a class=menu-item href=/series/>系列
</a><a class=menu-item href=/categories/tech/>技术
</a><a class=menu-item href=/categories/life/>生活
</a><a class=menu-item href=/tags/>标签
</a><a class=menu-item href=/friends/>朋友们
</a><a class=menu-item href=/now/>此刻
</a><a class=menu-item href=/about/>关于
</a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title=选择语言 id=language-select-desktop onchange="location=this.value"><option value=/posts/sqlalchemy-notes-3-relationship-and-foreignkey/ selected>Simplified Chinese</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a><a href=javascript:void(0); class=menu-item title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title=选择语言 onchange="location=this.value"><option value=/posts/sqlalchemy-notes-3-relationship-and-foreignkey/ selected>Simplified Chinese</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#一关系构建foreignkey-与-relationship>一、关系构建：<code>ForeignKey</code> 与 <code>relationship</code></a></li><li><a href=#二relationship>二、<code>relationship</code></a><ul><li><a href=#1-一对多>1. 一对多</a><ul><li><a href=#11-反向引用>1.1 反向引用</a><ul><li><a href=#111-backref-与-back_populates>1.1.1 <code>backref</code> 与 <code>back_populates</code></a></li></ul></li><li><a href=#112-反向引用的参数sqlalchemyormbackrefname-kwargs>1.1.2. 反向引用的参数：<code>sqlalchemy.orm.backref(name, **kwargs)</code></a></li></ul></li><li><a href=#2-多对一>2. 多对一</a></li><li><a href=#3-一对一>3. 一对一</a></li><li><a href=#4-多对多>4. 多对多</a><ul><li><a href=#41-user2user>4.1 user2user</a></li></ul></li></ul></li><li><a href=#三orm-层-的-delete-cascade-vs-foreign-key-层的-on-delete-cascade>三、ORM 层 的 “delete” cascade vs. FOREIGN KEY 层的 “ON DELETE” cascade</a><ul><li><a href=#方法一orm-层的-cascade-实现>方法一：ORM 层的 cascade 实现</a></li><li><a href=#方法二数据库层的-cascade-实现>方法二：数据库层的 cascade 实现</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">SQLAlchemy 学习笔记（三）：ORM 中的关系构建</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=https://thiscute.world/ title=Author target=_blank rel="noopener noreferrerauthor" class=author>ryan4yin</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-05-21>2019-05-21</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2019-05-21>2019-05-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3074 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 7 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#一关系构建foreignkey-与-relationship>一、关系构建：<code>ForeignKey</code> 与 <code>relationship</code></a></li><li><a href=#二relationship>二、<code>relationship</code></a><ul><li><a href=#1-一对多>1. 一对多</a><ul><li><a href=#11-反向引用>1.1 反向引用</a><ul><li><a href=#111-backref-与-back_populates>1.1.1 <code>backref</code> 与 <code>back_populates</code></a></li></ul></li><li><a href=#112-反向引用的参数sqlalchemyormbackrefname-kwargs>1.1.2. 反向引用的参数：<code>sqlalchemy.orm.backref(name, **kwargs)</code></a></li></ul></li><li><a href=#2-多对一>2. 多对一</a></li><li><a href=#3-一对一>3. 一对一</a></li><li><a href=#4-多对多>4. 多对多</a><ul><li><a href=#41-user2user>4.1 user2user</a></li></ul></li></ul></li><li><a href=#三orm-层-的-delete-cascade-vs-foreign-key-层的-on-delete-cascade>三、ORM 层 的 “delete” cascade vs. FOREIGN KEY 层的 “ON DELETE” cascade</a><ul><li><a href=#方法一orm-层的-cascade-实现>方法一：ORM 层的 cascade 实现</a></li><li><a href=#方法二数据库层的-cascade-实现>方法二：数据库层的 cascade 实现</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>个人笔记，不保证正确。</p></blockquote><h2 id=一关系构建foreignkey-与-relationship class=headerLink><a href=#%e4%b8%80%e5%85%b3%e7%b3%bb%e6%9e%84%e5%bb%baforeignkey-%e4%b8%8e-relationship class=header-mark></a>一、关系构建：<code>ForeignKey</code> 与 <code>relationship</code></h2><p>关系构建的重点，在于搞清楚这两个函数的用法。<code>ForeignKey</code> 的用法已经在 <a href=https://www.cnblogs.com/kirito-c/p/10269485.html#%E8%A1%A8%E5%AE%9A%E4%B9%89%E4%B8%AD%E7%9A%84%E7%BA%A6%E6%9D%9F target=_blank rel="noopener noreferrer">SQL表达式语言 - 表定义中的约束</a>
讲过了。主要是 <code>ondelete</code> 和 <code>onupdate</code> 两个参数的用法。</p><h2 id=二relationship class=headerLink><a href=#%e4%ba%8crelationship class=header-mark></a>二、<code>relationship</code></h2><p><code>relationship</code> 函数在 ORM 中用于构建表之间的关联关系。与 <code>ForeignKey</code> 不同的是，它定义的关系不属于表定义，而是动态计算的。
用它定义出来的属性，相当于 SQL 中的视图。</p><p>这个函数有点难用，一是因为它的有几个参数不太好理解，二是因为它的参数非常丰富，让人望而却步。下面通过<strong>一对多</strong>、<strong>多对一</strong>、<strong>多对多</strong>几个场景下 <code>relationship</code> 的使用，来一步步熟悉它的用法。</p><p>首先初始化：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy</span> <span class=kn>import</span> <span class=n>Table</span><span class=p>,</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>relationship</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.ext.declarative</span> <span class=kn>import</span> <span class=n>declarative_base</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=1-一对多 class=headerLink><a href=#1-%e4%b8%80%e5%af%b9%e5%a4%9a class=header-mark></a>1. 一对多</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 因为 Child 中有 Parent 的 ForeignKey，这边的声明不需要再额外指定什么。</span>
</span></span><span class=line><span class=cl>    <span class=n>children</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>)</span>  <span class=c1># children 的集合，相当于一个视图。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;child&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parent_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;parent.id&#39;</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><p>一个 <code>Parent</code> 可以有多个 <code>Children</code>，通过 <code>relationship</code>，我们就能直接通过 <code>parent.children</code> 得到结果，免去繁琐的 query 语句。</p><h4 id=11-反向引用 class=headerLink><a href=#11-%e5%8f%8d%e5%90%91%e5%bc%95%e7%94%a8 class=header-mark></a>1.1 反向引用</h4><h5 id=111-backref-与-back_populates class=headerLink><a href=#111-backref-%e4%b8%8e-back_populates class=header-mark></a>1.1.1 <code>backref</code> 与 <code>back_populates</code></h5><p>那如果我们需要得知 <code>child</code> 的 <code>parent</code> 对象呢？能不能直接访问 <code>child.parent</code>？</p><p>为了实现这个功能，SQLAlchemy 提供了 <code>backref</code> 和 <code>back_populates</code> 两个参数。</p><p>两个参数的效果完全一致，区别在于，<code>backref</code> 只需要在 <code>Parent</code> 类中声明 <code>children</code>，<code>Child.parent</code> 会被动态创建。</p><p>而 <code>back_populates</code> 必须在两个类中显式地使用 <code>back_populates</code>，更显繁琐。（但是也更清晰？）</p><p>先看 <code>backref</code> 版：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>children</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>backref</span><span class=o>=</span><span class=s2>&#34;parent&#34;</span><span class=p>)</span>  <span class=c1># backref 表示，在 Child 类中动态创建 parent 属性，指向当前类。</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Child 类不需要修改</span>
</span></span></code></pre></td></tr></table></div></div><p>再看 <code>back_populates</code> 版：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>children</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s2>&#34;parent&#34;</span><span class=p>)</span>  <span class=c1># back_populates</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;child&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parent_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;parent.id&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 这边也必须声明，不能省略！</span>
</span></span><span class=line><span class=cl>    <span class=n>parent</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Parent&#34;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s2>&#34;children&#34;</span><span class=p>)</span>  <span class=c1># parent 不是集合，是属性！</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>NOTE：声明的两个 <code>relationship</code> 不需要多余的说明，SQLAlchemy 能自动识别到 <code>parent.children</code> 是 collection，<code>child.parent</code> 是 attribute.</strong></p><h4 id=112-反向引用的参数sqlalchemyormbackrefname-kwargs class=headerLink><a href=#112-%e5%8f%8d%e5%90%91%e5%bc%95%e7%94%a8%e7%9a%84%e5%8f%82%e6%95%b0sqlalchemyormbackrefname-kwargs class=header-mark></a>1.1.2. 反向引用的参数：<code>sqlalchemy.orm.backref(name, **kwargs)</code></h4><p>使用 <code>back_populates</code> 时，我们可以很方便地在两个 <code>relationship</code> 函数中指定各种参数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>children</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s2>&#34;parent&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>)</span>  <span class=c1># 指定 lazy 的值</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;child&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parent_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;parent.id&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>parent</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Parent&#34;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s2>&#34;children&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>)</span>  <span class=c1># 指定 lazy 的值</span>
</span></span></code></pre></td></tr></table></div></div><p>但是如果使用 <code>backref</code>，因为我们只有一个 <code>relationship</code> 函数，<code>Child.parent</code> 是被隐式创建的，我们该如何指定这个属性的参数呢？</p><p>答案就是 <code>backref()</code> 函数，使用它替代 <code>backref</code> 参数的值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sqlalchemy.orm</span> <span class=kn>import</span> <span class=n>backref</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>children</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>backref</span><span class=o>=</span><span class=n>backref</span><span class=p>(</span><span class=s2>&#34;parent&#34;</span><span class=p>,</span> <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>))</span>  <span class=c1># 使用 backref() 函数，指定 Child.parent 属性的参数</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Child 类不需要修改</span>
</span></span></code></pre></td></tr></table></div></div><p><code>backref()</code> 的参数会被传递给 <code>relationship()</code>，因此它俩的参数也完全一致。</p><h3 id=2-多对一 class=headerLink><a href=#2-%e5%a4%9a%e5%af%b9%e4%b8%80 class=header-mark></a>2. 多对一</h3><p>A many-to-one is similar to a one-to-many relationship. The difference is that this relationship is looked at from the &ldquo;many&rdquo; side.</p><h3 id=3-一对一 class=headerLink><a href=#3-%e4%b8%80%e5%af%b9%e4%b8%80 class=header-mark></a>3. 一对一</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;parent&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>child</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                    <span class=n>uselist</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>   <span class=c1># 不使用 collection！这是关键</span>
</span></span><span class=line><span class=cl>                                    <span class=n>back_populates</span><span class=o>=</span><span class=s2>&#34;parent&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;child&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>parent_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;parent.id&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     <span class=c1># 包含 ForeignKey 的类，此属性默认为 attribute，因此不需要 uselist=False</span>
</span></span><span class=line><span class=cl>    <span class=n>parent</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Parent&#34;</span><span class=p>,</span> <span class=n>back_populates</span><span class=o>=</span><span class=s2>&#34;child&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=4-多对多 class=headerLink><a href=#4-%e5%a4%9a%e5%af%b9%e5%a4%9a class=header-mark></a>4. 多对多</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 多对多，必须要使用一个关联表！</span>
</span></span><span class=line><span class=cl><span class=n>association_table</span> <span class=o>=</span> <span class=n>Table</span><span class=p>(</span><span class=s1>&#39;association&#39;</span><span class=p>,</span> <span class=n>Base</span><span class=o>.</span><span class=n>metadata</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>Column</span><span class=p>(</span><span class=s1>&#39;left_id&#39;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;left.id&#39;</span><span class=p>)),</span>  <span class=c1># 约定俗成的规矩，左边是 parent</span>
</span></span><span class=line><span class=cl>    <span class=n>Column</span><span class=p>(</span><span class=s1>&#39;right_id&#39;</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;right.id&#39;</span><span class=p>))</span>  <span class=c1># 右边是 child</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Parent</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;left&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>children</span> <span class=o>=</span> <span class=n>relationship</span><span class=p>(</span><span class=s2>&#34;Child&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>secondary</span><span class=o>=</span><span class=n>association_table</span><span class=p>)</span>  <span class=c1># 专用参数 secondary，用于指定使用的关联表</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Child</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s1>&#39;right&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>要添加反向引用时，同样可以使用 <code>backref</code> 或 <code>back_populates</code>.</p><h4 id=41-user2user class=headerLink><a href=#41-user2user class=header-mark></a>4.1 user2user</h4><p>如果多对多关系中的两边都是 user，即都是同一个表时，该怎么声明？</p><p>例如用户的「关注」与「粉丝」，你是 user，你的粉丝是 user，你关注的账号也是 user。</p><p>这个时候，关联表 <code>association_table</code> 的两个键都是 <code>user</code>，<strong>SQLAlchemy 无法区分主次，需要手动指定</strong>，为此需要使用 <code>primaryjoin</code> 和 <code>secondaryjoin</code> 两个参数。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 关联表，左侧的 user 正在关注右侧的 user</span>
</span></span><span class=line><span class=cl><span class=n>followers</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Table</span><span class=p>(</span><span class=s1>&#39;followers&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=s1>&#39;follower_id&#39;</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Integer</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>)),</span>  <span class=c1># 左侧</span>
</span></span><span class=line><span class=cl>    <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=s1>&#39;followed_id&#39;</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Integer</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>))</span>  <span class=c1># 右侧，被关注的 user</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>UserMixin</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>id</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>username</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=mi>64</span><span class=p>),</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>email</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=mi>120</span><span class=p>),</span> <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>unique</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>password_hash</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=n>db</span><span class=o>.</span><span class=n>String</span><span class=p>(</span><span class=mi>128</span><span class=p>),</span> <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 我关注的 users</span>
</span></span><span class=line><span class=cl>    <span class=n>followed</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>relationship</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;User&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>secondary</span><span class=o>=</span><span class=n>followers</span><span class=p>,</span>  <span class=c1># 指定多对多关联表</span>
</span></span><span class=line><span class=cl>        <span class=n>primaryjoin</span><span class=o>=</span><span class=p>(</span><span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>follower_id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>),</span>  <span class=c1># 左侧，用于获取「我关注的 users」的 join 条件</span>
</span></span><span class=line><span class=cl>        <span class=n>secondaryjoin</span><span class=o>=</span><span class=p>(</span><span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>followed_id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>),</span>  <span class=c1># 右侧，用于获取「我的粉丝」的 join 条件</span>
</span></span><span class=line><span class=cl>        <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>,</span>  <span class=c1># 延迟求值，这样才能用 filter_by 等过滤函数</span>
</span></span><span class=line><span class=cl>        <span class=n>backref</span><span class=o>=</span><span class=n>db</span><span class=o>.</span><span class=n>backref</span><span class=p>(</span><span class=s1>&#39;followers&#39;</span><span class=p>,</span> <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>))</span>  <span class=c1># followers 也要延迟求值</span>
</span></span></code></pre></td></tr></table></div></div><p>这里比较绕的，就是容易搞混 <code>primaryjoin</code> 和 <code>secondaryjoin</code> 两个参数。</p><ol><li>primaryjoin：（多对多中）用于从子对象查询其父对象的 condition（child.parents），默认只考虑外键。</li><li>secondaryjoin：（多对多中）用于从父对象查询其所有子对象的 condition（parent.children），同样的，默认情况下只考虑外键。</li></ol><h2 id=三orm-层-的-delete-cascade-vs-foreign-key-层的-on-delete-cascade class=headerLink><a href=#%e4%b8%89orm-%e5%b1%82-%e7%9a%84-delete-cascade-vs-foreign-key-%e5%b1%82%e7%9a%84-on-delete-cascade class=header-mark></a>三、ORM 层 的 “delete” cascade vs. FOREIGN KEY 层的 “ON DELETE” cascade</h2><p>之前有讲过 Table 定义中的级联操作：<code>ON DELETE</code> 和 <code>ON UPDATE</code>，可以通过 <code>ForeignKey</code> 的参数指定为 <code>CASCADE</code>.</p><p>可 SQLAlchemy 还有一个 <code>relationship</code> 生成 SQL 语句时的配置参数 <code>cascade</code>，另外 <code>passive_deletes</code> 也可以指定为 <code>cascade</code>。</p><p>有这么多的 cascade，我真的是很懵。这三个 cascade 到底有何差别呢？</p><p>外键约束中的 <code>ON DELETE</code> 和 <code>ON UPDATE</code>，与 ORM 层的 <code>CASCADE</code> 在功能上，确实有很多重叠的地方。
但是也有很多不同：</p><ol><li>数据库层面的 <code>ON DELETE</code> 级联能高效地处理 <strong>many-to-one</strong> 的关联；我们在 <code>many</code> 方定义外键，也在这里添加 <code>ON DELETE</code> 约束。而在 ORM 层，就<strong>刚好相反</strong>。SQLAlchemy 在 <code>one</code> 方处理 <code>many</code> 方的删除操作，这意味着它更适合处理 <strong>one-to-many</strong> 的关联。</li><li>数据库层面上，不带 <code>ON DELETE</code> 的外键常用于防止父数据被删除，而导致子数据成为无法被索引到的垃圾数据。如果要在一个 one-to-many 映射上实现这个行为，SQLAlchemy 将外键设置为 NULL 的默认行为可以通过以下两种方式之一捕获：<ol><li>最简单也最常用的方法，当然是将外键定义为 <strong>NOT NULL</strong>. 尝试将该列设为 NULL 会触发 NOT NULL constraint exception.</li><li>另一种更特殊的方法，是将 <code>passive_deletes</code> 标志设置为字 <code>all</code>. 这会完全禁用 SQLAlchemy 将外键列设置为 NULL 的行为，并且 DELETE 父数据而不会对子数据产生任何影响。这样才能触发数据库层面的 <code>ON DELETE</code> 约束，或者其他的触发器。</li><li>数据库层面的 <code>ON DELETE</code> 级联 比 ORM 层面的级联更高效。数据库可以同时在多个 relationship 中链接一系列级联操作。</li><li>SQLAlchemy 不需要这么复杂，因为我们通过将 passive_deletes 选项与正确配置的外键约束结合使用，提供与数据库的 <code>ON DELETE</code> 功能的平滑集成。</li></ol></li></ol><h3 id=方法一orm-层的-cascade-实现 class=headerLink><a href=#%e6%96%b9%e6%b3%95%e4%b8%80orm-%e5%b1%82%e7%9a%84-cascade-%e5%ae%9e%e7%8e%b0 class=header-mark></a>方法一：ORM 层的 cascade 实现</h3><p><code>relationship</code> 的 <code>cascade</code> 参数决定了修改父表时，什么时候子表要进行级联操作。它的可选项有（str，选项之间用逗号分隔）：</p><ol><li><code>save-update</code>：默认选项之一。在 add（对应 SQL 的 insert 或 update）一个对象的时候，会 add 所有它相关联的对象。</li><li><code>merge</code>：默认选项之一。在 merge（相当字典的update操作，有就替换掉，没有就合并）一个对象的时候，会 merge 所有和它相关联的对象。</li><li><code>expunge</code> ：移除操作的时候，会将相关联的对象也进行移除。这个操作只是从session中移除，并不会真正的从数据库中删除。</li><li><code>delete</code>：删除父表数据时，同时删除与它关联的数据。</li><li><code>delete-orphan</code>：当子对象与父对象解除关系时，删除掉此子对象（孤儿）。（其实还是没懂。。）</li><li><code>refresh-expire</code>：不常用。</li><li><code>all</code>：表示选中除 <code>delete-orphan</code> 之外的所有选项。（因此 <code>all, delete-orphan</code> 很常用，它才是真正的 <code>all</code>）</li></ol><p>默认属性是 &ldquo;save-update, merge&rdquo;.</p><p>这只是简略的说明，上述几个参数的详细文档见 <a href=https://docs.sqlalchemy.org/en/13/orm/cascades.html#unitofwork-cascades target=_blank rel="noopener noreferrer">SQLAlchemy - Cascades</a></p><h3 id=方法二数据库层的-cascade-实现 class=headerLink><a href=#%e6%96%b9%e6%b3%95%e4%ba%8c%e6%95%b0%e6%8d%ae%e5%ba%93%e5%b1%82%e7%9a%84-cascade-%e5%ae%9e%e7%8e%b0 class=header-mark></a>方法二：数据库层的 cascade 实现</h3><ol><li>将 <code>ForeignKey</code> 的 <code>ondelete</code> 和 <code>onupdate</code> 参数指定为 <code>CASCADE</code>，实现数据库层面的级联。</li><li>为 <code>relationship</code> 添加关键字参数 <code>passive_deletes="all"</code>，这样就完全禁用 SQLAlchemy 将外键列设置为 NULL 的行为，并且 DELETE 父数据不会对子数据产生任何影响。</li></ol><p>这样 DELETE 操作时，就会触发数据库的 <code>ON DELETE</code> 约束，从而级联删除子数据。</p><h2 id=参考 class=headerLink><a href=#%e5%8f%82%e8%80%83 class=header-mark></a>参考</h2><ul><li><a href=https://docs.sqlalchemy.org/en/13/orm/relationships.html target=_blank rel="noopener noreferrer">SQLAlchemy - Relationship Configuration</a></li><li><a href=https://docs.sqlalchemy.org/en/13/orm/cascades.html#unitofwork-cascades target=_blank rel="noopener noreferrer">SQLAlchemy - Cascades</a></li><li><a href=https://ia.jifangcheng.com/p/46 target=_blank rel="noopener noreferrer">SQLAlchemy 中的 backref 和 back_populates</a></li><li><a href=https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-viii-followers target=_blank rel="noopener noreferrer">The Flask Mega-Tutorial Part VIII: Followers</a></li><li><a href=https://github.com/hackersandslackers/sqlalchemy-tutorial target=_blank rel="noopener noreferrer">hackersandslackers/sqlalchemy-tutorial</a></li></ul></div><h2>相关内容</h2><div class=related-container><div class=related-item-container><div class=related-image><a href=/posts/consistency-and-consensus-algorithm/><img loading=lazy src=/posts/consistency-and-consensus-algorithm/featured-image.webp srcset="/posts/consistency-and-consensus-algorithm/featured-image.webp,
/posts/consistency-and-consensus-algorithm/featured-image.webp 1.5x,
/posts/consistency-and-consensus-algorithm/featured-image.webp 2x" title=/posts/consistency-and-consensus-algorithm/featured-image.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/consistency-and-consensus-algorithm/>分布式数据库的一致性问题与共识算法</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/python-tips-and-tricks/><img loading=lazy src=/posts/python-tips-and-tricks/python-tips-and-tricks.webp srcset="/posts/python-tips-and-tricks/python-tips-and-tricks.webp,
/posts/python-tips-and-tricks/python-tips-and-tricks.webp 1.5x,
/posts/python-tips-and-tricks/python-tips-and-tricks.webp 2x" title=/posts/python-tips-and-tricks/python-tips-and-tricks.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/python-tips-and-tricks/>Python 实用技巧与常见错误集锦</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/python-concurrency-pool-executor/><img loading=lazy src=/posts/python-concurrency-pool-executor/python-concurrency.webp srcset="/posts/python-concurrency-pool-executor/python-concurrency.webp,
/posts/python-concurrency-pool-executor/python-concurrency.webp 1.5x,
/posts/python-concurrency-pool-executor/python-concurrency.webp 2x" title=/posts/python-concurrency-pool-executor/python-concurrency.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/python-concurrency-pool-executor/>Python 并发编程：PoolExecutor 篇</a></h2></div></div><div class=sponsor><div class=sponsor-avatar><img loading=lazy src=https://thiscute.world/avatar/myself.webp srcset="https://thiscute.world/avatar/myself.webp,
https://thiscute.world/avatar/myself.webp 1.5x,
https://thiscute.world/avatar/myself.webp 2x" title=https://thiscute.world/avatar/myself.webp></div><p class=sponsor-bio><em>如果你觉得这篇文章对你有所帮助，欢迎评论、分享、打赏~</em></p><a href=https://afdian.net/a/ryan4yin title=Sponsor target=_blank class=sponsor-button rel="noopener noreferrer"><i class="far fa-heart fa-fw icon" style=color:#ec6cb9></i>
<span>赞赏</span></a></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-05-21</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/ data-title="SQLAlchemy 学习笔记（三）：ORM 中的关系构建" data-via=ryan4yin data-hashtags=SQLAlchemy,Python,ORM,后端,数据库,Database><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Hacker News" data-sharer=hackernews data-url=https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/ data-title="SQLAlchemy 学习笔记（三）：ORM 中的关系构建"><span class="fab fa-hacker-news fa-fw"></span></button><button title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/><span class="fab fa-reddit fa-fw"></span></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="分享到 Mastodon" onclick='shareOnMastodon("SQLAlchemy 学习笔记（三）：ORM 中的关系构建","https://thiscute.world/posts/sqlalchemy-notes-3-relationship-and-foreignkey/")'><span class="fab fa-mastodon fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/sqlalchemy/>SQLAlchemy</a>,&nbsp;<a href=/tags/python/>Python</a>,&nbsp;<a href=/tags/orm/>ORM</a>,&nbsp;<a href=/tags/%E5%90%8E%E7%AB%AF/>后端</a>,&nbsp;<a href=/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>数据库</a>,&nbsp;<a href=/tags/database/>Database</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/webnovel-addiction-recovery/ class=prev rel=prev title=瘾的退却><i class="fas fa-angle-left fa-fw"></i>瘾的退却</a>
<a href=/posts/escape-my-university/ class=next rel=next title=逃离我的大学>逃离我的大学<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=display:inline-block;width:auto;height:20px></a>
<a href=https://www.foreverblog.cn/go.html target=_blank><img src=https://img.foreverblog.cn/wormhole_3.gif alt style=display:inline-block;width:auto;height:20px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动&nbsp;|&nbsp;托管在 <a title=Vercel href=https://vercel.com/ target=_blank rel="noopener noreffer">Vercel</a> 上&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 -2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://thiscute.world/ target=_blank rel="noopener noreferrer">ryan4yin</a></span>&nbsp;|&nbsp;<span class=license> <a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script></div></body></html>