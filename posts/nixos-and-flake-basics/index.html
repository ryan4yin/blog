<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title class=pjax-title>NixOS 与 Nix Flakes 新手入门 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:title" content="NixOS 与 Nix Flakes 新手入门"><meta property="og:description" content="本文的目标 NixOS 版本为 22.11，Nix 版本为 2.13.3，在此环境下 Nix Flakes 仍然为实验性功能。 更新日志 2023/5/21 补充 overlays 一节的内容。 移除「九、使用 Nix Flakes 打包应"><meta property="og:type" content="article"><meta property="og:url" content="https://thiscute.world/posts/nixos-and-flake-basics/"><meta property="og:image" content="https://thiscute.world/posts/nixos-and-flake-basics/screenshot_2023-05-07-21-21.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-04T15:19:28+08:00"><meta property="article:modified_time" content="2023-05-09T11:41:28+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/nixos-and-flake-basics/screenshot_2023-05-07-21-21.webp"><meta name=twitter:title content="NixOS 与 Nix Flakes 新手入门"><meta name=twitter:description content="本文的目标 NixOS 版本为 22.11，Nix 版本为 2.13.3，在此环境下 Nix Flakes 仍然为实验性功能。 更新日志 2023/5/21 补充 overlays 一节的内容。 移除「九、使用 Nix Flakes 打包应"><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/nixos-and-flake-basics/><link rel=prev href=https://thiscute.world/posts/wireguard-on-linux/><link rel=next href=https://thiscute.world/posts/macos-window-manager-yabai-usage/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"NixOS 与 Nix Flakes 新手入门","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/thiscute.world\/posts\/nixos-and-flake-basics\/"},"image":[{"@type":"ImageObject","url":"https:\/\/thiscute.world\/posts\/nixos-and-flake-basics\/screenshot_2023-05-07-21-21.webp","width":3840,"height":2160}],"genre":"posts","keywords":"NixOS, Nix, Flakes, Linux, DevOps","wordcount":18832,"url":"https:\/\/thiscute.world\/posts\/nixos-and-flake-basics\/","datePublished":"2023-05-04T15:19:28+08:00","dateModified":"2023-05-09T11:41:28+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https:\/\/thiscute.world\/avatar\/myself.png"},"author":{"@type":"Person","name":"ryan4yin"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark")}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行 </a><a class=menu-item href=/series/>系列 </a><a class=menu-item href=/categories/tech/>技术 </a><a class=menu-item href=/categories/life/>生活 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/friends/>朋友们 </a><a class=menu-item href=/now/>此刻 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><a href=# onclick=return!1 class="menu-item language" title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" id=language-select-desktop onchange="location=this.value"><option value=/posts/nixos-and-flake-basics/ selected>Simplified Chinese</option><option value=/en/posts/nixos-and-flake-basics/>English</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=# onclick=return!1 class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a><a href=# onclick=return!1 class=menu-item title=选择语言>Simplified Chinese<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select title="Select Language" onchange="location=this.value"><option value=/posts/nixos-and-flake-basics/ selected>Simplified Chinese</option><option value=/en/posts/nixos-and-flake-basics/>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#更新日志>更新日志</a></li><li><a href=#零为什么选择-nix>零、为什么选择 Nix</a></li><li><a href=#nix-intro>一、Nix 简介</a><ul><li><a href=#nix-advantages>Nix 的优点</a></li><li><a href=#nix-disadvantages>Nix 的缺点</a></li><li><a href=#nix-simple-summary>简单总结下</a></li></ul></li><li><a href=#install-nix>二、安装</a></li><li><a href=#nix-flakes-and-old-nix>三、Nix Flakes 与旧的 Nix</a></li><li><a href=#nixos-flakes-repo>四、NixOS 的 Flakes 包仓库</a></li><li><a href=#nix-language>五、Nix 语言基础</a><ul><li><a href=#basic-data-types>1. 基础数据类型一览</a></li><li><a href=#let-in>2. let &mldr; in &mldr;</a></li><li><a href=#attribute-set>3. attribute set 说明</a></li><li><a href=#with-statement>4. with 语句</a></li><li><a href=#inherit>5. 继承 inherit &mldr;</a></li><li><a href=#string-interpolation>6. ${ &mldr; } 字符串插值</a></li><li><a href=#file-system-path>7. 文件系统路径</a></li><li><a href=#search-path>8. 搜索路径</a></li><li><a href=#multi-line-string>9. 多行字符串</a></li><li><a href=#nix-function>10. 函数</a><ul><li><a href=#built-in-function>内置函数</a></li><li><a href=#import-expression>import 表达式</a></li><li><a href=#pkgs-lib>pkgs.lib 函数包</a></li></ul></li><li><a href=#impurities>11. 不纯（Impurities）</a></li><li><a href=#fetchers>12. Fetchers</a></li><li><a href=#derivations>13. Derivations</a></li></ul></li><li><a href=#declarative-system-management>六、以声明式的方式管理系统</a><ul><li><a href=#configuration-nix>1. 使用 <code>/etc/nixos/configuration.nix</code> 配置系统</a></li><li><a href=#enable-nix-flakes>2. 启用 NixOS 的 Flakes 支持</a></li><li><a href=#switch-to-flake-nix>3. 将系统配置切换到 flake.nix</a></li><li><a href=#manage-system-software-with-flakes>4. 通过 Flakes 来管理系统软件</a></li><li><a href=#add-cache-source-for-flake>5. 为 Flake 添加国内 cache 源</a></li><li><a href=#install-home-manager>6. 安装 home-manager</a></li><li><a href=#modularize-nixos-configuration>7. 模块化 NixOS 配置</a></li><li><a href=#update-nixos-system>8. 更新系统</a></li><li><a href=#rollback-package-version>9. 回退个别软件包的版本</a></li><li><a href=#git-manage-nixos-config>10. 使用 Git 管理 NixOS 配置</a></li><li><a href=#other-useful-commands>11. 其他可能需要用到的指令</a></li></ul></li><li><a href=#nix-flakes-usage>七、Nix Flakes 的使用</a><ul><li><a href=#flake-outputs>1. Flake 的 outputs</a></li><li><a href=#flake-commands-usage>2. Flake 命令行的使用</a></li></ul></li><li><a href=#nixpkgs-advanced-usage>八、Nixpkgs 的高级用法</a><ul><li><a href=#overriding>Overriding</a></li><li><a href=#overlays>Overlays</a><ul><li><a href=#模块化-overlays-配置>模块化 overlays 配置</a></li></ul></li></ul></li><li><a href=#advanced-topics>进阶玩法</a></li><li><a href=#summary>总结</a></li><li><a href=#reference>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">NixOS 与 Nix Flakes 新手入门</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=https://thiscute.world/ title=Author target=_blank rel="noopener noreferrer author" class=author>ryan4yin</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><i class="far fa-folder fa-fw"></i>tech</a></span>&nbsp;<span class=post-category>和</span>&nbsp;<span class=post-series>系列 <a href=/series/nixos-%E4%B8%8E-nix-flakes/><i class="far fa-list-alt fa-fw"></i>NixOS 与 Nix Flakes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-05-04>2023-05-04</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-05-09>2023-05-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 18832 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 38 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload data-src=/posts/nixos-and-flake-basics/screenshot_2023-05-07-21-21.webp data-srcset="/posts/nixos-and-flake-basics/screenshot_2023-05-07-21-21.webp, /posts/nixos-and-flake-basics/screenshot_2023-05-07-21-21.webp 1.5x, /posts/nixos-and-flake-basics/screenshot_2023-05-07-21-21.webp 2x" data-sizes=auto alt=/posts/nixos-and-flake-basics/screenshot_2023-05-07-21-21.webp title=/posts/nixos-and-flake-basics/screenshot_2023-05-07-21-21.webp height=2160 width=3840></div><div class="details series-nav open"><div class="details-summary series-title"><span>系列 - NixOS 与 Nix Flakes</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content series-content"><nav><ul><li><span class=active>NixOS 与 Nix Flakes 新手入门</span></li></ul></nav></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#更新日志>更新日志</a></li><li><a href=#零为什么选择-nix>零、为什么选择 Nix</a></li><li><a href=#nix-intro>一、Nix 简介</a><ul><li><a href=#nix-advantages>Nix 的优点</a></li><li><a href=#nix-disadvantages>Nix 的缺点</a></li><li><a href=#nix-simple-summary>简单总结下</a></li></ul></li><li><a href=#install-nix>二、安装</a></li><li><a href=#nix-flakes-and-old-nix>三、Nix Flakes 与旧的 Nix</a></li><li><a href=#nixos-flakes-repo>四、NixOS 的 Flakes 包仓库</a></li><li><a href=#nix-language>五、Nix 语言基础</a><ul><li><a href=#basic-data-types>1. 基础数据类型一览</a></li><li><a href=#let-in>2. let &mldr; in &mldr;</a></li><li><a href=#attribute-set>3. attribute set 说明</a></li><li><a href=#with-statement>4. with 语句</a></li><li><a href=#inherit>5. 继承 inherit &mldr;</a></li><li><a href=#string-interpolation>6. ${ &mldr; } 字符串插值</a></li><li><a href=#file-system-path>7. 文件系统路径</a></li><li><a href=#search-path>8. 搜索路径</a></li><li><a href=#multi-line-string>9. 多行字符串</a></li><li><a href=#nix-function>10. 函数</a><ul><li><a href=#built-in-function>内置函数</a></li><li><a href=#import-expression>import 表达式</a></li><li><a href=#pkgs-lib>pkgs.lib 函数包</a></li></ul></li><li><a href=#impurities>11. 不纯（Impurities）</a></li><li><a href=#fetchers>12. Fetchers</a></li><li><a href=#derivations>13. Derivations</a></li></ul></li><li><a href=#declarative-system-management>六、以声明式的方式管理系统</a><ul><li><a href=#configuration-nix>1. 使用 <code>/etc/nixos/configuration.nix</code> 配置系统</a></li><li><a href=#enable-nix-flakes>2. 启用 NixOS 的 Flakes 支持</a></li><li><a href=#switch-to-flake-nix>3. 将系统配置切换到 flake.nix</a></li><li><a href=#manage-system-software-with-flakes>4. 通过 Flakes 来管理系统软件</a></li><li><a href=#add-cache-source-for-flake>5. 为 Flake 添加国内 cache 源</a></li><li><a href=#install-home-manager>6. 安装 home-manager</a></li><li><a href=#modularize-nixos-configuration>7. 模块化 NixOS 配置</a></li><li><a href=#update-nixos-system>8. 更新系统</a></li><li><a href=#rollback-package-version>9. 回退个别软件包的版本</a></li><li><a href=#git-manage-nixos-config>10. 使用 Git 管理 NixOS 配置</a></li><li><a href=#other-useful-commands>11. 其他可能需要用到的指令</a></li></ul></li><li><a href=#nix-flakes-usage>七、Nix Flakes 的使用</a><ul><li><a href=#flake-outputs>1. Flake 的 outputs</a></li><li><a href=#flake-commands-usage>2. Flake 命令行的使用</a></li></ul></li><li><a href=#nixpkgs-advanced-usage>八、Nixpkgs 的高级用法</a><ul><li><a href=#overriding>Overriding</a></li><li><a href=#overlays>Overlays</a><ul><li><a href=#模块化-overlays-配置>模块化 overlays 配置</a></li></ul></li></ul></li><li><a href=#advanced-topics>进阶玩法</a></li><li><a href=#summary>总结</a></li><li><a href=#reference>参考</a></li></ul></nav></div></div><div class=content id=content><blockquote><p>本文的目标 NixOS 版本为 22.11，Nix 版本为 2.13.3，在此环境下 Nix Flakes 仍然为实验性功能。</p></blockquote><h2 id=更新日志 class=headerLink><a href=#%e6%9b%b4%e6%96%b0%e6%97%a5%e5%bf%97 class=header-mark></a>更新日志</h2><ul><li>2023/5/21<ul><li>补充 overlays 一节的内容。</li><li>移除「九、使用 Nix Flakes 打包应用」，这部分可能会放在后续文章中介绍。</li><li>六-4 一节补充了一个通过 flakes 数据源安装程序的例子。</li></ul></li></ul><h2 id=零为什么选择-nix class=headerLink><a href=#%e9%9b%b6%e4%b8%ba%e4%bb%80%e4%b9%88%e9%80%89%e6%8b%a9-nix class=header-mark></a>零、为什么选择 Nix</h2><p>好几年前就听说过 Nix 包管理器，它用 Nix 语言编写配置来管理系统依赖，此外基于 Nix 包管理器设计的 Linux 发行版 NixOS，还能随时回滚到任一历史状态。
虽然听着很牛，但是不仅要多学一门语言，装个包还得写代码，当时觉得太麻烦就没研究。
但是最近搞系统迁移遇到两件麻烦事，使我决定尝试下 Nix.</p><p>第一件事是在新组装的 PC 主机上安装 EndeavourOS（Arch Linux 的一个衍生发行版），因为旧系统也是 EndeavourOS 系统，安装完为了省事，我就直接把旧电脑的 Home 目录 rsync 同步到了新 PC 上。
这一同步就出了问题，所有功能都工作正常，但是视频播放老是卡住，firefox/chrome/mpv 都会卡住，网上找各种资料都没解决，还是我灵光一闪想到是不是 Home 目录同步的锅，清空了 Home 目录，问题立马就解决了&mldr;后面又花好长时间从旧电脑一点点恢复 Home 目录下的东西。</p><p>第二件事是，我最近想尝鲜 wayland，把桌面从 i3wm 换成了 sway，但是因为用起来区别不明显，再加上诸多不便（hidpi、sway 配置调优都要花时间精力），嫌麻烦就还是回退到了 i3wm。结果回退后，每次系统刚启动时，有一段时间 firefox/thunar 等 GUI 程序会一直卡着，要大概 1 分钟后才能正常启动&mldr;</p><p>发生第二件事时我就懒得折腾了，想到归根结底还是系统没有版本控制跟回滚机制，导致出了问题不能还原，装新系统时各种软件包也全靠自己手工从旧机器导出软件包清单，再在新机器安装恢复。就打算干脆换成 NixOS.</p><p>我折腾的第一步是在我 Homelab 上开了台 NixOS 虚拟机，在这台虚拟机里一步步调试，把我物理机的 EndeavourOS i3 配置迁移到 NixOS + Flakes，还原出了整个桌面环境。
在虚拟机里搞定后问题就不大了，直接备份好我办公电脑的 Home 目录、软件清单，然后将系统重装为 NixOS，再 git clone 我调试好的 NixOS 配置，改一改硬盘挂载相关的参数，额外补充下 Nvidia 显卡相关的 NixOS 配置，最后一行命令部署配置。几行命令就在我全新的 NixOS 系统上还原出了整个 i3 桌面环境跟我的常用软件，那一刻真的很有成就感！</p><p>NixOS 的回滚能力给了我非常大的底气——再也不怕把系统搞挂了，于是我前几天我又进一步迁移到了 hyprland 桌面，确实比 i3 香多了，它的动画效果我吹爆！（在以前 EndeavourOS 上我肯定是不太敢做这样的切换的，原因前面已经解释过了——万一把系统搞出问题，会非常麻烦。）</p><blockquote><p>补充：v2ex 上有 v 友反馈 btrfs 文件系统的快照功能，也能提供类似的回滚能力，而且简单很多。我研究了下发现确实如此，btrfs 甚至也可以像 NixOS 一样配置 grub 从快照启动。所以如果你只是想要系统回滚能力，那么基于 btrfs 快照功能的 <a href=https://github.com/digint/btrbk target=_blank rel="noopener noreferrer">btrbk</a> 也是一个不错的选择。当然如果你仍然对 Nix 感兴趣，那学一学也绝对不亏，毕竟 Nix 的能力远不止于此，系统快照只是它能力的一部分而已～</p></blockquote><figure><img src=./screenshot_2023-05-07-21-21.webp alt="我当前的 NixOS 桌面"><figcaption><p>我当前的 NixOS 桌面</p></figcaption></figure><p>在学了大半个月的 NixOS 与 Nix Flakes 后，我终于将我的 PC 从 EndeavouOS 系统切换到了 NixOS，这篇文章就脱胎于我这段时间的折腾笔记，希望能对你有所帮助～</p><p>前因后果交代完毕，那么下面开始正文！</p><h2 id=nix-intro class=headerLink><a href=#nix-intro class=header-mark></a>一、Nix 简介</h2><p>Nix 包管理器，跟 DevOps 领域当前流行的 pulumi/terraform/kubernetes 类似，都是声明式配置管理工具，用户需要在某些配置文件中声明好期望的系统状态，而 Nix 负责达成目标。区别在于 Nix 的管理目标是软件包，而 pulumi/terraform 的管理目标是云上资源。</p><blockquote><p>简单解释下什么是「声明式配置」，它是指用户只需要声明好自己想要的结果——比如说希望将 i3 桌面替换成 sway 桌面，Nix 就会帮用户达成这个目标。用户不需要关心底层细节（比如说 sway 需要安装哪些软件包，哪些 i3 相关的软件包需要卸载掉，哪些系统配置或环境变量需要针对 sway 做调整、如果使用了 Nvidia 显卡 Sway 参数要做什么调整才能正常运行等等），Nix 会自动帮用户处理这些细节。</p></blockquote><p>基于 Nix 构建的 Linux 发行版 NixOS，可以简单用 OS as Code 来形容，它通过声明式的 Nix 配置文件来描述整个操作系统的状态。</p><p>NixOS 的配置只负责管理系统层面的状态，用户目录不受它管辖。有另一个重要的社区项目 home-manager 专门用于管理用户目录，将 home-manager 与 NixOS、Git 结合使用，就可以得到一个完全可复现、可回滚的系统环境。</p><p>因为 Nix 声明式、可复现的特性，Nix 不仅可用于管理桌面电脑的环境，也有很多人用它管理开发编译环境、云上虚拟机、容器镜像构建，Nix 官方的 <a href=https://github.com/NixOS/nixops target=_blank rel="noopener noreferrer">NixOps</a> 与社区的 <a href=https://github.com/serokell/deploy-rs target=_blank rel="noopener noreferrer">deploy-rs</a> 都是基于 Nix 实现的运维工具。</p><blockquote><p>Home 目录下文件众多，行为也不一，因此不可能对其中的所有文件进行版本控制，代价太高。一般仅使用 home-manager 管理一些重要的配置文件，而其他需要备份的文件可以用 rsync/synthing 等手段做备份同步，或者用 <a href=https://github.com/digint/btrbk target=_blank rel="noopener noreferrer">btrbk</a> 之类的工具对 home 目录做快照。</p></blockquote><h3 id=nix-advantages class=headerLink><a href=#nix-advantages class=header-mark></a>Nix 的优点</h3><ul><li>声明式配置，Environment as Code，可以直接用 Git 管理配置，只要配置文件不丢，系统就可以随时还原到任一历史状态（理想情况下）。<ul><li>这跟一些编程语言中 cargo.lock/go.mod 等文件锁定依赖库版本以确保构建结果可复现的思路是一致的。</li><li>与 Docker 相比，Dockerfile 实际是命令式的配置，而且也不存在版本锁这样的东西，所以 Docker 的可复现能力远不如 Nix.</li></ul></li><li>高度便捷的系统自定义能力<ul><li>通过改几行配置，就可以简单地更换系统的各种组件。这是因为 Nix 将底层的复杂操作全部封装在了 nix package 包中，只给用户提供了简洁且必要的声明式参数。</li><li>而且这种修改非常安全，例证之一是有 v 友表示「<a href=https://www.v2ex.com/t/938569#r_13053251 target=_blank rel="noopener noreferrer">nixos 切换不同桌面非常简单干净，而且很安全，我就经常 gnome/kde/sway 来回换着用。</a>」</li></ul></li><li>可回滚：可以随时回滚到任一历史环境，NixOS 甚至默认将所有旧版本都加入到了启动项，确保系统滚挂了也能随时回退。所以 Nix 也被认为是最稳定的包管理方式。</li><li>没有依赖冲突问题：因为 Nix 中每个软件包都拥有唯一的 hash，其安装路径中也会包含这个 hash 值，因此可以多版本共存。</li><li>社区很活跃，第三方项目也挺丰富，官方包仓库 nixpkgs 贡献者众多，也有很多人分享自己的 Nix 配置，一遍浏览下来，整个生态给我一种发现新大陆的兴奋感。</li></ul><figure><img src=./nixos-bootloader.avif alt="NixOS 启动项中列出了所有历史版本，图来自 NixOS Discourse - 10074"><figcaption><p>NixOS 启动项中列出了所有历史版本，图来自 <a href=https://discourse.nixos.org/t/how-to-make-uefis-grub2-menu-the-same-as-bioss-one/10074 target=_blank rel="noopener noreferrer">NixOS Discourse - 10074</a></p></figcaption></figure><h3 id=nix-disadvantages class=headerLink><a href=#nix-disadvantages class=header-mark></a>Nix 的缺点</h3><ul><li>学习成本高：如果你希望系统完全可复现，并且避免各种不当使用导致的坑，那就需要学习了解 Nix 的整个设计，并以声明式的方式管理系统，不能无脑 <code>nix-env -i</code>（这类似 <code>apt-get install</code>）。</li><li>文档混乱：首先 Nix Flakes 目前仍然是实验性特性，介绍它本身的文档目前比较匮乏。 其次 Nix 社区绝大多数文档都只介绍了旧的 <code>nix-env</code>/<code>nix-channel</code>，想直接从 Nix Flakes 开始学习的话，需要参考大量旧文档，从中提取出自己需要的内容。另外一些 Nix 当前的核心功能，官方文档都语焉不详（比如 <code>imports</code> 跟 Nixpkgs Module System），想搞明白基本只能看源码了&mldr;</li><li><del>包数量比较少</del>：撤回下这一条，官方宣称 nixpkgs 是有 <a href=https://search.nixos.org/packages target=_blank rel="noopener noreferrer">80000+</a> 个软件包，使用下来确实绝大部分包都能在 nixpkgs 里找到，体验还是不错滴。</li><li>比较吃硬盘空间：为了保证系统可以随时回退，nix 默认总是保留所有历史环境，这非常吃硬盘空间。虽然可以定期使用 <code>nix-collect-garbage</code> 来手动清理旧的历史环境，也还是建议配置个更大的硬盘&mldr;</li><li>报错信息比较隐晦：一般的报错提示还是比较清楚的，但是遇到好几次依赖版本有问题或者传参错误提示不出原因，<code>--show-trace</code> 直接输出一堆的内部堆栈，都花了很长时间才定位到，通过升级依赖版本或者修正参数后问题解决。<ul><li>猜测导致这个问题的原因有两个，一是 Nix 是动态语言，各种参数都是运行时才确定类型。二是我用到的 flake 包的错误处理逻辑写得不太好，错误提示不清晰，一些隐晦的错误甚至通过错误堆栈也定位不到原因。</li></ul></li></ul><h3 id=nix-simple-summary class=headerLink><a href=#nix-simple-summary class=header-mark></a>简单总结下</h3><p>总的来说，我觉得 NixOS 适合那些有一定 Linux 使用经验与编程经验，并且希望对自己的系统拥有更强掌控力的开发者。</p><p>另外一条信息：在开发环境搭建方面 Nix 与相对流行的 <a href=https://containers.dev/ target=_blank rel="noopener noreferrer">Dev Containers</a> 也有些竞争关系，它们的具体区别还有待我发掘~</p><h2 id=install-nix class=headerLink><a href=#install-nix class=header-mark></a>二、安装</h2><p>Nix 有多种安装方式，支持以包管理器的形式安装到 MacOS/Linux/WSL 三种系统上，Nix 还额外提供了 NixOS ——一个使用 Nix 管理整个系统环境的 Linux 发行版。</p><p>我选择了直接使用 NixOS 的 ISO 镜像安装 NixOS 系统，从而最大程度上通过 Nix 管理整个系统的环境。</p><p>安装很简单，这里不多介绍，仅列一下我觉得比较有用的参考资料：</p><ul><li>国内镜像源说明：<a href=https://mirrors.bfsu.edu.cn/help/nix/ target=_blank rel="noopener noreferrer">https://mirrors.bfsu.edu.cn/help/nix/</a></li></ul><ol><li><a href=https://nixos.org/download.html target=_blank rel="noopener noreferrer">Nix 的官方安装方式</a>: 使用 bash 脚本编写, 目前（2023-04-23）为止 <code>nix-command</code> & <code>flakes</code> 仍然是实验性特性，需要手动开启。<ol><li>你需要参照 <a href=https://nixos.wiki/wiki/Flakes target=_blank rel="noopener noreferrer">Enable flakes - NixOS Wiki</a> 的说明启用 <code>nix-command</code> & <code>flakes</code></li><li>官方不提供任何卸载手段，要在 Linux/MacOS 上卸载 Nix，你需要手动删除所有相关的文件、用户以及用户组</li></ol></li><li><a href=https://github.com/DeterminateSystems/nix-installer target=_blank rel="noopener noreferrer">The Determinate Nix Installer</a>: 第三方使用 Rust 编写的 installer, 默认启用 <code>nix-command</code> & <code>flakes</code>，并且提供了卸载命令。</li></ol><h2 id=nix-flakes-and-old-nix class=headerLink><a href=#nix-flakes-and-old-nix class=header-mark></a>三、Nix Flakes 与旧的 Nix</h2><p>Nix 于 2020 年推出了 <code>nix-command</code> & <code>flakes</code> 两个新特性，它们提供了全新的命令行工具、标准的 Nix 包结构定义、类似 cargo/npm 的 <code>flake.lock</code> 版本锁文件等等。这两个特性极大地增强了 Nix 的能力，因此虽然至今（2023/5/5）它们仍然是实验性特性，但是已经被 Nix 社区广泛使用，是强烈推荐使用的功能。</p><p>目前 Nix 社区的绝大多数文档仍然只介绍了传统 Nix，不包含 Nix Flakes 相关的内容，但是从可复现、易于管理维护的角度讲，旧的 Nix 包结构与命令行工具已经不推荐使用了，因此本文档也不会介绍旧的 Nix 包结构与命令行工具的使用方法，也建议新手直接忽略掉这些旧的内容，从 <code>nix-command</code> & <code>flakes</code> 学起。</p><p>这里列举下在 <code>nix-command</code> & <code>flakes</code> 中已经不需要用到的旧的 Nix 命令行工具与相关概念，在查找资料时，如果看到它们直接忽略掉就行：</p><ol><li><code>nix-channel</code>: nix-channel 与 apt/yum/pacman 等其他 Linux 发行版的包管理工具类似，通过 stable/unstable/test 等 channel 来管理软件包的版本。<ol><li>Nix Flakes 在 flake.nix 中通过 inputs 声明依赖包的数据源，通过 flake.lock 锁定依赖版本，完全取代掉了 nix-channel 的功能。</li></ol></li><li><code>nix-env</code>: 用于管理用户环境的软件包，是传统 Nix 的核心命令行工具。它从 nix-channel 定义的数据源中安装软件包，所以安装的软件包版本受 channel 影响。通过 <code>nix-env</code> 安装的包不会被自动记录到 Nix 的声明式配置中，是完全脱离掌控的，无法在其他主机上复现，因此不推荐使用。<ol><li>在 Nix Flakes 中对应的命令为 <code>nix profile</code></li></ol></li><li><code>nix-shell</code>: nix-shell 用于创建一个临时的 shell 环境<ol><li>在 Nix Flakes 中它被 <code>nix develop</code> 与 <code>nix shell</code> 取代了。</li></ol></li><li><code>nix-build</code>: 用于构建 Nix 包，它会将构建结果放到 <code>/nix/store</code> 路径下，但是不会记录到 Nix 的声明式配置中。<ol><li>在 Nix Flakes 中对应的命令为 <code>nix build</code></li></ol></li><li>&mldr;</li></ol><h2 id=nixos-flakes-repo class=headerLink><a href=#nixos-flakes-repo class=header-mark></a>四、NixOS 的 Flakes 包仓库</h2><p>跟 Arch Linux 类似，Nix 也有官方与社区的软件包仓库：</p><ol><li><a href=https://github.com/NixOS/nixpkgs target=_blank rel="noopener noreferrer">nixpkgs</a> 是一个包含了所有 Nix 包与 NixOS 模块/配置的 Git 仓库，其 master 分支包含最新的 Nix 包与 NixOS 模块/配置。</li><li>比如 <a href=https://github.com/NixOS/nixpkgs/tree/master/pkgs/applications/networking/instant-messengers/qq target=_blank rel="noopener noreferrer">qq</a> 就直接包含在 nixpkgs 中了</li><li><a href=https://github.com/nix-community/NUR target=_blank rel="noopener noreferrer">NUR</a>: 类似 Arch Linux 的 AUR，NUR 是 Nix 的一个第三方的 Nix 包仓库，算是 nixpkgs 的一个增补包仓库。</li><li>这些常用国产软件，都可以通过 NUR 安装：</li><li><a href=https://github.com/nix-community/nur-combined/blob/master/repos/xddxdd/pkgs/uncategorized/qqmusic/default.nix target=_blank rel="noopener noreferrer">qqmusic</a></li><li><a href=https://github.com/nix-community/nur-combined/blob/master/repos/xddxdd/pkgs/uncategorized/wechat-uos/default.nix target=_blank rel="noopener noreferrer">wechat-uos</a></li><li><a href=https://github.com/nix-community/nur-combined/blob/master/repos/xddxdd/pkgs/uncategorized/dingtalk/default.nix target=_blank rel="noopener noreferrer">dingtalk</a></li><li>更多程序，可以在这里搜索：<a href=https://nur.nix-community.org/ target=_blank rel="noopener noreferrer">Nix User Repositories</a></li><li>Nix Flakes 也可直接从 Git 仓库中安装软件包，这种方式可以用于安装任何人提供的 Flakes 包</li></ol><p>此外一些没有 Nix 支持或者支持不佳的软件，也可以考虑通过 Flatpak 或者 AppImage 的方式安装使用，这两个都是在所有 Linux 发行版上可用的软件打包与安装手段，详情请自行搜索，这里就不介绍细节了。</p><h2 id=nix-language class=headerLink><a href=#nix-language class=header-mark></a>五、Nix 语言基础</h2><blockquote><p><a href=https://nix.dev/tutorials/first-steps/nix-language target=_blank rel="noopener noreferrer">https://nix.dev/tutorials/first-steps/nix-language</a></p></blockquote><p>Nix 语言是 Nix 的基础，要想玩得转 NixOS 与 Nix Flakes，享受到它们带来的诸多好处，就必须学会这门语言。</p><p>Nix 是一门比较简单的函数式语言，在已有一定编程基础的情况下，过一遍这些语法用时应该在 2 个小时以内，本文假设你具有一定编程基础（也就是说写得不会很细）。</p><p>这一节主要包含如下内容：</p><ol><li>数据类型</li><li>let&mldr;in&mldr; with inherit 等特殊语法</li><li>函数的声明与调用语法</li><li>内置函数与库函数</li><li>inputs 的不纯性（Impurities）</li><li>用于描述 Build Task 的 Derivation</li><li>Overriding 与 Overlays</li><li>&mldr;</li></ol><p>先把语法过一遍，有个大概的印象就行，后面需要用到时再根据右侧目录回来复习。</p><h3 id=basic-data-types class=headerLink><a href=#basic-data-types class=header-mark></a>1. 基础数据类型一览</h3><p>下面通过一个 attribute set （这类似 json 或者其他语言中的 map/dict）来简要说明所有基础数据类型：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>string</span> <span class=o>=</span> <span class=s2>&#34;hello&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>integer</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>float</span> <span class=o>=</span> <span class=mi>3</span><span class=mf>.141</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>bool</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=no>null</span> <span class=o>=</span> <span class=no>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>list</span> <span class=o>=</span> <span class=p>[</span> <span class=mi>1</span> <span class=s2>&#34;two&#34;</span> <span class=no>false</span> <span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>attribute-set</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>a</span> <span class=o>=</span> <span class=s2>&#34;hello&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>c</span> <span class=o>=</span> <span class=mi>2</span><span class=mf>.718</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>d</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span> <span class=c1># comments are supported</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以及一些基础操作符（普通的算术运算、布尔运算就跳过不介绍了）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=c1># 列表拼接</span>
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span> <span class=p>]</span> <span class=o>++</span> <span class=p>[</span> <span class=mi>4</span> <span class=mi>5</span> <span class=mi>6</span> <span class=p>]</span> <span class=c1># [ 1 2 3 4 5 6 ]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将 // 后面的 attribut set 中的内容，全部更新到 // 前面的 attribute set 中</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span> <span class=p>}</span> <span class=o>//</span> <span class=p>{</span> <span class=n>b</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span> <span class=n>c</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span> <span class=p>}</span> <span class=c1># 结果为 { a = 1; b = 3; c = 4; }</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 逻辑隐含，等同于 !b1 || b2.</span>
</span></span><span class=line><span class=cl><span class=n>bool</span> <span class=o>-&gt;</span> <span class=n>bool</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=let-in class=headerLink><a href=#let-in class=header-mark></a>2. let &mldr; in &mldr;</h3><p>Nix 的 <code>let ... in ...</code> 语法被称作「let 表达式」或者「let 绑定」，它用于创建临时使用的局部变量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=n>a</span> <span class=o>+</span> <span class=n>a</span>  <span class=c1># 结果是 2</span>
</span></span></code></pre></td></tr></table></div></div><p>let 表达式中的变量只能在 <code>in</code> 之后的表达式中使用，理解成临时变量就行。</p><h3 id=attribute-set class=headerLink><a href=#attribute-set class=header-mark></a>3. attribute set 说明</h3><p>花括号 <code>{}</code> 用于创建 attribute set，也就是 key-value 对的集合，类似于 JSON 中的对象。</p><p>attribute set 默认不支持递归引用，如下内容会报错：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>b</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=c1># error: undefined variable &#39;a&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>不过 Nix 提供了 <code>rec</code> 关键字（recursive attribute set），可用于创建递归引用的 attribute set：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>rec</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>b</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=c1># ok</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在递归引用的情况下，Nix 会按照声明的顺序进行求值，所以如果 <code>a</code> 在 <code>b</code> 之后声明，那么 <code>b</code> 会报错。</p><p>可以使用 <code>.</code> 操作符来访问 attribute set 的成员：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>c</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>.</span><span class=n>b</span><span class=o>.</span><span class=n>c</span> <span class=c1># 结果是 1</span>
</span></span></code></pre></td></tr></table></div></div><p><code>.</code> 操作符也可直接用于赋值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span> <span class=n>a</span><span class=o>.</span><span class=n>b</span><span class=o>.</span><span class=n>c</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此外 attribute set 还支持一个 has attribute 操作符，它可用于检测 attribute set 中是否包含某个属性，返回 bool 值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>c</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=o>?</span><span class=n>b</span>  <span class=c1># 结果是 true，因为 a.b 这个属性确实存在</span>
</span></span></code></pre></td></tr></table></div></div><p>has attribute 操作符在 nixpkgs 库中常被用于检测处理 <code>args?system</code> 等参数，以 <code>(args?system)</code> 或 <code>(! args?system)</code> 的形式作为函数参数使用（叹号表示对 bool 值取反，是常见 bool 值运算符）。</p><h3 id=with-statement class=headerLink><a href=#with-statement class=header-mark></a>4. with 语句</h3><p>with 语句的语法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>with</span> <span class=sr>&lt;attribute-set&gt;</span> <span class=p>;</span> <span class=sr>&lt;expression&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>with</code> 语句会将 <code>&lt;attribute-set></code> 中的所有成员添加到当前作用域中，这样在 <code>&lt;expression></code> 中就可以直接使用 <code>&lt;attribute-set></code> 中的成员了，简化 attribute set 的访问语法，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>z</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>a</span><span class=p>;</span> <span class=p>[</span> <span class=n>x</span> <span class=n>y</span> <span class=n>z</span> <span class=p>]</span>  <span class=c1># 结果是 [ 1 2 3 ], 等价于 [ a.x a.y a.z ]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=inherit class=headerLink><a href=#inherit class=header-mark></a>5. 继承 inherit &mldr;</h3><p><code>inherit</code> 语句用于从 attribute set 中继承成员，同样是一个简化代码的语法糖，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>y</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>inherit</span> <span class=n>x</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>  <span class=c1># 结果是 { x = 1; y = 2; }</span>
</span></span></code></pre></td></tr></table></div></div><p>inherit 还能直接从某个 attribute set 中继承成员，语法为 <code>inherit (&lt;attribute-set>) &lt;member-name>;</code>，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>z</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>inherit</span> <span class=p>(</span><span class=n>a</span><span class=p>)</span> <span class=n>x</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>  <span class=c1># 结果是 { x = 1; y = 2; }</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=string-interpolation class=headerLink><a href=#string-interpolation class=header-mark></a>6. ${ &mldr; } 字符串插值</h3><p><code>${ ... }</code> 用于字符串插值，懂点编程的应该都很容易理解这个，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>a</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;the value of a is </span><span class=si>${</span><span class=n>a</span><span class=si>}</span><span class=s2>&#34;</span>  <span class=c1># 结果是 &#34;the value of a is 1&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=file-system-path class=headerLink><a href=#file-system-path class=header-mark></a>7. 文件系统路径</h3><p>Nix 中不带引号的字符串会被解析为文件系统路径，路径的语法与 Unix 系统相同。</p><h3 id=search-path class=headerLink><a href=#search-path class=header-mark></a>8. 搜索路径</h3><blockquote><p>请不要使用这个功能，它会导致不可预期的行为。</p></blockquote><p>Nix 会在看到 <code>&lt;nixpkgs></code> 这类三角括号语法时，会在 <code>NIX_PATH</code> 环境变量中指定的路径中搜索该路径。</p><p>因为环境变量 <code>NIX_PATH</code> 是可变更的值，所以这个功能是不纯的，会导致不可预期的行为。</p><p>在这里做个介绍，只是为了让你在看到别人使用类似的语法时不至于抓瞎。</p><h3 id=multi-line-string class=headerLink><a href=#multi-line-string class=header-mark></a>9. 多行字符串</h3><p>多行字符串的语法为 <code>''</code>，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=cl><span class=s1>  this is a
</span></span></span><span class=line><span class=cl><span class=s1>  multi-line
</span></span></span><span class=line><span class=cl><span class=s1>  string
</span></span></span><span class=line><span class=cl><span class=s1>&#39;&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=nix-function class=headerLink><a href=#nix-function class=header-mark></a>10. 函数</h3><p>函数的声明语法为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=sr>&lt;arg1&gt;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=sr>&lt;body&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>举几个常见的例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=c1># 单参数函数</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>:</span> <span class=n>a</span> <span class=o>+</span> <span class=n>a</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 嵌套函数</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>:</span> <span class=n>b</span><span class=p>:</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 双参数函数</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>a</span><span class=o>,</span> <span class=n>b</span> <span class=p>}:</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 双参数函数，带默认值。问号后面的是参数的默认值</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>a</span> <span class=o>?</span> <span class=mi>1</span><span class=o>,</span> <span class=n>b</span> <span class=o>?</span> <span class=mi>2</span> <span class=p>}:</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 带有命名 attribute set 作为参数的函数，并且使用 ... 收集其他可选参数</span>
</span></span><span class=line><span class=cl><span class=c1># 命名 args 与 ... 可选参数通常被一起作为函数的参数定义使用</span>
</span></span><span class=line><span class=cl><span class=n>args</span><span class=o>@</span><span class=p>{</span> <span class=n>a</span><span class=o>,</span> <span class=n>b</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>args</span><span class=o>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=c1># 如下内容等价于上面的内容,</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>a</span><span class=o>,</span> <span class=n>b</span><span class=o>,</span> <span class=o>...</span> <span class=p>}</span><span class=o>@</span><span class=n>args</span><span class=p>:</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span> <span class=o>+</span> <span class=n>args</span><span class=o>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 但是要注意命名参数仅绑定了输入的 attribute set，默认参数不在其中，举例</span>
</span></span><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>f</span> <span class=o>=</span> <span class=p>{</span> <span class=n>a</span> <span class=o>?</span> <span class=mi>1</span><span class=o>,</span> <span class=n>b</span> <span class=o>?</span> <span class=mi>2</span><span class=o>,</span> <span class=o>...</span> <span class=p>}</span><span class=o>@</span><span class=n>args</span><span class=p>:</span> <span class=n>args</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl>  <span class=n>f</span> <span class=p>{}</span>  <span class=c1># 结果是 {}，也就说明了 args 中包含默认值</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 函数的调用方式就是把参数放在后面，比如下面的 2 就是前面这个函数的参数</span>
</span></span><span class=line><span class=cl><span class=n>a</span><span class=p>:</span> <span class=n>a</span> <span class=o>+</span> <span class=n>a</span> <span class=mi>2</span>  <span class=c1># 结果是 4</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 还可以给函数命名，不过必须使用 let 表达式</span>
</span></span><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>f</span> <span class=o>=</span> <span class=n>a</span><span class=p>:</span> <span class=n>a</span> <span class=o>+</span> <span class=n>a</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl>  <span class=n>f</span> <span class=mi>2</span>  <span class=c1># 结果是 4</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=built-in-function class=headerLink><a href=#built-in-function class=header-mark></a>内置函数</h4><p>Nix 内置了一些函数，可通过 <code>builtins.&lt;function-name></code> 来调用，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=nb>builtins</span><span class=o>.</span><span class=n>add</span> <span class=mi>1</span> <span class=mi>2</span>  <span class=c1># 结果是 3</span>
</span></span></code></pre></td></tr></table></div></div><p>详细的内置函数列表参见 <a href=https://nixos.org/manual/nix/stable/language/builtins.html target=_blank rel="noopener noreferrer">Built-in Functions - Nix Reference Mannual</a></p><h4 id=import-expression class=headerLink><a href=#import-expression class=header-mark></a>import 表达式</h4><p><code>import</code> 表达式以其他 Nix 文件的路径作为参数，返回该 Nix 文件的执行结果。</p><p><code>import</code> 的参数如果为文件夹路径，那么会返回该文件夹下的 <code>default.nix</code> 文件的执行结果。</p><p>举个例子，首先创建一个 <code>file.nix</code> 文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;x: x + 1&#34;</span> &gt; file.nix
</span></span></code></pre></td></tr></table></div></div><p>然后使用 import 执行它：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=kn>import</span> <span class=sr>./file.nix</span> <span class=mi>1</span>  <span class=c1># 结果是 2</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=pkgs-lib class=headerLink><a href=#pkgs-lib class=header-mark></a>pkgs.lib 函数包</h4><p>除了 builtins 之外，Nix 的 nixpkgs 仓库还提供了一个名为 <code>lib</code> 的 attribute set，它包含了一些常用的函数，它通常被以如下的形式被使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=n>pkgs</span> <span class=o>=</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl><span class=k>in</span>
</span></span><span class=line><span class=cl><span class=n>pkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>strings</span><span class=o>.</span><span class=n>toUpper</span> <span class=s2>&#34;search paths considered harmful&#34;</span>  <span class=c1># 结果是 &#34;SEARCH PATHS CONSIDERED HARMFUL&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>可以通过 <a href=https://nixos.org/manual/nixpkgs/stable/#sec-functions-library target=_blank rel="noopener noreferrer">Nixpkgs Library Functions - Nixpkgs Manual</a> 查看 lib 函数包的详细内容。</p><h3 id=impurities class=headerLink><a href=#impurities class=header-mark></a>11. 不纯（Impurities）</h3><p>Nix 语言本身是纯函数式的，是纯的，「纯」是指它就跟数学中的函数一样，同样的输入永远得到同样的输出。</p><p>Nix 有两种构建输入，一种是从文件系统路径等输入源中读取文件，另一种是将其他函数作为输入。</p><p><strong>Nix 唯一的不纯之处在这里：从文件系统路径或者其他输入源中读取文件作为构建任务的输入</strong>，这些输入源参数可能没变化，但是文件内容或数据源的返回内容可能会变化，这就会导致输入相同，Nix 函数的输出却可能不同——函数变得不纯了。</p><blockquote><p>Nix 中的搜索路径与 <code>builtins.currentSystem</code> 也是不纯的，但是这两个功能都不建议使用，所以这里略过了。</p></blockquote><h3 id=fetchers class=headerLink><a href=#fetchers class=header-mark></a>12. Fetchers</h3><p>构建输入除了直接来自文件系统路径之外，还可以通过 Fetchers 来获取，Fetcher 是一种特殊的函数，它的输入是一个 attribute set，输出是 Nix Store 中的一个系统路径。</p><p>Nix 提供了四个内置的 Fetcher，分别是：</p><ul><li><code>builtins.fetchurl</code>：从 url 中下载文件</li><li><code>builtins.fetchTarball</code>：从 url 中下载 tarball 文件</li><li><code>builtins.fetchGit</code>：从 git 仓库中下载文件</li><li><code>builtins.fetchClosure</code>：从 Nix Store 中获取 Derivation</li></ul><p>举例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=nb>builtins</span><span class=o>.</span><span class=n>fetchurl</span> <span class=s2>&#34;https://github.com/NixOS/nix/archive/7c3ab5751568a0bc63430b33a5169c5e4784a0ff.tar.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># result example =&gt; &#34;/nix/store/7dhgs330clj36384akg86140fqkgh8zf-7c3ab5751568a0bc63430b33a5169c5e4784a0ff.tar.gz&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>builtins</span><span class=o>.</span><span class=nb>fetchTarball</span> <span class=s2>&#34;https://github.com/NixOS/nix/archive/7c3ab5751568a0bc63430b33a5169c5e4784a0ff.tar.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># result example(auto unzip the tarball) =&gt; &#34;/nix/store/d59llm96vgis5fy231x6m7nrijs0ww36-source&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=derivations class=headerLink><a href=#derivations class=header-mark></a>13. Derivations</h3><p>一个构建动作的 Nix 语言描述被称做一个 Derivation，它描述了如何构建一个软件包，它的构建结果是一个 Store Object</p><p>Store Object 的存放路径格式为 <code>/nix/store/&lt;hash>-&lt;name></code>，其中 <code>&lt;hash></code> 是构建结果的 hash 值，<code>&lt;name></code> 是它的名字。路径 hash 值确保了每个构建结果都是唯一的，因此可以多版本共存，而且不会出现依赖冲突的问题。</p><p><code>/nix/store</code> 被称为 Store，存放所有的 Store Objects，这个路径被设置为只读，只有 Nix 本身才能修改这个路径下的内容，以保证系统的可复现性。</p><p>在 Nix 语言的最底层，一个构建任务就是使用 builtins 中的不纯函数 <code>derivation</code> 创建的，我们实际使用的 <code>stdenv.mkDerivation</code> 就是它的一个 wrapper，屏蔽了底层的细节，简化了用法。</p><h2 id=declarative-system-management class=headerLink><a href=#declarative-system-management class=header-mark></a>六、以声明式的方式管理系统</h2><blockquote><p><a href=https://nixos.wiki/wiki/Overview_of_the_NixOS_Linux_distribution target=_blank rel="noopener noreferrer">https://nixos.wiki/wiki/Overview_of_the_NixOS_Linux_distribution</a></p></blockquote><p>了解了 Nix 语言的基本用法之后，我们就可以开始使用 Nix 语言来配置 NixOS 系统了。NixOS 的系统配置路径为 <code>/etc/nixos/configuration.nix</code>，它包含系统的所有声明式配置，如时区、语言、键盘布局、网络、用户、文件系统、启动项等。</p><p>如果想要以可复现的方式修改系统的状态（这也是最推荐的方式），就需要手工修改 <code>/etc/nixos/configuration.nix</code> 文件，然后执行 <code>sudo nixos-rebuild switch</code> 命令来应用配置，此命令会根据配置文件生成一个新的系统环境，并将新的环境设为默认环境。
同时上一个系统环境会被保留，而且会被加入到 grub 的启动项中，这确保了即使新的环境不能启动，也能随时回退到旧环境。</p><p>另一方面，<code>/etc/nixos/configuration.nix</code> 是传统的 Nix 配置方式，它依赖 <code>nix-channel</code> 配置的数据源，也没有任何版本锁定机制，实际无法确保系统的可复现性。
<strong>更推荐使用的是 Nix Flakes</strong>，它可以确保系统的可复现性，同时也可以很方便地管理系统的配置。</p><p>我们下面首先介绍下通过 NixOS 默认的配置方式来管理系统，然后再过渡到更先进的 Nix Flakes.</p><h3 id=configuration-nix class=headerLink><a href=#configuration-nix class=header-mark></a>1. 使用 <code>/etc/nixos/configuration.nix</code> 配置系统</h3><p>前面提过了这是传统的 Nix 配置方式，也是当前 NixOS 默认使用的配置方式，它依赖 <code>nix-channel</code> 配置的数据源，也没有任何版本锁定机制，实际无法确保系统的可复现性。</p><p>简单起见我们先使用这种方式来配置系统，后面会介绍 Flake 的使用。</p><p>比如要启用 ssh 并添加一个用户 ryan，只需要在 <code>/etc/nixos/configuration.nix</code> 中添加如下配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=c1># Edit this configuration file to define what should be installed on</span>
</span></span><span class=line><span class=cl><span class=c1># your system.  Help is available in the configuration.nix(5) man page</span>
</span></span><span class=line><span class=cl><span class=c1># and in the NixOS manual (accessible by running ‘nixos-help’).</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>config</span><span class=o>,</span> <span class=n>pkgs</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>imports</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span> <span class=c1># Include the results of the hardware scan.</span>
</span></span><span class=line><span class=cl>      <span class=sr>./hardware-configuration.nix</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 省略掉前面的配置......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 新增用户 ryan</span>
</span></span><span class=line><span class=cl>  <span class=n>users</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>ryan</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>isNormalUser</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;ryan&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>extraGroups</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>&#34;networkmanager&#34;</span> <span class=s2>&#34;wheel&#34;</span> <span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>openssh</span><span class=o>.</span><span class=n>authorizedKeys</span><span class=o>.</span><span class=n>keys</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=c1># replace with your own public key</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;ssh-ed25519 &lt;some-public-key&gt; ryan@ryan-pc&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>packages</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=n>firefox</span>
</span></span><span class=line><span class=cl>    <span class=c1>#  thunderbird</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 启用 OpenSSH 后台服务</span>
</span></span><span class=line><span class=cl>  <span class=n>services</span><span class=o>.</span><span class=n>openssh</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>permitRootLogin</span> <span class=o>=</span> <span class=s2>&#34;no&#34;</span><span class=p>;</span>         <span class=c1># disable root login</span>
</span></span><span class=line><span class=cl>    <span class=n>passwordAuthentication</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span> <span class=c1># disable password login</span>
</span></span><span class=line><span class=cl>    <span class=n>openFirewall</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>forwardX11</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>              <span class=c1># enable X11 forwarding</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 省略其他配置......</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我启用了 openssh 服务，为 ryan 用户添加了 ssh 公钥，并禁用了密码登录。</p><p>现在运行 <code>sudo nixos-rebuild switch</code> 部署修改后的配置，之后就可以通过 ssh 密钥远程登录到我的这台主机了。</p><p>这就是 NixOS 默认的声明式系统配置，要对系统做任何可复现的变更，都只需要修改 <code>/etc/nixos/configuration.nix</code> 文件，然后运行 <code>sudo nixos-rebuild switch</code> 部署变更即可。</p><p><code>/etc/nixos/configuration.nix</code> 的所有配置项，可以在这几个地方查到：</p><ul><li>直接 Google，比如 <code>Chrome NixOS</code> 就能找到 Chrome 相关的配置项，一般 NixOS Wiki 或 nixpkgs 仓库源码的排名会比较靠前。</li><li>在 <a href=https://search.nixos.org/options target=_blank rel="noopener noreferrer">NixOS Options Search</a> 中搜索关键字</li><li>系统级别的配置，可以考虑在 <a href=https://nixos.org/manual/nixos/unstable/index.html#ch-configuration target=_blank rel="noopener noreferrer">Configuration - NixOS Manual</a> 找找相关文档</li><li>直接在 <a href=https://github.com/NixOS/nixpkgs target=_blank rel="noopener noreferrer">nixpkgs</a> 仓库中搜索关键字，读相关的源码。</li></ul><h3 id=enable-nix-flakes class=headerLink><a href=#enable-nix-flakes class=header-mark></a>2. 启用 NixOS 的 Flakes 支持</h3><p>与 NixOS 默认的配置方式相比，Nix Flakes 提供了更好的可复现性，同时它清晰的包结构定义原生支持了以其他 Git 仓库为依赖，便于代码分享，因此更建议使用 Nix Flakes 来管理系统配置。</p><p>但是目前 Nix Flakes 作为一个实验性的功能，仍未被默认启用。所以我们需要手动启用它，修改 <code>/etc/nixos/configuration.nix</code> 文件，在函数块中启用 flakes 与 nix-command 功能：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=c1># Edit this configuration file to define what should be installed on</span>
</span></span><span class=line><span class=cl><span class=c1># your system.  Help is available in the configuration.nix(5) man page</span>
</span></span><span class=line><span class=cl><span class=c1># and in the NixOS manual (accessible by running ‘nixos-help’).</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>config</span><span class=o>,</span> <span class=n>pkgs</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>imports</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span> <span class=c1># Include the results of the hardware scan.</span>
</span></span><span class=line><span class=cl>      <span class=sr>./hardware-configuration.nix</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 省略掉前面的配置......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 启用 Nix Flakes 功能，以及配套的新 nix-command 命令行工具</span>
</span></span><span class=line><span class=cl>  <span class=n>nix</span><span class=o>.</span><span class=n>settings</span><span class=o>.</span><span class=n>experimental-features</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>&#34;nix-command&#34;</span> <span class=s2>&#34;flakes&#34;</span> <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>environment</span><span class=o>.</span><span class=n>systemPackages</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>git</span>  <span class=c1># Nix Flakes 通过 git 命令从数据源拉取依赖，所以必须先安装好 git</span>
</span></span><span class=line><span class=cl>    <span class=n>vim</span>
</span></span><span class=line><span class=cl>    <span class=n>wget</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 省略其他配置......</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后运行 <code>sudo nixos-rebuild switch</code> 应用修改后，即可使用 Nix Flakes 来管理系统配置。</p><p>额外还有个好处就是，现在你可以通过 <code>nix repl</code> 打开一个 nix 交互式环境，有兴趣的话，可以使用它复习测试一遍前面学过的所有 Nix 语法。</p><h3 id=switch-to-flake-nix class=headerLink><a href=#switch-to-flake-nix class=header-mark></a>3. 将系统配置切换到 flake.nix</h3><p>在启用了 Nix Flakes 特性后，<code>sudo nixos-rebuild switch</code> 命令会优先读取 <code>/etc/nixos/flake.nix</code> 文件，如果找不到再尝试使用 <code>/etc/nixos/configuration.nix</code>。</p><p>可以首先使用官方提供的模板来学习 flake 的编写，先查下有哪些模板：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nix flake show templates
</span></span></code></pre></td></tr></table></div></div><p>其中有个 <code>templates#full</code> 模板展示了所有可能的用法，可以看看它的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nix flake init -t templates#full
</span></span><span class=line><span class=cl>cat flake.nix
</span></span></code></pre></td></tr></table></div></div><p>我们参照该模板创建文件 <code>/etc/nixos/flake.nix</code> 并编写好配置内容，后续系统的所有修改都将全部由 Nix Flakes 接管，示例内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;Ryan&#39;s NixOS Flake&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 这是 flake.nix 的标准格式，inputs 是 flake 的依赖，outputs 是 flake 的输出</span>
</span></span><span class=line><span class=cl>  <span class=c1># inputs 中的每一项依赖都会在被拉取、构建后，作为参数传递给 outputs 函数</span>
</span></span><span class=line><span class=cl>  <span class=n>inputs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># flake inputs 有很多种引用方式，应用最广泛的是 github:owner/name/reference，即 github 仓库地址 + branch/commit-id/tag</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># NixOS 官方软件源，这里使用 nixos-unstable 分支</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:NixOS/nixpkgs/nixos-unstable&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># home-manager，用于管理用户配置</span>
</span></span><span class=line><span class=cl>    <span class=n>home-manager</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:nix-community/home-manager/release-22.11&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1># follows 是 inputs 中的继承语法</span>
</span></span><span class=line><span class=cl>      <span class=c1># 这里使 home-manager 的 nixpkgs 这个 inputs 与当前 flake 的 inputs.nixpkgs</span>
</span></span><span class=line><span class=cl>      <span class=c1># 保持一致，避免依赖的 nixpkgs 版本不一致导致问题</span>
</span></span><span class=line><span class=cl>      <span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>follows</span> <span class=o>=</span> <span class=s2>&#34;nixpkgs&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># outputs 即 flake 的所有输出，其中的 nixosConfigurations 即 NixOS 系统配置</span>
</span></span><span class=line><span class=cl>  <span class=c1># 一个 flake 可以有很多用途，也可以有很多种不同的输出，nixosConfigurations 只是其中一种</span>
</span></span><span class=line><span class=cl>  <span class=c1>#</span>
</span></span><span class=line><span class=cl>  <span class=c1># outputs 的参数都是 inputs 中定义的依赖项，可以通过它们的名称来引用。</span>
</span></span><span class=line><span class=cl>  <span class=c1># 不过 self 是个例外，这个特殊参数指向 outputs 自身（自引用），以及 flake 根目录</span>
</span></span><span class=line><span class=cl>  <span class=c1># 这里的 @ 语法将函数的参数 attribute set 取了个别名，方便在内部使用</span>
</span></span><span class=line><span class=cl>  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span><span class=o>,</span> <span class=o>...</span> <span class=p>}</span><span class=o>@</span><span class=n>inputs</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 名为 nixosConfigurations 的 outputs 会在执行 `sudo nixos-rebuild switch` 时被使用</span>
</span></span><span class=line><span class=cl>    <span class=c1># 默认情况下上述命令会使用与主机 hostname 同名的 nixosConfigurations</span>
</span></span><span class=line><span class=cl>    <span class=c1># 但是也可以通过 `--flake /path/to/flake/direcotry#nixos-test` 来指定</span>
</span></span><span class=line><span class=cl>    <span class=c1># 在 flakes 配置文件夹中执行 `sudo nixos-rebuild switch --flake .#nixos-test` 即可部署此配置</span>
</span></span><span class=line><span class=cl>    <span class=c1>#   其中 `.` 表示使用当前文件夹的 Flakes 配置，`#` 后面的内容则是 nixosConfigurations 的名称</span>
</span></span><span class=line><span class=cl>    <span class=n>nixosConfigurations</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1># hostname 为 nixos-test 的主机会使用这个配置</span>
</span></span><span class=line><span class=cl>      <span class=c1># 这里使用了 nixpkgs.lib.nixosSystem 函数来构建配置，后面的 attributes set 是它的参数</span>
</span></span><span class=line><span class=cl>      <span class=c1># 在 nixos 系统上使用如下命令即可部署此配置：`nixos-rebuild switch --flake .#nixos-test`</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;nixos-test&#34;</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>nixosSystem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>system</span> <span class=o>=</span> <span class=s2>&#34;x86_64-linux&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Nix 模块系统可将配置模块化，提升配置的可维护性</span>
</span></span><span class=line><span class=cl>        <span class=c1>#</span>
</span></span><span class=line><span class=cl>        <span class=c1># modules 中每个参数，都是一个 Nix Module，nixpkgs manual 中有半份介绍它的文档：</span>
</span></span><span class=line><span class=cl>        <span class=c1>#    &lt;https://nixos.org/manual/nixpkgs/unstable/#module-system-introduction&gt;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 说半份是因为它的文档不全，只有一些简单的介绍（Nix 文档现状...）</span>
</span></span><span class=line><span class=cl>        <span class=c1># Nix Module 可以是一个 attribute set，也可以是一个返回 attribute set 的函数</span>
</span></span><span class=line><span class=cl>        <span class=c1># 如果是函数，那么它的参数就是当前的 NixOS Module 的参数.</span>
</span></span><span class=line><span class=cl>        <span class=c1># 根据 Nix Wiki 对 Nix modules 的描述，Nix modules 函数的参数可以有这几个：</span>
</span></span><span class=line><span class=cl>        <span class=c1>#</span>
</span></span><span class=line><span class=cl>        <span class=c1>#  lib:     nixpkgs 自带的函数库，提供了许多操作 Nix 表达式的实用函数</span>
</span></span><span class=line><span class=cl>        <span class=c1>#           详见 https://nixos.org/manual/nixpkgs/stable/#id-1.4</span>
</span></span><span class=line><span class=cl>        <span class=c1>#  config:  当前 flake 的所有 config 参数的集何</span>
</span></span><span class=line><span class=cl>        <span class=c1>#  options: 当前 flake 中所有 NixOS Modules 中定义的所有参数的集合</span>
</span></span><span class=line><span class=cl>        <span class=c1>#  pkgs:    一个包含所有 nixpkgs 包的集合</span>
</span></span><span class=line><span class=cl>        <span class=c1>#           入门阶段可以认为它的默认值为 `nixpkgs.legacyPackages.&#34;${system}&#34;`</span>
</span></span><span class=line><span class=cl>        <span class=c1>#           可通过 `nixpkgs.pkgs` 这个 option 来自定义 pkgs 的值</span>
</span></span><span class=line><span class=cl>        <span class=c1>#  modulesPath: 默认 nixpkgs 的内置 Modules 文件夹路径，常用于从 nixpkgs 中导入一些额外的模块</span>
</span></span><span class=line><span class=cl>        <span class=c1>#               这个参数通常都用不到，我只在制作 iso 镜像时用到过</span>
</span></span><span class=line><span class=cl>        <span class=c1>#</span>
</span></span><span class=line><span class=cl>        <span class=c1># 默认只能传上面这几个参数，如果需要传其他参数，必须使用 specialArgs，你可以取消注释如下这行来启用该参数</span>
</span></span><span class=line><span class=cl>        <span class=c1># specialArgs = inputs  # 将 inputs 中的参数传入所有子模块</span>
</span></span><span class=line><span class=cl>        <span class=n>modules</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=c1># 导入之前我们使用的 configuration.nix，这样旧的配置文件仍然能生效</span>
</span></span><span class=line><span class=cl>          <span class=c1># 注: /etc/nixos/configuration.nix 本身也是一个 Nix Module，因此可以直接在这里导入</span>
</span></span><span class=line><span class=cl>          <span class=sr>./configuration.nix</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里我们定义了一个名为 <code>nixos-test</code> 的系统，它的配置文件为 <code>./configuration.nix</code>，这个文件就是我们之前的配置文件，这样我们仍然可以沿用旧的配置。</p><p>现在执行 <code>sudo nixos-rebuild switch</code> 应用配置，系统应该没有任何变化，因为我们仅仅是切换到了 Nix Flakes，配置内容与之前还是一致的。</p><h3 id=manage-system-software-with-flakes class=headerLink><a href=#manage-system-software-with-flakes class=header-mark></a>4. 通过 Flakes 来管理系统软件</h3><p>切换完毕后，我们就可以通过 Flakes 来管理系统了。管系统最常见的需求就是装软件，我们在前面已经见识过如何通过 <code>environment.systemPackages</code> 来安装 <code>pkgs</code> 中的包，这些包都来自官方的 nixpkgs 仓库。</p><p>现在我们学习下如何通过 Flakes 安装其他来源的软件包，这比直接安装 nixpkgs 要灵活很多，最显而易见的好处是你可以很方便地设定软件的版本。
以 <a href=https://github.com/helix-editor/helix target=_blank rel="noopener noreferrer">helix</a> 编辑器为例，我们首先需要在 <code>flake.nix</code> 中添加 helix 这个 inputs 数据源：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;NixOS configuration of Ryan Yin&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># ......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>inputs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># ......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># helix editor, use tag 23.05</span>
</span></span><span class=line><span class=cl>    <span class=n>helix</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:helix-editor/helix/23.05&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>outputs</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>@</span><span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nixosConfigurations</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>nixos-test</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>nixosSystem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>system</span> <span class=o>=</span> <span class=s2>&#34;x86_64-linux&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 将所有 inputs 参数设为所有子模块的特殊参数，这样就能在子模块中使用 helix 这个 inputs 了</span>
</span></span><span class=line><span class=cl>        <span class=n>specialArgs</span> <span class=o>=</span> <span class=n>inputs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>modules</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=sr>./configuration.nix</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>接下来在 <code>configuration.nix</code> 中就能引用这个 flake input 数据源了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=c1># Edit this configuration file to define what should be installed on</span>
</span></span><span class=line><span class=cl><span class=c1># your system.  Help is available in the configuration.nix(5) man page</span>
</span></span><span class=line><span class=cl><span class=c1># and in the NixOS manual (accessible by running ‘nixos-help’).</span>
</span></span><span class=line><span class=cl><span class=c1># Nix 会通过名称匹配，自动将 specialArgs 中的 helix 注入到此函数的第三个参数</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=n>config</span><span class=o>,</span> <span class=n>pkgs</span><span class=o>,</span> <span class=n>helix</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1># 省略掉前面的配置......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>environment</span><span class=o>.</span><span class=n>systemPackages</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>git</span>  <span class=c1># Nix Flakes 通过 git 命令从数据源拉取依赖，所以必须先安装好 git</span>
</span></span><span class=line><span class=cl>    <span class=n>vim</span>
</span></span><span class=line><span class=cl>    <span class=n>wget</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 这里从 helix 这个 inputs 数据源安装了 helix 程序</span>
</span></span><span class=line><span class=cl>    <span class=n>helix</span><span class=o>.</span><span class=s2>&#34;</span><span class=si>${</span><span class=n>pkgs</span><span class=o>.</span><span class=n>system</span><span class=si>}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>packages</span><span class=o>.</span><span class=n>helix</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 省略其他配置......</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>改好后再 <code>sudo nixos-rebuild switch</code> 部署，就能安装好 helix 程序了，可直接在终端使用 <code>helix</code> 命令测试验证。</p><h3 id=add-cache-source-for-flake class=headerLink><a href=#add-cache-source-for-flake class=header-mark></a>5. 为 Flake 添加国内 cache 源</h3><p>Nix 为了加快包构建速度，提供了 <a href=https://cache.nixos.org target=_blank rel="noopener noreferrer">https://cache.nixos.org</a> 提前缓存构建结果提供给用户，但是在国内访问这个 cache 地址非常地慢，如果没有全局代理的话，基本上是无法使用的。
另外 Flakes 的数据源基本都是某个 Github 仓库，在国内从 Github 下载 Flakes 数据源也同样非常非常慢。</p><p>在旧的 NixOS 配置方式中，可以通过 <code>nix-channel</code> 命令添加国内的 cache 镜像源以提升下载速度，但是 Nix Flakes 会尽可能地避免使用任何系统级别的配置跟环境变量，以确保其构建结果不受环境的影响，因此在使用了 Flakes 后 <code>nix-channel</code> 命令就失效了。</p><p>为了自定义 cache 镜像源，我们必须在 <code>flake.nix</code> 中添加相关配置，这就是 <code>nixConfig</code> 参数，示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;NixOS configuration of Ryan Yin&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 为了确保够纯，Flake 不依赖系统自身的 /etc/nix/nix.conf，而是在 flake.nix 中通过 nixConfig 设置</span>
</span></span><span class=line><span class=cl>  <span class=c1># 但是为了确保安全性，flake 默认仅允许直接设置少数 nixConfig 参数，其他参数都需要在执行 nix 命令时指定 `--accept-flake-config`，否则会被忽略</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     &lt;https://nixos.org/manual/nix/stable/command-ref/conf-file.html&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c1># 注意：即使添加了国内 cache 镜像，如果有些包国内镜像下载不到，它仍然会走国外。</span>
</span></span><span class=line><span class=cl>  <span class=c1># 我的解法是使用 openwrt 旁路由 + openclash 加速下载。</span>
</span></span><span class=line><span class=cl>  <span class=c1># 临时修改系统默认网关为我的旁路由 IP:</span>
</span></span><span class=line><span class=cl>  <span class=c1>#    sudo ip route add default via 192.168.5.201</span>
</span></span><span class=line><span class=cl>  <span class=c1># 还原路由规则:</span>
</span></span><span class=line><span class=cl>  <span class=c1>#    sudo ip route del default via 192.168.5.201</span>
</span></span><span class=line><span class=cl>  <span class=n>nixConfig</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>experimental-features</span> <span class=o>=</span> <span class=p>[</span> <span class=s2>&#34;nix-command&#34;</span> <span class=s2>&#34;flakes&#34;</span> <span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>substituters</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=c1># replace official cache with a mirror located in China</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;https://mirrors.bfsu.edu.cn/nix-channels/store&#34;</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;https://cache.nixos.org/&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># nix community&#39;s cache server</span>
</span></span><span class=line><span class=cl>    <span class=n>extra-substituters</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;https://nix-community.cachix.org&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>extra-trusted-public-keys</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>inputs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 省略若干配置...</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>outputs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 省略若干配置...</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>改完后使用 <code>sudo nixos-rebuild switch</code> 应用配置即可生效，后续所有的包都会优先从国内镜像源查找缓存。</p><blockquote><p>注：上述手段只能加速部分包的下载，许多 inputs 数据源仍然会从 Github 拉取，另外如果找不到缓存，会执行本地构建，这通常仍然需要从国外下载源码与构建依赖，因此仍然会很慢。为了完全解决速度问题，仍然建议使用旁路由等局域网全局代理方案。</p></blockquote><h3 id=install-home-manager class=headerLink><a href=#install-home-manager class=header-mark></a>6. 安装 home-manager</h3><p>前面简单提过，NixOS 自身的配置文件只能管理系统级别的配置，而用户级别的配置则需要使用 home-manager 来管理。</p><p>根据官方文档 <a href=https://nix-community.github.io/home-manager/index.htm target=_blank rel="noopener noreferrer">Home Manager Manual</a>，要将 home manager 作为 NixOS 模块安装，首先需要创建 <code>/etc/nixos/home.nix</code>，配置方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span> <span class=n>config</span><span class=o>,</span> <span class=n>pkgs</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1># 注意修改这里的用户名与用户目录</span>
</span></span><span class=line><span class=cl>  <span class=n>home</span><span class=o>.</span><span class=n>username</span> <span class=o>=</span> <span class=s2>&#34;ryan&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>home</span><span class=o>.</span><span class=n>homeDirectory</span> <span class=o>=</span> <span class=s2>&#34;/home/ryan&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 直接将当前文件夹的配置文件，链接到 Home 目录下的指定位置</span>
</span></span><span class=line><span class=cl>  <span class=c1># home.file.&#34;.config/i3/wallpaper.jpg&#34;.source = ./wallpaper.jpg;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 递归将某个文件夹中的文件，链接到 Home 目录下的指定位置</span>
</span></span><span class=line><span class=cl>  <span class=c1># home.file.&#34;.config/i3/scripts&#34; = {</span>
</span></span><span class=line><span class=cl>  <span class=c1>#   source = ./scripts;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#   recursive = true;   # 递归整个文件夹</span>
</span></span><span class=line><span class=cl>  <span class=c1>#   executable = true;  # 将其中所有文件添加「执行」权限</span>
</span></span><span class=line><span class=cl>  <span class=c1># };</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 直接以 text 的方式，在 nix 配置文件中硬编码文件内容</span>
</span></span><span class=line><span class=cl>  <span class=c1># home.file.&#34;.xxx&#34;.text = &#39;&#39;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#     xxx</span>
</span></span><span class=line><span class=cl>  <span class=c1># &#39;&#39;;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># set cursor size and dpi for 4k monitor</span>
</span></span><span class=line><span class=cl>  <span class=n>xresources</span><span class=o>.</span><span class=n>properties</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Xcursor.size&#34;</span> <span class=o>=</span> <span class=mi>16</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;Xft.dpi&#34;</span> <span class=o>=</span> <span class=mi>172</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># git 相关配置</span>
</span></span><span class=line><span class=cl>  <span class=n>programs</span><span class=o>.</span><span class=n>git</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>userName</span> <span class=o>=</span> <span class=s2>&#34;Ryan Yin&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>userEmail</span> <span class=o>=</span> <span class=s2>&#34;xiaoyin_c@qq.com&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Packages that should be installed to the user profile.</span>
</span></span><span class=line><span class=cl>  <span class=n>home</span><span class=o>.</span><span class=n>packages</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>pkgs</span><span class=o>.</span><span class=n>htop</span>
</span></span><span class=line><span class=cl>    <span class=n>pkgs</span><span class=o>.</span><span class=n>btop</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 启用 starship，这是一个漂亮的 shell 提示符</span>
</span></span><span class=line><span class=cl>  <span class=n>programs</span><span class=o>.</span><span class=n>starship</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>settings</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>add_newline</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>aws</span><span class=o>.</span><span class=n>disabled</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>gcloud</span><span class=o>.</span><span class=n>disabled</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>line_break</span><span class=o>.</span><span class=n>disabled</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># alacritty 终端配置</span>
</span></span><span class=line><span class=cl>  <span class=n>programs</span><span class=o>.</span><span class=n>alacritty</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>env</span><span class=o>.</span><span class=n>TERM</span> <span class=o>=</span> <span class=s2>&#34;xterm-256color&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>font</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=mi>12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>draw_bold_text_with_bright_colors</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=n>scrolling</span><span class=o>.</span><span class=n>multiplier</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>selection</span><span class=o>.</span><span class=n>save_to_clipboard</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># This value determines the Home Manager release that your</span>
</span></span><span class=line><span class=cl>  <span class=c1># configuration is compatible with. This helps avoid breakage</span>
</span></span><span class=line><span class=cl>  <span class=c1># when a new Home Manager release introduces backwards</span>
</span></span><span class=line><span class=cl>  <span class=c1># incompatible changes.</span>
</span></span><span class=line><span class=cl>  <span class=c1>#</span>
</span></span><span class=line><span class=cl>  <span class=c1># You can update Home Manager without changing this value. See</span>
</span></span><span class=line><span class=cl>  <span class=c1># the Home Manager release notes for a list of state version</span>
</span></span><span class=line><span class=cl>  <span class=c1># changes in each release.</span>
</span></span><span class=line><span class=cl>  <span class=n>home</span><span class=o>.</span><span class=n>stateVersion</span> <span class=o>=</span> <span class=s2>&#34;22.11&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Let Home Manager install and manage itself.</span>
</span></span><span class=line><span class=cl>  <span class=n>programs</span><span class=o>.</span><span class=n>home-manager</span><span class=o>.</span><span class=n>enable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>添加好 <code>/etc/nixos/home.nix</code> 后，还需要在 <code>/etc/nixos/flake.nix</code> 中导入该配置，它才能生效，可以使用如下命令，在当前文件夹中生成一个示例配置以供参考：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>nix flake new example -t github:nix-community/home-manager#nixos
</span></span></code></pre></td></tr></table></div></div><p>调整好参数后的 <code>/etc/nixos/flake.nix</code> 内容示例如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;NixOS configuration&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>inputs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:nixos/nixpkgs/nixos-unstable&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>home-manager</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:nix-community/home-manager&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>home-manager</span><span class=o>.</span><span class=n>inputs</span><span class=o>.</span><span class=n>nixpkgs</span><span class=o>.</span><span class=n>follows</span> <span class=o>=</span> <span class=s2>&#34;nixpkgs&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>outputs</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>@</span><span class=p>{</span> <span class=n>nixpkgs</span><span class=o>,</span> <span class=n>home-manager</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nixosConfigurations</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1># 这里的 nixos-test 替换成你的主机名称</span>
</span></span><span class=line><span class=cl>      <span class=n>nixos-test</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>nixosSystem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>system</span> <span class=o>=</span> <span class=s2>&#34;x86_64-linux&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>modules</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=sr>./configuration.nix</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1># 将 home-manager 配置为 nixos 的一个 module</span>
</span></span><span class=line><span class=cl>          <span class=c1># 这样在 nixos-rebuild switch 时，home-manager 配置也会被自动部署</span>
</span></span><span class=line><span class=cl>          <span class=n>home-manager</span><span class=o>.</span><span class=n>nixosModules</span><span class=o>.</span><span class=n>home-manager</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>home-manager</span><span class=o>.</span><span class=n>useGlobalPkgs</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>home-manager</span><span class=o>.</span><span class=n>useUserPackages</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 这里的 ryan 也得替换成你的用户名</span>
</span></span><span class=line><span class=cl>            <span class=c1># 这里的 import 函数在前面 Nix 语法中介绍过了，不再赘述</span>
</span></span><span class=line><span class=cl>            <span class=n>home-manager</span><span class=o>.</span><span class=n>users</span><span class=o>.</span><span class=n>ryan</span> <span class=o>=</span> <span class=kn>import</span> <span class=sr>./home.nix</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># 使用 home-manager.extraSpecialArgs 自定义传递给 ./home.nix 的参数</span>
</span></span><span class=line><span class=cl>            <span class=c1># 取消注释下面这一行，就可以在 home.nix 中使用 flake 的所有 inputs 参数了</span>
</span></span><span class=line><span class=cl>            <span class=c1># home-manager.extraSpecialArgs = inputs;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后执行 <code>sudo nixos-rebuild switch</code> 应用配置，即可完成 home-manager 的安装。</p><p>安装完成后，所有用户级别的程序、配置，都可以通过 <code>/etc/nixos/home.nix</code> 管理，并且执行 <code>sudo nixos-rebuild switch</code> 时也会自动应用 home-manager 的配置。</p><p><code>home.nix</code> 中 Home Manager 的配置项有这几种查找方式：</p><ul><li><a href=https://nix-community.github.io/home-manager/options.html target=_blank rel="noopener noreferrer">Home Manager - Appendix A. Configuration Options</a>: 一份包含了所有配置项的列表，建议在其中关键字搜索。</li><li><a href=https://github.com/nix-community/home-manager target=_blank rel="noopener noreferrer">home-manager</a>: 有些配置项在官方文档中没有列出，或者文档描述不够清晰，可以直接在这份 home-manager 的源码中搜索阅读对应的源码。</li></ul><h3 id=modularize-nixos-configuration class=headerLink><a href=#modularize-nixos-configuration class=header-mark></a>7. 模块化 NixOS 配置</h3><p>到这里整个系统的骨架基本就配置完成了，当前我们 <code>/etc/nixos</code> 中的系统配置结构应该如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>$ tree
</span></span><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── flake.lock
</span></span><span class=line><span class=cl>├── flake.nix
</span></span><span class=line><span class=cl>├── home.nix
</span></span><span class=line><span class=cl>└── configuration.nix
</span></span></code></pre></td></tr></table></div></div><p>下面分别说明下这四个文件的功能：</p><ul><li><code>flake.lock</code>: 自动生成的版本锁文件，它记录了整个 flake 所有输入的数据源、hash 值、版本号，确保系统可复现。</li><li><code>flake.nix</code>: 入口文件，执行 <code>sudo nixos-rebuild switch</code> 时会识别并部署它。</li><li><code>configuration.nix</code>: 在 flake.nix 中被作为系统模块导入，目前所有系统级别的配置都写在此文件中。<ul><li>此配置文件中的所有配置项，参见官方文档 <a href=https://nixos.org/manual/nixos/unstable/index.html#ch-configuration target=_blank rel="noopener noreferrer">Configuration - NixOS Manual</a></li></ul></li><li><code>home.nix</code>: 在 flake.nix 中被 home-manager 作为 ryan 用户的配置导入，也就是说它包含了 ryan 这个用户的所有 Home Manager 配置，负责管理其 Home 文件夹。<ul><li>此配置文件的所有配置项，参见 <a href=https://nix-community.github.io/home-manager/options.html target=_blank rel="noopener noreferrer">Appendix A. Configuration Options - Home Manager</a></li></ul></li></ul><p>通过修改上面几个配置文件就可以实现对系统与 Home 目录状态的修改。
但是随着配置的增多，单纯依靠 <code>configuration.nix</code> 跟 <code>home.nix</code> 会导致配置文件臃肿，难以维护，因此更好的解决方案是通过 Nix 的模块机制，将配置文件拆分成多个模块，分门别类地编写维护。</p><p>在前面的 Nix 语法一节有介绍过：「<code>import</code> 的参数如果为文件夹路径，那么会返回该文件夹下的 <code>default.nix</code> 文件的执行结果」，实际 Nix 还提供了一个 <code>imports</code> 参数，它可以接受一个 <code>.nix</code> 文件列表，并将该列表中的所有配置<strong>合并</strong>（Merge）到当前的 attribute set 中。注意这里的用词是「合并」，它表明 <code>imports</code> 如果遇到重复的配置项，不会简单地按执行顺序互相覆盖，而是更合理地处理。比如说我在多个 modules 中都定义了 <code>program.packages = [...]</code>，那么 <code>imports</code> 会将所有 modules 中的 <code>program.packages</code> 这个 list 合并。不仅 list 能被正确合并，attribute set 也能被正确合并，具体行为各位看官可以自行探索。</p><blockquote><p>我只在 <a href=https://nixos.org/manual/nixpkgs/unstable/#module-system-lib-evalModules-parameters target=_blank rel="noopener noreferrer">nixpkgs-unstable 官方手册 - evalModules parameters</a> 中找到一句关于 <code>imports</code> 的描述：<code>A list of modules. These are merged together to form the final configuration.</code>，可以意会一下&mldr;（Nix 的文档真的一言难尽&mldr;这么核心的参数文档就这么一句&mldr;）</p></blockquote><p>我们可以借助 <code>imports</code> 参数，将 <code>home.nix</code> 与 <code>configuration.nix</code> 拆分成多个 <code>.nix</code> 文件。</p><p>比如我之前的 i3wm 系统配置 <a href=https://github.com/ryan4yin/nix-config/tree/v0.0.2 target=_blank rel="noopener noreferrer">ryan4yin/nix-config/v0.0.2</a>，结构如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>├── flake.lock
</span></span><span class=line><span class=cl>├── flake.nix
</span></span><span class=line><span class=cl>├── home
</span></span><span class=line><span class=cl>│   ├── default.nix         <span class=c1># 在这里通过 imports = [...] 导入所有子模块</span>
</span></span><span class=line><span class=cl>│   ├── fcitx5              <span class=c1># fcitx5 中文输入法设置，我使用了自定义的小鹤音形输入法</span>
</span></span><span class=line><span class=cl>│   │   ├── default.nix
</span></span><span class=line><span class=cl>│   │   └── rime-data-flypy
</span></span><span class=line><span class=cl>│   ├── i3                  <span class=c1># i3wm 桌面配置</span>
</span></span><span class=line><span class=cl>│   │   ├── config
</span></span><span class=line><span class=cl>│   │   ├── default.nix
</span></span><span class=line><span class=cl>│   │   ├── i3blocks.conf
</span></span><span class=line><span class=cl>│   │   ├── keybindings
</span></span><span class=line><span class=cl>│   │   └── scripts
</span></span><span class=line><span class=cl>│   ├── programs
</span></span><span class=line><span class=cl>│   │   ├── browsers.nix
</span></span><span class=line><span class=cl>│   │   ├── common.nix
</span></span><span class=line><span class=cl>│   │   ├── default.nix   <span class=c1># 在这里通过 imports = [...] 导入 programs 目录下的所有 nix 文件</span>
</span></span><span class=line><span class=cl>│   │   ├── git.nix
</span></span><span class=line><span class=cl>│   │   ├── media.nix
</span></span><span class=line><span class=cl>│   │   ├── vscode.nix
</span></span><span class=line><span class=cl>│   │   └── xdg.nix
</span></span><span class=line><span class=cl>│   ├── rofi              <span class=c1>#  rofi 应用启动器配置，通过 i3wm 中配置的快捷键触发</span>
</span></span><span class=line><span class=cl>│   │   ├── configs
</span></span><span class=line><span class=cl>│   │   │   ├── arc_dark_colors.rasi
</span></span><span class=line><span class=cl>│   │   │   ├── arc_dark_transparent_colors.rasi
</span></span><span class=line><span class=cl>│   │   │   ├── power-profiles.rasi
</span></span><span class=line><span class=cl>│   │   │   ├── powermenu.rasi
</span></span><span class=line><span class=cl>│   │   │   ├── rofidmenu.rasi
</span></span><span class=line><span class=cl>│   │   │   └── rofikeyhint.rasi
</span></span><span class=line><span class=cl>│   │   └── default.nix
</span></span><span class=line><span class=cl>│   └── shell             <span class=c1># shell 终端相关配置</span>
</span></span><span class=line><span class=cl>│       ├── common.nix
</span></span><span class=line><span class=cl>│       ├── default.nix
</span></span><span class=line><span class=cl>│       ├── nushell
</span></span><span class=line><span class=cl>│       │   ├── config.nu
</span></span><span class=line><span class=cl>│       │   ├── default.nix
</span></span><span class=line><span class=cl>│       │   └── env.nu
</span></span><span class=line><span class=cl>│       ├── starship.nix
</span></span><span class=line><span class=cl>│       └── terminals.nix
</span></span><span class=line><span class=cl>├── hosts
</span></span><span class=line><span class=cl>│   ├── msi-rtx4090      <span class=c1># PC 主机的配置</span>
</span></span><span class=line><span class=cl>│   │   ├── default.nix                 <span class=c1># 这就是之前的 configuration.nix，不过大部分内容都拆出到 modules 了</span>
</span></span><span class=line><span class=cl>│   │   └── hardware-configuration.nix  <span class=c1># 与系统硬件相关的配置，安装 nixos 时自动生成的</span>
</span></span><span class=line><span class=cl>│   └── nixos-test       <span class=c1># 测试用的虚拟机配置</span>
</span></span><span class=line><span class=cl>│       ├── default.nix
</span></span><span class=line><span class=cl>│       └── hardware-configuration.nix
</span></span><span class=line><span class=cl>├── modules          <span class=c1># 从 configuration.nix 中拆分出的一些通用配置</span>
</span></span><span class=line><span class=cl>│   ├── i3.nix
</span></span><span class=line><span class=cl>│   └── system.nix
</span></span><span class=line><span class=cl>└── wallpaper.jpg    <span class=c1># 桌面壁纸，在 i3wm 配置中被引用</span>
</span></span></code></pre></td></tr></table></div></div><p>详细结构与内容，请移步前面提供的 github 仓库链接，这里就不多介绍了。</p><h3 id=update-nixos-system class=headerLink><a href=#update-nixos-system class=header-mark></a>8. 更新系统</h3><p>在使用了 Nix Flakes 后，要更新系统也很简单，先更新 flake.lock 文件，然后部署即可。在配置文件夹中执行如下命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 更新 flake.lock</span>
</span></span><span class=line><span class=cl>nix flake update
</span></span><span class=line><span class=cl><span class=c1># 部署系统</span>
</span></span><span class=line><span class=cl>sudo nixos-rebuild switch
</span></span></code></pre></td></tr></table></div></div><p>另外有时候安装新的包，跑 <code>sudo nixos-rebuild switch</code> 时可能会遇到 sha256 不匹配的报错，也可以尝试通过 <code>nix flake update</code> 更新 flake.lock 来解决（原理暂时不太清楚）。</p><h3 id=rollback-package-version class=headerLink><a href=#rollback-package-version class=header-mark></a>9. 回退个别软件包的版本</h3><p>在使用 Nix Flakes 后，目前大家用得比较多的都是 <code>nixos-unstable</code> 分支的 nixpkgs，有时候就会遇到一些 bug，比如我最近（2023/5/6）就遇到了 <a href=https://github.com/swaywm/sway/issues/7562 target=_blank rel="noopener noreferrer">chrome/vscode 闪退的问题</a>。</p><p>这时候就需要退回到之前的版本，在 Nix Flakes 中，所有的包版本与 hash 值与其 input 数据源的 git commit 是一一对应的关系，因此回退某个包的到历史版本，就需要锁定其 input 数据源的 git commit.</p><p>为了实现上述需求，首先修改 <code>/etc/nixos/flake.nix</code>，示例内容如下（主要是利用 <code>specialArgs</code> 参数）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;NixOS configuration of Ryan Yin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>inputs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 默认使用 nixos-unstable 分支</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:nixos/nixpkgs/nixos-unstable&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 最新 stable 分支的 nixpkgs，用于回退个别软件包的版本，当前最新版本为 22.11</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs-stable</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:nixos/nixpkgs/nixos-22.11&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 另外也可以使用 git commit hash 来锁定版本，这是最彻底的锁定方式</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs-fd40cef8d</span><span class=o>.</span><span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;github:nixos/nixpkgs/fd40cef8d797670e203a27a91e4b8e6decf0b90c&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>outputs</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>@</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>self</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs-stable</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=n>nixpkgs-fd40cef8d</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=p>}:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nixosConfigurations</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>nixos-test</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>nixosSystem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>system</span> <span class=o>=</span> <span class=s2>&#34;x86_64-linux&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 核心参数是这个，将非默认的 nixpkgs 数据源传到其他 modules 中</span>
</span></span><span class=line><span class=cl>        <span class=n>specialArgs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>inherit</span> <span class=n>nixpkgs-stable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>inherit</span> <span class=n>nixpkgs-fd40cef8d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=n>modules</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=sr>./hosts/nixos-test</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1># 省略其他模块配置...</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>然后在你对应的 module 中使用该数据源中的包，一个 Home Manager 的子模块示例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>pkgs</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=n>config</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=c1># nix 会从 flake.nix 的 specialArgs 查找并注入此参数</span>
</span></span><span class=line><span class=cl>  <span class=n>nixpkgs-stable</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=c1># nixpkgs-fd40cef8d,  # 也可以使用固定 hash 的 nixpkgs 数据源</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=cl>  <span class=c1># 为了在后面使用 nixpkgs-stable 中的包，需要先给它配置一些参数</span>
</span></span><span class=line><span class=cl>  <span class=n>pkgs-stable</span> <span class=o>=</span> <span class=kn>import</span> <span class=n>nixpkgs-stable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 我们全局的参数会被自动配置到默认的 pkgs 中，这里可以直接从 pkgs 中引用</span>
</span></span><span class=line><span class=cl>    <span class=n>system</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>system</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 为了拉取 chrome，需要允许安装非自由软件</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>.</span><span class=n>allowUnfree</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>in</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1># 这里从 pkg-stable 中引用包</span>
</span></span><span class=line><span class=cl>  <span class=n>home</span><span class=o>.</span><span class=n>packages</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs-stable</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>firefox-wayland</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># chrome wayland support was broken on nixos-unstable branch, so fallback to stable branch for now</span>
</span></span><span class=line><span class=cl>    <span class=c1># https://github.com/swaywm/sway/issues/7562</span>
</span></span><span class=line><span class=cl>    <span class=n>google-chrome</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>programs</span><span class=o>.</span><span class=n>vscode</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>enable</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>package</span> <span class=o>=</span> <span class=n>pkgs-stable</span><span class=o>.</span><span class=n>vscode</span><span class=p>;</span>  <span class=c1># 这里也一样，从 pkgs-stable 中引用包</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>配置完成后，通过 <code>sudo nixos-rebuild switch</code> 部署即可将 firefox/chrome/vscode 三个软件包回退到 stable 分支的版本。</p><h3 id=git-manage-nixos-config class=headerLink><a href=#git-manage-nixos-config class=header-mark></a>10. 使用 Git 管理 NixOS 配置</h3><p>NixOS 的配置文件是纯文本，因此跟普通的 dotfiles 一样可以使用 Git 管理。</p><p>此外 Nix Flakes 配置也不一定需要放在 <code>/etc/nixos</code> 目录下，可以放在任意目录下，只要在部署时指定正确的路径即可。</p><blockquote><p>我们在前面第 3 小节的代码注释中有说明过，可以通过 <code>sudo nixos-rebuild switch --flake .#xxx</code> 的 <code>--flake</code> 参数指定 Flakes 配置的文件夹路径，并通过 <code>#</code> 后面的值来指定使用的 outputs 名称。</p></blockquote><p>比如我的使用方式是将 Nix Flakes 配置放在 <code>~/nixos-config</code> 目录下，然后在 <code>/etc/nixos</code> 目录下创建一个软链接：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo mv /etc/nixos /etc/nixos.bak  <span class=c1># 备份原来的配置</span>
</span></span><span class=line><span class=cl>sudo ln -s ~/nixos-config/ /etc/nixos
</span></span></code></pre></td></tr></table></div></div><p>然后就可以在 <code>~/nixos-config</code> 目录下使用 Git 管理配置了，配置使用普通的用户级别权限即可，不要求 owner 为 root.</p><p>另一种方法是直接删除掉 <code>/etc/nixos</code>，并在每次部署时指定配置文件路径：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo mv /etc/nixos /etc/nixos.bak  <span class=c1># 备份原来的配置</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> ~/nixos-config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 通过 --flake .#nixos-test 参数，指定使用当前文件夹的 flake.nix，使用的 nixosConfiguraitons 名称为 nixos-test</span>
</span></span><span class=line><span class=cl>sudo nixos-rebuild switch --flake .#nixos-test
</span></span></code></pre></td></tr></table></div></div><p>两种方式都可以，看个人喜好。</p><h3 id=other-useful-commands class=headerLink><a href=#other-useful-commands class=header-mark></a>11. 其他可能需要用到的指令</h3><blockquote><p>这里提供了部分 <code>nix-env</code> 指令，因为新的 Nix 命令行工具貌似未提供对应的功能。</p></blockquote><p>如前所述，NixOS 的每次部署都会生成一个新的版本，所有版本都会被添加到系统启动项中，除了重启电脑外，我们也可以通过如下命令查询当前可用的所有历史版本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo nix-env --list-generations --profile /nix/var/nix/profiles/system
</span></span></code></pre></td></tr></table></div></div><p>另外如下命令会列出所有系统中当前安装的 Nix 包：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>nix-env -qa
</span></span></code></pre></td></tr></table></div></div><p>以及清理历史版本释放存储空间的命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># 清理 14 天之前的所有历史版本</span>
</span></span><span class=line><span class=cl>sudo nix-collect-garbage --delete-older-than 14d
</span></span></code></pre></td></tr></table></div></div><h2 id=nix-flakes-usage class=headerLink><a href=#nix-flakes-usage class=header-mark></a>七、Nix Flakes 的使用</h2><p>到这里我们已经写了不少 Nix Flakes 配置来管理 NixOS 系统了，这里再简单介绍下 Nix Flakes 更细节的内容，以及常用的 nix flake 命令。</p><h3 id=flake-outputs class=headerLink><a href=#flake-outputs class=header-mark></a>1. Flake 的 outputs</h3><p><code>flake.nix</code> 中的 <code>outputs</code> 是一个 attribute set，是整个 Flake 的构建结果，每个 Flake 都可以有许多不同的 outputs，outputs 大致有如下这些类型：</p><ul><li>Nix packages: 名称为 <code>apps.&lt;system>.&lt;name></code>, <code>packages.&lt;system>.&lt;name></code> 或 <code>legacyPackages.&lt;system>.&lt;name></code> 的 outputs，都是 Nix 包，通常都是一个个应用程序。</li><li>Nix Helper Functions: 名称为 <code>lib</code> 的 outputs 是 Flake 函数库，可以被其他 Flake 作为 inputs 导入使用。</li><li>Nix development environments: 名称为 <code>devShells</code> 的 outputs 是 Nix 开发环境<ul><li>可以通过 <code>nix develop</code> 命令来使用该 Output 创建开发环境</li></ul></li><li>NixOS configurations: 名称为 <code>nixosConfigurations.&lt;hostname></code> 的 outputs，是 NixOS 的系统配置。</li><li>Nix templates: 名称为 <code>templates</code> 的 outputs 是 flake 模板<ul><li>可以通过执行命令 <code>nix flake init --template &lt;reference></code> 使用模板初始化一个 Flake 包</li></ul></li><li>其他用户自定义的 outputs</li></ul><h3 id=flake-commands-usage class=headerLink><a href=#flake-commands-usage class=header-mark></a>2. Flake 命令行的使用</h3><p>在启用了 <code>nix-command</code> & <code>flakes</code> 功能后，我们就可以使用 Nix 提供的新一代 Nix 命令行工具 <a href=https://nixos.org/manual/nix/stable/command-ref/new-cli/nix.html target=_blank rel="noopener noreferrer">New Nix Commands</a> 了，下面列举下其中常用命令的用法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 解释下这条指令涉及的参数：</span>
</span></span><span class=line><span class=cl><span class=c1>#   `nixpkgs#ponysay` 意思是 `nixpkgs` 这个 flake 中的 `ponysay` 包。</span>
</span></span><span class=line><span class=cl><span class=c1>#   `nixpkgs` 是一个 flakeregistry ida,</span>
</span></span><span class=line><span class=cl><span class=c1>#    nix 会从 &lt;https://github.com/NixOS/flake-registry/blob/master/flake-registry.json&gt; 中</span>
</span></span><span class=line><span class=cl><span class=c1>#    找到这个 id 对应的 github 仓库地址</span>
</span></span><span class=line><span class=cl><span class=c1># 所以这个命令的意思是创建一个新环境，安装并运行 `nixpkgs` 这个 flake 提供的 `ponysay` 包。</span>
</span></span><span class=line><span class=cl><span class=c1>#   注：前面已经介绍过了，nix 包 是 flake outputs 中的一种。</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Hello Nix&#34;</span> <span class=p>|</span> nix run <span class=s2>&#34;nixpkgs#ponysay&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 这条命令和上面的命令作用是一样的，只是使用了完整的 flake URI，而不是 flakeregistry id。</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Hello Nix&#34;</span> <span class=p>|</span> nix run <span class=s2>&#34;github:NixOS/nixpkgs/nixos-unstable#ponysay&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 这条命令的作用是使用 zero-to-nix 这个 flake 中名 `devShells.example` 的 outptus 来创建一个开发环境，</span>
</span></span><span class=line><span class=cl><span class=c1># 然后在这个环境中打开一个 bash shell。</span>
</span></span><span class=line><span class=cl>nix develop <span class=s2>&#34;github:DeterminateSystems/zero-to-nix#example&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 除了使用远程 flake uri 之外，你也可以使用当前目录下的 flake 来创建一个开发环境。</span>
</span></span><span class=line><span class=cl>mkdir my-flake <span class=o>&amp;&amp;</span> <span class=nb>cd</span> my-flake
</span></span><span class=line><span class=cl><span class=c1>## 通过模板初始化一个 flake</span>
</span></span><span class=line><span class=cl>nix flake init --template <span class=s2>&#34;github:DeterminateSystems/zero-to-nix#javascript-dev&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>## 使用当前目录下的 flake 创建一个开发环境，并打开一个 bash shell</span>
</span></span><span class=line><span class=cl>nix develop
</span></span><span class=line><span class=cl><span class=c1># 或者如果你的 flake 有多个 devShell 输出，你可以指定使用名为 example 的那个</span>
</span></span><span class=line><span class=cl>nix develop .#example
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 构建 `nixpkgs` flake 中的 `bat` 这个包</span>
</span></span><span class=line><span class=cl><span class=c1># 并在当前目录下创建一个名为 `result` 的符号链接，链接到该构建结果文件夹。</span>
</span></span><span class=line><span class=cl>mkdir build-nix-package <span class=o>&amp;&amp;</span> <span class=nb>cd</span> build-nix-package
</span></span><span class=line><span class=cl>nix build <span class=s2>&#34;nixpkgs#bat&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 构建一个本地 flake 和 nix develop 是一样的，不再赘述</span>
</span></span></code></pre></td></tr></table></div></div><p>此外 <a href=https://github.com/DeterminateSystems/zero-to-nix target=_blank rel="noopener noreferrer">Zero to Nix - Determinate Systems</a> 是一份全新的 Nix & Flake 新手入门文档，写得比较浅显易懂，适合新手用来入门。</p><h2 id=nixpkgs-advanced-usage class=headerLink><a href=#nixpkgs-advanced-usage class=header-mark></a>八、Nixpkgs 的高级用法</h2><p>callPackage、Overriding 与 Overlays 是在使用 Nix 时偶尔会用到的技术，它们都是用来自定义 Nix 包的构建方法的。</p><p>我们知道许多程序都有大量构建参数需要配置，不同的用户会希望使用不同的构建参数，这时候就需要 Overriding 与 Overlays 来实现。我举几个我遇到过的例子：</p><ol><li><a href=https://github.com/NixOS/nixpkgs/blob/e4246ae1e7f78b7087dce9c9da10d28d3725025f/pkgs/tools/inputmethods/fcitx5/fcitx5-rime.nix target=_blank rel="noopener noreferrer">fcitx5-rime.nix</a>: fcitx5-rime 的 <code>rimeDataPkgs</code> 默认使用 <code>rime-data</code> 包，但是也可以通过 override 来自定义该参数的值，以加载自定义的 rime 配置（比如加载小鹤音形输入法配置）。</li><li><a href=https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/vscode/with-extensions.nix target=_blank rel="noopener noreferrer">vscode/with-extensions.nix</a>: vscode 的这个包也可以通过 override 来自定义 <code>vscodeExtensions</code> 参数的值来安装自定义插件。<ol><li><a href=https://github.com/nix-community/nix-vscode-extensions target=_blank rel="noopener noreferrer">nix-vscode-extensions</a>: 就是利用该参数实现的 vscode 插件管理</li></ol></li><li><a href=https://github.com/NixOS/nixpkgs/blob/416ffcd08f1f16211130cd9571f74322e98ecef6/pkgs/applications/networking/browsers/firefox/common.nix target=_blank rel="noopener noreferrer">firefox/common.nix</a>: firefox 同样有许多可自定义的参数</li><li>等等</li></ol><p>总之如果需要自定义上述这类 Nix 包的构建参数，或者实施某些比较底层的修改，我们就得用到 Overriding 跟 Overlays。</p><h3 id=overriding class=headerLink><a href=#overriding class=header-mark></a>Overriding</h3><blockquote><p><a href=https://nixos.org/manual/nixpkgs/stable/#chap-overrides target=_blank rel="noopener noreferrer">Chapter 4. Overriding - nixpkgs Manual</a></p></blockquote><p>简单的说，所有 nixpkgs 中的 Nix 包都可以通过 <code>&lt;pkg>.override {}</code> 来自定义某些构建参数，它返回一个使用了自定义参数的新 Derivation. 举个例子：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=n>pkgs</span><span class=o>.</span><span class=n>fcitx5-rime</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span><span class=n>rimeDataPkgs</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=sr>./rime-data-flypy</span>
</span></span><span class=line><span class=cl><span class=p>];}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面这个 Nix 表达式的执行结果就是一个新的 Derivation，它的 <code>rimeDataPkgs</code> 参数被覆盖为 <code>[./rime-data-flypy]</code>，而其他参数则沿用原来的值。</p><p>除了覆写参数，还可以通过 <code>overrideAttrs</code> 来覆写使用 <code>stdenv.mkDerivation</code> 构建的 Derivation 的属性，比如：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=n>helloWithDebug</span> <span class=err>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>hello</span><span class=o>.</span><span class=n>overrideAttrs</span> <span class=p>(</span><span class=n>finalAttrs</span><span class=p>:</span> <span class=n>previousAttrs</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>separateDebugInfo</span> <span class=o>=</span> <span class=no>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>上面这个例子中，<code>helloWithDebug</code> 就是一个新的 Derivation，它的 <code>separateDebugInfo</code> 参数被覆盖为 <code>true</code>，而其他参数则沿用原来的值。</p><h3 id=overlays class=headerLink><a href=#overlays class=header-mark></a>Overlays</h3><blockquote><p><a href=https://nixos.org/manual/nixpkgs/stable/#chap-overlays target=_blank rel="noopener noreferrer">Chapter 3. Overlays - nixpkgs Manual</a></p></blockquote><p>前面介绍的 override 函数都会生成新的 Derivation，不影响 pkgs 中原有的 Derivation，只适合作为局部参数使用。
但如果你需要覆写的 Derivation 还被其他 Nix 包所依赖，那其他 Nix 包使用的仍然会是原有的 Derivation.</p><p>为了解决这个问题，Nix 提供了 overlays 能力。简单的说，Overlays 可以全局修改 pkgs 中的 Derivation。</p><p>在旧的 Nix 环境中，Nix 默认会自动应用 <code>~/.config/nixpkgs/overlays.nix</code> <code>~/.config/nixpkgs/overlays/*.nix</code> 这类路径下的所有 overlays 配置。</p><p>但是在 Flakes 中，为了确保系统的可复现性，它不能依赖任何 Git 仓库之外的配置，所以这种旧的方法就不能用了。</p><p>在使用 Nix Flakes 编写 NixOS 配置时，Home Manager 与 NixOS 都提供了 <code>nixpkgs.overlays</code> 这个 option 来引入 overlays, 相关文档：</p><ul><li><a href=https://nix-community.github.io/home-manager/options.html#opt-nixpkgs.overlays target=_blank rel="noopener noreferrer">home-manager docs - <code>nixpkgs.overlays</code></a></li><li><a href=https://github.com/NixOS/nixpkgs/blob/30d7dd7e7f2cba9c105a6906ae2c9ed419e02f17/nixos/modules/misc/nixpkgs.nix#L169 target=_blank rel="noopener noreferrer">nixpkgs source code - <code>nixpkgs.overlays</code></a></li></ul><p>举个例子，如下内容就是一个加载 Overlays 的 Module，它既可以用做 Home Manager Module，也可以用做 NixOS Module，因为这俩定义完全是一致的：</p><blockquote><p>不过我使用发现，Home Manager 毕竟是个外部组件，而且现在全都用的 unstable 分支，这导致 Home Manager Module 有时候会有点小毛病，因此更建议以 NixOS Module 的形式引入 overlays</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span> <span class=n>config</span><span class=o>,</span> <span class=n>pkgs</span><span class=o>,</span> <span class=n>lib</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>nixpkgs</span><span class=o>.</span><span class=n>overlays</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1># overlayer1 - 参数名用 self 与 super，表达继承关系</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>self</span><span class=p>:</span> <span class=n>super</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>     <span class=n>google-chrome</span> <span class=o>=</span> <span class=n>super</span><span class=o>.</span><span class=n>google-chrome</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=n>commandLineArgs</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>         <span class=s2>&#34;--proxy-server=&#39;https=127.0.0.1:3128;http=127.0.0.1:3128&#39;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>     <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># overlayer2 - 还可以使用 extend 来继承其他 overlay</span>
</span></span><span class=line><span class=cl>    <span class=c1># 这里改用 final 与 prev，表达新旧关系</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>final</span><span class=p>:</span> <span class=n>prev</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>steam</span> <span class=o>=</span> <span class=n>prev</span><span class=o>.</span><span class=n>steam</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>extraPkgs</span> <span class=o>=</span> <span class=n>pkgs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>          <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>keyutils</span>
</span></span><span class=line><span class=cl>            <span class=n>libkrb5</span>
</span></span><span class=line><span class=cl>            <span class=n>libpng</span>
</span></span><span class=line><span class=cl>            <span class=n>libpulseaudio</span>
</span></span><span class=line><span class=cl>            <span class=n>libvorbis</span>
</span></span><span class=line><span class=cl>            <span class=n>stdenv</span><span class=o>.</span><span class=n>cc</span><span class=o>.</span><span class=n>cc</span><span class=o>.</span><span class=n>lib</span>
</span></span><span class=line><span class=cl>            <span class=n>xorg</span><span class=o>.</span><span class=n>libXcursor</span>
</span></span><span class=line><span class=cl>            <span class=n>xorg</span><span class=o>.</span><span class=n>libXi</span>
</span></span><span class=line><span class=cl>            <span class=n>xorg</span><span class=o>.</span><span class=n>libXinerama</span>
</span></span><span class=line><span class=cl>            <span class=n>xorg</span><span class=o>.</span><span class=n>libXScrnSaver</span>
</span></span><span class=line><span class=cl>          <span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>extraProfile</span> <span class=o>=</span> <span class=s2>&#34;export GDK_SCALE=2&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># overlay3 - 也可以将 overlay 定义在其他文件中</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=kn>import</span> <span class=sr>./overlays/overlay3.nix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里只是个示例配置，参照此格式编写你自己的 overlays 配置，将该配置作为 NixOS Module 或者 Home Manager Module 引入，然后部署就可以看到效果了。</p><h4 id=模块化-overlays-配置 class=headerLink><a href=#%e6%a8%a1%e5%9d%97%e5%8c%96-overlays-%e9%85%8d%e7%bd%ae class=header-mark></a>模块化 overlays 配置</h4><p>上面的例子说明了如何编写 overlays，但是所有 overlays 都一股脑儿写在一起，就有点难以维护了，写得多了自然就希望模块化管理这些 overlays.</p><p>这里介绍下我找到的一个 overlays 模块化管理的最佳实践。</p><p>首先在 Git 仓库中创建 <code>overlays</code> 文件夹用于存放所有 overlays 配置，然后创建 <code>overlays/default.nix</code>，其内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=n>args</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=c1># import 当前文件夹下所有的 nix 文件，并以 args 为参数执行它们</span>
</span></span><span class=line><span class=cl>  <span class=c1># 返回值是一个所有执行结果的列表，也就是 overlays 的列表</span>
</span></span><span class=line><span class=cl>  <span class=nb>builtins</span><span class=o>.</span><span class=nb>map</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=n>f</span><span class=p>:</span> <span class=p>(</span><span class=kn>import</span> <span class=p>(</span><span class=sr>./.</span> <span class=o>+</span> <span class=s2>&#34;/</span><span class=si>${</span><span class=n>f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span> <span class=n>args</span><span class=p>))</span>  <span class=c1># map 的第一个参数，是一个 import 并执行 nix 文件的函数</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>filter</span>          <span class=c1># map 的第二个参数，它返回一个当前文件夹下除 default.nix 外所有 nix 文件的列表</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=n>f</span><span class=p>:</span> <span class=n>f</span> <span class=o>!=</span> <span class=s2>&#34;default.nix&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>attrNames</span> <span class=p>(</span><span class=nb>builtins</span><span class=o>.</span><span class=n>readDir</span> <span class=sr>./.</span><span class=p>)))</span>
</span></span></code></pre></td></tr></table></div></div><p>后续所有 overlays 配置都添加到 <code>overlays</code> 文件夹中，一个示例配置 <code>overlays/fcitx5/default.nix</code> 内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=c1># 为了不使用默认的 rime-data，改用我自定义的小鹤音形数据，这里需要 override</span>
</span></span><span class=line><span class=cl><span class=c1># 参考 https://github.com/NixOS/nixpkgs/blob/e4246ae1e7f78b7087dce9c9da10d28d3725025f/pkgs/tools/inputmethods/fcitx5/fcitx5-rime.nix</span>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=n>pkgs</span><span class=o>,</span> <span class=n>config</span><span class=o>,</span> <span class=n>lib</span><span class=o>,</span> <span class=o>...</span><span class=p>}:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>self</span><span class=p>:</span> <span class=n>super</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1># 小鹤音形配置，配置来自 flypy.com 官方网盘的鼠须管配置压缩包「小鹤音形“鼠须管”for macOS.zip」</span>
</span></span><span class=line><span class=cl>  <span class=n>rime-data</span> <span class=o>=</span> <span class=sr>./rime-data-flypy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fcitx5-rime</span> <span class=o>=</span> <span class=n>super</span><span class=o>.</span><span class=n>fcitx5-rime</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span> <span class=n>rimeDataPkgs</span> <span class=o>=</span> <span class=p>[</span> <span class=sr>./rime-data-flypy</span> <span class=p>];</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>我通过上面这个 overlays 修改了 fcitx5-rime 输入法的默认数据，加载了我自定义的小鹤音形输入法。</p><p>最后，还需要通过 <code>nixpkgs.overlays</code> 这个 option 加载 <code>overlays/default.nix</code> 返回的所有 overlays 配置，在任一 NixOS Module 中添加如下参数即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span> <span class=n>config</span><span class=o>,</span> <span class=n>pkgs</span><span class=o>,</span> <span class=n>lib</span><span class=o>,</span> <span class=o>...</span> <span class=p>}</span> <span class=o>@</span> <span class=n>args</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1># ......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># 添加此参数</span>
</span></span><span class=line><span class=cl>  <span class=n>nixpkgs</span><span class=o>.</span><span class=n>overlays</span> <span class=o>=</span> <span class=kn>import</span> <span class=sr>/path/to/overlays/dir</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># ......</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>比如说直接写 <code>flake.nix</code> 里：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>description</span> <span class=o>=</span> <span class=s2>&#34;NixOS configuration of Ryan Yin&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># ......</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>inputs</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># ......</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>outputs</span> <span class=o>=</span> <span class=n>inputs</span><span class=o>@</span><span class=p>{</span> <span class=n>self</span><span class=o>,</span> <span class=n>nixpkgs</span><span class=o>,</span> <span class=o>...</span> <span class=p>}:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>nixosConfigurations</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>nixos-test</span> <span class=o>=</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>nixosSystem</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>system</span> <span class=o>=</span> <span class=s2>&#34;x86_64-linux&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>specialArgs</span> <span class=o>=</span> <span class=n>inputs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>modules</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=sr>./hosts/nixos-test</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1># 添加如下内嵌 module 定义</span>
</span></span><span class=line><span class=cl>          <span class=c1>#   这里将 modules 的所有参数 args 都传递到了 overlays 中</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=n>args</span><span class=p>:</span> <span class=p>{</span> <span class=n>nixpkgs</span><span class=o>.</span><span class=n>overlays</span> <span class=o>=</span> <span class=kn>import</span> <span class=sr>./overlays</span> <span class=n>args</span><span class=p>;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=c1># ......</span>
</span></span><span class=line><span class=cl>        <span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>按照上述方法进行配置，就可以很方便地模块化管理所有 overlays 配置了，以我的配置为例，overlays 文件夹的结构大致如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=cl><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>flake</span><span class=o>.</span><span class=n>lock</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>flake</span><span class=o>.</span><span class=n>nix</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>home</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>hosts</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>modules</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=o>......</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>overlays</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>default</span><span class=o>.</span><span class=n>nix</span>         <span class=c1># 它返回一个所有 overlays 的列表</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=n>fcitx5</span>              <span class=c1># fcitx5 overlay</span>
</span></span><span class=line><span class=cl><span class=err>│</span>       <span class=err>├──</span> <span class=n>default</span><span class=o>.</span><span class=n>nix</span>
</span></span><span class=line><span class=cl><span class=err>│</span>       <span class=err>├──</span> <span class=n>README</span><span class=o>.</span><span class=n>md</span>
</span></span><span class=line><span class=cl><span class=err>│</span>       <span class=err>└──</span> <span class=n>rime-data-flypy</span>  <span class=c1># 自定义的 rime-data，需要遵循它的文件夹格式</span>
</span></span><span class=line><span class=cl><span class=err>│</span>           <span class=err>└──</span> <span class=n>share</span>
</span></span><span class=line><span class=cl><span class=err>│</span>               <span class=err>└──</span> <span class=n>rime-data</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                   <span class=err>├──</span> <span class=o>......</span>  <span class=c1># rime-data 文件</span>
</span></span><span class=line><span class=cl><span class=err>└──</span> <span class=n>README</span><span class=o>.</span><span class=n>md</span>
</span></span></code></pre></td></tr></table></div></div><p>你可以在我的配置仓库 <a href=https://github.com/ryan4yin/nix-config/tree/v0.0.4 target=_blank rel="noopener noreferrer">ryan4yin/nix-config/v0.0.4</a> 查看更详细的内容，获取些灵感。</p><h2 id=advanced-topics class=headerLink><a href=#advanced-topics class=header-mark></a>进阶玩法</h2><p>逐渐熟悉 Nix 这一套工具链后，可以进一步读一读 Nix 的三本手册，挖掘更多的玩法：</p><ul><li><a href=https://nixos.org/manual/nix/stable/package-management/profiles.html target=_blank rel="noopener noreferrer">Nix Reference Manual</a>: Nix 包管理器使用手册，主要包含 Nix 包管理器的设计、命令行使用说明。</li><li><a href=https://nixos.org/manual/nixpkgs/unstable/ target=_blank rel="noopener noreferrer">nixpkgs Manual</a>: 主要介绍 Nixpkgs 的参数、Nix 包的使用、修改、打包方法。</li><li><a href=https://nixos.org/manual/nixos/unstable/ target=_blank rel="noopener noreferrer">NixOS Manual</a>: NixOS 系统使用手册，主要包含 Wayland/X11, GPU 等系统级别的配置说明。</li><li><a href=https://nixos.org/guides/nix-pills target=_blank rel="noopener noreferrer">nix-pills</a>: Nix Pills 对如何使用 Nix 构建软件包进行了深入的阐述，写得比官方文档清晰易懂，而且也足够深入，值得一读。</li></ul><p>在对 Nix Flakes 熟悉到一定程度后，你可以尝试一些 Flakes 的进阶玩法，如下是一些比较流行的社区项目，可以试用：</p><ul><li><a href=https://github.com/hercules-ci/flake-parts target=_blank rel="noopener noreferrer">flake-parts</a>: 通过 Module 模块系统简化配置的编写与维护。</li><li><a href=https://github.com/gytis-ivaskevicius/flake-utils-plus target=_blank rel="noopener noreferrer">flake-utils-plus</a>:同样是用于简化 Flake 配置的第三方包，不过貌似更强大些</li><li><a href=https://github.com/divnix/digga target=_blank rel="noopener noreferrer">digga</a>: 一个大而全的 Flake 模板，揉合了各种实用 Nix 工具包的功能，不过结构比较复杂，需要一定经验才能玩得转。</li><li>&mldr;&mldr;</li></ul><p>以及其他许多实用的社区项目可探索，我比较关注的有这几个：</p><ul><li><a href=https://github.com/cachix/devenv target=_blank rel="noopener noreferrer">devenv</a>: 开发环境管理</li><li><a href=https://github.com/ryantm/agenix target=_blank rel="noopener noreferrer">agenix</a>: secrets 管理</li><li><a href=https://github.com/nix-community/nixos-generators target=_blank rel="noopener noreferrer">nixos-generator</a>: 镜像生成工具，从 nixos 配置生成 iso/qcow2 等格式的镜像</li><li><a href=https://github.com/nix-community/lanzaboote target=_blank rel="noopener noreferrer">lanzaboote</a>: 启用 secure boot</li><li><a href=https://github.com/nix-community/impermanence target=_blank rel="noopener noreferrer">impermanence</a>: 用于配置无状态系统。可用它持久化你指定的文件或文件夹，同时再将 /home 目录挂载为 tmpfs 或者每次启动时用工具擦除一遍。这样所有不受 impermanence 管理的数据都将成为临时数据，如果它们导致了任何问题，重启下系统这些数据就全部还原到初始状态了！</li><li><a href=https://github.com/zhaofengli/colmena target=_blank rel="noopener noreferrer">colmena</a>: NixOS 主机部署工具</li></ul><h2 id=summary class=headerLink><a href=#summary class=header-mark></a>总结</h2><p>这是本系列文章的第一篇，介绍了使用 Nix Flakes 配置 NixOS 系统的基础知识，跟着这篇文章把系统配置好，就算是入门了。</p><p>我会在后续文章中介绍 NixOS & Nix Flakes 的进阶知识：开发环境管理、secrets 管理、软件打包、远程主机管理等等，尽请期待。</p><h2 id=reference class=headerLink><a href=#reference class=header-mark></a>参考</h2><p>如下是我参考过的比较有用的 Nix 相关资料：</p><ul><li><a href=https://github.com/DeterminateSystems/zero-to-nix target=_blank rel="noopener noreferrer">Zero to Nix - Determinate Systems</a>: 浅显易懂的 Nix Flakes 新手入门文档，值得一读。</li><li><a href=https://lantian.pub/article/modify-website/nixos-why.lantian/ target=_blank rel="noopener noreferrer">NixOS 系列</a>: 这是 LanTian 大佬的 NixOS 系列文章，写得非常清晰明了，新手必读。</li><li><a href=https://www.tweag.io/blog/2020-05-25-flakes/ target=_blank rel="noopener noreferrer">Nix Flakes Series</a>: 官方的 Nix Flakes 系列文章，介绍得比较详细，作为新手入门比较 OK</li><li><a href=https://nixos.wiki/wiki/Flakes target=_blank rel="noopener noreferrer">Nix Flakes - Wiki</a>: Nix Flakes 的官方 Wiki，此文介绍得比较粗略。</li><li><a href=https://github.com/ryan4yin/nix-config target=_blank rel="noopener noreferrer">ryan4yin/nix-config</a>: 我的 NixOS 配置仓库，README 中也列出了我参考过的其他配置仓库</li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-05-09</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=# onclick=return!1 title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/nixos-and-flake-basics/ data-title="NixOS 与 Nix Flakes 新手入门" data-via=ryan4yin data-hashtags=NixOS,Nix,Flakes,Linux,DevOps><i class="fab fa-twitter fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Facebook" data-sharer=facebook data-url=https://thiscute.world/posts/nixos-and-flake-basics/ data-hashtag=NixOS><i class="fab fa-facebook-square fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/nixos-and-flake-basics/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/nixos/>NixOS</a>,&nbsp;<a href=/tags/nix/>Nix</a>,&nbsp;<a href=/tags/flakes/>Flakes</a>,&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/devops/>DevOps</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/wireguard-on-linux/ class=prev rel=prev title="Linux 上的 WireGuard 网络分析（一）"><i class="fas fa-angle-left fa-fw"></i>Linux 上的 WireGuard 网络分析（一）</a>
<a href=/posts/macos-window-manager-yabai-usage/ class=next rel=next title="MacOS 窗口管理器 yabai 玩耍笔记">MacOS 窗口管理器 yabai 玩耍笔记<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=width:auto;height:15px;margin-bottom:5px></a> <a href=https://www.foreverblog.cn/go.html target=_blank><img src=https://img.foreverblog.cn/wormhole_3.gif alt style=width:auto;height:24px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://thiscute.world/ target=_blank rel="noopener noreferrer">ryan4yin</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/algoliasearch/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/topbar/topbar.min.js></script><script type=text/javascript src=/lib/pjax/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script></div><div class=pjax-assets><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript></div></body></html>